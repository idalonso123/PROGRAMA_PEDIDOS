2026-02-06 17:38:41 - INFO - ======================================================================
2026-02-06 17:38:41 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 17:38:41 - INFO - Fecha de ejecución: 2026-02-06 17:38:41
2026-02-06 17:38:41 - INFO - ======================================================================
2026-02-06 17:38:41 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 17:38:41 - INFO - Envío de emails: Sí
2026-02-06 17:38:41 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 17:38:41 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 17:38:41 - WARNING - Archivo de estado no encontrado. Creando nuevo: .\./data\state.json
2026-02-06 17:38:41 - INFO - Estado guardado correctamente
2026-02-06 17:38:41 - INFO - SchedulerService inicializado correctamente
2026-02-06 17:38:41 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 17:38:41 - INFO - Semana forzada por argumento: 14
2026-02-06 17:38:41 - INFO - ======================================================================
2026-02-06 17:38:41 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 17:38:41 - INFO - ======================================================================
2026-02-06 17:38:41 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 17:38:41 - INFO - DataLoader inicializado correctamente
2026-02-06 17:38:41 - INFO - ForecastEngine inicializado correctamente
2026-02-06 17:38:41 - INFO - OrderGenerator inicializado correctamente
2026-02-06 17:38:41 - INFO - SchedulerService inicializado correctamente
2026-02-06 17:38:41 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 17:38:41 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 17:38:41 - INFO - Stock acumulado cargado: 0 artículos
2026-02-06 17:38:41 - INFO - 
==================================================
2026-02-06 17:38:41 - INFO - SECCION: MAF
2026-02-06 17:38:41 - INFO - ==================================================
2026-02-06 17:38:41 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 17:38:41 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:38:41 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 17:38:41 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 17:38:41 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 17:38:41 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:38:41 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 17:38:41 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 17:38:41 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:38:41 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:38:41 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:38:45 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:38:45 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:38:45 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:38:45 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:38:45 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:38:45 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:38:45 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 17:38:45 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:38:45 - DEBUG -   maf: 10970 registros
2026-02-06 17:38:45 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:38:45 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:38:45 - DEBUG -   interior: 3624 registros
2026-02-06 17:38:45 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:38:45 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:38:45 - DEBUG -   vivero: 2460 registros
2026-02-06 17:38:45 - DEBUG -   fitos: 1987 registros
2026-02-06 17:38:45 - DEBUG -   semillas: 1180 registros
2026-02-06 17:38:45 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:38:45 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:38:45 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 17:38:45 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 17:38:45 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:38:45 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:38:47 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:38:47 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:38:47 - INFO - Costes cargados: 22145 registros
2026-02-06 17:38:47 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:38:47 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:38:47 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 17:38:47 - INFO -   ABC: 499 registros
2026-02-06 17:38:47 - INFO -   Ventas: 10970 registros
2026-02-06 17:38:47 - INFO -   Costes: 22145 registros
2026-02-06 17:38:47 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 17:38:47 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 17:38:47 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:38:47 - INFO - Datos de ventas: 1011 registros
2026-02-06 17:38:47 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 17:38:48 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 17:38:48 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:38:48 - INFO -   Factor total: 1.3125
2026-02-06 17:38:48 - INFO -   Factor escalado: 1.5844
2026-02-06 17:38:48 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 17:38:48 - INFO -   Objetivo final: 9253.98€
2026-02-06 17:38:48 - INFO -   Delta: 679.77€
2026-02-06 17:38:48 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:38:48 - DEBUG -   Total registros: 222
2026-02-06 17:38:48 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 17:38:48 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 17:38:48 - INFO -   Ventas finales: 9254.53€
2026-02-06 17:38:48 - INFO - 
============================================================
2026-02-06 17:38:48 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:38:48 - INFO - ============================================================
2026-02-06 17:38:48 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:38:48 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:38:48 - INFO - DataLoader inicializado correctamente
2026-02-06 17:38:48 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:38:48 - INFO - ============================================================
2026-02-06 17:38:48 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:38:48 - INFO - ============================================================
2026-02-06 17:38:48 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:38:48 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:38:48 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:38:48 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:38:48 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:38:48 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:38:48 - DEBUG - Usando hoja: Stock
2026-02-06 17:38:48 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:38:48 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:38:48 - INFO -   Stock: 30 registros
2026-02-06 17:38:48 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:38:48 - INFO - Fusión completada: 222 registros
2026-02-06 17:38:48 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:38:48 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:38:48 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:38:48 - INFO - 
============================================================
2026-02-06 17:38:48 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:38:48 - INFO - ============================================================
2026-02-06 17:38:48 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:38:48 - INFO - Corrección completada:
2026-02-06 17:38:48 - INFO -   - Artículos corregidos: 191/222
2026-02-06 17:38:48 - INFO -   - Artículos aumentados: 191
2026-02-06 17:38:48 - INFO -   - Artículos reducidos: 0
2026-02-06 17:38:48 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:38:48 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:38:48 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:38:48 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 17:38:48 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:38:48 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:38:48 - DEBUG -   Con valor 0: 31
2026-02-06 17:38:48 - DEBUG -   Con valor > 0: 191
2026-02-06 17:38:48 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 17:38:48 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 191 registros
2026-02-06 17:38:48 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 17:38:48 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 17:38:48 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 17:38:48 - INFO -   Articulos: 191
2026-02-06 17:38:48 - INFO -   Importe: 9254.53€
2026-02-06 17:38:48 - INFO - 
==================================================
2026-02-06 17:38:48 - INFO - SECCION: DECO_INTERIOR
2026-02-06 17:38:48 - INFO - ==================================================
2026-02-06 17:38:48 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 17:38:48 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:38:48 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 17:38:48 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 17:38:48 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 17:38:49 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:38:49 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 17:38:49 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 17:38:49 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:38:49 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:38:49 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:38:52 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:38:52 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:38:52 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:38:52 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:38:52 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:38:52 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:38:52 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 17:38:53 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:38:53 - DEBUG -   maf: 10970 registros
2026-02-06 17:38:53 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:38:53 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:38:53 - DEBUG -   interior: 3624 registros
2026-02-06 17:38:53 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:38:53 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:38:53 - DEBUG -   vivero: 2460 registros
2026-02-06 17:38:53 - DEBUG -   fitos: 1987 registros
2026-02-06 17:38:53 - DEBUG -   semillas: 1180 registros
2026-02-06 17:38:53 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:38:53 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:38:53 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 17:38:53 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 17:38:53 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:38:53 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:38:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:38:55 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:38:55 - INFO - Costes cargados: 22145 registros
2026-02-06 17:38:55 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:38:55 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:38:55 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 17:38:55 - INFO -   ABC: 1827 registros
2026-02-06 17:38:55 - INFO -   Ventas: 2468 registros
2026-02-06 17:38:55 - INFO -   Costes: 22145 registros
2026-02-06 17:38:55 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 17:38:55 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 17:38:55 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:38:55 - INFO - Datos de ventas: 180 registros
2026-02-06 17:38:55 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 17:38:55 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 17:38:55 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:38:55 - INFO -   Factor total: 1.3125
2026-02-06 17:38:55 - INFO -   Factor escalado: 1.5747
2026-02-06 17:38:55 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 17:38:55 - INFO -   Objetivo final: 2576.42€
2026-02-06 17:38:55 - INFO -   Delta: 373.59€
2026-02-06 17:38:55 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:38:55 - DEBUG -   Total registros: 139
2026-02-06 17:38:55 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 17:38:55 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 17:38:55 - INFO -   Ventas finales: 2580.73€
2026-02-06 17:38:55 - INFO - 
============================================================
2026-02-06 17:38:55 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:38:55 - INFO - ============================================================
2026-02-06 17:38:55 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:38:55 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:38:55 - INFO - DataLoader inicializado correctamente
2026-02-06 17:38:55 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:38:55 - INFO - ============================================================
2026-02-06 17:38:55 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:38:55 - INFO - ============================================================
2026-02-06 17:38:55 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:38:55 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:38:55 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:38:55 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:38:55 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:38:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:38:55 - DEBUG - Usando hoja: Stock
2026-02-06 17:38:55 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:38:55 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:38:55 - INFO -   Stock: 30 registros
2026-02-06 17:38:55 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:38:55 - INFO - Fusión completada: 139 registros
2026-02-06 17:38:55 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:38:55 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:38:55 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:38:55 - INFO - 
============================================================
2026-02-06 17:38:55 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:38:55 - INFO - ============================================================
2026-02-06 17:38:55 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:38:55 - INFO - Corrección completada:
2026-02-06 17:38:55 - INFO -   - Artículos corregidos: 135/139
2026-02-06 17:38:55 - INFO -   - Artículos aumentados: 135
2026-02-06 17:38:55 - INFO -   - Artículos reducidos: 0
2026-02-06 17:38:55 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:38:55 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:38:55 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:38:55 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 17:38:55 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:38:55 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:38:55 - DEBUG -   Con valor 0: 4
2026-02-06 17:38:55 - DEBUG -   Con valor > 0: 135
2026-02-06 17:38:55 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 17:38:55 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 135 registros
2026-02-06 17:38:55 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 17:38:55 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 17:38:55 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 17:38:55 - INFO -   Articulos: 135
2026-02-06 17:38:55 - INFO -   Importe: 2580.73€
2026-02-06 17:38:55 - INFO - 
==================================================
2026-02-06 17:38:55 - INFO - SECCION: SEMILLAS
2026-02-06 17:38:55 - INFO - ==================================================
2026-02-06 17:38:55 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 17:38:55 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:38:55 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 17:38:55 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 17:38:55 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 17:38:55 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:38:55 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 17:38:55 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 17:38:55 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:38:55 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:38:55 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:38:59 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:38:59 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:38:59 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:38:59 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:38:59 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:38:59 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:38:59 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 17:38:59 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:38:59 - DEBUG -   maf: 10970 registros
2026-02-06 17:38:59 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:38:59 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:38:59 - DEBUG -   interior: 3624 registros
2026-02-06 17:38:59 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:38:59 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:38:59 - DEBUG -   vivero: 2460 registros
2026-02-06 17:38:59 - DEBUG -   fitos: 1987 registros
2026-02-06 17:38:59 - DEBUG -   semillas: 1180 registros
2026-02-06 17:38:59 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:38:59 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:38:59 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 17:38:59 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 17:38:59 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:38:59 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:01 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:01 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:01 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:01 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:01 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:01 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 17:39:01 - INFO -   ABC: 218 registros
2026-02-06 17:39:01 - INFO -   Ventas: 1180 registros
2026-02-06 17:39:01 - INFO -   Costes: 22145 registros
2026-02-06 17:39:01 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 17:39:01 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 17:39:01 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:01 - INFO - Datos de ventas: 136 registros
2026-02-06 17:39:01 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 17:39:02 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 17:39:02 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:02 - INFO -   Factor total: 1.3125
2026-02-06 17:39:02 - INFO -   Factor escalado: 2.0023
2026-02-06 17:39:02 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 17:39:02 - INFO -   Objetivo final: 911.32€
2026-02-06 17:39:02 - INFO -   Delta: 217.83€
2026-02-06 17:39:02 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:02 - DEBUG -   Total registros: 84
2026-02-06 17:39:02 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 17:39:02 - DEBUG -   Ventas finales: 911.60€
2026-02-06 17:39:02 - INFO -   Ventas finales: 911.60€
2026-02-06 17:39:02 - INFO - 
============================================================
2026-02-06 17:39:02 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:02 - INFO - ============================================================
2026-02-06 17:39:02 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:02 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:02 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:02 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:02 - INFO - ============================================================
2026-02-06 17:39:02 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:02 - INFO - ============================================================
2026-02-06 17:39:02 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:02 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:02 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:02 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:02 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:02 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:02 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:02 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:02 - INFO -   Stock: 30 registros
2026-02-06 17:39:02 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:02 - INFO - Fusión completada: 84 registros
2026-02-06 17:39:02 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:02 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:02 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:02 - INFO - 
============================================================
2026-02-06 17:39:02 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:02 - INFO - ============================================================
2026-02-06 17:39:02 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:02 - INFO - Corrección completada:
2026-02-06 17:39:02 - INFO -   - Artículos corregidos: 84/84
2026-02-06 17:39:02 - INFO -   - Artículos aumentados: 84
2026-02-06 17:39:02 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:02 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:02 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:02 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:02 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 17:39:02 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:02 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:02 - DEBUG -   Con valor 0: 0
2026-02-06 17:39:02 - DEBUG -   Con valor > 0: 84
2026-02-06 17:39:02 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 17:39:02 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 84 registros
2026-02-06 17:39:02 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 17:39:02 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 17:39:02 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 17:39:02 - INFO -   Articulos: 84
2026-02-06 17:39:02 - INFO -   Importe: 911.60€
2026-02-06 17:39:02 - INFO - 
==================================================
2026-02-06 17:39:02 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 17:39:02 - INFO - ==================================================
2026-02-06 17:39:02 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 17:39:02 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:39:02 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 17:39:02 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 17:39:02 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 17:39:02 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:39:02 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 17:39:02 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 17:39:02 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:39:02 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:39:02 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:39:06 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:06 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:39:06 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:39:06 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:39:06 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:39:06 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:39:06 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 17:39:06 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:39:06 - DEBUG -   maf: 10970 registros
2026-02-06 17:39:06 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:39:06 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:39:06 - DEBUG -   interior: 3624 registros
2026-02-06 17:39:06 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:39:06 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:39:06 - DEBUG -   vivero: 2460 registros
2026-02-06 17:39:06 - DEBUG -   fitos: 1987 registros
2026-02-06 17:39:06 - DEBUG -   semillas: 1180 registros
2026-02-06 17:39:06 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:39:06 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:39:06 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 17:39:06 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 17:39:06 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:39:06 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:08 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:08 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:08 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:08 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:08 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 17:39:08 - INFO -   ABC: 205 registros
2026-02-06 17:39:08 - INFO -   Ventas: 1124 registros
2026-02-06 17:39:08 - INFO -   Costes: 22145 registros
2026-02-06 17:39:08 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 17:39:08 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 17:39:08 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:08 - INFO - Datos de ventas: 88 registros
2026-02-06 17:39:08 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 17:39:08 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 17:39:08 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:08 - INFO -   Factor total: 1.3125
2026-02-06 17:39:08 - INFO -   Factor escalado: 1.6854
2026-02-06 17:39:08 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 17:39:08 - INFO -   Objetivo final: 1426.88€
2026-02-06 17:39:08 - INFO -   Delta: 346.78€
2026-02-06 17:39:08 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:08 - DEBUG -   Total registros: 43
2026-02-06 17:39:08 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 17:39:08 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 17:39:08 - INFO -   Ventas finales: 1455.34€
2026-02-06 17:39:08 - INFO - 
============================================================
2026-02-06 17:39:08 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:08 - INFO - ============================================================
2026-02-06 17:39:08 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:08 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:08 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:08 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:08 - INFO - ============================================================
2026-02-06 17:39:08 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:08 - INFO - ============================================================
2026-02-06 17:39:08 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:08 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:08 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:08 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:08 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:08 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:08 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:08 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:08 - INFO -   Stock: 30 registros
2026-02-06 17:39:08 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:08 - INFO - Fusión completada: 43 registros
2026-02-06 17:39:08 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:08 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:08 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:08 - INFO - 
============================================================
2026-02-06 17:39:08 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:08 - INFO - ============================================================
2026-02-06 17:39:08 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:08 - INFO - Corrección completada:
2026-02-06 17:39:08 - INFO -   - Artículos corregidos: 36/43
2026-02-06 17:39:08 - INFO -   - Artículos aumentados: 36
2026-02-06 17:39:08 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:08 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:08 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:08 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:08 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 17:39:08 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:08 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:08 - DEBUG -   Con valor 0: 7
2026-02-06 17:39:08 - DEBUG -   Con valor > 0: 36
2026-02-06 17:39:08 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 17:39:08 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 36 registros
2026-02-06 17:39:08 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 17:39:08 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 17:39:08 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 17:39:08 - INFO -   Articulos: 36
2026-02-06 17:39:08 - INFO -   Importe: 1455.34€
2026-02-06 17:39:08 - INFO - 
==================================================
2026-02-06 17:39:08 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 17:39:08 - INFO - ==================================================
2026-02-06 17:39:08 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 17:39:08 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:39:08 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 17:39:08 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 17:39:08 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 17:39:09 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:39:09 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 17:39:09 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 17:39:09 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:39:09 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:39:09 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:39:13 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:13 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:39:13 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:39:13 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:39:13 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:39:13 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:39:13 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 17:39:13 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:39:13 - DEBUG -   maf: 10970 registros
2026-02-06 17:39:13 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:39:13 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:39:13 - DEBUG -   interior: 3624 registros
2026-02-06 17:39:13 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:39:13 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:39:13 - DEBUG -   vivero: 2460 registros
2026-02-06 17:39:13 - DEBUG -   fitos: 1987 registros
2026-02-06 17:39:13 - DEBUG -   semillas: 1180 registros
2026-02-06 17:39:13 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:39:13 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:39:13 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 17:39:13 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 17:39:13 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:39:13 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:15 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:15 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:15 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:15 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:15 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:15 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 17:39:15 - INFO -   ABC: 2749 registros
2026-02-06 17:39:15 - INFO -   Ventas: 9784 registros
2026-02-06 17:39:15 - INFO -   Costes: 22145 registros
2026-02-06 17:39:15 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 17:39:15 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 17:39:15 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:15 - INFO - Datos de ventas: 822 registros
2026-02-06 17:39:15 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 17:39:17 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 17:39:17 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:17 - INFO -   Factor total: 1.3125
2026-02-06 17:39:17 - INFO -   Factor escalado: 1.0268
2026-02-06 17:39:17 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 17:39:17 - INFO -   Objetivo final: 8977.26€
2026-02-06 17:39:17 - INFO -   Delta: 3401.99€
2026-02-06 17:39:17 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:17 - DEBUG -   Total registros: 538
2026-02-06 17:39:17 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 17:39:17 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 17:39:17 - INFO -   Ventas finales: 8993.98€
2026-02-06 17:39:17 - INFO - 
============================================================
2026-02-06 17:39:17 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:17 - INFO - ============================================================
2026-02-06 17:39:17 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:17 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:17 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:17 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:17 - INFO - ============================================================
2026-02-06 17:39:17 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:17 - INFO - ============================================================
2026-02-06 17:39:17 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:17 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:17 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:17 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:17 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:17 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:17 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:17 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:17 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:17 - INFO -   Stock: 30 registros
2026-02-06 17:39:17 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:17 - INFO - Fusión completada: 538 registros
2026-02-06 17:39:17 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:17 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:17 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:17 - INFO - 
============================================================
2026-02-06 17:39:17 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:17 - INFO - ============================================================
2026-02-06 17:39:17 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:17 - INFO - Corrección completada:
2026-02-06 17:39:17 - INFO -   - Artículos corregidos: 411/538
2026-02-06 17:39:17 - INFO -   - Artículos aumentados: 411
2026-02-06 17:39:17 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:17 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:17 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:17 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:17 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 17:39:17 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:17 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:17 - DEBUG -   Con valor 0: 127
2026-02-06 17:39:17 - DEBUG -   Con valor > 0: 411
2026-02-06 17:39:17 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 17:39:17 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 411 registros
2026-02-06 17:39:17 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 17:39:18 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 17:39:18 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 17:39:18 - INFO -   Articulos: 411
2026-02-06 17:39:18 - INFO -   Importe: 8993.98€
2026-02-06 17:39:18 - INFO - 
==================================================
2026-02-06 17:39:18 - INFO - SECCION: INTERIOR
2026-02-06 17:39:18 - INFO - ==================================================
2026-02-06 17:39:18 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 17:39:18 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:39:18 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 17:39:18 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 17:39:18 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 17:39:18 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:39:18 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 17:39:18 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 17:39:18 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:39:18 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:39:18 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:39:22 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:22 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:39:22 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:39:22 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:39:22 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:39:22 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:39:22 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 17:39:22 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:39:22 - DEBUG -   maf: 10970 registros
2026-02-06 17:39:22 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:39:22 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:39:22 - DEBUG -   interior: 3624 registros
2026-02-06 17:39:22 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:39:22 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:39:22 - DEBUG -   vivero: 2460 registros
2026-02-06 17:39:22 - DEBUG -   fitos: 1987 registros
2026-02-06 17:39:22 - DEBUG -   semillas: 1180 registros
2026-02-06 17:39:22 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:39:22 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:39:22 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 17:39:22 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 17:39:22 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:39:22 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:24 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:24 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:24 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:24 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:24 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 17:39:24 - INFO -   ABC: 555 registros
2026-02-06 17:39:24 - INFO -   Ventas: 3624 registros
2026-02-06 17:39:24 - INFO -   Costes: 22145 registros
2026-02-06 17:39:24 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 17:39:24 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 17:39:24 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:24 - INFO - Datos de ventas: 286 registros
2026-02-06 17:39:24 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 17:39:24 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 17:39:24 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:24 - INFO -   Factor total: 1.3125
2026-02-06 17:39:24 - INFO -   Factor escalado: 1.5971
2026-02-06 17:39:24 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 17:39:24 - INFO -   Objetivo final: 3846.45€
2026-02-06 17:39:24 - INFO -   Delta: 685.37€
2026-02-06 17:39:24 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:24 - DEBUG -   Total registros: 138
2026-02-06 17:39:24 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 17:39:24 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 17:39:24 - INFO -   Ventas finales: 3862.17€
2026-02-06 17:39:24 - INFO - 
============================================================
2026-02-06 17:39:24 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:24 - INFO - ============================================================
2026-02-06 17:39:24 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:24 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:24 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:24 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:24 - INFO - ============================================================
2026-02-06 17:39:24 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:24 - INFO - ============================================================
2026-02-06 17:39:24 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:24 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:24 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:24 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:24 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:24 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:24 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:24 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:24 - INFO -   Stock: 30 registros
2026-02-06 17:39:24 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:24 - INFO - Fusión completada: 138 registros
2026-02-06 17:39:24 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:24 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:24 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:24 - INFO - 
============================================================
2026-02-06 17:39:24 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:24 - INFO - ============================================================
2026-02-06 17:39:24 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:24 - INFO - Corrección completada:
2026-02-06 17:39:24 - INFO -   - Artículos corregidos: 121/138
2026-02-06 17:39:24 - INFO -   - Artículos aumentados: 121
2026-02-06 17:39:24 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:24 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:24 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:24 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:24 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 17:39:24 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:24 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:24 - DEBUG -   Con valor 0: 17
2026-02-06 17:39:24 - DEBUG -   Con valor > 0: 121
2026-02-06 17:39:24 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 17:39:24 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 121 registros
2026-02-06 17:39:24 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 17:39:24 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 17:39:24 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 17:39:24 - INFO -   Articulos: 121
2026-02-06 17:39:24 - INFO -   Importe: 3862.17€
2026-02-06 17:39:24 - INFO - 
==================================================
2026-02-06 17:39:24 - INFO - SECCION: FITOS
2026-02-06 17:39:24 - INFO - ==================================================
2026-02-06 17:39:24 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 17:39:24 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:39:24 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 17:39:24 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 17:39:24 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 17:39:24 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:39:24 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 17:39:24 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 17:39:24 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:39:24 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:39:24 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:39:28 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:28 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:39:28 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:39:28 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:39:28 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:39:28 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:39:28 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 17:39:28 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:39:28 - DEBUG -   maf: 10970 registros
2026-02-06 17:39:28 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:39:28 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:39:28 - DEBUG -   interior: 3624 registros
2026-02-06 17:39:28 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:39:28 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:39:28 - DEBUG -   vivero: 2460 registros
2026-02-06 17:39:28 - DEBUG -   fitos: 1987 registros
2026-02-06 17:39:28 - DEBUG -   semillas: 1180 registros
2026-02-06 17:39:28 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:39:28 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:39:28 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 17:39:28 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 17:39:28 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:39:28 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:30 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:30 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:30 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:30 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:30 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:30 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 17:39:30 - INFO -   ABC: 247 registros
2026-02-06 17:39:30 - INFO -   Ventas: 1987 registros
2026-02-06 17:39:30 - INFO -   Costes: 22145 registros
2026-02-06 17:39:31 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 17:39:31 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 17:39:31 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:31 - INFO - Datos de ventas: 157 registros
2026-02-06 17:39:31 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 17:39:31 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 17:39:31 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:31 - INFO -   Factor total: 1.3125
2026-02-06 17:39:31 - INFO -   Factor escalado: 1.4055
2026-02-06 17:39:31 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 17:39:31 - INFO -   Objetivo final: 2360.20€
2026-02-06 17:39:31 - INFO -   Delta: 424.74€
2026-02-06 17:39:31 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:31 - DEBUG -   Total registros: 84
2026-02-06 17:39:31 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 17:39:31 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 17:39:31 - INFO -   Ventas finales: 2365.92€
2026-02-06 17:39:31 - INFO - 
============================================================
2026-02-06 17:39:31 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:31 - INFO - ============================================================
2026-02-06 17:39:31 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:31 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:31 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:31 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:31 - INFO - ============================================================
2026-02-06 17:39:31 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:31 - INFO - ============================================================
2026-02-06 17:39:31 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:31 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:31 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:31 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:31 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:31 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:31 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:31 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:31 - INFO -   Stock: 30 registros
2026-02-06 17:39:31 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:31 - INFO - Fusión completada: 84 registros
2026-02-06 17:39:31 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:31 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:31 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:31 - INFO - 
============================================================
2026-02-06 17:39:31 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:31 - INFO - ============================================================
2026-02-06 17:39:31 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:31 - INFO - Corrección completada:
2026-02-06 17:39:31 - INFO -   - Artículos corregidos: 82/84
2026-02-06 17:39:31 - INFO -   - Artículos aumentados: 82
2026-02-06 17:39:31 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:31 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:31 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:31 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:31 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 17:39:31 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:31 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:31 - DEBUG -   Con valor 0: 2
2026-02-06 17:39:31 - DEBUG -   Con valor > 0: 82
2026-02-06 17:39:31 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 17:39:31 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 82 registros
2026-02-06 17:39:31 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 17:39:31 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 17:39:31 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 17:39:31 - INFO -   Articulos: 82
2026-02-06 17:39:31 - INFO -   Importe: 2365.92€
2026-02-06 17:39:31 - INFO - 
==================================================
2026-02-06 17:39:31 - INFO - SECCION: VIVERO
2026-02-06 17:39:31 - INFO - ==================================================
2026-02-06 17:39:31 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 17:39:31 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:39:31 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 17:39:31 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 17:39:31 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 17:39:31 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:39:31 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 17:39:31 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 17:39:31 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:39:31 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:39:31 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:39:35 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:35 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:39:35 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:39:35 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:39:35 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:39:35 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:39:35 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 17:39:35 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:39:35 - DEBUG -   maf: 10970 registros
2026-02-06 17:39:35 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:39:35 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:39:35 - DEBUG -   interior: 3624 registros
2026-02-06 17:39:35 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:39:35 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:39:35 - DEBUG -   vivero: 2460 registros
2026-02-06 17:39:35 - DEBUG -   fitos: 1987 registros
2026-02-06 17:39:35 - DEBUG -   semillas: 1180 registros
2026-02-06 17:39:35 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:39:35 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:39:35 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 17:39:35 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 17:39:35 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:39:35 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:38 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:38 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:38 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:38 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:38 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 17:39:38 - INFO -   ABC: 565 registros
2026-02-06 17:39:38 - INFO -   Ventas: 2460 registros
2026-02-06 17:39:38 - INFO -   Costes: 22145 registros
2026-02-06 17:39:38 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 17:39:38 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 17:39:38 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:38 - INFO - Datos de ventas: 189 registros
2026-02-06 17:39:38 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 17:39:38 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 17:39:38 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:38 - INFO -   Factor total: 1.3125
2026-02-06 17:39:38 - INFO -   Factor escalado: 1.6886
2026-02-06 17:39:38 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 17:39:38 - INFO -   Objetivo final: 6952.54€
2026-02-06 17:39:38 - INFO -   Delta: 1809.40€
2026-02-06 17:39:38 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:38 - DEBUG -   Total registros: 107
2026-02-06 17:39:38 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 17:39:38 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 17:39:38 - INFO -   Ventas finales: 6990.51€
2026-02-06 17:39:38 - INFO - 
============================================================
2026-02-06 17:39:38 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:38 - INFO - ============================================================
2026-02-06 17:39:38 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:38 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:38 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:38 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:38 - INFO - ============================================================
2026-02-06 17:39:38 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:38 - INFO - ============================================================
2026-02-06 17:39:38 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:38 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:38 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:38 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:38 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:38 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:38 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:38 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:38 - INFO -   Stock: 30 registros
2026-02-06 17:39:38 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:38 - INFO - Fusión completada: 107 registros
2026-02-06 17:39:38 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:38 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:38 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:38 - INFO - 
============================================================
2026-02-06 17:39:38 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:38 - INFO - ============================================================
2026-02-06 17:39:38 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:38 - INFO - Corrección completada:
2026-02-06 17:39:38 - INFO -   - Artículos corregidos: 96/107
2026-02-06 17:39:38 - INFO -   - Artículos aumentados: 96
2026-02-06 17:39:38 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:38 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:38 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:38 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:38 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 17:39:38 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:38 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:38 - DEBUG -   Con valor 0: 11
2026-02-06 17:39:38 - DEBUG -   Con valor > 0: 96
2026-02-06 17:39:38 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 17:39:38 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 96 registros
2026-02-06 17:39:38 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 17:39:38 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 17:39:38 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 17:39:38 - INFO -   Articulos: 96
2026-02-06 17:39:38 - INFO -   Importe: 6990.51€
2026-02-06 17:39:38 - INFO - 
==================================================
2026-02-06 17:39:38 - INFO - SECCION: UTILES_JARDIN
2026-02-06 17:39:38 - INFO - ==================================================
2026-02-06 17:39:38 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 17:39:38 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:39:38 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 17:39:38 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 17:39:38 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 17:39:38 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:39:38 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 17:39:38 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 17:39:38 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:39:38 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:39:38 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:39:42 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:42 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:39:42 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:39:42 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:39:42 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:39:42 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:39:42 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 17:39:42 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:39:42 - DEBUG -   maf: 10970 registros
2026-02-06 17:39:42 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:39:42 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:39:42 - DEBUG -   interior: 3624 registros
2026-02-06 17:39:42 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:39:42 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:39:42 - DEBUG -   vivero: 2460 registros
2026-02-06 17:39:42 - DEBUG -   fitos: 1987 registros
2026-02-06 17:39:42 - DEBUG -   semillas: 1180 registros
2026-02-06 17:39:42 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:39:42 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:39:42 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 17:39:42 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 17:39:42 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:39:42 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:44 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:45 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:45 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:45 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:45 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:45 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 17:39:45 - INFO -   ABC: 433 registros
2026-02-06 17:39:45 - INFO -   Ventas: 1009 registros
2026-02-06 17:39:45 - INFO -   Costes: 22145 registros
2026-02-06 17:39:45 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 17:39:45 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 17:39:45 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:45 - INFO - Datos de ventas: 89 registros
2026-02-06 17:39:45 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 17:39:45 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 17:39:45 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:45 - INFO -   Factor total: 1.3125
2026-02-06 17:39:45 - INFO -   Factor escalado: 1.6747
2026-02-06 17:39:45 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 17:39:45 - INFO -   Objetivo final: 1371.26€
2026-02-06 17:39:45 - INFO -   Delta: 558.30€
2026-02-06 17:39:45 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:45 - DEBUG -   Total registros: 78
2026-02-06 17:39:45 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 17:39:45 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 17:39:45 - INFO -   Ventas finales: 1390.00€
2026-02-06 17:39:45 - INFO - 
============================================================
2026-02-06 17:39:45 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:45 - INFO - ============================================================
2026-02-06 17:39:45 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:45 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:45 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:45 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:45 - INFO - ============================================================
2026-02-06 17:39:45 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:45 - INFO - ============================================================
2026-02-06 17:39:45 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:45 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:45 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:45 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:45 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:45 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:45 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:45 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:45 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:45 - INFO -   Stock: 30 registros
2026-02-06 17:39:45 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:45 - INFO - Fusión completada: 78 registros
2026-02-06 17:39:45 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:45 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:45 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:45 - INFO - 
============================================================
2026-02-06 17:39:45 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:45 - INFO - ============================================================
2026-02-06 17:39:45 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:45 - INFO - Corrección completada:
2026-02-06 17:39:45 - INFO -   - Artículos corregidos: 78/78
2026-02-06 17:39:45 - INFO -   - Artículos aumentados: 78
2026-02-06 17:39:45 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:45 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:45 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:45 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:45 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 17:39:45 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:45 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:45 - DEBUG -   Con valor 0: 0
2026-02-06 17:39:45 - DEBUG -   Con valor > 0: 78
2026-02-06 17:39:45 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 17:39:45 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 78 registros
2026-02-06 17:39:45 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 17:39:45 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 17:39:45 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 17:39:45 - INFO -   Articulos: 78
2026-02-06 17:39:45 - INFO -   Importe: 1390.00€
2026-02-06 17:39:45 - INFO - 
==================================================
2026-02-06 17:39:45 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 17:39:45 - INFO - ==================================================
2026-02-06 17:39:45 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 17:39:45 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:39:45 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 17:39:45 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 17:39:45 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 17:39:45 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:39:45 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 17:39:45 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 17:39:45 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:39:45 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:39:45 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:39:49 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:49 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:39:49 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:39:49 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:39:49 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:39:49 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:39:49 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 17:39:49 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:39:49 - DEBUG -   maf: 10970 registros
2026-02-06 17:39:49 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:39:49 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:39:49 - DEBUG -   interior: 3624 registros
2026-02-06 17:39:49 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:39:49 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:39:49 - DEBUG -   vivero: 2460 registros
2026-02-06 17:39:49 - DEBUG -   fitos: 1987 registros
2026-02-06 17:39:49 - DEBUG -   semillas: 1180 registros
2026-02-06 17:39:49 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:39:49 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:39:49 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 17:39:49 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 17:39:49 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:39:49 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:51 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:51 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:51 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:51 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:51 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 17:39:51 - INFO -   ABC: 247 registros
2026-02-06 17:39:51 - INFO -   Ventas: 3264 registros
2026-02-06 17:39:51 - INFO -   Costes: 22145 registros
2026-02-06 17:39:51 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 17:39:51 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 17:39:51 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:51 - INFO - Datos de ventas: 302 registros
2026-02-06 17:39:51 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 17:39:51 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 17:39:51 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:51 - INFO -   Factor total: 1.3125
2026-02-06 17:39:51 - INFO -   Factor escalado: 1.3380
2026-02-06 17:39:51 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 17:39:51 - INFO -   Objetivo final: 5377.63€
2026-02-06 17:39:51 - INFO -   Delta: 432.03€
2026-02-06 17:39:51 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:51 - DEBUG -   Total registros: 72
2026-02-06 17:39:51 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 17:39:51 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 17:39:51 - INFO -   Ventas finales: 5387.14€
2026-02-06 17:39:51 - INFO - 
============================================================
2026-02-06 17:39:51 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:51 - INFO - ============================================================
2026-02-06 17:39:51 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:51 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:51 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:51 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:51 - INFO - ============================================================
2026-02-06 17:39:51 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:51 - INFO - ============================================================
2026-02-06 17:39:51 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:51 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:51 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:51 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:51 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:51 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:51 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:51 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:51 - INFO -   Stock: 30 registros
2026-02-06 17:39:51 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:51 - INFO - Fusión completada: 72 registros
2026-02-06 17:39:51 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:51 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:51 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:51 - INFO - 
============================================================
2026-02-06 17:39:51 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:51 - INFO - ============================================================
2026-02-06 17:39:51 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:51 - INFO - Corrección completada:
2026-02-06 17:39:51 - INFO -   - Artículos corregidos: 71/72
2026-02-06 17:39:51 - INFO -   - Artículos aumentados: 71
2026-02-06 17:39:51 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:51 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:51 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:51 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:51 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 17:39:51 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:51 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:51 - DEBUG -   Con valor 0: 1
2026-02-06 17:39:51 - DEBUG -   Con valor > 0: 71
2026-02-06 17:39:51 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 17:39:51 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 71 registros
2026-02-06 17:39:51 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 17:39:51 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 17:39:51 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 17:39:51 - INFO -   Articulos: 71
2026-02-06 17:39:51 - INFO -   Importe: 5387.14€
2026-02-06 17:39:51 - INFO - 
==================================================
2026-02-06 17:39:51 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 17:39:51 - INFO - ==================================================
2026-02-06 17:39:51 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 17:39:51 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 17:39:51 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 17:39:51 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 17:39:51 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 17:39:52 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 17:39:52 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 17:39:52 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 17:39:52 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 17:39:52 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 17:39:52 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 17:39:56 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:56 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 17:39:56 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 17:39:56 - INFO - Ventas cargadas: 44082 registros
2026-02-06 17:39:56 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 17:39:56 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 17:39:56 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 17:39:56 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 17:39:56 - DEBUG -   maf: 10970 registros
2026-02-06 17:39:56 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 17:39:56 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 17:39:56 - DEBUG -   interior: 3624 registros
2026-02-06 17:39:56 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 17:39:56 - DEBUG -   deco_interior: 2468 registros
2026-02-06 17:39:56 - DEBUG -   vivero: 2460 registros
2026-02-06 17:39:56 - DEBUG -   fitos: 1987 registros
2026-02-06 17:39:56 - DEBUG -   semillas: 1180 registros
2026-02-06 17:39:56 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 17:39:56 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 17:39:56 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 17:39:56 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 17:39:56 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 17:39:56 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 17:39:58 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:58 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 17:39:58 - INFO - Costes cargados: 22145 registros
2026-02-06 17:39:58 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 17:39:58 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 17:39:58 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 17:39:58 - INFO -   ABC: 995 registros
2026-02-06 17:39:58 - INFO -   Ventas: 4018 registros
2026-02-06 17:39:58 - INFO -   Costes: 22145 registros
2026-02-06 17:39:58 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 17:39:58 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 17:39:58 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 17:39:58 - INFO - Datos de ventas: 316 registros
2026-02-06 17:39:58 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 17:39:58 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 17:39:58 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 17:39:58 - INFO -   Factor total: 1.3125
2026-02-06 17:39:58 - INFO -   Factor escalado: 1.1960
2026-02-06 17:39:58 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 17:39:58 - INFO -   Objetivo final: 4909.20€
2026-02-06 17:39:58 - INFO -   Delta: 1185.39€
2026-02-06 17:39:58 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 17:39:58 - DEBUG -   Total registros: 224
2026-02-06 17:39:58 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 17:39:58 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 17:39:58 - INFO -   Ventas finales: 4923.89€
2026-02-06 17:39:58 - INFO - 
============================================================
2026-02-06 17:39:58 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 17:39:58 - INFO - ============================================================
2026-02-06 17:39:58 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 17:39:58 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 17:39:58 - INFO - DataLoader inicializado correctamente
2026-02-06 17:39:58 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 17:39:58 - INFO - ============================================================
2026-02-06 17:39:58 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 17:39:58 - INFO - ============================================================
2026-02-06 17:39:58 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 17:39:58 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 17:39:58 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:58 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:58 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 17:39:58 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 17:39:58 - DEBUG - Usando hoja: Stock
2026-02-06 17:39:58 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 17:39:58 - INFO - Stock actual cargado: 30 registros
2026-02-06 17:39:58 - INFO -   Stock: 30 registros
2026-02-06 17:39:58 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 17:39:58 - INFO - Fusión completada: 224 registros
2026-02-06 17:39:58 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 17:39:58 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 17:39:58 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 17:39:58 - INFO - 
============================================================
2026-02-06 17:39:58 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 17:39:58 - INFO - ============================================================
2026-02-06 17:39:58 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 17:39:58 - INFO - Corrección completada:
2026-02-06 17:39:58 - INFO -   - Artículos corregidos: 205/224
2026-02-06 17:39:58 - INFO -   - Artículos aumentados: 205
2026-02-06 17:39:58 - INFO -   - Artículos reducidos: 0
2026-02-06 17:39:58 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 17:39:58 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 17:39:58 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 17:39:58 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 17:39:58 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock']
2026-02-06 17:39:58 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 17:39:58 - DEBUG -   Con valor 0: 19
2026-02-06 17:39:58 - DEBUG -   Con valor > 0: 205
2026-02-06 17:39:58 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 17:39:58 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 205 registros
2026-02-06 17:39:58 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 17:39:59 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 17:39:59 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 17:39:59 - INFO -   Articulos: 205
2026-02-06 17:39:59 - INFO -   Importe: 4923.89€
2026-02-06 17:39:59 - INFO - Estado guardado correctamente
2026-02-06 17:39:59 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 17:39:59 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 17:39:59 - INFO - Estado guardado correctamente
2026-02-06 17:39:59 - INFO - 
============================================================
2026-02-06 17:39:59 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 17:39:59 - INFO - ============================================================
2026-02-06 17:39:59 - DEBUG - [DEBUG] Archivos agrupados por sección: {'maf': ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx'], 'interior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx'], 'semillas': ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx'], 'vivo': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx'], 'manufacturado': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx'], 'fitos': ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx'], 'vivero': ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx'], 'jardin': ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx'], 'aridos': ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx'], 'exterior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']}
2026-02-06 17:39:59 - INFO - 
============================================================
2026-02-06 17:39:59 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 17:39:59 - INFO - ============================================================
2026-02-06 17:39:59 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 17:39:59 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 17:39:59 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 17:39:59 - INFO - EmailService inicializado correctamente
2026-02-06 17:39:59 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 17:39:59 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 17:39:59 - INFO - 
Enviando email para sección: maf
2026-02-06 17:39:59 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx']
2026-02-06 17:39:59 - DEBUG - Destinatarios para maf: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 17:39:59 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 17:39:59 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 17:39:59 - INFO - Email enviado para sección maf (semana 14)
2026-02-06 17:39:59 - ERROR - ✗ Error al enviar email a maf: None
2026-02-06 17:39:59 - INFO - 
Enviando email para sección: interior
2026-02-06 17:39:59 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx']
2026-02-06 17:39:59 - DEBUG - Destinatarios para interior: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Iris'}]
2026-02-06 17:39:59 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 17:39:59 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 17:39:59 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 17:39:59 - INFO - Email enviado para sección interior (semana 14)
2026-02-06 17:39:59 - ERROR - ✗ Error al enviar email a interior: None
2026-02-06 17:39:59 - INFO - 
Enviando email para sección: semillas
2026-02-06 17:39:59 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx']
2026-02-06 17:39:59 - DEBUG - Destinatarios para semillas: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 17:39:59 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 17:40:00 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 17:40:00 - INFO - Email enviado para sección semillas (semana 14)
2026-02-06 17:40:00 - ERROR - ✗ Error al enviar email a semillas: None
2026-02-06 17:40:00 - INFO - 
Enviando email para sección: vivo
2026-02-06 17:40:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx']
2026-02-06 17:40:00 - WARNING - No hay destinatarios configurados para la sección: vivo
2026-02-06 17:40:00 - WARNING - No se puede enviar email para vivo: No hay destinatarios configurados
2026-02-06 17:40:00 - ERROR - ✗ Error al enviar email a vivo: No hay destinatarios configurados
2026-02-06 17:40:00 - INFO - 
Enviando email para sección: manufacturado
2026-02-06 17:40:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx']
2026-02-06 17:40:00 - WARNING - No hay destinatarios configurados para la sección: manufacturado
2026-02-06 17:40:00 - WARNING - No se puede enviar email para manufacturado: No hay destinatarios configurados
2026-02-06 17:40:00 - ERROR - ✗ Error al enviar email a manufacturado: No hay destinatarios configurados
2026-02-06 17:40:00 - INFO - 
Enviando email para sección: fitos
2026-02-06 17:40:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx']
2026-02-06 17:40:00 - DEBUG - Destinatarios para fitos: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 17:40:00 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 17:40:00 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 17:40:00 - INFO - Email enviado para sección fitos (semana 14)
2026-02-06 17:40:00 - ERROR - ✗ Error al enviar email a fitos: None
2026-02-06 17:40:00 - INFO - 
Enviando email para sección: vivero
2026-02-06 17:40:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx']
2026-02-06 17:40:00 - DEBUG - Destinatarios para vivero: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 17:40:00 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 17:40:00 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 17:40:00 - INFO - Email enviado para sección vivero (semana 14)
2026-02-06 17:40:00 - ERROR - ✗ Error al enviar email a vivero: None
2026-02-06 17:40:00 - INFO - 
Enviando email para sección: jardin
2026-02-06 17:40:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx']
2026-02-06 17:40:00 - WARNING - No hay destinatarios configurados para la sección: jardin
2026-02-06 17:40:00 - WARNING - No se puede enviar email para jardin: No hay destinatarios configurados
2026-02-06 17:40:00 - ERROR - ✗ Error al enviar email a jardin: No hay destinatarios configurados
2026-02-06 17:40:00 - INFO - 
Enviando email para sección: aridos
2026-02-06 17:40:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx']
2026-02-06 17:40:00 - WARNING - No hay destinatarios configurados para la sección: aridos
2026-02-06 17:40:00 - WARNING - No se puede enviar email para aridos: No hay destinatarios configurados
2026-02-06 17:40:00 - ERROR - ✗ Error al enviar email a aridos: No hay destinatarios configurados
2026-02-06 17:40:00 - INFO - 
Enviando email para sección: exterior
2026-02-06 17:40:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']
2026-02-06 17:40:00 - WARNING - No hay destinatarios configurados para la sección: exterior
2026-02-06 17:40:00 - WARNING - No se puede enviar email para exterior: No hay destinatarios configurados
2026-02-06 17:40:00 - ERROR - ✗ Error al enviar email a exterior: No hay destinatarios configurados
2026-02-06 17:40:00 - INFO - 
============================================================
2026-02-06 17:40:00 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 17:40:00 - INFO - ============================================================
2026-02-06 17:40:00 - INFO - Emails enviados exitosamente: 0
2026-02-06 17:40:00 - INFO - Emails fallidos: 10
2026-02-06 17:40:00 - INFO - Secciones procesadas: 10
2026-02-06 17:40:00 - INFO - 
============================================================
2026-02-06 17:40:00 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 17:40:00 - INFO - ============================================================
2026-02-06 17:40:00 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 17:40:00 - INFO - 
============================================================
2026-02-06 17:40:00 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 17:40:00 - INFO - ============================================================
2026-02-06 17:40:00 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 17:40:01 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 17:40:01 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 17:40:01 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 17:40:01 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 17:40:01 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 17:40:01 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 17:40:01 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 17:40:01 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 17:40:01 - INFO - 
============================================================
2026-02-06 17:40:01 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 17:40:01 - INFO - ============================================================
2026-02-06 17:40:01 - INFO - Emails enviados: 3
2026-02-06 17:40:01 - INFO - Emails fallidos: 0
2026-02-06 17:40:01 - INFO - 
======================================================================
2026-02-06 17:40:01 - INFO - RESUMEN DE EJECUCION
2026-02-06 17:40:01 - INFO - ======================================================================
2026-02-06 17:40:01 - INFO - Semana procesada: 14
2026-02-06 17:40:01 - INFO - Archivos generados: 12
2026-02-06 17:40:01 - INFO - Total articulos: 1510
2026-02-06 17:40:01 - INFO - Total importe: 48115.81€
2026-02-06 17:40:01 - WARNING - 
✗ EMAILS FALLIDOS: 10
2026-02-06 17:40:01 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 17:40:01 - INFO - ======================================================================
2026-02-06 17:40:01 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 17:40:01 - INFO - Archivo principal: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 17:40:01 - INFO - Artículos: 1510
2026-02-06 17:40:01 - INFO - Importe: 48115.81€
2026-02-06 17:40:01 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 18:51:05 - INFO - ======================================================================
2026-02-06 18:51:05 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 18:51:05 - INFO - Fecha de ejecución: 2026-02-06 18:51:05
2026-02-06 18:51:05 - INFO - ======================================================================
2026-02-06 18:51:05 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 18:51:05 - INFO - Envío de emails: Sí
2026-02-06 18:51:05 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 18:51:05 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 18:51:05 - INFO - Estado cargado correctamente
2026-02-06 18:51:05 - INFO - SchedulerService inicializado correctamente
2026-02-06 18:51:05 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 18:51:05 - INFO - Semana forzada por argumento: 14
2026-02-06 18:51:05 - INFO - ======================================================================
2026-02-06 18:51:05 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 18:51:05 - INFO - ======================================================================
2026-02-06 18:51:05 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 18:51:05 - INFO - DataLoader inicializado correctamente
2026-02-06 18:51:05 - INFO - ForecastEngine inicializado correctamente
2026-02-06 18:51:05 - INFO - OrderGenerator inicializado correctamente
2026-02-06 18:51:05 - INFO - SchedulerService inicializado correctamente
2026-02-06 18:51:05 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 18:51:05 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 18:51:05 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 18:51:05 - INFO - 
==================================================
2026-02-06 18:51:05 - INFO - SECCION: MAF
2026-02-06 18:51:05 - INFO - ==================================================
2026-02-06 18:51:05 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 18:51:05 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:51:05 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 18:51:05 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 18:51:05 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 18:51:06 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:51:06 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 18:51:06 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 18:51:06 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:51:06 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:51:06 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:51:09 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:09 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:51:10 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:51:10 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:51:10 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:51:10 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:51:10 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 18:51:10 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:51:10 - DEBUG -   maf: 10970 registros
2026-02-06 18:51:10 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:51:10 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:51:10 - DEBUG -   interior: 3624 registros
2026-02-06 18:51:10 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:51:10 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:51:10 - DEBUG -   vivero: 2460 registros
2026-02-06 18:51:10 - DEBUG -   fitos: 1987 registros
2026-02-06 18:51:10 - DEBUG -   semillas: 1180 registros
2026-02-06 18:51:10 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:51:10 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:51:10 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 18:51:10 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 18:51:10 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:51:10 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:51:12 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:12 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:51:12 - INFO - Costes cargados: 22145 registros
2026-02-06 18:51:12 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:51:12 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:51:12 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 18:51:12 - INFO -   ABC: 499 registros
2026-02-06 18:51:12 - INFO -   Ventas: 10970 registros
2026-02-06 18:51:12 - INFO -   Costes: 22145 registros
2026-02-06 18:51:12 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 18:51:12 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 18:51:12 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:51:12 - INFO - Datos de ventas: 1011 registros
2026-02-06 18:51:12 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 18:51:12 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 18:51:12 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:51:12 - INFO -   Factor total: 1.3125
2026-02-06 18:51:12 - INFO -   Factor escalado: 1.5844
2026-02-06 18:51:12 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 18:51:12 - INFO -   Objetivo final: 9253.98€
2026-02-06 18:51:12 - INFO -   Delta: 679.77€
2026-02-06 18:51:12 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:51:12 - DEBUG -   Total registros: 222
2026-02-06 18:51:12 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 18:51:12 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 18:51:12 - INFO -   Ventas finales: 9254.53€
2026-02-06 18:51:12 - INFO - 
============================================================
2026-02-06 18:51:12 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:51:12 - INFO - ============================================================
2026-02-06 18:51:12 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:51:12 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:51:12 - INFO - DataLoader inicializado correctamente
2026-02-06 18:51:12 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:51:12 - INFO - ============================================================
2026-02-06 18:51:12 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:51:12 - INFO - ============================================================
2026-02-06 18:51:12 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:51:12 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:51:12 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:12 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:12 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:12 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:12 - DEBUG - Usando hoja: Stock
2026-02-06 18:51:12 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:51:12 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:51:12 - INFO -   Stock: 30 registros
2026-02-06 18:51:12 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:51:12 - INFO - Fusión completada: 222 registros
2026-02-06 18:51:12 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:51:12 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:51:12 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:51:12 - INFO - 
============================================================
2026-02-06 18:51:12 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:51:12 - INFO - ============================================================
2026-02-06 18:51:12 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:51:12 - INFO - Corrección completada:
2026-02-06 18:51:12 - INFO -   - Artículos corregidos: 191/222
2026-02-06 18:51:12 - INFO -   - Artículos aumentados: 191
2026-02-06 18:51:12 - INFO -   - Artículos reducidos: 0
2026-02-06 18:51:12 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:51:12 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:51:12 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:51:12 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 18:51:12 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:51:12 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:51:12 - DEBUG -   Con valor 0: 31
2026-02-06 18:51:12 - DEBUG -   Con valor > 0: 191
2026-02-06 18:51:12 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 18:51:12 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 191 registros
2026-02-06 18:51:12 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 18:51:13 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 18:51:13 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 18:51:13 - INFO -   Articulos: 191
2026-02-06 18:51:13 - INFO -   Importe: 9254.53€
2026-02-06 18:51:13 - INFO - 
==================================================
2026-02-06 18:51:13 - INFO - SECCION: DECO_INTERIOR
2026-02-06 18:51:13 - INFO - ==================================================
2026-02-06 18:51:13 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 18:51:13 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:51:13 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 18:51:13 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 18:51:13 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 18:51:13 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:51:13 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 18:51:13 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 18:51:13 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:51:13 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:51:13 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:51:17 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:17 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:51:17 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:51:17 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:51:17 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:51:17 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:51:17 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 18:51:18 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:51:18 - DEBUG -   maf: 10970 registros
2026-02-06 18:51:18 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:51:18 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:51:18 - DEBUG -   interior: 3624 registros
2026-02-06 18:51:18 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:51:18 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:51:18 - DEBUG -   vivero: 2460 registros
2026-02-06 18:51:18 - DEBUG -   fitos: 1987 registros
2026-02-06 18:51:18 - DEBUG -   semillas: 1180 registros
2026-02-06 18:51:18 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:51:18 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:51:18 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 18:51:18 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 18:51:18 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:51:18 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:51:20 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:20 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:51:20 - INFO - Costes cargados: 22145 registros
2026-02-06 18:51:20 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:51:20 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:51:20 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 18:51:20 - INFO -   ABC: 1827 registros
2026-02-06 18:51:20 - INFO -   Ventas: 2468 registros
2026-02-06 18:51:20 - INFO -   Costes: 22145 registros
2026-02-06 18:51:20 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 18:51:20 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 18:51:20 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:51:20 - INFO - Datos de ventas: 180 registros
2026-02-06 18:51:20 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 18:51:20 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 18:51:20 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:51:20 - INFO -   Factor total: 1.3125
2026-02-06 18:51:20 - INFO -   Factor escalado: 1.5747
2026-02-06 18:51:20 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 18:51:20 - INFO -   Objetivo final: 2576.42€
2026-02-06 18:51:20 - INFO -   Delta: 373.59€
2026-02-06 18:51:20 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:51:20 - DEBUG -   Total registros: 139
2026-02-06 18:51:20 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 18:51:20 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 18:51:20 - INFO -   Ventas finales: 2580.73€
2026-02-06 18:51:20 - INFO - 
============================================================
2026-02-06 18:51:20 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:51:20 - INFO - ============================================================
2026-02-06 18:51:20 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:51:20 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:51:20 - INFO - DataLoader inicializado correctamente
2026-02-06 18:51:20 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:51:20 - INFO - ============================================================
2026-02-06 18:51:20 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:51:20 - INFO - ============================================================
2026-02-06 18:51:20 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:51:20 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:51:20 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:20 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:20 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:20 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:20 - DEBUG - Usando hoja: Stock
2026-02-06 18:51:20 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:51:20 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:51:20 - INFO -   Stock: 30 registros
2026-02-06 18:51:20 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:51:20 - INFO - Fusión completada: 139 registros
2026-02-06 18:51:20 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:51:20 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:51:20 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:51:20 - INFO - 
============================================================
2026-02-06 18:51:20 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:51:20 - INFO - ============================================================
2026-02-06 18:51:20 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:51:20 - INFO - Corrección completada:
2026-02-06 18:51:20 - INFO -   - Artículos corregidos: 135/139
2026-02-06 18:51:20 - INFO -   - Artículos aumentados: 135
2026-02-06 18:51:20 - INFO -   - Artículos reducidos: 0
2026-02-06 18:51:20 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:51:20 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:51:20 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:51:20 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 18:51:20 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:51:20 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:51:20 - DEBUG -   Con valor 0: 4
2026-02-06 18:51:20 - DEBUG -   Con valor > 0: 135
2026-02-06 18:51:20 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 18:51:20 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 135 registros
2026-02-06 18:51:20 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 18:51:20 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 18:51:20 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 18:51:20 - INFO -   Articulos: 135
2026-02-06 18:51:20 - INFO -   Importe: 2580.73€
2026-02-06 18:51:20 - INFO - 
==================================================
2026-02-06 18:51:20 - INFO - SECCION: SEMILLAS
2026-02-06 18:51:20 - INFO - ==================================================
2026-02-06 18:51:20 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 18:51:20 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:51:20 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 18:51:20 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 18:51:20 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 18:51:20 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:51:20 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 18:51:20 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 18:51:20 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:51:20 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:51:20 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:51:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:24 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:51:24 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:51:24 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:51:24 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:51:24 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:51:24 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 18:51:24 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:51:24 - DEBUG -   maf: 10970 registros
2026-02-06 18:51:24 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:51:24 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:51:24 - DEBUG -   interior: 3624 registros
2026-02-06 18:51:24 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:51:24 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:51:24 - DEBUG -   vivero: 2460 registros
2026-02-06 18:51:24 - DEBUG -   fitos: 1987 registros
2026-02-06 18:51:24 - DEBUG -   semillas: 1180 registros
2026-02-06 18:51:24 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:51:24 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:51:24 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 18:51:24 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 18:51:24 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:51:24 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:51:26 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:26 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:51:26 - INFO - Costes cargados: 22145 registros
2026-02-06 18:51:26 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:51:26 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:51:26 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 18:51:26 - INFO -   ABC: 218 registros
2026-02-06 18:51:26 - INFO -   Ventas: 1180 registros
2026-02-06 18:51:26 - INFO -   Costes: 22145 registros
2026-02-06 18:51:26 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 18:51:26 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 18:51:26 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:51:26 - INFO - Datos de ventas: 136 registros
2026-02-06 18:51:26 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 18:51:27 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 18:51:27 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:51:27 - INFO -   Factor total: 1.3125
2026-02-06 18:51:27 - INFO -   Factor escalado: 2.0023
2026-02-06 18:51:27 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 18:51:27 - INFO -   Objetivo final: 911.32€
2026-02-06 18:51:27 - INFO -   Delta: 217.83€
2026-02-06 18:51:27 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:51:27 - DEBUG -   Total registros: 84
2026-02-06 18:51:27 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 18:51:27 - DEBUG -   Ventas finales: 911.60€
2026-02-06 18:51:27 - INFO -   Ventas finales: 911.60€
2026-02-06 18:51:27 - INFO - 
============================================================
2026-02-06 18:51:27 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:51:27 - INFO - ============================================================
2026-02-06 18:51:27 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:51:27 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:51:27 - INFO - DataLoader inicializado correctamente
2026-02-06 18:51:27 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:51:27 - INFO - ============================================================
2026-02-06 18:51:27 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:51:27 - INFO - ============================================================
2026-02-06 18:51:27 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:51:27 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:51:27 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:27 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:27 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:27 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:27 - DEBUG - Usando hoja: Stock
2026-02-06 18:51:27 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:51:27 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:51:27 - INFO -   Stock: 30 registros
2026-02-06 18:51:27 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:51:27 - INFO - Fusión completada: 84 registros
2026-02-06 18:51:27 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:51:27 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:51:27 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:51:27 - INFO - 
============================================================
2026-02-06 18:51:27 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:51:27 - INFO - ============================================================
2026-02-06 18:51:27 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:51:27 - INFO - Corrección completada:
2026-02-06 18:51:27 - INFO -   - Artículos corregidos: 84/84
2026-02-06 18:51:27 - INFO -   - Artículos aumentados: 84
2026-02-06 18:51:27 - INFO -   - Artículos reducidos: 0
2026-02-06 18:51:27 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:51:27 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:51:27 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:51:27 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 18:51:27 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:51:27 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:51:27 - DEBUG -   Con valor 0: 0
2026-02-06 18:51:27 - DEBUG -   Con valor > 0: 84
2026-02-06 18:51:27 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 18:51:27 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 84 registros
2026-02-06 18:51:27 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 18:51:27 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 18:51:27 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 18:51:27 - INFO -   Articulos: 84
2026-02-06 18:51:27 - INFO -   Importe: 911.60€
2026-02-06 18:51:27 - INFO - 
==================================================
2026-02-06 18:51:27 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 18:51:27 - INFO - ==================================================
2026-02-06 18:51:27 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 18:51:27 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:51:27 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 18:51:27 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 18:51:27 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 18:51:27 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:51:27 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 18:51:27 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 18:51:27 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:51:27 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:51:27 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:51:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:31 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:51:31 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:51:31 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:51:31 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:51:31 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:51:31 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 18:51:31 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:51:31 - DEBUG -   maf: 10970 registros
2026-02-06 18:51:31 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:51:31 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:51:31 - DEBUG -   interior: 3624 registros
2026-02-06 18:51:31 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:51:31 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:51:31 - DEBUG -   vivero: 2460 registros
2026-02-06 18:51:31 - DEBUG -   fitos: 1987 registros
2026-02-06 18:51:31 - DEBUG -   semillas: 1180 registros
2026-02-06 18:51:31 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:51:31 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:51:31 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 18:51:31 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 18:51:31 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:51:31 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:51:33 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:33 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:51:33 - INFO - Costes cargados: 22145 registros
2026-02-06 18:51:33 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:51:33 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:51:33 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 18:51:33 - INFO -   ABC: 205 registros
2026-02-06 18:51:33 - INFO -   Ventas: 1124 registros
2026-02-06 18:51:33 - INFO -   Costes: 22145 registros
2026-02-06 18:51:33 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 18:51:33 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 18:51:33 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:51:33 - INFO - Datos de ventas: 88 registros
2026-02-06 18:51:33 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 18:51:33 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 18:51:33 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:51:33 - INFO -   Factor total: 1.3125
2026-02-06 18:51:33 - INFO -   Factor escalado: 1.6854
2026-02-06 18:51:33 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 18:51:33 - INFO -   Objetivo final: 1426.88€
2026-02-06 18:51:33 - INFO -   Delta: 346.78€
2026-02-06 18:51:33 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:51:33 - DEBUG -   Total registros: 43
2026-02-06 18:51:33 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 18:51:33 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 18:51:33 - INFO -   Ventas finales: 1455.34€
2026-02-06 18:51:33 - INFO - 
============================================================
2026-02-06 18:51:33 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:51:33 - INFO - ============================================================
2026-02-06 18:51:33 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:51:33 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:51:33 - INFO - DataLoader inicializado correctamente
2026-02-06 18:51:33 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:51:33 - INFO - ============================================================
2026-02-06 18:51:33 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:51:33 - INFO - ============================================================
2026-02-06 18:51:33 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:51:33 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:51:33 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:33 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:33 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:33 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:33 - DEBUG - Usando hoja: Stock
2026-02-06 18:51:33 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:51:33 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:51:33 - INFO -   Stock: 30 registros
2026-02-06 18:51:33 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:51:33 - INFO - Fusión completada: 43 registros
2026-02-06 18:51:33 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:51:33 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:51:33 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:51:33 - INFO - 
============================================================
2026-02-06 18:51:33 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:51:33 - INFO - ============================================================
2026-02-06 18:51:33 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:51:33 - INFO - Corrección completada:
2026-02-06 18:51:33 - INFO -   - Artículos corregidos: 36/43
2026-02-06 18:51:33 - INFO -   - Artículos aumentados: 36
2026-02-06 18:51:33 - INFO -   - Artículos reducidos: 0
2026-02-06 18:51:33 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:51:33 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:51:33 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:51:33 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 18:51:33 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:51:33 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:51:33 - DEBUG -   Con valor 0: 7
2026-02-06 18:51:33 - DEBUG -   Con valor > 0: 36
2026-02-06 18:51:33 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 18:51:33 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 36 registros
2026-02-06 18:51:33 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 18:51:33 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 18:51:33 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 18:51:33 - INFO -   Articulos: 36
2026-02-06 18:51:33 - INFO -   Importe: 1455.34€
2026-02-06 18:51:33 - INFO - 
==================================================
2026-02-06 18:51:33 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 18:51:33 - INFO - ==================================================
2026-02-06 18:51:33 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 18:51:33 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:51:33 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 18:51:33 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 18:51:33 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 18:51:34 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:51:34 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 18:51:34 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 18:51:34 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:51:34 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:51:34 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:51:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:38 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:51:38 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:51:38 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:51:38 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:51:38 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:51:38 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 18:51:38 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:51:38 - DEBUG -   maf: 10970 registros
2026-02-06 18:51:38 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:51:38 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:51:38 - DEBUG -   interior: 3624 registros
2026-02-06 18:51:38 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:51:38 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:51:38 - DEBUG -   vivero: 2460 registros
2026-02-06 18:51:38 - DEBUG -   fitos: 1987 registros
2026-02-06 18:51:38 - DEBUG -   semillas: 1180 registros
2026-02-06 18:51:38 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:51:38 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:51:38 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 18:51:38 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 18:51:38 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:51:38 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:51:40 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:40 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:51:40 - INFO - Costes cargados: 22145 registros
2026-02-06 18:51:40 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:51:40 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:51:40 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 18:51:40 - INFO -   ABC: 2749 registros
2026-02-06 18:51:40 - INFO -   Ventas: 9784 registros
2026-02-06 18:51:40 - INFO -   Costes: 22145 registros
2026-02-06 18:51:40 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 18:51:40 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 18:51:40 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:51:40 - INFO - Datos de ventas: 822 registros
2026-02-06 18:51:40 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 18:51:42 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 18:51:42 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:51:42 - INFO -   Factor total: 1.3125
2026-02-06 18:51:42 - INFO -   Factor escalado: 1.0268
2026-02-06 18:51:42 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 18:51:42 - INFO -   Objetivo final: 8977.26€
2026-02-06 18:51:42 - INFO -   Delta: 3401.99€
2026-02-06 18:51:42 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:51:42 - DEBUG -   Total registros: 538
2026-02-06 18:51:42 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 18:51:42 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 18:51:42 - INFO -   Ventas finales: 8993.98€
2026-02-06 18:51:42 - INFO - 
============================================================
2026-02-06 18:51:42 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:51:42 - INFO - ============================================================
2026-02-06 18:51:42 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:51:42 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:51:42 - INFO - DataLoader inicializado correctamente
2026-02-06 18:51:42 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:51:42 - INFO - ============================================================
2026-02-06 18:51:42 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:51:42 - INFO - ============================================================
2026-02-06 18:51:42 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:51:42 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:51:42 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:42 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:42 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:42 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:42 - DEBUG - Usando hoja: Stock
2026-02-06 18:51:42 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:51:42 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:51:42 - INFO -   Stock: 30 registros
2026-02-06 18:51:42 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:51:42 - INFO - Fusión completada: 538 registros
2026-02-06 18:51:42 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:51:42 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:51:42 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:51:42 - INFO - 
============================================================
2026-02-06 18:51:42 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:51:42 - INFO - ============================================================
2026-02-06 18:51:42 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:51:42 - INFO - Corrección completada:
2026-02-06 18:51:42 - INFO -   - Artículos corregidos: 411/538
2026-02-06 18:51:42 - INFO -   - Artículos aumentados: 411
2026-02-06 18:51:42 - INFO -   - Artículos reducidos: 0
2026-02-06 18:51:42 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:51:42 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:51:42 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:51:42 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 18:51:42 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:51:42 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:51:42 - DEBUG -   Con valor 0: 127
2026-02-06 18:51:42 - DEBUG -   Con valor > 0: 411
2026-02-06 18:51:42 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 18:51:42 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 411 registros
2026-02-06 18:51:42 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 18:51:42 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 18:51:42 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 18:51:42 - INFO -   Articulos: 411
2026-02-06 18:51:42 - INFO -   Importe: 8993.98€
2026-02-06 18:51:42 - INFO - 
==================================================
2026-02-06 18:51:42 - INFO - SECCION: INTERIOR
2026-02-06 18:51:42 - INFO - ==================================================
2026-02-06 18:51:42 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 18:51:42 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:51:42 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 18:51:42 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 18:51:42 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 18:51:43 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:51:43 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 18:51:43 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 18:51:43 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:51:43 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:51:43 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:51:46 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:46 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:51:46 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:51:46 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:51:46 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:51:46 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:51:46 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 18:51:46 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:51:46 - DEBUG -   maf: 10970 registros
2026-02-06 18:51:46 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:51:46 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:51:46 - DEBUG -   interior: 3624 registros
2026-02-06 18:51:46 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:51:46 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:51:46 - DEBUG -   vivero: 2460 registros
2026-02-06 18:51:46 - DEBUG -   fitos: 1987 registros
2026-02-06 18:51:46 - DEBUG -   semillas: 1180 registros
2026-02-06 18:51:46 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:51:46 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:51:46 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 18:51:46 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 18:51:46 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:51:46 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:51:49 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:49 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:51:49 - INFO - Costes cargados: 22145 registros
2026-02-06 18:51:49 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:51:49 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:51:49 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 18:51:49 - INFO -   ABC: 555 registros
2026-02-06 18:51:49 - INFO -   Ventas: 3624 registros
2026-02-06 18:51:49 - INFO -   Costes: 22145 registros
2026-02-06 18:51:49 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 18:51:49 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 18:51:49 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:51:49 - INFO - Datos de ventas: 286 registros
2026-02-06 18:51:49 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 18:51:49 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 18:51:49 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:51:49 - INFO -   Factor total: 1.3125
2026-02-06 18:51:49 - INFO -   Factor escalado: 1.5971
2026-02-06 18:51:49 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 18:51:49 - INFO -   Objetivo final: 3846.45€
2026-02-06 18:51:49 - INFO -   Delta: 685.37€
2026-02-06 18:51:49 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:51:49 - DEBUG -   Total registros: 138
2026-02-06 18:51:49 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 18:51:49 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 18:51:49 - INFO -   Ventas finales: 3862.17€
2026-02-06 18:51:49 - INFO - 
============================================================
2026-02-06 18:51:49 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:51:49 - INFO - ============================================================
2026-02-06 18:51:49 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:51:49 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:51:49 - INFO - DataLoader inicializado correctamente
2026-02-06 18:51:49 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:51:49 - INFO - ============================================================
2026-02-06 18:51:49 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:51:49 - INFO - ============================================================
2026-02-06 18:51:49 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:51:49 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:51:49 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:49 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:49 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:49 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:49 - DEBUG - Usando hoja: Stock
2026-02-06 18:51:49 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:51:49 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:51:49 - INFO -   Stock: 30 registros
2026-02-06 18:51:49 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:51:49 - INFO - Fusión completada: 138 registros
2026-02-06 18:51:49 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:51:49 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:51:49 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:51:49 - INFO - 
============================================================
2026-02-06 18:51:49 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:51:49 - INFO - ============================================================
2026-02-06 18:51:49 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:51:49 - INFO - Corrección completada:
2026-02-06 18:51:49 - INFO -   - Artículos corregidos: 121/138
2026-02-06 18:51:49 - INFO -   - Artículos aumentados: 121
2026-02-06 18:51:49 - INFO -   - Artículos reducidos: 0
2026-02-06 18:51:49 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:51:49 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:51:49 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:51:49 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 18:51:49 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:51:49 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:51:49 - DEBUG -   Con valor 0: 17
2026-02-06 18:51:49 - DEBUG -   Con valor > 0: 121
2026-02-06 18:51:49 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 18:51:49 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 121 registros
2026-02-06 18:51:49 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 18:51:49 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 18:51:49 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 18:51:49 - INFO -   Articulos: 121
2026-02-06 18:51:49 - INFO -   Importe: 3862.17€
2026-02-06 18:51:49 - INFO - 
==================================================
2026-02-06 18:51:49 - INFO - SECCION: FITOS
2026-02-06 18:51:49 - INFO - ==================================================
2026-02-06 18:51:49 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 18:51:49 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:51:49 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 18:51:49 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 18:51:49 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 18:51:49 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:51:49 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 18:51:49 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 18:51:49 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:51:49 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:51:49 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:51:53 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:53 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:51:53 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:51:53 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:51:53 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:51:53 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:51:53 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 18:51:53 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:51:53 - DEBUG -   maf: 10970 registros
2026-02-06 18:51:53 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:51:53 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:51:53 - DEBUG -   interior: 3624 registros
2026-02-06 18:51:53 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:51:53 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:51:53 - DEBUG -   vivero: 2460 registros
2026-02-06 18:51:53 - DEBUG -   fitos: 1987 registros
2026-02-06 18:51:53 - DEBUG -   semillas: 1180 registros
2026-02-06 18:51:53 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:51:53 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:51:53 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 18:51:53 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 18:51:53 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:51:53 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:51:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:55 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:51:55 - INFO - Costes cargados: 22145 registros
2026-02-06 18:51:55 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:51:55 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:51:55 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 18:51:55 - INFO -   ABC: 247 registros
2026-02-06 18:51:55 - INFO -   Ventas: 1987 registros
2026-02-06 18:51:55 - INFO -   Costes: 22145 registros
2026-02-06 18:51:55 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 18:51:55 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 18:51:55 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:51:55 - INFO - Datos de ventas: 157 registros
2026-02-06 18:51:55 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 18:51:56 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 18:51:56 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:51:56 - INFO -   Factor total: 1.3125
2026-02-06 18:51:56 - INFO -   Factor escalado: 1.4055
2026-02-06 18:51:56 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 18:51:56 - INFO -   Objetivo final: 2360.20€
2026-02-06 18:51:56 - INFO -   Delta: 424.74€
2026-02-06 18:51:56 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:51:56 - DEBUG -   Total registros: 84
2026-02-06 18:51:56 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 18:51:56 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 18:51:56 - INFO -   Ventas finales: 2365.92€
2026-02-06 18:51:56 - INFO - 
============================================================
2026-02-06 18:51:56 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:51:56 - INFO - ============================================================
2026-02-06 18:51:56 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:51:56 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:51:56 - INFO - DataLoader inicializado correctamente
2026-02-06 18:51:56 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:51:56 - INFO - ============================================================
2026-02-06 18:51:56 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:51:56 - INFO - ============================================================
2026-02-06 18:51:56 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:51:56 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:51:56 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:56 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:56 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:51:56 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:51:56 - DEBUG - Usando hoja: Stock
2026-02-06 18:51:56 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:51:56 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:51:56 - INFO -   Stock: 30 registros
2026-02-06 18:51:56 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:51:56 - INFO - Fusión completada: 84 registros
2026-02-06 18:51:56 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:51:56 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:51:56 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:51:56 - INFO - 
============================================================
2026-02-06 18:51:56 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:51:56 - INFO - ============================================================
2026-02-06 18:51:56 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:51:56 - INFO - Corrección completada:
2026-02-06 18:51:56 - INFO -   - Artículos corregidos: 82/84
2026-02-06 18:51:56 - INFO -   - Artículos aumentados: 82
2026-02-06 18:51:56 - INFO -   - Artículos reducidos: 0
2026-02-06 18:51:56 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:51:56 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:51:56 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:51:56 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 18:51:56 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:51:56 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:51:56 - DEBUG -   Con valor 0: 2
2026-02-06 18:51:56 - DEBUG -   Con valor > 0: 82
2026-02-06 18:51:56 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 18:51:56 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 82 registros
2026-02-06 18:51:56 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 18:51:56 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 18:51:56 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 18:51:56 - INFO -   Articulos: 82
2026-02-06 18:51:56 - INFO -   Importe: 2365.92€
2026-02-06 18:51:56 - INFO - 
==================================================
2026-02-06 18:51:56 - INFO - SECCION: VIVERO
2026-02-06 18:51:56 - INFO - ==================================================
2026-02-06 18:51:56 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 18:51:56 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:51:56 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 18:51:56 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 18:51:56 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 18:51:56 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:51:56 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 18:51:56 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 18:51:56 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:51:56 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:51:56 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:52:00 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:00 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:52:00 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:52:00 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:52:00 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:52:00 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:52:00 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 18:52:00 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:52:00 - DEBUG -   maf: 10970 registros
2026-02-06 18:52:00 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:52:00 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:52:00 - DEBUG -   interior: 3624 registros
2026-02-06 18:52:00 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:52:00 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:52:00 - DEBUG -   vivero: 2460 registros
2026-02-06 18:52:00 - DEBUG -   fitos: 1987 registros
2026-02-06 18:52:00 - DEBUG -   semillas: 1180 registros
2026-02-06 18:52:00 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:52:00 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:52:00 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 18:52:00 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 18:52:00 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:52:00 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:52:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:02 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:52:02 - INFO - Costes cargados: 22145 registros
2026-02-06 18:52:02 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:52:02 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:52:02 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 18:52:02 - INFO -   ABC: 565 registros
2026-02-06 18:52:02 - INFO -   Ventas: 2460 registros
2026-02-06 18:52:02 - INFO -   Costes: 22145 registros
2026-02-06 18:52:02 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 18:52:02 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 18:52:02 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:52:02 - INFO - Datos de ventas: 189 registros
2026-02-06 18:52:02 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 18:52:02 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 18:52:02 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:52:02 - INFO -   Factor total: 1.3125
2026-02-06 18:52:02 - INFO -   Factor escalado: 1.6886
2026-02-06 18:52:02 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 18:52:02 - INFO -   Objetivo final: 6952.54€
2026-02-06 18:52:02 - INFO -   Delta: 1809.40€
2026-02-06 18:52:02 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:52:02 - DEBUG -   Total registros: 107
2026-02-06 18:52:02 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 18:52:02 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 18:52:02 - INFO -   Ventas finales: 6990.51€
2026-02-06 18:52:02 - INFO - 
============================================================
2026-02-06 18:52:02 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:52:02 - INFO - ============================================================
2026-02-06 18:52:02 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:52:02 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:52:02 - INFO - DataLoader inicializado correctamente
2026-02-06 18:52:02 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:52:02 - INFO - ============================================================
2026-02-06 18:52:02 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:52:02 - INFO - ============================================================
2026-02-06 18:52:02 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:52:02 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:52:02 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:02 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:02 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:02 - DEBUG - Usando hoja: Stock
2026-02-06 18:52:02 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:52:02 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:52:02 - INFO -   Stock: 30 registros
2026-02-06 18:52:02 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:52:02 - INFO - Fusión completada: 107 registros
2026-02-06 18:52:02 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:52:02 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:52:02 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:52:02 - INFO - 
============================================================
2026-02-06 18:52:02 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:52:02 - INFO - ============================================================
2026-02-06 18:52:02 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:52:02 - INFO - Corrección completada:
2026-02-06 18:52:02 - INFO -   - Artículos corregidos: 96/107
2026-02-06 18:52:02 - INFO -   - Artículos aumentados: 96
2026-02-06 18:52:02 - INFO -   - Artículos reducidos: 0
2026-02-06 18:52:02 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:52:02 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:52:02 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:52:02 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 18:52:02 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:52:02 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:52:02 - DEBUG -   Con valor 0: 11
2026-02-06 18:52:02 - DEBUG -   Con valor > 0: 96
2026-02-06 18:52:02 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 18:52:02 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 96 registros
2026-02-06 18:52:02 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 18:52:02 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 18:52:02 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 18:52:02 - INFO -   Articulos: 96
2026-02-06 18:52:02 - INFO -   Importe: 6990.51€
2026-02-06 18:52:02 - INFO - 
==================================================
2026-02-06 18:52:02 - INFO - SECCION: UTILES_JARDIN
2026-02-06 18:52:02 - INFO - ==================================================
2026-02-06 18:52:02 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 18:52:02 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:52:02 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 18:52:02 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 18:52:02 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 18:52:02 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:52:02 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 18:52:02 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 18:52:02 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:52:02 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:52:02 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:52:06 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:06 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:52:06 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:52:06 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:52:06 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:52:06 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:52:06 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 18:52:06 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:52:06 - DEBUG -   maf: 10970 registros
2026-02-06 18:52:06 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:52:06 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:52:06 - DEBUG -   interior: 3624 registros
2026-02-06 18:52:06 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:52:06 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:52:06 - DEBUG -   vivero: 2460 registros
2026-02-06 18:52:06 - DEBUG -   fitos: 1987 registros
2026-02-06 18:52:06 - DEBUG -   semillas: 1180 registros
2026-02-06 18:52:06 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:52:06 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:52:06 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 18:52:06 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 18:52:06 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:52:06 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:52:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:08 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:52:08 - INFO - Costes cargados: 22145 registros
2026-02-06 18:52:08 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:52:08 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:52:08 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 18:52:08 - INFO -   ABC: 433 registros
2026-02-06 18:52:08 - INFO -   Ventas: 1009 registros
2026-02-06 18:52:08 - INFO -   Costes: 22145 registros
2026-02-06 18:52:08 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 18:52:08 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 18:52:08 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:52:08 - INFO - Datos de ventas: 89 registros
2026-02-06 18:52:08 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 18:52:09 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 18:52:09 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:52:09 - INFO -   Factor total: 1.3125
2026-02-06 18:52:09 - INFO -   Factor escalado: 1.6747
2026-02-06 18:52:09 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 18:52:09 - INFO -   Objetivo final: 1371.26€
2026-02-06 18:52:09 - INFO -   Delta: 558.30€
2026-02-06 18:52:09 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:52:09 - DEBUG -   Total registros: 78
2026-02-06 18:52:09 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 18:52:09 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 18:52:09 - INFO -   Ventas finales: 1390.00€
2026-02-06 18:52:09 - INFO - 
============================================================
2026-02-06 18:52:09 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:52:09 - INFO - ============================================================
2026-02-06 18:52:09 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:52:09 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:52:09 - INFO - DataLoader inicializado correctamente
2026-02-06 18:52:09 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:52:09 - INFO - ============================================================
2026-02-06 18:52:09 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:52:09 - INFO - ============================================================
2026-02-06 18:52:09 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:52:09 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:52:09 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:09 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:09 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:09 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:09 - DEBUG - Usando hoja: Stock
2026-02-06 18:52:09 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:52:09 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:52:09 - INFO -   Stock: 30 registros
2026-02-06 18:52:09 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:52:09 - INFO - Fusión completada: 78 registros
2026-02-06 18:52:09 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:52:09 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:52:09 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:52:09 - INFO - 
============================================================
2026-02-06 18:52:09 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:52:09 - INFO - ============================================================
2026-02-06 18:52:09 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:52:09 - INFO - Corrección completada:
2026-02-06 18:52:09 - INFO -   - Artículos corregidos: 78/78
2026-02-06 18:52:09 - INFO -   - Artículos aumentados: 78
2026-02-06 18:52:09 - INFO -   - Artículos reducidos: 0
2026-02-06 18:52:09 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:52:09 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:52:09 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:52:09 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 18:52:09 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:52:09 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:52:09 - DEBUG -   Con valor 0: 0
2026-02-06 18:52:09 - DEBUG -   Con valor > 0: 78
2026-02-06 18:52:09 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 18:52:09 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 78 registros
2026-02-06 18:52:09 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 18:52:09 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 18:52:09 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 18:52:09 - INFO -   Articulos: 78
2026-02-06 18:52:09 - INFO -   Importe: 1390.00€
2026-02-06 18:52:09 - INFO - 
==================================================
2026-02-06 18:52:09 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 18:52:09 - INFO - ==================================================
2026-02-06 18:52:09 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 18:52:09 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:52:09 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 18:52:09 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 18:52:09 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 18:52:09 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:52:09 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 18:52:09 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 18:52:09 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:52:09 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:52:09 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:52:13 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:13 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:52:13 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:52:13 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:52:13 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:52:13 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:52:13 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 18:52:13 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:52:13 - DEBUG -   maf: 10970 registros
2026-02-06 18:52:13 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:52:13 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:52:13 - DEBUG -   interior: 3624 registros
2026-02-06 18:52:13 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:52:13 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:52:13 - DEBUG -   vivero: 2460 registros
2026-02-06 18:52:13 - DEBUG -   fitos: 1987 registros
2026-02-06 18:52:13 - DEBUG -   semillas: 1180 registros
2026-02-06 18:52:13 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:52:13 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:52:13 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 18:52:13 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 18:52:13 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:52:13 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:52:15 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:15 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:52:15 - INFO - Costes cargados: 22145 registros
2026-02-06 18:52:15 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:52:15 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:52:15 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 18:52:15 - INFO -   ABC: 247 registros
2026-02-06 18:52:15 - INFO -   Ventas: 3264 registros
2026-02-06 18:52:15 - INFO -   Costes: 22145 registros
2026-02-06 18:52:15 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 18:52:15 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 18:52:15 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:52:15 - INFO - Datos de ventas: 302 registros
2026-02-06 18:52:15 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 18:52:15 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 18:52:15 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:52:15 - INFO -   Factor total: 1.3125
2026-02-06 18:52:15 - INFO -   Factor escalado: 1.3380
2026-02-06 18:52:15 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 18:52:15 - INFO -   Objetivo final: 5377.63€
2026-02-06 18:52:15 - INFO -   Delta: 432.03€
2026-02-06 18:52:15 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:52:15 - DEBUG -   Total registros: 72
2026-02-06 18:52:15 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 18:52:15 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 18:52:15 - INFO -   Ventas finales: 5387.14€
2026-02-06 18:52:15 - INFO - 
============================================================
2026-02-06 18:52:15 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:52:15 - INFO - ============================================================
2026-02-06 18:52:15 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:52:15 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:52:15 - INFO - DataLoader inicializado correctamente
2026-02-06 18:52:15 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:52:15 - INFO - ============================================================
2026-02-06 18:52:15 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:52:15 - INFO - ============================================================
2026-02-06 18:52:15 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:52:15 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:52:15 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:15 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:15 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:15 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:15 - DEBUG - Usando hoja: Stock
2026-02-06 18:52:15 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:52:15 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:52:15 - INFO -   Stock: 30 registros
2026-02-06 18:52:15 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:52:15 - INFO - Fusión completada: 72 registros
2026-02-06 18:52:15 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:52:15 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:52:15 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:52:15 - INFO - 
============================================================
2026-02-06 18:52:15 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:52:15 - INFO - ============================================================
2026-02-06 18:52:15 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:52:15 - INFO - Corrección completada:
2026-02-06 18:52:15 - INFO -   - Artículos corregidos: 71/72
2026-02-06 18:52:15 - INFO -   - Artículos aumentados: 71
2026-02-06 18:52:15 - INFO -   - Artículos reducidos: 0
2026-02-06 18:52:15 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:52:15 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:52:15 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:52:15 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 18:52:15 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:52:15 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:52:15 - DEBUG -   Con valor 0: 1
2026-02-06 18:52:15 - DEBUG -   Con valor > 0: 71
2026-02-06 18:52:15 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 18:52:15 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 71 registros
2026-02-06 18:52:15 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 18:52:15 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 18:52:15 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 18:52:15 - INFO -   Articulos: 71
2026-02-06 18:52:15 - INFO -   Importe: 5387.14€
2026-02-06 18:52:15 - INFO - 
==================================================
2026-02-06 18:52:15 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 18:52:15 - INFO - ==================================================
2026-02-06 18:52:15 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 18:52:15 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 18:52:15 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 18:52:15 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 18:52:15 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 18:52:15 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 18:52:15 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 18:52:15 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 18:52:15 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 18:52:15 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 18:52:15 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 18:52:19 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:19 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 18:52:19 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 18:52:19 - INFO - Ventas cargadas: 44082 registros
2026-02-06 18:52:19 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 18:52:19 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 18:52:19 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 18:52:19 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 18:52:19 - DEBUG -   maf: 10970 registros
2026-02-06 18:52:19 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 18:52:19 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 18:52:19 - DEBUG -   interior: 3624 registros
2026-02-06 18:52:19 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 18:52:19 - DEBUG -   deco_interior: 2468 registros
2026-02-06 18:52:19 - DEBUG -   vivero: 2460 registros
2026-02-06 18:52:19 - DEBUG -   fitos: 1987 registros
2026-02-06 18:52:19 - DEBUG -   semillas: 1180 registros
2026-02-06 18:52:19 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 18:52:19 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 18:52:19 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 18:52:19 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 18:52:19 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 18:52:19 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 18:52:21 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:21 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 18:52:21 - INFO - Costes cargados: 22145 registros
2026-02-06 18:52:21 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 18:52:21 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 18:52:21 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 18:52:21 - INFO -   ABC: 995 registros
2026-02-06 18:52:21 - INFO -   Ventas: 4018 registros
2026-02-06 18:52:21 - INFO -   Costes: 22145 registros
2026-02-06 18:52:21 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 18:52:21 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 18:52:21 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 18:52:21 - INFO - Datos de ventas: 316 registros
2026-02-06 18:52:21 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 18:52:22 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 18:52:22 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 18:52:22 - INFO -   Factor total: 1.3125
2026-02-06 18:52:22 - INFO -   Factor escalado: 1.1960
2026-02-06 18:52:22 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 18:52:22 - INFO -   Objetivo final: 4909.20€
2026-02-06 18:52:22 - INFO -   Delta: 1185.39€
2026-02-06 18:52:22 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 18:52:22 - DEBUG -   Total registros: 224
2026-02-06 18:52:22 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 18:52:22 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 18:52:22 - INFO -   Ventas finales: 4923.89€
2026-02-06 18:52:22 - INFO - 
============================================================
2026-02-06 18:52:22 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 18:52:22 - INFO - ============================================================
2026-02-06 18:52:22 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 18:52:22 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 18:52:22 - INFO - DataLoader inicializado correctamente
2026-02-06 18:52:22 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 18:52:22 - INFO - ============================================================
2026-02-06 18:52:22 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 18:52:22 - INFO - ============================================================
2026-02-06 18:52:22 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 18:52:22 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 18:52:22 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:22 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:22 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 18:52:22 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 18:52:22 - DEBUG - Usando hoja: Stock
2026-02-06 18:52:22 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 18:52:22 - INFO - Stock actual cargado: 30 registros
2026-02-06 18:52:22 - INFO -   Stock: 30 registros
2026-02-06 18:52:22 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 18:52:22 - INFO - Fusión completada: 224 registros
2026-02-06 18:52:22 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 18:52:22 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 18:52:22 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 18:52:22 - INFO - 
============================================================
2026-02-06 18:52:22 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 18:52:22 - INFO - ============================================================
2026-02-06 18:52:22 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 18:52:22 - INFO - Corrección completada:
2026-02-06 18:52:22 - INFO -   - Artículos corregidos: 205/224
2026-02-06 18:52:22 - INFO -   - Artículos aumentados: 205
2026-02-06 18:52:22 - INFO -   - Artículos reducidos: 0
2026-02-06 18:52:22 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 18:52:22 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 18:52:22 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 18:52:22 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 18:52:22 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 18:52:22 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 18:52:22 - DEBUG -   Con valor 0: 19
2026-02-06 18:52:22 - DEBUG -   Con valor > 0: 205
2026-02-06 18:52:22 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 18:52:22 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 205 registros
2026-02-06 18:52:22 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 18:52:22 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 18:52:22 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 18:52:22 - INFO -   Articulos: 205
2026-02-06 18:52:22 - INFO -   Importe: 4923.89€
2026-02-06 18:52:22 - INFO - Estado guardado correctamente
2026-02-06 18:52:22 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 18:52:22 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 18:52:22 - INFO - Estado guardado correctamente
2026-02-06 18:52:22 - INFO - 
============================================================
2026-02-06 18:52:22 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 18:52:22 - INFO - ============================================================
2026-02-06 18:52:22 - DEBUG - [DEBUG] Archivos agrupados por sección: {'maf': ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx'], 'interior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx'], 'semillas': ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx'], 'vivo': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx'], 'manufacturado': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx'], 'fitos': ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx'], 'vivero': ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx'], 'jardin': ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx'], 'aridos': ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx'], 'exterior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']}
2026-02-06 18:52:22 - INFO - 
============================================================
2026-02-06 18:52:22 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 18:52:22 - INFO - ============================================================
2026-02-06 18:52:22 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 18:52:22 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 18:52:22 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 18:52:22 - INFO - EmailService inicializado correctamente
2026-02-06 18:52:22 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 18:52:22 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 18:52:22 - INFO - 
Enviando email para sección: maf
2026-02-06 18:52:22 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx']
2026-02-06 18:52:22 - DEBUG - Destinatarios para maf: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 18:52:22 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 18:52:23 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 18:52:23 - INFO - Email enviado para sección maf (semana 14)
2026-02-06 18:52:23 - ERROR - ✗ Error al enviar email a maf: None
2026-02-06 18:52:23 - INFO - 
Enviando email para sección: interior
2026-02-06 18:52:23 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx']
2026-02-06 18:52:23 - DEBUG - Destinatarios para interior: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Iris'}]
2026-02-06 18:52:23 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 18:52:23 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 18:52:23 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 18:52:23 - INFO - Email enviado para sección interior (semana 14)
2026-02-06 18:52:23 - ERROR - ✗ Error al enviar email a interior: None
2026-02-06 18:52:23 - INFO - 
Enviando email para sección: semillas
2026-02-06 18:52:23 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx']
2026-02-06 18:52:23 - DEBUG - Destinatarios para semillas: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 18:52:23 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 18:52:24 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 18:52:24 - INFO - Email enviado para sección semillas (semana 14)
2026-02-06 18:52:24 - ERROR - ✗ Error al enviar email a semillas: None
2026-02-06 18:52:24 - INFO - 
Enviando email para sección: vivo
2026-02-06 18:52:24 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx']
2026-02-06 18:52:24 - WARNING - No hay destinatarios configurados para la sección: vivo
2026-02-06 18:52:24 - WARNING - No se puede enviar email para vivo: No hay destinatarios configurados
2026-02-06 18:52:24 - ERROR - ✗ Error al enviar email a vivo: No hay destinatarios configurados
2026-02-06 18:52:24 - INFO - 
Enviando email para sección: manufacturado
2026-02-06 18:52:24 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx']
2026-02-06 18:52:24 - WARNING - No hay destinatarios configurados para la sección: manufacturado
2026-02-06 18:52:24 - WARNING - No se puede enviar email para manufacturado: No hay destinatarios configurados
2026-02-06 18:52:24 - ERROR - ✗ Error al enviar email a manufacturado: No hay destinatarios configurados
2026-02-06 18:52:24 - INFO - 
Enviando email para sección: fitos
2026-02-06 18:52:24 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx']
2026-02-06 18:52:24 - DEBUG - Destinatarios para fitos: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 18:52:24 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 18:52:24 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 18:52:24 - INFO - Email enviado para sección fitos (semana 14)
2026-02-06 18:52:24 - ERROR - ✗ Error al enviar email a fitos: None
2026-02-06 18:52:24 - INFO - 
Enviando email para sección: vivero
2026-02-06 18:52:24 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx']
2026-02-06 18:52:24 - DEBUG - Destinatarios para vivero: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 18:52:24 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 18:52:24 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 18:52:24 - INFO - Email enviado para sección vivero (semana 14)
2026-02-06 18:52:24 - ERROR - ✗ Error al enviar email a vivero: None
2026-02-06 18:52:24 - INFO - 
Enviando email para sección: jardin
2026-02-06 18:52:24 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx']
2026-02-06 18:52:24 - WARNING - No hay destinatarios configurados para la sección: jardin
2026-02-06 18:52:24 - WARNING - No se puede enviar email para jardin: No hay destinatarios configurados
2026-02-06 18:52:24 - ERROR - ✗ Error al enviar email a jardin: No hay destinatarios configurados
2026-02-06 18:52:24 - INFO - 
Enviando email para sección: aridos
2026-02-06 18:52:24 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx']
2026-02-06 18:52:24 - WARNING - No hay destinatarios configurados para la sección: aridos
2026-02-06 18:52:24 - WARNING - No se puede enviar email para aridos: No hay destinatarios configurados
2026-02-06 18:52:24 - ERROR - ✗ Error al enviar email a aridos: No hay destinatarios configurados
2026-02-06 18:52:24 - INFO - 
Enviando email para sección: exterior
2026-02-06 18:52:24 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']
2026-02-06 18:52:24 - WARNING - No hay destinatarios configurados para la sección: exterior
2026-02-06 18:52:24 - WARNING - No se puede enviar email para exterior: No hay destinatarios configurados
2026-02-06 18:52:24 - ERROR - ✗ Error al enviar email a exterior: No hay destinatarios configurados
2026-02-06 18:52:24 - INFO - 
============================================================
2026-02-06 18:52:24 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 18:52:24 - INFO - ============================================================
2026-02-06 18:52:24 - INFO - Emails enviados exitosamente: 0
2026-02-06 18:52:24 - INFO - Emails fallidos: 10
2026-02-06 18:52:24 - INFO - Secciones procesadas: 10
2026-02-06 18:52:24 - INFO - 
============================================================
2026-02-06 18:52:24 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 18:52:24 - INFO - ============================================================
2026-02-06 18:52:24 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 18:52:24 - INFO - 
============================================================
2026-02-06 18:52:24 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 18:52:24 - INFO - ============================================================
2026-02-06 18:52:24 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 18:52:24 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 18:52:24 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 18:52:24 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 18:52:25 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 18:52:25 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 18:52:25 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 18:52:25 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 18:52:25 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 18:52:25 - INFO - 
============================================================
2026-02-06 18:52:25 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 18:52:25 - INFO - ============================================================
2026-02-06 18:52:25 - INFO - Emails enviados: 3
2026-02-06 18:52:25 - INFO - Emails fallidos: 0
2026-02-06 18:52:25 - INFO - 
======================================================================
2026-02-06 18:52:25 - INFO - RESUMEN DE EJECUCION
2026-02-06 18:52:25 - INFO - ======================================================================
2026-02-06 18:52:25 - INFO - Semana procesada: 14
2026-02-06 18:52:25 - INFO - Archivos generados: 12
2026-02-06 18:52:25 - INFO - Total articulos: 1510
2026-02-06 18:52:25 - INFO - Total importe: 48115.81€
2026-02-06 18:52:25 - WARNING - 
✗ EMAILS FALLIDOS: 10
2026-02-06 18:52:25 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 18:52:25 - INFO - ======================================================================
2026-02-06 18:52:25 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 18:52:25 - INFO - Archivo principal: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 18:52:25 - INFO - Artículos: 1510
2026-02-06 18:52:25 - INFO - Importe: 48115.81€
2026-02-06 18:52:25 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 19:31:05 - INFO - ======================================================================
2026-02-06 19:31:05 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 19:31:05 - INFO - Fecha de ejecución: 2026-02-06 19:31:05
2026-02-06 19:31:05 - INFO - ======================================================================
2026-02-06 19:31:05 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 19:31:05 - INFO - Envío de emails: Sí
2026-02-06 19:31:05 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 19:31:05 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 19:31:05 - INFO - Estado cargado correctamente
2026-02-06 19:31:05 - INFO - SchedulerService inicializado correctamente
2026-02-06 19:31:05 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 19:31:05 - INFO - Semana forzada por argumento: 14
2026-02-06 19:31:05 - INFO - ======================================================================
2026-02-06 19:31:05 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 19:31:05 - INFO - ======================================================================
2026-02-06 19:31:05 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 19:31:05 - INFO - DataLoader inicializado correctamente
2026-02-06 19:31:05 - INFO - ForecastEngine inicializado correctamente
2026-02-06 19:31:05 - INFO - OrderGenerator inicializado correctamente
2026-02-06 19:31:05 - INFO - SchedulerService inicializado correctamente
2026-02-06 19:31:05 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 19:31:05 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 19:31:05 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 19:31:05 - INFO - 
==================================================
2026-02-06 19:31:05 - INFO - SECCION: MAF
2026-02-06 19:31:05 - INFO - ==================================================
2026-02-06 19:31:05 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 19:31:05 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:31:05 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 19:31:05 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 19:31:05 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 19:31:05 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:31:05 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 19:31:05 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 19:31:05 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:31:05 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:31:05 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:31:09 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:09 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:31:09 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:31:09 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:31:09 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:31:09 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:31:09 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 19:31:09 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:31:09 - DEBUG -   maf: 10970 registros
2026-02-06 19:31:09 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:31:09 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:31:09 - DEBUG -   interior: 3624 registros
2026-02-06 19:31:09 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:31:09 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:31:09 - DEBUG -   vivero: 2460 registros
2026-02-06 19:31:09 - DEBUG -   fitos: 1987 registros
2026-02-06 19:31:09 - DEBUG -   semillas: 1180 registros
2026-02-06 19:31:09 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:31:09 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:31:09 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 19:31:09 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 19:31:09 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:31:09 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:31:11 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:11 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:31:11 - INFO - Costes cargados: 22145 registros
2026-02-06 19:31:11 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:31:11 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:31:11 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 19:31:11 - INFO -   ABC: 499 registros
2026-02-06 19:31:11 - INFO -   Ventas: 10970 registros
2026-02-06 19:31:11 - INFO -   Costes: 22145 registros
2026-02-06 19:31:11 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 19:31:11 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 19:31:11 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:31:11 - INFO - Datos de ventas: 1011 registros
2026-02-06 19:31:11 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 19:31:12 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 19:31:12 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:31:12 - INFO -   Factor total: 1.3125
2026-02-06 19:31:12 - INFO -   Factor escalado: 1.5844
2026-02-06 19:31:12 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 19:31:12 - INFO -   Objetivo final: 9253.98€
2026-02-06 19:31:12 - INFO -   Delta: 679.77€
2026-02-06 19:31:12 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:31:12 - DEBUG -   Total registros: 222
2026-02-06 19:31:12 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 19:31:12 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 19:31:12 - INFO -   Ventas finales: 9254.53€
2026-02-06 19:31:12 - INFO - 
============================================================
2026-02-06 19:31:12 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:31:12 - INFO - ============================================================
2026-02-06 19:31:12 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:31:12 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:31:12 - INFO - DataLoader inicializado correctamente
2026-02-06 19:31:12 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:31:12 - INFO - ============================================================
2026-02-06 19:31:12 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:31:12 - INFO - ============================================================
2026-02-06 19:31:12 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:31:12 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:31:12 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:12 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:12 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:12 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:12 - DEBUG - Usando hoja: Stock
2026-02-06 19:31:12 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:31:12 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:31:12 - INFO -   Stock: 30 registros
2026-02-06 19:31:12 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:31:12 - INFO - Fusión completada: 222 registros
2026-02-06 19:31:12 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:31:12 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:31:12 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:31:12 - INFO - 
============================================================
2026-02-06 19:31:12 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:31:12 - INFO - ============================================================
2026-02-06 19:31:12 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:31:12 - INFO - Corrección completada:
2026-02-06 19:31:12 - INFO -   - Artículos corregidos: 191/222
2026-02-06 19:31:12 - INFO -   - Artículos aumentados: 191
2026-02-06 19:31:12 - INFO -   - Artículos reducidos: 0
2026-02-06 19:31:12 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:31:12 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:31:12 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:31:12 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 19:31:12 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:31:12 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:31:12 - DEBUG -   Con valor 0: 31
2026-02-06 19:31:12 - DEBUG -   Con valor > 0: 191
2026-02-06 19:31:12 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 19:31:12 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 191 registros
2026-02-06 19:31:12 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 19:31:12 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 19:31:12 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 19:31:12 - INFO -   Articulos: 191
2026-02-06 19:31:12 - INFO -   Importe: 9254.53€
2026-02-06 19:31:12 - INFO - 
==================================================
2026-02-06 19:31:12 - INFO - SECCION: DECO_INTERIOR
2026-02-06 19:31:12 - INFO - ==================================================
2026-02-06 19:31:12 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 19:31:12 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:31:12 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 19:31:12 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 19:31:12 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 19:31:12 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:31:12 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 19:31:12 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 19:31:12 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:31:12 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:31:12 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:31:16 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:16 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:31:16 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:31:16 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:31:16 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:31:16 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:31:16 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 19:31:16 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:31:16 - DEBUG -   maf: 10970 registros
2026-02-06 19:31:16 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:31:16 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:31:16 - DEBUG -   interior: 3624 registros
2026-02-06 19:31:16 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:31:16 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:31:16 - DEBUG -   vivero: 2460 registros
2026-02-06 19:31:16 - DEBUG -   fitos: 1987 registros
2026-02-06 19:31:16 - DEBUG -   semillas: 1180 registros
2026-02-06 19:31:16 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:31:16 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:31:16 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 19:31:16 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 19:31:16 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:31:16 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:31:18 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:18 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:31:18 - INFO - Costes cargados: 22145 registros
2026-02-06 19:31:18 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:31:18 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:31:18 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 19:31:18 - INFO -   ABC: 1827 registros
2026-02-06 19:31:18 - INFO -   Ventas: 2468 registros
2026-02-06 19:31:18 - INFO -   Costes: 22145 registros
2026-02-06 19:31:18 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 19:31:18 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 19:31:18 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:31:18 - INFO - Datos de ventas: 180 registros
2026-02-06 19:31:18 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 19:31:19 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 19:31:19 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:31:19 - INFO -   Factor total: 1.3125
2026-02-06 19:31:19 - INFO -   Factor escalado: 1.5747
2026-02-06 19:31:19 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 19:31:19 - INFO -   Objetivo final: 2576.42€
2026-02-06 19:31:19 - INFO -   Delta: 373.59€
2026-02-06 19:31:19 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:31:19 - DEBUG -   Total registros: 139
2026-02-06 19:31:19 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 19:31:19 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 19:31:19 - INFO -   Ventas finales: 2580.73€
2026-02-06 19:31:19 - INFO - 
============================================================
2026-02-06 19:31:19 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:31:19 - INFO - ============================================================
2026-02-06 19:31:19 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:31:19 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:31:19 - INFO - DataLoader inicializado correctamente
2026-02-06 19:31:19 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:31:19 - INFO - ============================================================
2026-02-06 19:31:19 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:31:19 - INFO - ============================================================
2026-02-06 19:31:19 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:31:19 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:31:19 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:19 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:19 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:19 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:19 - DEBUG - Usando hoja: Stock
2026-02-06 19:31:19 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:31:19 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:31:19 - INFO -   Stock: 30 registros
2026-02-06 19:31:19 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:31:19 - INFO - Fusión completada: 139 registros
2026-02-06 19:31:19 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:31:19 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:31:19 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:31:19 - INFO - 
============================================================
2026-02-06 19:31:19 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:31:19 - INFO - ============================================================
2026-02-06 19:31:19 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:31:19 - INFO - Corrección completada:
2026-02-06 19:31:19 - INFO -   - Artículos corregidos: 135/139
2026-02-06 19:31:19 - INFO -   - Artículos aumentados: 135
2026-02-06 19:31:19 - INFO -   - Artículos reducidos: 0
2026-02-06 19:31:19 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:31:19 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:31:19 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:31:19 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 19:31:19 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:31:19 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:31:19 - DEBUG -   Con valor 0: 4
2026-02-06 19:31:19 - DEBUG -   Con valor > 0: 135
2026-02-06 19:31:19 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 19:31:19 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 135 registros
2026-02-06 19:31:19 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 19:31:19 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 19:31:19 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 19:31:19 - INFO -   Articulos: 135
2026-02-06 19:31:19 - INFO -   Importe: 2580.73€
2026-02-06 19:31:19 - INFO - 
==================================================
2026-02-06 19:31:19 - INFO - SECCION: SEMILLAS
2026-02-06 19:31:19 - INFO - ==================================================
2026-02-06 19:31:19 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 19:31:19 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:31:19 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 19:31:19 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 19:31:19 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 19:31:19 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:31:19 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 19:31:19 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 19:31:19 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:31:19 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:31:19 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:31:23 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:23 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:31:23 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:31:23 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:31:23 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:31:23 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:31:23 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 19:31:23 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:31:23 - DEBUG -   maf: 10970 registros
2026-02-06 19:31:23 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:31:23 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:31:23 - DEBUG -   interior: 3624 registros
2026-02-06 19:31:23 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:31:23 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:31:23 - DEBUG -   vivero: 2460 registros
2026-02-06 19:31:23 - DEBUG -   fitos: 1987 registros
2026-02-06 19:31:23 - DEBUG -   semillas: 1180 registros
2026-02-06 19:31:23 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:31:23 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:31:23 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 19:31:23 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 19:31:23 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:31:23 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:31:25 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:25 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:31:25 - INFO - Costes cargados: 22145 registros
2026-02-06 19:31:25 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:31:25 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:31:25 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 19:31:25 - INFO -   ABC: 218 registros
2026-02-06 19:31:25 - INFO -   Ventas: 1180 registros
2026-02-06 19:31:25 - INFO -   Costes: 22145 registros
2026-02-06 19:31:25 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 19:31:25 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 19:31:25 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:31:25 - INFO - Datos de ventas: 136 registros
2026-02-06 19:31:25 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 19:31:26 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 19:31:26 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:31:26 - INFO -   Factor total: 1.3125
2026-02-06 19:31:26 - INFO -   Factor escalado: 2.0023
2026-02-06 19:31:26 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 19:31:26 - INFO -   Objetivo final: 911.32€
2026-02-06 19:31:26 - INFO -   Delta: 217.83€
2026-02-06 19:31:26 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:31:26 - DEBUG -   Total registros: 84
2026-02-06 19:31:26 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 19:31:26 - DEBUG -   Ventas finales: 911.60€
2026-02-06 19:31:26 - INFO -   Ventas finales: 911.60€
2026-02-06 19:31:26 - INFO - 
============================================================
2026-02-06 19:31:26 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:31:26 - INFO - ============================================================
2026-02-06 19:31:26 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:31:26 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:31:26 - INFO - DataLoader inicializado correctamente
2026-02-06 19:31:26 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:31:26 - INFO - ============================================================
2026-02-06 19:31:26 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:31:26 - INFO - ============================================================
2026-02-06 19:31:26 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:31:26 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:31:26 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:26 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:26 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:26 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:26 - DEBUG - Usando hoja: Stock
2026-02-06 19:31:26 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:31:26 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:31:26 - INFO -   Stock: 30 registros
2026-02-06 19:31:26 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:31:26 - INFO - Fusión completada: 84 registros
2026-02-06 19:31:26 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:31:26 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:31:26 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:31:26 - INFO - 
============================================================
2026-02-06 19:31:26 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:31:26 - INFO - ============================================================
2026-02-06 19:31:26 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:31:26 - INFO - Corrección completada:
2026-02-06 19:31:26 - INFO -   - Artículos corregidos: 84/84
2026-02-06 19:31:26 - INFO -   - Artículos aumentados: 84
2026-02-06 19:31:26 - INFO -   - Artículos reducidos: 0
2026-02-06 19:31:26 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:31:26 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:31:26 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:31:26 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 19:31:26 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:31:26 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:31:26 - DEBUG -   Con valor 0: 0
2026-02-06 19:31:26 - DEBUG -   Con valor > 0: 84
2026-02-06 19:31:26 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 19:31:26 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 84 registros
2026-02-06 19:31:26 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 19:31:26 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 19:31:26 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 19:31:26 - INFO -   Articulos: 84
2026-02-06 19:31:26 - INFO -   Importe: 911.60€
2026-02-06 19:31:26 - INFO - 
==================================================
2026-02-06 19:31:26 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 19:31:26 - INFO - ==================================================
2026-02-06 19:31:26 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 19:31:26 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:31:26 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 19:31:26 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 19:31:26 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 19:31:26 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:31:26 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 19:31:26 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 19:31:26 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:31:26 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:31:26 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:31:30 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:30 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:31:30 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:31:30 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:31:30 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:31:30 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:31:30 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 19:31:30 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:31:30 - DEBUG -   maf: 10970 registros
2026-02-06 19:31:30 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:31:30 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:31:30 - DEBUG -   interior: 3624 registros
2026-02-06 19:31:30 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:31:30 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:31:30 - DEBUG -   vivero: 2460 registros
2026-02-06 19:31:30 - DEBUG -   fitos: 1987 registros
2026-02-06 19:31:30 - DEBUG -   semillas: 1180 registros
2026-02-06 19:31:30 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:31:30 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:31:30 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 19:31:30 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 19:31:30 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:31:30 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:31:32 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:32 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:31:32 - INFO - Costes cargados: 22145 registros
2026-02-06 19:31:32 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:31:32 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:31:32 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 19:31:32 - INFO -   ABC: 205 registros
2026-02-06 19:31:32 - INFO -   Ventas: 1124 registros
2026-02-06 19:31:32 - INFO -   Costes: 22145 registros
2026-02-06 19:31:32 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 19:31:32 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 19:31:32 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:31:32 - INFO - Datos de ventas: 88 registros
2026-02-06 19:31:32 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 19:31:32 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 19:31:32 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:31:32 - INFO -   Factor total: 1.3125
2026-02-06 19:31:32 - INFO -   Factor escalado: 1.6854
2026-02-06 19:31:32 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 19:31:32 - INFO -   Objetivo final: 1426.88€
2026-02-06 19:31:32 - INFO -   Delta: 346.78€
2026-02-06 19:31:32 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:31:32 - DEBUG -   Total registros: 43
2026-02-06 19:31:32 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 19:31:32 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 19:31:32 - INFO -   Ventas finales: 1455.34€
2026-02-06 19:31:32 - INFO - 
============================================================
2026-02-06 19:31:32 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:31:32 - INFO - ============================================================
2026-02-06 19:31:32 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:31:32 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:31:32 - INFO - DataLoader inicializado correctamente
2026-02-06 19:31:32 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:31:32 - INFO - ============================================================
2026-02-06 19:31:32 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:31:32 - INFO - ============================================================
2026-02-06 19:31:32 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:31:32 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:31:32 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:32 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:32 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:32 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:32 - DEBUG - Usando hoja: Stock
2026-02-06 19:31:32 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:31:32 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:31:32 - INFO -   Stock: 30 registros
2026-02-06 19:31:32 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:31:32 - INFO - Fusión completada: 43 registros
2026-02-06 19:31:32 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:31:32 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:31:32 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:31:32 - INFO - 
============================================================
2026-02-06 19:31:32 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:31:32 - INFO - ============================================================
2026-02-06 19:31:32 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:31:32 - INFO - Corrección completada:
2026-02-06 19:31:32 - INFO -   - Artículos corregidos: 36/43
2026-02-06 19:31:32 - INFO -   - Artículos aumentados: 36
2026-02-06 19:31:32 - INFO -   - Artículos reducidos: 0
2026-02-06 19:31:32 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:31:32 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:31:32 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:31:32 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 19:31:32 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:31:32 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:31:32 - DEBUG -   Con valor 0: 7
2026-02-06 19:31:32 - DEBUG -   Con valor > 0: 36
2026-02-06 19:31:32 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 19:31:32 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 36 registros
2026-02-06 19:31:32 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 19:31:32 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 19:31:32 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 19:31:32 - INFO -   Articulos: 36
2026-02-06 19:31:32 - INFO -   Importe: 1455.34€
2026-02-06 19:31:32 - INFO - 
==================================================
2026-02-06 19:31:32 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 19:31:32 - INFO - ==================================================
2026-02-06 19:31:32 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 19:31:32 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:31:32 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 19:31:32 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 19:31:32 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 19:31:33 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:31:33 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 19:31:33 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 19:31:33 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:31:33 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:31:33 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:31:36 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:36 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:31:36 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:31:36 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:31:36 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:31:36 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:31:36 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 19:31:37 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:31:37 - DEBUG -   maf: 10970 registros
2026-02-06 19:31:37 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:31:37 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:31:37 - DEBUG -   interior: 3624 registros
2026-02-06 19:31:37 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:31:37 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:31:37 - DEBUG -   vivero: 2460 registros
2026-02-06 19:31:37 - DEBUG -   fitos: 1987 registros
2026-02-06 19:31:37 - DEBUG -   semillas: 1180 registros
2026-02-06 19:31:37 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:31:37 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:31:37 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 19:31:37 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 19:31:37 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:31:37 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:31:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:38 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:31:39 - INFO - Costes cargados: 22145 registros
2026-02-06 19:31:39 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:31:39 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:31:39 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 19:31:39 - INFO -   ABC: 2749 registros
2026-02-06 19:31:39 - INFO -   Ventas: 9784 registros
2026-02-06 19:31:39 - INFO -   Costes: 22145 registros
2026-02-06 19:31:39 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 19:31:39 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 19:31:39 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:31:39 - INFO - Datos de ventas: 822 registros
2026-02-06 19:31:39 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 19:31:41 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 19:31:41 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:31:41 - INFO -   Factor total: 1.3125
2026-02-06 19:31:41 - INFO -   Factor escalado: 1.0268
2026-02-06 19:31:41 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 19:31:41 - INFO -   Objetivo final: 8977.26€
2026-02-06 19:31:41 - INFO -   Delta: 3401.99€
2026-02-06 19:31:41 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:31:41 - DEBUG -   Total registros: 538
2026-02-06 19:31:41 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 19:31:41 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 19:31:41 - INFO -   Ventas finales: 8993.98€
2026-02-06 19:31:41 - INFO - 
============================================================
2026-02-06 19:31:41 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:31:41 - INFO - ============================================================
2026-02-06 19:31:41 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:31:41 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:31:41 - INFO - DataLoader inicializado correctamente
2026-02-06 19:31:41 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:31:41 - INFO - ============================================================
2026-02-06 19:31:41 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:31:41 - INFO - ============================================================
2026-02-06 19:31:41 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:31:41 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:31:41 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:41 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:41 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:41 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:41 - DEBUG - Usando hoja: Stock
2026-02-06 19:31:41 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:31:41 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:31:41 - INFO -   Stock: 30 registros
2026-02-06 19:31:41 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:31:41 - INFO - Fusión completada: 538 registros
2026-02-06 19:31:41 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:31:41 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:31:41 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:31:41 - INFO - 
============================================================
2026-02-06 19:31:41 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:31:41 - INFO - ============================================================
2026-02-06 19:31:41 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:31:41 - INFO - Corrección completada:
2026-02-06 19:31:41 - INFO -   - Artículos corregidos: 411/538
2026-02-06 19:31:41 - INFO -   - Artículos aumentados: 411
2026-02-06 19:31:41 - INFO -   - Artículos reducidos: 0
2026-02-06 19:31:41 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:31:41 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:31:41 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:31:41 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 19:31:41 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:31:41 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:31:41 - DEBUG -   Con valor 0: 127
2026-02-06 19:31:41 - DEBUG -   Con valor > 0: 411
2026-02-06 19:31:41 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 19:31:41 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 411 registros
2026-02-06 19:31:41 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 19:31:41 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 19:31:41 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 19:31:41 - INFO -   Articulos: 411
2026-02-06 19:31:41 - INFO -   Importe: 8993.98€
2026-02-06 19:31:41 - INFO - 
==================================================
2026-02-06 19:31:41 - INFO - SECCION: INTERIOR
2026-02-06 19:31:41 - INFO - ==================================================
2026-02-06 19:31:41 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 19:31:41 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:31:41 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 19:31:41 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 19:31:41 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 19:31:41 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:31:41 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 19:31:41 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 19:31:41 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:31:41 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:31:41 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:31:45 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:45 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:31:45 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:31:45 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:31:45 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:31:45 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:31:45 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 19:31:45 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:31:45 - DEBUG -   maf: 10970 registros
2026-02-06 19:31:45 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:31:45 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:31:45 - DEBUG -   interior: 3624 registros
2026-02-06 19:31:45 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:31:45 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:31:45 - DEBUG -   vivero: 2460 registros
2026-02-06 19:31:45 - DEBUG -   fitos: 1987 registros
2026-02-06 19:31:45 - DEBUG -   semillas: 1180 registros
2026-02-06 19:31:45 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:31:45 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:31:45 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 19:31:45 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 19:31:45 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:31:45 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:31:47 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:47 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:31:47 - INFO - Costes cargados: 22145 registros
2026-02-06 19:31:47 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:31:47 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:31:47 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 19:31:47 - INFO -   ABC: 555 registros
2026-02-06 19:31:47 - INFO -   Ventas: 3624 registros
2026-02-06 19:31:47 - INFO -   Costes: 22145 registros
2026-02-06 19:31:47 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 19:31:47 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 19:31:47 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:31:47 - INFO - Datos de ventas: 286 registros
2026-02-06 19:31:47 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 19:31:48 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 19:31:48 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:31:48 - INFO -   Factor total: 1.3125
2026-02-06 19:31:48 - INFO -   Factor escalado: 1.5971
2026-02-06 19:31:48 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 19:31:48 - INFO -   Objetivo final: 3846.45€
2026-02-06 19:31:48 - INFO -   Delta: 685.37€
2026-02-06 19:31:48 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:31:48 - DEBUG -   Total registros: 138
2026-02-06 19:31:48 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 19:31:48 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 19:31:48 - INFO -   Ventas finales: 3862.17€
2026-02-06 19:31:48 - INFO - 
============================================================
2026-02-06 19:31:48 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:31:48 - INFO - ============================================================
2026-02-06 19:31:48 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:31:48 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:31:48 - INFO - DataLoader inicializado correctamente
2026-02-06 19:31:48 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:31:48 - INFO - ============================================================
2026-02-06 19:31:48 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:31:48 - INFO - ============================================================
2026-02-06 19:31:48 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:31:48 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:31:48 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:48 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:48 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:48 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:48 - DEBUG - Usando hoja: Stock
2026-02-06 19:31:48 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:31:48 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:31:48 - INFO -   Stock: 30 registros
2026-02-06 19:31:48 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:31:48 - INFO - Fusión completada: 138 registros
2026-02-06 19:31:48 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:31:48 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:31:48 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:31:48 - INFO - 
============================================================
2026-02-06 19:31:48 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:31:48 - INFO - ============================================================
2026-02-06 19:31:48 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:31:48 - INFO - Corrección completada:
2026-02-06 19:31:48 - INFO -   - Artículos corregidos: 121/138
2026-02-06 19:31:48 - INFO -   - Artículos aumentados: 121
2026-02-06 19:31:48 - INFO -   - Artículos reducidos: 0
2026-02-06 19:31:48 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:31:48 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:31:48 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:31:48 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 19:31:48 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:31:48 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:31:48 - DEBUG -   Con valor 0: 17
2026-02-06 19:31:48 - DEBUG -   Con valor > 0: 121
2026-02-06 19:31:48 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 19:31:48 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 121 registros
2026-02-06 19:31:48 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 19:31:48 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 19:31:48 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 19:31:48 - INFO -   Articulos: 121
2026-02-06 19:31:48 - INFO -   Importe: 3862.17€
2026-02-06 19:31:48 - INFO - 
==================================================
2026-02-06 19:31:48 - INFO - SECCION: FITOS
2026-02-06 19:31:48 - INFO - ==================================================
2026-02-06 19:31:48 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 19:31:48 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:31:48 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 19:31:48 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 19:31:48 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 19:31:48 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:31:48 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 19:31:48 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 19:31:48 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:31:48 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:31:48 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:31:52 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:52 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:31:52 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:31:52 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:31:52 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:31:52 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:31:52 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 19:31:52 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:31:52 - DEBUG -   maf: 10970 registros
2026-02-06 19:31:52 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:31:52 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:31:52 - DEBUG -   interior: 3624 registros
2026-02-06 19:31:52 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:31:52 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:31:52 - DEBUG -   vivero: 2460 registros
2026-02-06 19:31:52 - DEBUG -   fitos: 1987 registros
2026-02-06 19:31:52 - DEBUG -   semillas: 1180 registros
2026-02-06 19:31:52 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:31:52 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:31:52 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 19:31:52 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 19:31:52 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:31:52 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:31:54 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:54 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:31:54 - INFO - Costes cargados: 22145 registros
2026-02-06 19:31:54 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:31:54 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:31:54 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 19:31:54 - INFO -   ABC: 247 registros
2026-02-06 19:31:54 - INFO -   Ventas: 1987 registros
2026-02-06 19:31:54 - INFO -   Costes: 22145 registros
2026-02-06 19:31:54 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 19:31:54 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 19:31:54 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:31:54 - INFO - Datos de ventas: 157 registros
2026-02-06 19:31:54 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 19:31:54 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 19:31:54 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:31:54 - INFO -   Factor total: 1.3125
2026-02-06 19:31:54 - INFO -   Factor escalado: 1.4055
2026-02-06 19:31:54 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 19:31:54 - INFO -   Objetivo final: 2360.20€
2026-02-06 19:31:54 - INFO -   Delta: 424.74€
2026-02-06 19:31:54 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:31:54 - DEBUG -   Total registros: 84
2026-02-06 19:31:54 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 19:31:54 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 19:31:54 - INFO -   Ventas finales: 2365.92€
2026-02-06 19:31:54 - INFO - 
============================================================
2026-02-06 19:31:54 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:31:54 - INFO - ============================================================
2026-02-06 19:31:54 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:31:54 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:31:54 - INFO - DataLoader inicializado correctamente
2026-02-06 19:31:54 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:31:54 - INFO - ============================================================
2026-02-06 19:31:54 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:31:54 - INFO - ============================================================
2026-02-06 19:31:54 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:31:54 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:31:54 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:54 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:54 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:31:54 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:54 - DEBUG - Usando hoja: Stock
2026-02-06 19:31:54 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:31:54 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:31:54 - INFO -   Stock: 30 registros
2026-02-06 19:31:54 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:31:54 - INFO - Fusión completada: 84 registros
2026-02-06 19:31:54 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:31:54 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:31:54 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:31:54 - INFO - 
============================================================
2026-02-06 19:31:54 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:31:54 - INFO - ============================================================
2026-02-06 19:31:54 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:31:54 - INFO - Corrección completada:
2026-02-06 19:31:54 - INFO -   - Artículos corregidos: 82/84
2026-02-06 19:31:54 - INFO -   - Artículos aumentados: 82
2026-02-06 19:31:54 - INFO -   - Artículos reducidos: 0
2026-02-06 19:31:54 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:31:54 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:31:54 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:31:54 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 19:31:54 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:31:54 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:31:54 - DEBUG -   Con valor 0: 2
2026-02-06 19:31:54 - DEBUG -   Con valor > 0: 82
2026-02-06 19:31:54 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 19:31:54 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 82 registros
2026-02-06 19:31:54 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 19:31:54 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 19:31:54 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 19:31:54 - INFO -   Articulos: 82
2026-02-06 19:31:54 - INFO -   Importe: 2365.92€
2026-02-06 19:31:54 - INFO - 
==================================================
2026-02-06 19:31:54 - INFO - SECCION: VIVERO
2026-02-06 19:31:54 - INFO - ==================================================
2026-02-06 19:31:54 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 19:31:54 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:31:54 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 19:31:54 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 19:31:54 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 19:31:54 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:31:54 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 19:31:54 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 19:31:54 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:31:54 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:31:54 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:31:58 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:31:58 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:31:58 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:31:58 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:31:58 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:31:58 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:31:58 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 19:31:58 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:31:58 - DEBUG -   maf: 10970 registros
2026-02-06 19:31:58 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:31:58 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:31:58 - DEBUG -   interior: 3624 registros
2026-02-06 19:31:58 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:31:58 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:31:58 - DEBUG -   vivero: 2460 registros
2026-02-06 19:31:58 - DEBUG -   fitos: 1987 registros
2026-02-06 19:31:58 - DEBUG -   semillas: 1180 registros
2026-02-06 19:31:58 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:31:58 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:31:58 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 19:31:58 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 19:31:58 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:31:58 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:32:00 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:00 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:32:00 - INFO - Costes cargados: 22145 registros
2026-02-06 19:32:00 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:32:00 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:32:00 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 19:32:00 - INFO -   ABC: 565 registros
2026-02-06 19:32:00 - INFO -   Ventas: 2460 registros
2026-02-06 19:32:00 - INFO -   Costes: 22145 registros
2026-02-06 19:32:00 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 19:32:00 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 19:32:00 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:32:00 - INFO - Datos de ventas: 189 registros
2026-02-06 19:32:00 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 19:32:01 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 19:32:01 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:32:01 - INFO -   Factor total: 1.3125
2026-02-06 19:32:01 - INFO -   Factor escalado: 1.6886
2026-02-06 19:32:01 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 19:32:01 - INFO -   Objetivo final: 6952.54€
2026-02-06 19:32:01 - INFO -   Delta: 1809.40€
2026-02-06 19:32:01 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:32:01 - DEBUG -   Total registros: 107
2026-02-06 19:32:01 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 19:32:01 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 19:32:01 - INFO -   Ventas finales: 6990.51€
2026-02-06 19:32:01 - INFO - 
============================================================
2026-02-06 19:32:01 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:32:01 - INFO - ============================================================
2026-02-06 19:32:01 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:32:01 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:32:01 - INFO - DataLoader inicializado correctamente
2026-02-06 19:32:01 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:32:01 - INFO - ============================================================
2026-02-06 19:32:01 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:32:01 - INFO - ============================================================
2026-02-06 19:32:01 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:32:01 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:32:01 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:01 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:01 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:01 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:01 - DEBUG - Usando hoja: Stock
2026-02-06 19:32:01 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:32:01 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:32:01 - INFO -   Stock: 30 registros
2026-02-06 19:32:01 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:32:01 - INFO - Fusión completada: 107 registros
2026-02-06 19:32:01 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:32:01 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:32:01 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:32:01 - INFO - 
============================================================
2026-02-06 19:32:01 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:32:01 - INFO - ============================================================
2026-02-06 19:32:01 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:32:01 - INFO - Corrección completada:
2026-02-06 19:32:01 - INFO -   - Artículos corregidos: 96/107
2026-02-06 19:32:01 - INFO -   - Artículos aumentados: 96
2026-02-06 19:32:01 - INFO -   - Artículos reducidos: 0
2026-02-06 19:32:01 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:32:01 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:32:01 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:32:01 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 19:32:01 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:32:01 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:32:01 - DEBUG -   Con valor 0: 11
2026-02-06 19:32:01 - DEBUG -   Con valor > 0: 96
2026-02-06 19:32:01 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 19:32:01 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 96 registros
2026-02-06 19:32:01 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 19:32:01 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 19:32:01 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 19:32:01 - INFO -   Articulos: 96
2026-02-06 19:32:01 - INFO -   Importe: 6990.51€
2026-02-06 19:32:01 - INFO - 
==================================================
2026-02-06 19:32:01 - INFO - SECCION: UTILES_JARDIN
2026-02-06 19:32:01 - INFO - ==================================================
2026-02-06 19:32:01 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 19:32:01 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:32:01 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 19:32:01 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 19:32:01 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 19:32:01 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:32:01 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 19:32:01 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 19:32:01 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:32:01 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:32:01 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:32:05 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:05 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:32:05 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:32:05 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:32:05 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:32:05 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:32:05 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 19:32:05 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:32:05 - DEBUG -   maf: 10970 registros
2026-02-06 19:32:05 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:32:05 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:32:05 - DEBUG -   interior: 3624 registros
2026-02-06 19:32:05 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:32:05 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:32:05 - DEBUG -   vivero: 2460 registros
2026-02-06 19:32:05 - DEBUG -   fitos: 1987 registros
2026-02-06 19:32:05 - DEBUG -   semillas: 1180 registros
2026-02-06 19:32:05 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:32:05 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:32:05 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 19:32:05 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 19:32:05 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:32:05 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:32:07 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:07 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:32:07 - INFO - Costes cargados: 22145 registros
2026-02-06 19:32:07 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:32:07 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:32:07 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 19:32:07 - INFO -   ABC: 433 registros
2026-02-06 19:32:07 - INFO -   Ventas: 1009 registros
2026-02-06 19:32:07 - INFO -   Costes: 22145 registros
2026-02-06 19:32:07 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 19:32:07 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 19:32:07 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:32:07 - INFO - Datos de ventas: 89 registros
2026-02-06 19:32:07 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 19:32:07 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 19:32:07 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:32:07 - INFO -   Factor total: 1.3125
2026-02-06 19:32:07 - INFO -   Factor escalado: 1.6747
2026-02-06 19:32:07 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 19:32:07 - INFO -   Objetivo final: 1371.26€
2026-02-06 19:32:07 - INFO -   Delta: 558.30€
2026-02-06 19:32:07 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:32:07 - DEBUG -   Total registros: 78
2026-02-06 19:32:07 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 19:32:07 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 19:32:07 - INFO -   Ventas finales: 1390.00€
2026-02-06 19:32:07 - INFO - 
============================================================
2026-02-06 19:32:07 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:32:07 - INFO - ============================================================
2026-02-06 19:32:07 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:32:07 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:32:07 - INFO - DataLoader inicializado correctamente
2026-02-06 19:32:07 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:32:07 - INFO - ============================================================
2026-02-06 19:32:07 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:32:07 - INFO - ============================================================
2026-02-06 19:32:07 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:32:07 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:32:07 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:07 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:07 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:07 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:07 - DEBUG - Usando hoja: Stock
2026-02-06 19:32:07 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:32:07 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:32:07 - INFO -   Stock: 30 registros
2026-02-06 19:32:07 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:32:07 - INFO - Fusión completada: 78 registros
2026-02-06 19:32:07 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:32:07 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:32:07 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:32:07 - INFO - 
============================================================
2026-02-06 19:32:07 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:32:07 - INFO - ============================================================
2026-02-06 19:32:07 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:32:07 - INFO - Corrección completada:
2026-02-06 19:32:07 - INFO -   - Artículos corregidos: 78/78
2026-02-06 19:32:07 - INFO -   - Artículos aumentados: 78
2026-02-06 19:32:07 - INFO -   - Artículos reducidos: 0
2026-02-06 19:32:07 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:32:07 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:32:07 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:32:07 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 19:32:07 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:32:07 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:32:07 - DEBUG -   Con valor 0: 0
2026-02-06 19:32:07 - DEBUG -   Con valor > 0: 78
2026-02-06 19:32:07 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 19:32:07 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 78 registros
2026-02-06 19:32:07 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 19:32:07 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 19:32:07 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 19:32:07 - INFO -   Articulos: 78
2026-02-06 19:32:07 - INFO -   Importe: 1390.00€
2026-02-06 19:32:07 - INFO - 
==================================================
2026-02-06 19:32:07 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 19:32:07 - INFO - ==================================================
2026-02-06 19:32:07 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 19:32:07 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:32:07 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 19:32:07 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 19:32:07 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 19:32:07 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:32:07 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 19:32:07 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 19:32:07 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:32:07 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:32:07 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:32:11 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:11 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:32:11 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:32:11 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:32:11 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:32:11 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:32:11 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 19:32:11 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:32:11 - DEBUG -   maf: 10970 registros
2026-02-06 19:32:11 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:32:11 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:32:11 - DEBUG -   interior: 3624 registros
2026-02-06 19:32:11 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:32:11 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:32:11 - DEBUG -   vivero: 2460 registros
2026-02-06 19:32:11 - DEBUG -   fitos: 1987 registros
2026-02-06 19:32:11 - DEBUG -   semillas: 1180 registros
2026-02-06 19:32:11 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:32:11 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:32:11 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 19:32:11 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 19:32:11 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:32:11 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:32:13 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:13 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:32:13 - INFO - Costes cargados: 22145 registros
2026-02-06 19:32:13 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:32:13 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:32:13 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 19:32:13 - INFO -   ABC: 247 registros
2026-02-06 19:32:13 - INFO -   Ventas: 3264 registros
2026-02-06 19:32:13 - INFO -   Costes: 22145 registros
2026-02-06 19:32:13 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 19:32:13 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 19:32:13 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:32:13 - INFO - Datos de ventas: 302 registros
2026-02-06 19:32:13 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 19:32:14 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 19:32:14 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:32:14 - INFO -   Factor total: 1.3125
2026-02-06 19:32:14 - INFO -   Factor escalado: 1.3380
2026-02-06 19:32:14 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 19:32:14 - INFO -   Objetivo final: 5377.63€
2026-02-06 19:32:14 - INFO -   Delta: 432.03€
2026-02-06 19:32:14 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:32:14 - DEBUG -   Total registros: 72
2026-02-06 19:32:14 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 19:32:14 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 19:32:14 - INFO -   Ventas finales: 5387.14€
2026-02-06 19:32:14 - INFO - 
============================================================
2026-02-06 19:32:14 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:32:14 - INFO - ============================================================
2026-02-06 19:32:14 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:32:14 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:32:14 - INFO - DataLoader inicializado correctamente
2026-02-06 19:32:14 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:32:14 - INFO - ============================================================
2026-02-06 19:32:14 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:32:14 - INFO - ============================================================
2026-02-06 19:32:14 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:32:14 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:32:14 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:14 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:14 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:14 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:14 - DEBUG - Usando hoja: Stock
2026-02-06 19:32:14 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:32:14 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:32:14 - INFO -   Stock: 30 registros
2026-02-06 19:32:14 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:32:14 - INFO - Fusión completada: 72 registros
2026-02-06 19:32:14 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:32:14 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:32:14 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:32:14 - INFO - 
============================================================
2026-02-06 19:32:14 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:32:14 - INFO - ============================================================
2026-02-06 19:32:14 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:32:14 - INFO - Corrección completada:
2026-02-06 19:32:14 - INFO -   - Artículos corregidos: 71/72
2026-02-06 19:32:14 - INFO -   - Artículos aumentados: 71
2026-02-06 19:32:14 - INFO -   - Artículos reducidos: 0
2026-02-06 19:32:14 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:32:14 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:32:14 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:32:14 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 19:32:14 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:32:14 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:32:14 - DEBUG -   Con valor 0: 1
2026-02-06 19:32:14 - DEBUG -   Con valor > 0: 71
2026-02-06 19:32:14 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 19:32:14 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 71 registros
2026-02-06 19:32:14 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 19:32:14 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 19:32:14 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 19:32:14 - INFO -   Articulos: 71
2026-02-06 19:32:14 - INFO -   Importe: 5387.14€
2026-02-06 19:32:14 - INFO - 
==================================================
2026-02-06 19:32:14 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 19:32:14 - INFO - ==================================================
2026-02-06 19:32:14 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 19:32:14 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 19:32:14 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 19:32:14 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 19:32:14 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 19:32:14 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 19:32:14 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 19:32:14 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 19:32:14 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 19:32:14 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 19:32:14 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 19:32:18 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:18 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 19:32:18 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 19:32:18 - INFO - Ventas cargadas: 44082 registros
2026-02-06 19:32:18 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 19:32:18 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 19:32:18 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 19:32:18 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 19:32:18 - DEBUG -   maf: 10970 registros
2026-02-06 19:32:18 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 19:32:18 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 19:32:18 - DEBUG -   interior: 3624 registros
2026-02-06 19:32:18 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 19:32:18 - DEBUG -   deco_interior: 2468 registros
2026-02-06 19:32:18 - DEBUG -   vivero: 2460 registros
2026-02-06 19:32:18 - DEBUG -   fitos: 1987 registros
2026-02-06 19:32:18 - DEBUG -   semillas: 1180 registros
2026-02-06 19:32:18 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 19:32:18 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 19:32:18 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 19:32:18 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 19:32:18 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 19:32:18 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 19:32:20 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:20 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 19:32:20 - INFO - Costes cargados: 22145 registros
2026-02-06 19:32:20 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 19:32:20 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 19:32:20 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 19:32:20 - INFO -   ABC: 995 registros
2026-02-06 19:32:20 - INFO -   Ventas: 4018 registros
2026-02-06 19:32:20 - INFO -   Costes: 22145 registros
2026-02-06 19:32:20 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 19:32:20 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 19:32:20 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 19:32:20 - INFO - Datos de ventas: 316 registros
2026-02-06 19:32:20 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 19:32:21 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 19:32:21 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 19:32:21 - INFO -   Factor total: 1.3125
2026-02-06 19:32:21 - INFO -   Factor escalado: 1.1960
2026-02-06 19:32:21 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 19:32:21 - INFO -   Objetivo final: 4909.20€
2026-02-06 19:32:21 - INFO -   Delta: 1185.39€
2026-02-06 19:32:21 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 19:32:21 - DEBUG -   Total registros: 224
2026-02-06 19:32:21 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 19:32:21 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 19:32:21 - INFO -   Ventas finales: 4923.89€
2026-02-06 19:32:21 - INFO - 
============================================================
2026-02-06 19:32:21 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 19:32:21 - INFO - ============================================================
2026-02-06 19:32:21 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 19:32:21 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 19:32:21 - INFO - DataLoader inicializado correctamente
2026-02-06 19:32:21 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 19:32:21 - INFO - ============================================================
2026-02-06 19:32:21 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 19:32:21 - INFO - ============================================================
2026-02-06 19:32:21 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 19:32:21 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 19:32:21 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:21 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:21 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 19:32:21 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 19:32:21 - DEBUG - Usando hoja: Stock
2026-02-06 19:32:21 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 19:32:21 - INFO - Stock actual cargado: 30 registros
2026-02-06 19:32:21 - INFO -   Stock: 30 registros
2026-02-06 19:32:21 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 19:32:21 - INFO - Fusión completada: 224 registros
2026-02-06 19:32:21 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 19:32:21 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 19:32:21 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 19:32:21 - INFO - 
============================================================
2026-02-06 19:32:21 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 19:32:21 - INFO - ============================================================
2026-02-06 19:32:21 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 19:32:21 - INFO - Corrección completada:
2026-02-06 19:32:21 - INFO -   - Artículos corregidos: 205/224
2026-02-06 19:32:21 - INFO -   - Artículos aumentados: 205
2026-02-06 19:32:21 - INFO -   - Artículos reducidos: 0
2026-02-06 19:32:21 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 19:32:21 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 19:32:21 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 19:32:21 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 19:32:21 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 19:32:21 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 19:32:21 - DEBUG -   Con valor 0: 19
2026-02-06 19:32:21 - DEBUG -   Con valor > 0: 205
2026-02-06 19:32:21 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 19:32:21 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 205 registros
2026-02-06 19:32:21 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 19:32:21 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 19:32:21 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 19:32:21 - INFO -   Articulos: 205
2026-02-06 19:32:21 - INFO -   Importe: 4923.89€
2026-02-06 19:32:21 - INFO - Estado guardado correctamente
2026-02-06 19:32:21 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 19:32:21 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 19:32:21 - INFO - Estado guardado correctamente
2026-02-06 19:32:21 - INFO - 
============================================================
2026-02-06 19:32:21 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 19:32:21 - INFO - ============================================================
2026-02-06 19:32:21 - DEBUG - [DEBUG] Archivos agrupados por sección: {'maf': ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx'], 'interior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx'], 'semillas': ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx'], 'vivo': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx'], 'manufacturado': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx'], 'fitos': ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx'], 'vivero': ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx'], 'jardin': ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx'], 'aridos': ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx'], 'exterior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']}
2026-02-06 19:32:21 - INFO - 
============================================================
2026-02-06 19:32:21 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 19:32:21 - INFO - ============================================================
2026-02-06 19:32:21 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 19:32:21 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 19:32:21 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 19:32:21 - INFO - EmailService inicializado correctamente
2026-02-06 19:32:21 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 19:32:21 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 19:32:21 - INFO - 
Enviando email para sección: maf
2026-02-06 19:32:21 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx']
2026-02-06 19:32:21 - DEBUG - Destinatarios para maf: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 19:32:21 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 19:32:21 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 19:32:21 - INFO - Email enviado para sección maf (semana 14)
2026-02-06 19:32:21 - ERROR - ✗ Error al enviar email a maf: None
2026-02-06 19:32:21 - INFO - 
Enviando email para sección: interior
2026-02-06 19:32:21 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx']
2026-02-06 19:32:21 - DEBUG - Destinatarios para interior: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Iris'}]
2026-02-06 19:32:22 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 19:32:22 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 19:32:22 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 19:32:22 - INFO - Email enviado para sección interior (semana 14)
2026-02-06 19:32:22 - ERROR - ✗ Error al enviar email a interior: None
2026-02-06 19:32:22 - INFO - 
Enviando email para sección: semillas
2026-02-06 19:32:22 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx']
2026-02-06 19:32:22 - DEBUG - Destinatarios para semillas: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 19:32:22 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 19:32:22 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 19:32:22 - INFO - Email enviado para sección semillas (semana 14)
2026-02-06 19:32:22 - ERROR - ✗ Error al enviar email a semillas: None
2026-02-06 19:32:22 - INFO - 
Enviando email para sección: vivo
2026-02-06 19:32:22 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx']
2026-02-06 19:32:22 - WARNING - No hay destinatarios configurados para la sección: vivo
2026-02-06 19:32:22 - WARNING - No se puede enviar email para vivo: No hay destinatarios configurados
2026-02-06 19:32:22 - ERROR - ✗ Error al enviar email a vivo: No hay destinatarios configurados
2026-02-06 19:32:22 - INFO - 
Enviando email para sección: manufacturado
2026-02-06 19:32:22 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx']
2026-02-06 19:32:22 - WARNING - No hay destinatarios configurados para la sección: manufacturado
2026-02-06 19:32:22 - WARNING - No se puede enviar email para manufacturado: No hay destinatarios configurados
2026-02-06 19:32:22 - ERROR - ✗ Error al enviar email a manufacturado: No hay destinatarios configurados
2026-02-06 19:32:22 - INFO - 
Enviando email para sección: fitos
2026-02-06 19:32:22 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx']
2026-02-06 19:32:22 - DEBUG - Destinatarios para fitos: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 19:32:22 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 19:32:23 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 19:32:23 - INFO - Email enviado para sección fitos (semana 14)
2026-02-06 19:32:23 - ERROR - ✗ Error al enviar email a fitos: None
2026-02-06 19:32:23 - INFO - 
Enviando email para sección: vivero
2026-02-06 19:32:23 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx']
2026-02-06 19:32:23 - DEBUG - Destinatarios para vivero: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 19:32:23 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 19:32:23 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 19:32:23 - INFO - Email enviado para sección vivero (semana 14)
2026-02-06 19:32:23 - ERROR - ✗ Error al enviar email a vivero: None
2026-02-06 19:32:23 - INFO - 
Enviando email para sección: jardin
2026-02-06 19:32:23 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx']
2026-02-06 19:32:23 - WARNING - No hay destinatarios configurados para la sección: jardin
2026-02-06 19:32:23 - WARNING - No se puede enviar email para jardin: No hay destinatarios configurados
2026-02-06 19:32:23 - ERROR - ✗ Error al enviar email a jardin: No hay destinatarios configurados
2026-02-06 19:32:23 - INFO - 
Enviando email para sección: aridos
2026-02-06 19:32:23 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx']
2026-02-06 19:32:23 - WARNING - No hay destinatarios configurados para la sección: aridos
2026-02-06 19:32:23 - WARNING - No se puede enviar email para aridos: No hay destinatarios configurados
2026-02-06 19:32:23 - ERROR - ✗ Error al enviar email a aridos: No hay destinatarios configurados
2026-02-06 19:32:23 - INFO - 
Enviando email para sección: exterior
2026-02-06 19:32:23 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']
2026-02-06 19:32:23 - WARNING - No hay destinatarios configurados para la sección: exterior
2026-02-06 19:32:23 - WARNING - No se puede enviar email para exterior: No hay destinatarios configurados
2026-02-06 19:32:23 - ERROR - ✗ Error al enviar email a exterior: No hay destinatarios configurados
2026-02-06 19:32:23 - INFO - 
============================================================
2026-02-06 19:32:23 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 19:32:23 - INFO - ============================================================
2026-02-06 19:32:23 - INFO - Emails enviados exitosamente: 0
2026-02-06 19:32:23 - INFO - Emails fallidos: 10
2026-02-06 19:32:23 - INFO - Secciones procesadas: 10
2026-02-06 19:32:23 - INFO - 
============================================================
2026-02-06 19:32:23 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 19:32:23 - INFO - ============================================================
2026-02-06 19:32:23 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 19:32:23 - INFO - 
============================================================
2026-02-06 19:32:23 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 19:32:23 - INFO - ============================================================
2026-02-06 19:32:23 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 19:32:23 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 19:32:23 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 19:32:23 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 19:32:23 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 19:32:23 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 19:32:23 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 19:32:24 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 19:32:24 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 19:32:24 - INFO - 
============================================================
2026-02-06 19:32:24 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 19:32:24 - INFO - ============================================================
2026-02-06 19:32:24 - INFO - Emails enviados: 3
2026-02-06 19:32:24 - INFO - Emails fallidos: 0
2026-02-06 19:32:24 - INFO - 
======================================================================
2026-02-06 19:32:24 - INFO - RESUMEN DE EJECUCION
2026-02-06 19:32:24 - INFO - ======================================================================
2026-02-06 19:32:24 - INFO - Semana procesada: 14
2026-02-06 19:32:24 - INFO - Archivos generados: 12
2026-02-06 19:32:24 - INFO - Total articulos: 1510
2026-02-06 19:32:24 - INFO - Total importe: 48115.81€
2026-02-06 19:32:24 - WARNING - 
✗ EMAILS FALLIDOS: 10
2026-02-06 19:32:24 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 19:32:24 - INFO - ======================================================================
2026-02-06 19:32:24 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 19:32:24 - INFO - Archivo principal: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 19:32:24 - INFO - Artículos: 1510
2026-02-06 19:32:24 - INFO - Importe: 48115.81€
2026-02-06 19:32:24 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 20:00:46 - INFO - ======================================================================
2026-02-06 20:00:46 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 20:00:46 - INFO - Fecha de ejecución: 2026-02-06 20:00:46
2026-02-06 20:00:46 - INFO - ======================================================================
2026-02-06 20:00:46 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 20:00:46 - INFO - Envío de emails: Sí
2026-02-06 20:00:46 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 20:00:46 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 20:00:46 - INFO - Estado cargado correctamente
2026-02-06 20:00:46 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:00:46 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:00:46 - INFO - Semana forzada por argumento: 14
2026-02-06 20:00:46 - INFO - ======================================================================
2026-02-06 20:00:46 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 20:00:46 - INFO - ======================================================================
2026-02-06 20:00:46 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 20:00:46 - INFO - DataLoader inicializado correctamente
2026-02-06 20:00:46 - INFO - ForecastEngine inicializado correctamente
2026-02-06 20:00:46 - INFO - OrderGenerator inicializado correctamente
2026-02-06 20:00:46 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:00:46 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:00:46 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 20:00:46 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 20:00:46 - INFO - 
==================================================
2026-02-06 20:00:46 - INFO - SECCION: MAF
2026-02-06 20:00:46 - INFO - ==================================================
2026-02-06 20:00:46 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 20:00:46 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:00:46 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 20:00:46 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:00:46 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:00:47 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:00:47 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 20:00:47 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 20:00:47 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:00:47 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:00:47 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:00:50 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:00:50 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:00:50 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:00:50 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:00:50 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:00:50 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:00:50 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 20:00:51 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:00:51 - DEBUG -   maf: 10970 registros
2026-02-06 20:00:51 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:00:51 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:00:51 - DEBUG -   interior: 3624 registros
2026-02-06 20:00:51 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:00:51 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:00:51 - DEBUG -   vivero: 2460 registros
2026-02-06 20:00:51 - DEBUG -   fitos: 1987 registros
2026-02-06 20:00:51 - DEBUG -   semillas: 1180 registros
2026-02-06 20:00:51 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:00:51 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:00:51 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 20:00:51 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 20:00:51 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:00:51 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:00:52 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:00:52 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:00:53 - INFO - Costes cargados: 22145 registros
2026-02-06 20:00:53 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:00:53 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:00:53 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 20:00:53 - INFO -   ABC: 499 registros
2026-02-06 20:00:53 - INFO -   Ventas: 10970 registros
2026-02-06 20:00:53 - INFO -   Costes: 22145 registros
2026-02-06 20:00:53 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 20:00:53 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 20:00:53 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:00:53 - INFO - Datos de ventas: 1011 registros
2026-02-06 20:00:53 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 20:00:53 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 20:00:53 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:00:53 - INFO -   Factor total: 1.3125
2026-02-06 20:00:53 - INFO -   Factor escalado: 1.5844
2026-02-06 20:00:53 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 20:00:53 - INFO -   Objetivo final: 9253.98€
2026-02-06 20:00:53 - INFO -   Delta: 679.77€
2026-02-06 20:00:53 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:00:53 - DEBUG -   Total registros: 222
2026-02-06 20:00:53 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 20:00:53 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 20:00:53 - INFO -   Ventas finales: 9254.53€
2026-02-06 20:00:53 - INFO - 
============================================================
2026-02-06 20:00:53 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:00:53 - INFO - ============================================================
2026-02-06 20:00:53 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:00:53 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:00:53 - INFO - DataLoader inicializado correctamente
2026-02-06 20:00:53 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:00:53 - INFO - ============================================================
2026-02-06 20:00:53 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:00:53 - INFO - ============================================================
2026-02-06 20:00:53 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:00:53 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:00:53 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:00:53 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:00:53 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:00:53 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:00:53 - DEBUG - Usando hoja: Stock
2026-02-06 20:00:53 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:00:53 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:00:53 - INFO -   Stock: 30 registros
2026-02-06 20:00:53 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:00:53 - INFO - Fusión completada: 222 registros
2026-02-06 20:00:53 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:00:53 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:00:53 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:00:53 - INFO - 
============================================================
2026-02-06 20:00:53 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:00:53 - INFO - ============================================================
2026-02-06 20:00:53 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:00:53 - INFO - Corrección completada:
2026-02-06 20:00:53 - INFO -   - Artículos corregidos: 191/222
2026-02-06 20:00:53 - INFO -   - Artículos aumentados: 191
2026-02-06 20:00:53 - INFO -   - Artículos reducidos: 0
2026-02-06 20:00:53 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:00:53 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:00:53 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:00:53 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 20:00:53 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:00:53 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:00:53 - DEBUG -   Con valor 0: 31
2026-02-06 20:00:53 - DEBUG -   Con valor > 0: 191
2026-02-06 20:00:53 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 20:00:53 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 191 registros
2026-02-06 20:00:53 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:00:53 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:00:53 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:00:53 - INFO -   Articulos: 191
2026-02-06 20:00:53 - INFO -   Importe: 9254.53€
2026-02-06 20:00:53 - INFO - 
==================================================
2026-02-06 20:00:53 - INFO - SECCION: DECO_INTERIOR
2026-02-06 20:00:53 - INFO - ==================================================
2026-02-06 20:00:53 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 20:00:53 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:00:53 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 20:00:53 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:00:53 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:00:54 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:00:54 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 20:00:54 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 20:00:54 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:00:54 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:00:54 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:00:58 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:00:58 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:00:58 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:00:58 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:00:58 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:00:58 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:00:58 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 20:00:58 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:00:58 - DEBUG -   maf: 10970 registros
2026-02-06 20:00:58 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:00:58 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:00:58 - DEBUG -   interior: 3624 registros
2026-02-06 20:00:58 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:00:58 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:00:58 - DEBUG -   vivero: 2460 registros
2026-02-06 20:00:58 - DEBUG -   fitos: 1987 registros
2026-02-06 20:00:58 - DEBUG -   semillas: 1180 registros
2026-02-06 20:00:58 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:00:58 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:00:58 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 20:00:58 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 20:00:58 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:00:58 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:00 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:00 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:00 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:00 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:00 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:00 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 20:01:00 - INFO -   ABC: 1827 registros
2026-02-06 20:01:00 - INFO -   Ventas: 2468 registros
2026-02-06 20:01:00 - INFO -   Costes: 22145 registros
2026-02-06 20:01:00 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 20:01:00 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 20:01:00 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:00 - INFO - Datos de ventas: 180 registros
2026-02-06 20:01:00 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 20:01:01 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 20:01:01 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:01 - INFO -   Factor total: 1.3125
2026-02-06 20:01:01 - INFO -   Factor escalado: 1.5747
2026-02-06 20:01:01 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 20:01:01 - INFO -   Objetivo final: 2576.42€
2026-02-06 20:01:01 - INFO -   Delta: 373.59€
2026-02-06 20:01:01 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:01 - DEBUG -   Total registros: 139
2026-02-06 20:01:01 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 20:01:01 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 20:01:01 - INFO -   Ventas finales: 2580.73€
2026-02-06 20:01:01 - INFO - 
============================================================
2026-02-06 20:01:01 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:01 - INFO - ============================================================
2026-02-06 20:01:01 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:01 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:01 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:01 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:01 - INFO - ============================================================
2026-02-06 20:01:01 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:01 - INFO - ============================================================
2026-02-06 20:01:01 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:01 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:01 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:01 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:01 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:01 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:01 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:01 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:01 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:01 - INFO -   Stock: 30 registros
2026-02-06 20:01:01 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:01 - INFO - Fusión completada: 139 registros
2026-02-06 20:01:01 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:01 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:01 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:01 - INFO - 
============================================================
2026-02-06 20:01:01 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:01 - INFO - ============================================================
2026-02-06 20:01:01 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:01 - INFO - Corrección completada:
2026-02-06 20:01:01 - INFO -   - Artículos corregidos: 135/139
2026-02-06 20:01:01 - INFO -   - Artículos aumentados: 135
2026-02-06 20:01:01 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:01 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:01 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:01 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:01 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 20:01:01 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:01 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:01 - DEBUG -   Con valor 0: 4
2026-02-06 20:01:01 - DEBUG -   Con valor > 0: 135
2026-02-06 20:01:01 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 20:01:01 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 135 registros
2026-02-06 20:01:01 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:01:01 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:01:01 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:01:01 - INFO -   Articulos: 135
2026-02-06 20:01:01 - INFO -   Importe: 2580.73€
2026-02-06 20:01:01 - INFO - 
==================================================
2026-02-06 20:01:01 - INFO - SECCION: SEMILLAS
2026-02-06 20:01:01 - INFO - ==================================================
2026-02-06 20:01:01 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 20:01:01 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:01 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 20:01:01 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:01:01 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:01:01 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:01 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 20:01:01 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 20:01:01 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:01 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:01 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:01:05 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:05 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:01:05 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:01:05 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:01:05 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:01:05 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:01:05 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 20:01:05 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:01:05 - DEBUG -   maf: 10970 registros
2026-02-06 20:01:05 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:01:05 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:01:05 - DEBUG -   interior: 3624 registros
2026-02-06 20:01:05 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:01:05 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:01:05 - DEBUG -   vivero: 2460 registros
2026-02-06 20:01:05 - DEBUG -   fitos: 1987 registros
2026-02-06 20:01:05 - DEBUG -   semillas: 1180 registros
2026-02-06 20:01:05 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:01:05 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:01:05 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 20:01:05 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 20:01:05 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:01:05 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:07 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:07 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:07 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:07 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:07 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:07 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 20:01:07 - INFO -   ABC: 218 registros
2026-02-06 20:01:07 - INFO -   Ventas: 1180 registros
2026-02-06 20:01:07 - INFO -   Costes: 22145 registros
2026-02-06 20:01:07 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 20:01:07 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 20:01:07 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:07 - INFO - Datos de ventas: 136 registros
2026-02-06 20:01:07 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 20:01:07 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 20:01:07 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:07 - INFO -   Factor total: 1.3125
2026-02-06 20:01:07 - INFO -   Factor escalado: 2.0023
2026-02-06 20:01:07 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 20:01:07 - INFO -   Objetivo final: 911.32€
2026-02-06 20:01:07 - INFO -   Delta: 217.83€
2026-02-06 20:01:07 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:07 - DEBUG -   Total registros: 84
2026-02-06 20:01:07 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 20:01:07 - DEBUG -   Ventas finales: 911.60€
2026-02-06 20:01:07 - INFO -   Ventas finales: 911.60€
2026-02-06 20:01:07 - INFO - 
============================================================
2026-02-06 20:01:07 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:07 - INFO - ============================================================
2026-02-06 20:01:07 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:07 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:07 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:07 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:07 - INFO - ============================================================
2026-02-06 20:01:07 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:07 - INFO - ============================================================
2026-02-06 20:01:07 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:07 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:07 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:07 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:07 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:07 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:07 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:07 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:07 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:07 - INFO -   Stock: 30 registros
2026-02-06 20:01:07 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:07 - INFO - Fusión completada: 84 registros
2026-02-06 20:01:07 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:07 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:07 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:07 - INFO - 
============================================================
2026-02-06 20:01:07 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:07 - INFO - ============================================================
2026-02-06 20:01:07 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:07 - INFO - Corrección completada:
2026-02-06 20:01:07 - INFO -   - Artículos corregidos: 84/84
2026-02-06 20:01:07 - INFO -   - Artículos aumentados: 84
2026-02-06 20:01:07 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:07 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:07 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:07 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:07 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:01:07 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:07 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:07 - DEBUG -   Con valor 0: 0
2026-02-06 20:01:07 - DEBUG -   Con valor > 0: 84
2026-02-06 20:01:07 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 20:01:07 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 84 registros
2026-02-06 20:01:07 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:01:07 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:01:07 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:01:07 - INFO -   Articulos: 84
2026-02-06 20:01:07 - INFO -   Importe: 911.60€
2026-02-06 20:01:07 - INFO - 
==================================================
2026-02-06 20:01:07 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 20:01:07 - INFO - ==================================================
2026-02-06 20:01:07 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 20:01:07 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:07 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 20:01:07 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:01:07 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:01:07 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:07 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 20:01:07 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 20:01:07 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:07 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:07 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:01:11 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:11 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:01:11 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:01:11 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:01:11 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:01:11 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:01:11 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 20:01:11 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:01:11 - DEBUG -   maf: 10970 registros
2026-02-06 20:01:11 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:01:11 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:01:11 - DEBUG -   interior: 3624 registros
2026-02-06 20:01:11 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:01:11 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:01:11 - DEBUG -   vivero: 2460 registros
2026-02-06 20:01:11 - DEBUG -   fitos: 1987 registros
2026-02-06 20:01:11 - DEBUG -   semillas: 1180 registros
2026-02-06 20:01:11 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:01:11 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:01:11 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 20:01:11 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 20:01:11 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:01:11 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:13 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:13 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:14 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:14 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:14 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:14 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 20:01:14 - INFO -   ABC: 205 registros
2026-02-06 20:01:14 - INFO -   Ventas: 1124 registros
2026-02-06 20:01:14 - INFO -   Costes: 22145 registros
2026-02-06 20:01:14 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 20:01:14 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 20:01:14 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:14 - INFO - Datos de ventas: 88 registros
2026-02-06 20:01:14 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 20:01:14 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 20:01:14 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:14 - INFO -   Factor total: 1.3125
2026-02-06 20:01:14 - INFO -   Factor escalado: 1.6854
2026-02-06 20:01:14 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 20:01:14 - INFO -   Objetivo final: 1426.88€
2026-02-06 20:01:14 - INFO -   Delta: 346.78€
2026-02-06 20:01:14 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:14 - DEBUG -   Total registros: 43
2026-02-06 20:01:14 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 20:01:14 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 20:01:14 - INFO -   Ventas finales: 1455.34€
2026-02-06 20:01:14 - INFO - 
============================================================
2026-02-06 20:01:14 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:14 - INFO - ============================================================
2026-02-06 20:01:14 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:14 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:14 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:14 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:14 - INFO - ============================================================
2026-02-06 20:01:14 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:14 - INFO - ============================================================
2026-02-06 20:01:14 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:14 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:14 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:14 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:14 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:14 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:14 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:14 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:14 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:14 - INFO -   Stock: 30 registros
2026-02-06 20:01:14 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:14 - INFO - Fusión completada: 43 registros
2026-02-06 20:01:14 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:14 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:14 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:14 - INFO - 
============================================================
2026-02-06 20:01:14 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:14 - INFO - ============================================================
2026-02-06 20:01:14 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:14 - INFO - Corrección completada:
2026-02-06 20:01:14 - INFO -   - Artículos corregidos: 36/43
2026-02-06 20:01:14 - INFO -   - Artículos aumentados: 36
2026-02-06 20:01:14 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:14 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:14 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:14 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:14 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 20:01:14 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:14 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:14 - DEBUG -   Con valor 0: 7
2026-02-06 20:01:14 - DEBUG -   Con valor > 0: 36
2026-02-06 20:01:14 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 20:01:14 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 36 registros
2026-02-06 20:01:14 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:01:14 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:01:14 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:01:14 - INFO -   Articulos: 36
2026-02-06 20:01:14 - INFO -   Importe: 1455.34€
2026-02-06 20:01:14 - INFO - 
==================================================
2026-02-06 20:01:14 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 20:01:14 - INFO - ==================================================
2026-02-06 20:01:14 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 20:01:14 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:14 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 20:01:14 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:01:14 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:01:14 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:14 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 20:01:14 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 20:01:14 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:14 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:14 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:01:18 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:18 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:01:18 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:01:18 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:01:18 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:01:18 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:01:18 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 20:01:18 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:01:18 - DEBUG -   maf: 10970 registros
2026-02-06 20:01:18 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:01:18 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:01:18 - DEBUG -   interior: 3624 registros
2026-02-06 20:01:18 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:01:18 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:01:18 - DEBUG -   vivero: 2460 registros
2026-02-06 20:01:18 - DEBUG -   fitos: 1987 registros
2026-02-06 20:01:18 - DEBUG -   semillas: 1180 registros
2026-02-06 20:01:18 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:01:18 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:01:18 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 20:01:18 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 20:01:18 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:01:18 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:20 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:20 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:20 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:20 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:20 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:20 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 20:01:20 - INFO -   ABC: 2749 registros
2026-02-06 20:01:20 - INFO -   Ventas: 9784 registros
2026-02-06 20:01:20 - INFO -   Costes: 22145 registros
2026-02-06 20:01:20 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 20:01:20 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 20:01:20 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:20 - INFO - Datos de ventas: 822 registros
2026-02-06 20:01:20 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 20:01:22 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 20:01:22 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:22 - INFO -   Factor total: 1.3125
2026-02-06 20:01:22 - INFO -   Factor escalado: 1.0268
2026-02-06 20:01:22 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 20:01:22 - INFO -   Objetivo final: 8977.26€
2026-02-06 20:01:22 - INFO -   Delta: 3401.99€
2026-02-06 20:01:22 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:22 - DEBUG -   Total registros: 538
2026-02-06 20:01:22 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 20:01:22 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 20:01:22 - INFO -   Ventas finales: 8993.98€
2026-02-06 20:01:23 - INFO - 
============================================================
2026-02-06 20:01:23 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:23 - INFO - ============================================================
2026-02-06 20:01:23 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:23 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:23 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:23 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:23 - INFO - ============================================================
2026-02-06 20:01:23 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:23 - INFO - ============================================================
2026-02-06 20:01:23 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:23 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:23 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:23 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:23 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:23 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:23 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:23 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:23 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:23 - INFO -   Stock: 30 registros
2026-02-06 20:01:23 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:23 - INFO - Fusión completada: 538 registros
2026-02-06 20:01:23 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:23 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:23 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:23 - INFO - 
============================================================
2026-02-06 20:01:23 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:23 - INFO - ============================================================
2026-02-06 20:01:23 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:23 - INFO - Corrección completada:
2026-02-06 20:01:23 - INFO -   - Artículos corregidos: 411/538
2026-02-06 20:01:23 - INFO -   - Artículos aumentados: 411
2026-02-06 20:01:23 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:23 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:23 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:23 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:23 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 20:01:23 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:23 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:23 - DEBUG -   Con valor 0: 127
2026-02-06 20:01:23 - DEBUG -   Con valor > 0: 411
2026-02-06 20:01:23 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 20:01:23 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 411 registros
2026-02-06 20:01:23 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:01:23 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:01:23 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:01:23 - INFO -   Articulos: 411
2026-02-06 20:01:23 - INFO -   Importe: 8993.98€
2026-02-06 20:01:23 - INFO - 
==================================================
2026-02-06 20:01:23 - INFO - SECCION: INTERIOR
2026-02-06 20:01:23 - INFO - ==================================================
2026-02-06 20:01:23 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 20:01:23 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:23 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 20:01:23 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:01:23 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:01:23 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:23 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 20:01:23 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 20:01:23 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:23 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:23 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:01:27 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:27 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:01:27 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:01:27 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:01:27 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:01:27 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:01:27 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 20:01:27 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:01:27 - DEBUG -   maf: 10970 registros
2026-02-06 20:01:27 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:01:27 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:01:27 - DEBUG -   interior: 3624 registros
2026-02-06 20:01:27 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:01:27 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:01:27 - DEBUG -   vivero: 2460 registros
2026-02-06 20:01:27 - DEBUG -   fitos: 1987 registros
2026-02-06 20:01:27 - DEBUG -   semillas: 1180 registros
2026-02-06 20:01:27 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:01:27 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:01:27 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 20:01:27 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 20:01:27 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:01:27 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:29 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:29 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:29 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:29 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:29 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:29 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 20:01:29 - INFO -   ABC: 555 registros
2026-02-06 20:01:29 - INFO -   Ventas: 3624 registros
2026-02-06 20:01:29 - INFO -   Costes: 22145 registros
2026-02-06 20:01:29 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 20:01:29 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 20:01:29 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:29 - INFO - Datos de ventas: 286 registros
2026-02-06 20:01:29 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 20:01:29 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 20:01:29 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:29 - INFO -   Factor total: 1.3125
2026-02-06 20:01:29 - INFO -   Factor escalado: 1.5971
2026-02-06 20:01:29 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 20:01:29 - INFO -   Objetivo final: 3846.45€
2026-02-06 20:01:29 - INFO -   Delta: 685.37€
2026-02-06 20:01:29 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:29 - DEBUG -   Total registros: 138
2026-02-06 20:01:29 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 20:01:29 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 20:01:29 - INFO -   Ventas finales: 3862.17€
2026-02-06 20:01:29 - INFO - 
============================================================
2026-02-06 20:01:29 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:29 - INFO - ============================================================
2026-02-06 20:01:29 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:29 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:29 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:29 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:29 - INFO - ============================================================
2026-02-06 20:01:29 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:29 - INFO - ============================================================
2026-02-06 20:01:29 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:29 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:29 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:29 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:29 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:29 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:29 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:29 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:29 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:29 - INFO -   Stock: 30 registros
2026-02-06 20:01:29 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:30 - INFO - Fusión completada: 138 registros
2026-02-06 20:01:30 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:30 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:30 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:30 - INFO - 
============================================================
2026-02-06 20:01:30 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:30 - INFO - ============================================================
2026-02-06 20:01:30 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:30 - INFO - Corrección completada:
2026-02-06 20:01:30 - INFO -   - Artículos corregidos: 121/138
2026-02-06 20:01:30 - INFO -   - Artículos aumentados: 121
2026-02-06 20:01:30 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:30 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:30 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:30 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:30 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 20:01:30 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:30 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:30 - DEBUG -   Con valor 0: 17
2026-02-06 20:01:30 - DEBUG -   Con valor > 0: 121
2026-02-06 20:01:30 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 20:01:30 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 121 registros
2026-02-06 20:01:30 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:01:30 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:01:30 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:01:30 - INFO -   Articulos: 121
2026-02-06 20:01:30 - INFO -   Importe: 3862.17€
2026-02-06 20:01:30 - INFO - 
==================================================
2026-02-06 20:01:30 - INFO - SECCION: FITOS
2026-02-06 20:01:30 - INFO - ==================================================
2026-02-06 20:01:30 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 20:01:30 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:30 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 20:01:30 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:01:30 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:01:30 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:30 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 20:01:30 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:01:30 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:30 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:30 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:01:34 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:34 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:01:34 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:01:34 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:01:34 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:01:34 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:01:34 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 20:01:34 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:01:34 - DEBUG -   maf: 10970 registros
2026-02-06 20:01:34 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:01:34 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:01:34 - DEBUG -   interior: 3624 registros
2026-02-06 20:01:34 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:01:34 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:01:34 - DEBUG -   vivero: 2460 registros
2026-02-06 20:01:34 - DEBUG -   fitos: 1987 registros
2026-02-06 20:01:34 - DEBUG -   semillas: 1180 registros
2026-02-06 20:01:34 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:01:34 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:01:34 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 20:01:34 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 20:01:34 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:01:34 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:36 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:36 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:36 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:36 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:36 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:36 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 20:01:36 - INFO -   ABC: 247 registros
2026-02-06 20:01:36 - INFO -   Ventas: 1987 registros
2026-02-06 20:01:36 - INFO -   Costes: 22145 registros
2026-02-06 20:01:36 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:01:36 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 20:01:36 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:36 - INFO - Datos de ventas: 157 registros
2026-02-06 20:01:36 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 20:01:36 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 20:01:36 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:36 - INFO -   Factor total: 1.3125
2026-02-06 20:01:36 - INFO -   Factor escalado: 1.4055
2026-02-06 20:01:36 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 20:01:36 - INFO -   Objetivo final: 2360.20€
2026-02-06 20:01:36 - INFO -   Delta: 424.74€
2026-02-06 20:01:36 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:36 - DEBUG -   Total registros: 84
2026-02-06 20:01:36 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 20:01:36 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 20:01:36 - INFO -   Ventas finales: 2365.92€
2026-02-06 20:01:36 - INFO - 
============================================================
2026-02-06 20:01:36 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:36 - INFO - ============================================================
2026-02-06 20:01:36 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:36 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:36 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:36 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:36 - INFO - ============================================================
2026-02-06 20:01:36 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:36 - INFO - ============================================================
2026-02-06 20:01:36 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:36 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:36 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:36 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:36 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:36 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:36 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:36 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:36 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:36 - INFO -   Stock: 30 registros
2026-02-06 20:01:36 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:36 - INFO - Fusión completada: 84 registros
2026-02-06 20:01:36 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:36 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:36 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:36 - INFO - 
============================================================
2026-02-06 20:01:36 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:36 - INFO - ============================================================
2026-02-06 20:01:36 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:36 - INFO - Corrección completada:
2026-02-06 20:01:36 - INFO -   - Artículos corregidos: 82/84
2026-02-06 20:01:36 - INFO -   - Artículos aumentados: 82
2026-02-06 20:01:36 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:36 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:36 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:36 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:36 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:01:36 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:36 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:36 - DEBUG -   Con valor 0: 2
2026-02-06 20:01:36 - DEBUG -   Con valor > 0: 82
2026-02-06 20:01:36 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 20:01:36 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 82 registros
2026-02-06 20:01:36 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:01:36 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:01:36 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:01:36 - INFO -   Articulos: 82
2026-02-06 20:01:36 - INFO -   Importe: 2365.92€
2026-02-06 20:01:36 - INFO - 
==================================================
2026-02-06 20:01:36 - INFO - SECCION: VIVERO
2026-02-06 20:01:36 - INFO - ==================================================
2026-02-06 20:01:36 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 20:01:36 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:36 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 20:01:36 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:01:36 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:01:37 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:37 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 20:01:37 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 20:01:37 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:37 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:37 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:01:41 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:41 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:01:41 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:01:41 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:01:41 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:01:41 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:01:41 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 20:01:41 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:01:41 - DEBUG -   maf: 10970 registros
2026-02-06 20:01:41 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:01:41 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:01:41 - DEBUG -   interior: 3624 registros
2026-02-06 20:01:41 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:01:41 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:01:41 - DEBUG -   vivero: 2460 registros
2026-02-06 20:01:41 - DEBUG -   fitos: 1987 registros
2026-02-06 20:01:41 - DEBUG -   semillas: 1180 registros
2026-02-06 20:01:41 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:01:41 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:01:41 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 20:01:41 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 20:01:41 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:01:41 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:43 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:43 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:43 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:43 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:43 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:43 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 20:01:43 - INFO -   ABC: 565 registros
2026-02-06 20:01:43 - INFO -   Ventas: 2460 registros
2026-02-06 20:01:43 - INFO -   Costes: 22145 registros
2026-02-06 20:01:43 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 20:01:43 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 20:01:43 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:43 - INFO - Datos de ventas: 189 registros
2026-02-06 20:01:43 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 20:01:43 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 20:01:43 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:43 - INFO -   Factor total: 1.3125
2026-02-06 20:01:43 - INFO -   Factor escalado: 1.6886
2026-02-06 20:01:43 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 20:01:43 - INFO -   Objetivo final: 6952.54€
2026-02-06 20:01:43 - INFO -   Delta: 1809.40€
2026-02-06 20:01:43 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:43 - DEBUG -   Total registros: 107
2026-02-06 20:01:43 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 20:01:43 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 20:01:43 - INFO -   Ventas finales: 6990.51€
2026-02-06 20:01:43 - INFO - 
============================================================
2026-02-06 20:01:43 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:43 - INFO - ============================================================
2026-02-06 20:01:43 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:43 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:43 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:43 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:43 - INFO - ============================================================
2026-02-06 20:01:43 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:43 - INFO - ============================================================
2026-02-06 20:01:43 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:43 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:43 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:43 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:43 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:43 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:43 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:43 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:43 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:43 - INFO -   Stock: 30 registros
2026-02-06 20:01:43 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:43 - INFO - Fusión completada: 107 registros
2026-02-06 20:01:43 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:43 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:43 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:43 - INFO - 
============================================================
2026-02-06 20:01:43 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:43 - INFO - ============================================================
2026-02-06 20:01:43 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:43 - INFO - Corrección completada:
2026-02-06 20:01:43 - INFO -   - Artículos corregidos: 96/107
2026-02-06 20:01:43 - INFO -   - Artículos aumentados: 96
2026-02-06 20:01:43 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:43 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:43 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:43 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:43 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 20:01:43 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:43 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:43 - DEBUG -   Con valor 0: 11
2026-02-06 20:01:43 - DEBUG -   Con valor > 0: 96
2026-02-06 20:01:43 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 20:01:43 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 96 registros
2026-02-06 20:01:43 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:01:43 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:01:43 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:01:43 - INFO -   Articulos: 96
2026-02-06 20:01:43 - INFO -   Importe: 6990.51€
2026-02-06 20:01:43 - INFO - 
==================================================
2026-02-06 20:01:43 - INFO - SECCION: UTILES_JARDIN
2026-02-06 20:01:43 - INFO - ==================================================
2026-02-06 20:01:43 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 20:01:43 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:43 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 20:01:43 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:01:43 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:01:43 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:43 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 20:01:43 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 20:01:43 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:43 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:43 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:01:47 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:47 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:01:48 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:01:48 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:01:48 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:01:48 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:01:48 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 20:01:48 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:01:48 - DEBUG -   maf: 10970 registros
2026-02-06 20:01:48 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:01:48 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:01:48 - DEBUG -   interior: 3624 registros
2026-02-06 20:01:48 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:01:48 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:01:48 - DEBUG -   vivero: 2460 registros
2026-02-06 20:01:48 - DEBUG -   fitos: 1987 registros
2026-02-06 20:01:48 - DEBUG -   semillas: 1180 registros
2026-02-06 20:01:48 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:01:48 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:01:48 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 20:01:48 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 20:01:48 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:01:48 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:50 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:50 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:50 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:50 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:50 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:50 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 20:01:50 - INFO -   ABC: 433 registros
2026-02-06 20:01:50 - INFO -   Ventas: 1009 registros
2026-02-06 20:01:50 - INFO -   Costes: 22145 registros
2026-02-06 20:01:50 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 20:01:50 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 20:01:50 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:50 - INFO - Datos de ventas: 89 registros
2026-02-06 20:01:50 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 20:01:50 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 20:01:50 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:50 - INFO -   Factor total: 1.3125
2026-02-06 20:01:50 - INFO -   Factor escalado: 1.6747
2026-02-06 20:01:50 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 20:01:50 - INFO -   Objetivo final: 1371.26€
2026-02-06 20:01:50 - INFO -   Delta: 558.30€
2026-02-06 20:01:50 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:50 - DEBUG -   Total registros: 78
2026-02-06 20:01:50 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 20:01:50 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 20:01:50 - INFO -   Ventas finales: 1390.00€
2026-02-06 20:01:51 - INFO - 
============================================================
2026-02-06 20:01:51 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:51 - INFO - ============================================================
2026-02-06 20:01:51 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:51 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:51 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:51 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:51 - INFO - ============================================================
2026-02-06 20:01:51 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:51 - INFO - ============================================================
2026-02-06 20:01:51 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:51 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:51 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:51 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:51 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:51 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:51 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:51 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:51 - INFO -   Stock: 30 registros
2026-02-06 20:01:51 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:51 - INFO - Fusión completada: 78 registros
2026-02-06 20:01:51 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:51 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:51 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:51 - INFO - 
============================================================
2026-02-06 20:01:51 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:51 - INFO - ============================================================
2026-02-06 20:01:51 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:51 - INFO - Corrección completada:
2026-02-06 20:01:51 - INFO -   - Artículos corregidos: 78/78
2026-02-06 20:01:51 - INFO -   - Artículos aumentados: 78
2026-02-06 20:01:51 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:51 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:51 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:51 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:51 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 20:01:51 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:51 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:51 - DEBUG -   Con valor 0: 0
2026-02-06 20:01:51 - DEBUG -   Con valor > 0: 78
2026-02-06 20:01:51 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 20:01:51 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 78 registros
2026-02-06 20:01:51 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:01:51 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:01:51 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:01:51 - INFO -   Articulos: 78
2026-02-06 20:01:51 - INFO -   Importe: 1390.00€
2026-02-06 20:01:51 - INFO - 
==================================================
2026-02-06 20:01:51 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 20:01:51 - INFO - ==================================================
2026-02-06 20:01:51 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 20:01:51 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:51 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 20:01:51 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:01:51 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:01:51 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:51 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 20:01:51 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:01:51 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:51 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:51 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:01:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:55 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:01:55 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:01:55 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:01:55 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:01:55 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:01:55 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 20:01:55 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:01:55 - DEBUG -   maf: 10970 registros
2026-02-06 20:01:55 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:01:55 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:01:55 - DEBUG -   interior: 3624 registros
2026-02-06 20:01:55 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:01:55 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:01:55 - DEBUG -   vivero: 2460 registros
2026-02-06 20:01:55 - DEBUG -   fitos: 1987 registros
2026-02-06 20:01:55 - DEBUG -   semillas: 1180 registros
2026-02-06 20:01:55 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:01:55 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:01:55 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 20:01:55 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 20:01:55 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:01:55 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:01:57 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:57 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:01:57 - INFO - Costes cargados: 22145 registros
2026-02-06 20:01:57 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:01:57 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:01:57 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 20:01:57 - INFO -   ABC: 247 registros
2026-02-06 20:01:57 - INFO -   Ventas: 3264 registros
2026-02-06 20:01:57 - INFO -   Costes: 22145 registros
2026-02-06 20:01:57 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:01:57 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 20:01:57 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:01:57 - INFO - Datos de ventas: 302 registros
2026-02-06 20:01:57 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 20:01:57 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 20:01:57 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:01:57 - INFO -   Factor total: 1.3125
2026-02-06 20:01:57 - INFO -   Factor escalado: 1.3380
2026-02-06 20:01:57 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 20:01:57 - INFO -   Objetivo final: 5377.63€
2026-02-06 20:01:57 - INFO -   Delta: 432.03€
2026-02-06 20:01:57 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:01:57 - DEBUG -   Total registros: 72
2026-02-06 20:01:57 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 20:01:57 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 20:01:57 - INFO -   Ventas finales: 5387.14€
2026-02-06 20:01:57 - INFO - 
============================================================
2026-02-06 20:01:57 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:01:57 - INFO - ============================================================
2026-02-06 20:01:57 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:01:57 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:01:57 - INFO - DataLoader inicializado correctamente
2026-02-06 20:01:57 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:01:57 - INFO - ============================================================
2026-02-06 20:01:57 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:01:57 - INFO - ============================================================
2026-02-06 20:01:57 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:01:57 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:01:57 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:57 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:57 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:01:57 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:01:57 - DEBUG - Usando hoja: Stock
2026-02-06 20:01:57 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:01:57 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:01:57 - INFO -   Stock: 30 registros
2026-02-06 20:01:57 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:01:57 - INFO - Fusión completada: 72 registros
2026-02-06 20:01:57 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:01:57 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:01:57 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:01:57 - INFO - 
============================================================
2026-02-06 20:01:57 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:01:57 - INFO - ============================================================
2026-02-06 20:01:57 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:01:57 - INFO - Corrección completada:
2026-02-06 20:01:57 - INFO -   - Artículos corregidos: 71/72
2026-02-06 20:01:57 - INFO -   - Artículos aumentados: 71
2026-02-06 20:01:57 - INFO -   - Artículos reducidos: 0
2026-02-06 20:01:57 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:01:57 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:01:57 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:01:57 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 20:01:57 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:01:57 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:01:57 - DEBUG -   Con valor 0: 1
2026-02-06 20:01:57 - DEBUG -   Con valor > 0: 71
2026-02-06 20:01:57 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 20:01:57 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 71 registros
2026-02-06 20:01:58 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:01:58 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:01:58 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:01:58 - INFO -   Articulos: 71
2026-02-06 20:01:58 - INFO -   Importe: 5387.14€
2026-02-06 20:01:58 - INFO - 
==================================================
2026-02-06 20:01:58 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 20:01:58 - INFO - ==================================================
2026-02-06 20:01:58 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 20:01:58 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:01:58 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 20:01:58 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:01:58 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:01:58 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:01:58 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 20:01:58 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 20:01:58 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:01:58 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:01:58 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:02:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:02:02 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:02:02 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:02:02 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:02:02 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:02:02 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:02:02 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 20:02:02 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:02:02 - DEBUG -   maf: 10970 registros
2026-02-06 20:02:02 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:02:02 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:02:02 - DEBUG -   interior: 3624 registros
2026-02-06 20:02:02 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:02:02 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:02:02 - DEBUG -   vivero: 2460 registros
2026-02-06 20:02:02 - DEBUG -   fitos: 1987 registros
2026-02-06 20:02:02 - DEBUG -   semillas: 1180 registros
2026-02-06 20:02:02 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:02:02 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:02:02 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 20:02:02 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 20:02:02 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:02:02 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:02:04 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:02:04 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:02:04 - INFO - Costes cargados: 22145 registros
2026-02-06 20:02:04 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:02:04 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:02:04 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 20:02:04 - INFO -   ABC: 995 registros
2026-02-06 20:02:04 - INFO -   Ventas: 4018 registros
2026-02-06 20:02:04 - INFO -   Costes: 22145 registros
2026-02-06 20:02:04 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 20:02:04 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 20:02:04 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:02:04 - INFO - Datos de ventas: 316 registros
2026-02-06 20:02:04 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 20:02:05 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 20:02:05 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:02:05 - INFO -   Factor total: 1.3125
2026-02-06 20:02:05 - INFO -   Factor escalado: 1.1960
2026-02-06 20:02:05 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 20:02:05 - INFO -   Objetivo final: 4909.20€
2026-02-06 20:02:05 - INFO -   Delta: 1185.39€
2026-02-06 20:02:05 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:02:05 - DEBUG -   Total registros: 224
2026-02-06 20:02:05 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 20:02:05 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 20:02:05 - INFO -   Ventas finales: 4923.89€
2026-02-06 20:02:05 - INFO - 
============================================================
2026-02-06 20:02:05 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:02:05 - INFO - ============================================================
2026-02-06 20:02:05 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:02:05 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:02:05 - INFO - DataLoader inicializado correctamente
2026-02-06 20:02:05 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:02:05 - INFO - ============================================================
2026-02-06 20:02:05 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:02:05 - INFO - ============================================================
2026-02-06 20:02:05 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:02:05 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:02:05 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:02:05 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:02:05 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:02:05 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:02:05 - DEBUG - Usando hoja: Stock
2026-02-06 20:02:05 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:02:05 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:02:05 - INFO -   Stock: 30 registros
2026-02-06 20:02:05 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:02:05 - INFO - Fusión completada: 224 registros
2026-02-06 20:02:05 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:02:05 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:02:05 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:02:05 - INFO - 
============================================================
2026-02-06 20:02:05 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:02:05 - INFO - ============================================================
2026-02-06 20:02:05 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:02:05 - INFO - Corrección completada:
2026-02-06 20:02:05 - INFO -   - Artículos corregidos: 205/224
2026-02-06 20:02:05 - INFO -   - Artículos aumentados: 205
2026-02-06 20:02:05 - INFO -   - Artículos reducidos: 0
2026-02-06 20:02:05 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:02:05 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:02:05 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:02:05 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 20:02:05 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:02:05 - DEBUG - [DEBUG] Distribución de Unidades_Pedido:
2026-02-06 20:02:05 - DEBUG -   Con valor 0: 19
2026-02-06 20:02:05 - DEBUG -   Con valor > 0: 205
2026-02-06 20:02:05 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 20:02:05 - DEBUG - [DEBUG] Tras filtrar Unidades_Pedido > 0: 205 registros
2026-02-06 20:02:05 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:02:05 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:02:05 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:02:05 - INFO -   Articulos: 205
2026-02-06 20:02:05 - INFO -   Importe: 4923.89€
2026-02-06 20:02:05 - INFO - Estado guardado correctamente
2026-02-06 20:02:05 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:02:05 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:02:05 - INFO - Estado guardado correctamente
2026-02-06 20:02:05 - INFO - 
============================================================
2026-02-06 20:02:05 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 20:02:05 - INFO - ============================================================
2026-02-06 20:02:05 - DEBUG - [DEBUG] Archivos agrupados por sección: {'maf': ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx'], 'interior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx'], 'semillas': ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx'], 'vivo': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx'], 'manufacturado': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx'], 'fitos': ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx'], 'vivero': ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx'], 'jardin': ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx'], 'aridos': ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx'], 'exterior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']}
2026-02-06 20:02:05 - INFO - 
============================================================
2026-02-06 20:02:05 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 20:02:05 - INFO - ============================================================
2026-02-06 20:02:05 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 20:02:05 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 20:02:05 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 20:02:05 - INFO - EmailService inicializado correctamente
2026-02-06 20:02:05 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 20:02:05 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 20:02:05 - INFO - 
Enviando email para sección: maf
2026-02-06 20:02:05 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx']
2026-02-06 20:02:05 - DEBUG - Destinatarios para maf: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:02:05 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:02:05 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:02:05 - INFO - Email enviado para sección maf (semana 14)
2026-02-06 20:02:05 - ERROR - ✗ Error al enviar email a maf: None
2026-02-06 20:02:05 - INFO - 
Enviando email para sección: interior
2026-02-06 20:02:05 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx']
2026-02-06 20:02:05 - DEBUG - Destinatarios para interior: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Iris'}]
2026-02-06 20:02:05 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:02:05 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:02:06 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:02:06 - INFO - Email enviado para sección interior (semana 14)
2026-02-06 20:02:06 - ERROR - ✗ Error al enviar email a interior: None
2026-02-06 20:02:06 - INFO - 
Enviando email para sección: semillas
2026-02-06 20:02:06 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx']
2026-02-06 20:02:06 - DEBUG - Destinatarios para semillas: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:02:06 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:02:06 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:02:06 - INFO - Email enviado para sección semillas (semana 14)
2026-02-06 20:02:06 - ERROR - ✗ Error al enviar email a semillas: None
2026-02-06 20:02:06 - INFO - 
Enviando email para sección: vivo
2026-02-06 20:02:06 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx']
2026-02-06 20:02:06 - WARNING - No hay destinatarios configurados para la sección: vivo
2026-02-06 20:02:06 - WARNING - No se puede enviar email para vivo: No hay destinatarios configurados
2026-02-06 20:02:06 - ERROR - ✗ Error al enviar email a vivo: No hay destinatarios configurados
2026-02-06 20:02:06 - INFO - 
Enviando email para sección: manufacturado
2026-02-06 20:02:06 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx']
2026-02-06 20:02:06 - WARNING - No hay destinatarios configurados para la sección: manufacturado
2026-02-06 20:02:06 - WARNING - No se puede enviar email para manufacturado: No hay destinatarios configurados
2026-02-06 20:02:06 - ERROR - ✗ Error al enviar email a manufacturado: No hay destinatarios configurados
2026-02-06 20:02:06 - INFO - 
Enviando email para sección: fitos
2026-02-06 20:02:06 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx']
2026-02-06 20:02:06 - DEBUG - Destinatarios para fitos: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:02:06 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:02:06 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:02:06 - INFO - Email enviado para sección fitos (semana 14)
2026-02-06 20:02:06 - ERROR - ✗ Error al enviar email a fitos: None
2026-02-06 20:02:06 - INFO - 
Enviando email para sección: vivero
2026-02-06 20:02:06 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx']
2026-02-06 20:02:06 - DEBUG - Destinatarios para vivero: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:02:06 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:02:07 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:02:07 - INFO - Email enviado para sección vivero (semana 14)
2026-02-06 20:02:07 - ERROR - ✗ Error al enviar email a vivero: None
2026-02-06 20:02:07 - INFO - 
Enviando email para sección: jardin
2026-02-06 20:02:07 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx']
2026-02-06 20:02:07 - WARNING - No hay destinatarios configurados para la sección: jardin
2026-02-06 20:02:07 - WARNING - No se puede enviar email para jardin: No hay destinatarios configurados
2026-02-06 20:02:07 - ERROR - ✗ Error al enviar email a jardin: No hay destinatarios configurados
2026-02-06 20:02:07 - INFO - 
Enviando email para sección: aridos
2026-02-06 20:02:07 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx']
2026-02-06 20:02:07 - WARNING - No hay destinatarios configurados para la sección: aridos
2026-02-06 20:02:07 - WARNING - No se puede enviar email para aridos: No hay destinatarios configurados
2026-02-06 20:02:07 - ERROR - ✗ Error al enviar email a aridos: No hay destinatarios configurados
2026-02-06 20:02:07 - INFO - 
Enviando email para sección: exterior
2026-02-06 20:02:07 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']
2026-02-06 20:02:07 - WARNING - No hay destinatarios configurados para la sección: exterior
2026-02-06 20:02:07 - WARNING - No se puede enviar email para exterior: No hay destinatarios configurados
2026-02-06 20:02:07 - ERROR - ✗ Error al enviar email a exterior: No hay destinatarios configurados
2026-02-06 20:02:07 - INFO - 
============================================================
2026-02-06 20:02:07 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 20:02:07 - INFO - ============================================================
2026-02-06 20:02:07 - INFO - Emails enviados exitosamente: 0
2026-02-06 20:02:07 - INFO - Emails fallidos: 10
2026-02-06 20:02:07 - INFO - Secciones procesadas: 10
2026-02-06 20:02:07 - INFO - 
============================================================
2026-02-06 20:02:07 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:02:07 - INFO - ============================================================
2026-02-06 20:02:07 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:02:07 - INFO - 
============================================================
2026-02-06 20:02:07 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:02:07 - INFO - ============================================================
2026-02-06 20:02:07 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:02:07 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 20:02:07 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 20:02:07 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:02:07 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:02:07 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 20:02:07 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:02:08 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 20:02:08 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 20:02:08 - INFO - 
============================================================
2026-02-06 20:02:08 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 20:02:08 - INFO - ============================================================
2026-02-06 20:02:08 - INFO - Emails enviados: 3
2026-02-06 20:02:08 - INFO - Emails fallidos: 0
2026-02-06 20:02:08 - INFO - 
======================================================================
2026-02-06 20:02:08 - INFO - RESUMEN DE EJECUCION
2026-02-06 20:02:08 - INFO - ======================================================================
2026-02-06 20:02:08 - INFO - Semana procesada: 14
2026-02-06 20:02:08 - INFO - Archivos generados: 12
2026-02-06 20:02:08 - INFO - Total articulos: 1510
2026-02-06 20:02:08 - INFO - Total importe: 48115.81€
2026-02-06 20:02:08 - WARNING - 
✗ EMAILS FALLIDOS: 10
2026-02-06 20:02:08 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 20:02:08 - INFO - ======================================================================
2026-02-06 20:02:08 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 20:02:08 - INFO - Archivo principal: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:02:08 - INFO - Artículos: 1510
2026-02-06 20:02:08 - INFO - Importe: 48115.81€
2026-02-06 20:02:08 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 20:09:54 - INFO - ======================================================================
2026-02-06 20:09:54 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 20:09:54 - INFO - Fecha de ejecución: 2026-02-06 20:09:54
2026-02-06 20:09:54 - INFO - ======================================================================
2026-02-06 20:09:54 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 20:09:54 - INFO - Envío de emails: Sí
2026-02-06 20:09:54 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 20:09:54 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 20:09:54 - INFO - Estado cargado correctamente
2026-02-06 20:09:54 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:09:54 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:09:54 - INFO - Semana forzada por argumento: 14
2026-02-06 20:09:54 - INFO - ======================================================================
2026-02-06 20:09:54 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 20:09:54 - INFO - ======================================================================
2026-02-06 20:09:54 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 20:09:54 - INFO - DataLoader inicializado correctamente
2026-02-06 20:09:54 - INFO - ForecastEngine inicializado correctamente
2026-02-06 20:09:54 - INFO - OrderGenerator inicializado correctamente
2026-02-06 20:09:54 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:09:54 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:09:54 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 20:09:54 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 20:09:54 - INFO - 
==================================================
2026-02-06 20:09:54 - INFO - SECCION: MAF
2026-02-06 20:09:54 - INFO - ==================================================
2026-02-06 20:09:54 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 20:09:54 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:09:54 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 20:09:54 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:09:54 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:09:54 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:09:54 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 20:09:54 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 20:09:54 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:09:54 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:09:54 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:09:58 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:09:58 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:09:58 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:09:58 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:09:58 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:09:58 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:09:58 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 20:09:58 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:09:58 - DEBUG -   maf: 10970 registros
2026-02-06 20:09:58 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:09:58 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:09:58 - DEBUG -   interior: 3624 registros
2026-02-06 20:09:58 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:09:58 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:09:58 - DEBUG -   vivero: 2460 registros
2026-02-06 20:09:58 - DEBUG -   fitos: 1987 registros
2026-02-06 20:09:58 - DEBUG -   semillas: 1180 registros
2026-02-06 20:09:58 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:09:58 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:09:58 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 20:09:58 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 20:09:58 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:09:58 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:00 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:00 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:00 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:00 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:00 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:00 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 20:10:00 - INFO -   ABC: 499 registros
2026-02-06 20:10:00 - INFO -   Ventas: 10970 registros
2026-02-06 20:10:00 - INFO -   Costes: 22145 registros
2026-02-06 20:10:00 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 20:10:00 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 20:10:00 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:00 - INFO - Datos de ventas: 1011 registros
2026-02-06 20:10:00 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 20:10:01 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 20:10:01 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:01 - INFO -   Factor total: 1.3125
2026-02-06 20:10:01 - INFO -   Factor escalado: 1.5844
2026-02-06 20:10:01 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 20:10:01 - INFO -   Objetivo final: 9253.98€
2026-02-06 20:10:01 - INFO -   Delta: 679.77€
2026-02-06 20:10:01 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:01 - DEBUG -   Total registros: 222
2026-02-06 20:10:01 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 20:10:01 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 20:10:01 - INFO -   Ventas finales: 9254.53€
2026-02-06 20:10:01 - INFO - 
============================================================
2026-02-06 20:10:01 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:01 - INFO - ============================================================
2026-02-06 20:10:01 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:01 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:01 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:01 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:01 - INFO - ============================================================
2026-02-06 20:10:01 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:01 - INFO - ============================================================
2026-02-06 20:10:01 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:01 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:01 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:01 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:01 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:01 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:01 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:01 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:01 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:01 - INFO -   Stock: 30 registros
2026-02-06 20:10:01 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:01 - INFO - Fusión completada: 222 registros
2026-02-06 20:10:01 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:01 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:01 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:01 - INFO - 
============================================================
2026-02-06 20:10:01 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:01 - INFO - ============================================================
2026-02-06 20:10:01 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:01 - INFO - Corrección completada:
2026-02-06 20:10:01 - INFO -   - Artículos corregidos: 191/222
2026-02-06 20:10:01 - INFO -   - Artículos aumentados: 191
2026-02-06 20:10:01 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:01 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:01 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:01 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:01 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 20:10:01 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:01 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:01 - DEBUG -   Con valor 0: 31
2026-02-06 20:10:01 - DEBUG -   Con valor > 0: 191
2026-02-06 20:10:01 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 20:10:01 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 191 registros
2026-02-06 20:10:01 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:10:01 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:10:01 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:10:01 - INFO -   Articulos: 191
2026-02-06 20:10:01 - INFO -   Importe: 9254.53€
2026-02-06 20:10:01 - INFO - 
==================================================
2026-02-06 20:10:01 - INFO - SECCION: DECO_INTERIOR
2026-02-06 20:10:01 - INFO - ==================================================
2026-02-06 20:10:01 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 20:10:01 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:01 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 20:10:01 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:10:01 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:10:01 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:01 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 20:10:01 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 20:10:01 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:01 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:01 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:10:05 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:05 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:10:05 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:10:05 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:10:05 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:10:05 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:10:05 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 20:10:05 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:10:05 - DEBUG -   maf: 10970 registros
2026-02-06 20:10:05 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:10:05 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:10:05 - DEBUG -   interior: 3624 registros
2026-02-06 20:10:05 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:10:05 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:10:05 - DEBUG -   vivero: 2460 registros
2026-02-06 20:10:05 - DEBUG -   fitos: 1987 registros
2026-02-06 20:10:05 - DEBUG -   semillas: 1180 registros
2026-02-06 20:10:05 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:10:05 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:10:05 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 20:10:05 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 20:10:05 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:10:05 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:07 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:07 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:08 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:08 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:08 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:08 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 20:10:08 - INFO -   ABC: 1827 registros
2026-02-06 20:10:08 - INFO -   Ventas: 2468 registros
2026-02-06 20:10:08 - INFO -   Costes: 22145 registros
2026-02-06 20:10:08 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 20:10:08 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 20:10:08 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:08 - INFO - Datos de ventas: 180 registros
2026-02-06 20:10:08 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 20:10:08 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 20:10:08 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:08 - INFO -   Factor total: 1.3125
2026-02-06 20:10:08 - INFO -   Factor escalado: 1.5747
2026-02-06 20:10:08 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 20:10:08 - INFO -   Objetivo final: 2576.42€
2026-02-06 20:10:08 - INFO -   Delta: 373.59€
2026-02-06 20:10:08 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:08 - DEBUG -   Total registros: 139
2026-02-06 20:10:08 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 20:10:08 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 20:10:08 - INFO -   Ventas finales: 2580.73€
2026-02-06 20:10:08 - INFO - 
============================================================
2026-02-06 20:10:08 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:08 - INFO - ============================================================
2026-02-06 20:10:08 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:08 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:08 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:08 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:08 - INFO - ============================================================
2026-02-06 20:10:08 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:08 - INFO - ============================================================
2026-02-06 20:10:08 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:08 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:08 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:08 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:08 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:08 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:08 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:08 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:08 - INFO -   Stock: 30 registros
2026-02-06 20:10:08 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:08 - INFO - Fusión completada: 139 registros
2026-02-06 20:10:08 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:08 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:08 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:08 - INFO - 
============================================================
2026-02-06 20:10:08 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:08 - INFO - ============================================================
2026-02-06 20:10:08 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:08 - INFO - Corrección completada:
2026-02-06 20:10:08 - INFO -   - Artículos corregidos: 135/139
2026-02-06 20:10:08 - INFO -   - Artículos aumentados: 135
2026-02-06 20:10:08 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:08 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:08 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:08 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:08 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 20:10:08 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:08 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:08 - DEBUG -   Con valor 0: 4
2026-02-06 20:10:08 - DEBUG -   Con valor > 0: 135
2026-02-06 20:10:08 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 20:10:08 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 135 registros
2026-02-06 20:10:08 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:10:08 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:10:08 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:10:08 - INFO -   Articulos: 135
2026-02-06 20:10:08 - INFO -   Importe: 2580.73€
2026-02-06 20:10:08 - INFO - 
==================================================
2026-02-06 20:10:08 - INFO - SECCION: SEMILLAS
2026-02-06 20:10:08 - INFO - ==================================================
2026-02-06 20:10:08 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 20:10:08 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:08 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 20:10:08 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:10:08 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:10:08 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:08 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 20:10:08 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 20:10:08 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:08 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:08 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:10:12 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:12 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:10:12 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:10:12 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:10:12 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:10:12 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:10:12 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 20:10:12 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:10:12 - DEBUG -   maf: 10970 registros
2026-02-06 20:10:12 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:10:12 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:10:12 - DEBUG -   interior: 3624 registros
2026-02-06 20:10:12 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:10:12 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:10:12 - DEBUG -   vivero: 2460 registros
2026-02-06 20:10:12 - DEBUG -   fitos: 1987 registros
2026-02-06 20:10:12 - DEBUG -   semillas: 1180 registros
2026-02-06 20:10:12 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:10:12 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:10:12 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 20:10:12 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 20:10:12 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:10:12 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:14 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:14 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:14 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:14 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:14 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:14 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 20:10:14 - INFO -   ABC: 218 registros
2026-02-06 20:10:14 - INFO -   Ventas: 1180 registros
2026-02-06 20:10:14 - INFO -   Costes: 22145 registros
2026-02-06 20:10:14 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 20:10:14 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 20:10:14 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:14 - INFO - Datos de ventas: 136 registros
2026-02-06 20:10:14 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 20:10:15 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 20:10:15 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:15 - INFO -   Factor total: 1.3125
2026-02-06 20:10:15 - INFO -   Factor escalado: 2.0023
2026-02-06 20:10:15 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 20:10:15 - INFO -   Objetivo final: 911.32€
2026-02-06 20:10:15 - INFO -   Delta: 217.83€
2026-02-06 20:10:15 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:15 - DEBUG -   Total registros: 84
2026-02-06 20:10:15 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 20:10:15 - DEBUG -   Ventas finales: 911.60€
2026-02-06 20:10:15 - INFO -   Ventas finales: 911.60€
2026-02-06 20:10:15 - INFO - 
============================================================
2026-02-06 20:10:15 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:15 - INFO - ============================================================
2026-02-06 20:10:15 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:15 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:15 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:15 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:15 - INFO - ============================================================
2026-02-06 20:10:15 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:15 - INFO - ============================================================
2026-02-06 20:10:15 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:15 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:15 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:15 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:15 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:15 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:15 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:15 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:15 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:15 - INFO -   Stock: 30 registros
2026-02-06 20:10:15 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:15 - INFO - Fusión completada: 84 registros
2026-02-06 20:10:15 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:15 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:15 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:15 - INFO - 
============================================================
2026-02-06 20:10:15 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:15 - INFO - ============================================================
2026-02-06 20:10:15 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:15 - INFO - Corrección completada:
2026-02-06 20:10:15 - INFO -   - Artículos corregidos: 84/84
2026-02-06 20:10:15 - INFO -   - Artículos aumentados: 84
2026-02-06 20:10:15 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:15 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:15 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:15 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:15 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:10:15 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:15 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:15 - DEBUG -   Con valor 0: 0
2026-02-06 20:10:15 - DEBUG -   Con valor > 0: 84
2026-02-06 20:10:15 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 20:10:15 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 84 registros
2026-02-06 20:10:15 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:10:15 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:10:15 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:10:15 - INFO -   Articulos: 84
2026-02-06 20:10:15 - INFO -   Importe: 911.60€
2026-02-06 20:10:15 - INFO - 
==================================================
2026-02-06 20:10:15 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 20:10:15 - INFO - ==================================================
2026-02-06 20:10:15 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 20:10:15 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:15 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 20:10:15 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:10:15 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:10:15 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:15 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 20:10:15 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 20:10:15 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:15 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:15 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:10:19 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:19 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:10:19 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:10:19 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:10:19 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:10:19 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:10:19 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 20:10:19 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:10:19 - DEBUG -   maf: 10970 registros
2026-02-06 20:10:19 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:10:19 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:10:19 - DEBUG -   interior: 3624 registros
2026-02-06 20:10:19 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:10:19 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:10:19 - DEBUG -   vivero: 2460 registros
2026-02-06 20:10:19 - DEBUG -   fitos: 1987 registros
2026-02-06 20:10:19 - DEBUG -   semillas: 1180 registros
2026-02-06 20:10:19 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:10:19 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:10:19 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 20:10:19 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 20:10:19 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:10:19 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:21 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:21 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:21 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:21 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:21 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:21 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 20:10:21 - INFO -   ABC: 205 registros
2026-02-06 20:10:21 - INFO -   Ventas: 1124 registros
2026-02-06 20:10:21 - INFO -   Costes: 22145 registros
2026-02-06 20:10:21 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 20:10:21 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 20:10:21 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:21 - INFO - Datos de ventas: 88 registros
2026-02-06 20:10:21 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 20:10:21 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 20:10:21 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:21 - INFO -   Factor total: 1.3125
2026-02-06 20:10:21 - INFO -   Factor escalado: 1.6854
2026-02-06 20:10:21 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 20:10:21 - INFO -   Objetivo final: 1426.88€
2026-02-06 20:10:21 - INFO -   Delta: 346.78€
2026-02-06 20:10:21 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:21 - DEBUG -   Total registros: 43
2026-02-06 20:10:21 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 20:10:21 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 20:10:21 - INFO -   Ventas finales: 1455.34€
2026-02-06 20:10:21 - INFO - 
============================================================
2026-02-06 20:10:21 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:21 - INFO - ============================================================
2026-02-06 20:10:21 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:21 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:21 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:21 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:21 - INFO - ============================================================
2026-02-06 20:10:21 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:21 - INFO - ============================================================
2026-02-06 20:10:21 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:21 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:21 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:21 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:21 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:21 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:21 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:21 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:21 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:21 - INFO -   Stock: 30 registros
2026-02-06 20:10:21 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:21 - INFO - Fusión completada: 43 registros
2026-02-06 20:10:21 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:21 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:21 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:21 - INFO - 
============================================================
2026-02-06 20:10:21 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:21 - INFO - ============================================================
2026-02-06 20:10:21 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:21 - INFO - Corrección completada:
2026-02-06 20:10:21 - INFO -   - Artículos corregidos: 36/43
2026-02-06 20:10:21 - INFO -   - Artículos aumentados: 36
2026-02-06 20:10:21 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:21 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:21 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:21 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:21 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 20:10:21 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:21 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:21 - DEBUG -   Con valor 0: 7
2026-02-06 20:10:21 - DEBUG -   Con valor > 0: 36
2026-02-06 20:10:21 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 20:10:21 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 36 registros
2026-02-06 20:10:21 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:10:21 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:10:21 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:10:21 - INFO -   Articulos: 36
2026-02-06 20:10:21 - INFO -   Importe: 1455.34€
2026-02-06 20:10:21 - INFO - 
==================================================
2026-02-06 20:10:21 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 20:10:21 - INFO - ==================================================
2026-02-06 20:10:21 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 20:10:21 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:21 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 20:10:21 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:10:21 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:10:22 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:22 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 20:10:22 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 20:10:22 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:22 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:22 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:10:26 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:26 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:10:26 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:10:26 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:10:26 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:10:26 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:10:26 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 20:10:26 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:10:26 - DEBUG -   maf: 10970 registros
2026-02-06 20:10:26 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:10:26 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:10:26 - DEBUG -   interior: 3624 registros
2026-02-06 20:10:26 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:10:26 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:10:26 - DEBUG -   vivero: 2460 registros
2026-02-06 20:10:26 - DEBUG -   fitos: 1987 registros
2026-02-06 20:10:26 - DEBUG -   semillas: 1180 registros
2026-02-06 20:10:26 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:10:26 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:10:26 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 20:10:26 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 20:10:26 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:10:26 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:28 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:28 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:28 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:28 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:28 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:28 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 20:10:28 - INFO -   ABC: 2749 registros
2026-02-06 20:10:28 - INFO -   Ventas: 9784 registros
2026-02-06 20:10:28 - INFO -   Costes: 22145 registros
2026-02-06 20:10:28 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 20:10:28 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 20:10:28 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:28 - INFO - Datos de ventas: 822 registros
2026-02-06 20:10:28 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 20:10:30 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 20:10:30 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:30 - INFO -   Factor total: 1.3125
2026-02-06 20:10:30 - INFO -   Factor escalado: 1.0268
2026-02-06 20:10:30 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 20:10:30 - INFO -   Objetivo final: 8977.26€
2026-02-06 20:10:30 - INFO -   Delta: 3401.99€
2026-02-06 20:10:30 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:30 - DEBUG -   Total registros: 538
2026-02-06 20:10:30 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 20:10:30 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 20:10:30 - INFO -   Ventas finales: 8993.98€
2026-02-06 20:10:30 - INFO - 
============================================================
2026-02-06 20:10:30 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:30 - INFO - ============================================================
2026-02-06 20:10:30 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:30 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:30 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:30 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:30 - INFO - ============================================================
2026-02-06 20:10:30 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:30 - INFO - ============================================================
2026-02-06 20:10:30 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:30 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:30 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:30 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:30 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:30 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:30 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:30 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:30 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:30 - INFO -   Stock: 30 registros
2026-02-06 20:10:30 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:30 - INFO - Fusión completada: 538 registros
2026-02-06 20:10:30 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:30 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:30 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:30 - INFO - 
============================================================
2026-02-06 20:10:30 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:30 - INFO - ============================================================
2026-02-06 20:10:30 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:30 - INFO - Corrección completada:
2026-02-06 20:10:30 - INFO -   - Artículos corregidos: 411/538
2026-02-06 20:10:30 - INFO -   - Artículos aumentados: 411
2026-02-06 20:10:30 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:30 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:30 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:30 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:30 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 20:10:30 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:30 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:30 - DEBUG -   Con valor 0: 127
2026-02-06 20:10:30 - DEBUG -   Con valor > 0: 411
2026-02-06 20:10:30 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 20:10:30 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 411 registros
2026-02-06 20:10:30 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:10:30 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:10:30 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:10:30 - INFO -   Articulos: 411
2026-02-06 20:10:30 - INFO -   Importe: 8993.98€
2026-02-06 20:10:30 - INFO - 
==================================================
2026-02-06 20:10:30 - INFO - SECCION: INTERIOR
2026-02-06 20:10:30 - INFO - ==================================================
2026-02-06 20:10:30 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 20:10:30 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:30 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 20:10:30 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:10:30 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:10:31 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:31 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 20:10:31 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 20:10:31 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:31 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:31 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:10:34 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:34 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:10:35 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:10:35 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:10:35 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:10:35 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:10:35 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 20:10:35 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:10:35 - DEBUG -   maf: 10970 registros
2026-02-06 20:10:35 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:10:35 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:10:35 - DEBUG -   interior: 3624 registros
2026-02-06 20:10:35 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:10:35 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:10:35 - DEBUG -   vivero: 2460 registros
2026-02-06 20:10:35 - DEBUG -   fitos: 1987 registros
2026-02-06 20:10:35 - DEBUG -   semillas: 1180 registros
2026-02-06 20:10:35 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:10:35 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:10:35 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 20:10:35 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 20:10:35 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:10:35 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:37 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:37 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:37 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:37 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:37 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:37 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 20:10:37 - INFO -   ABC: 555 registros
2026-02-06 20:10:37 - INFO -   Ventas: 3624 registros
2026-02-06 20:10:37 - INFO -   Costes: 22145 registros
2026-02-06 20:10:37 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 20:10:37 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 20:10:37 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:37 - INFO - Datos de ventas: 286 registros
2026-02-06 20:10:37 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 20:10:37 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 20:10:37 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:37 - INFO -   Factor total: 1.3125
2026-02-06 20:10:37 - INFO -   Factor escalado: 1.5971
2026-02-06 20:10:37 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 20:10:37 - INFO -   Objetivo final: 3846.45€
2026-02-06 20:10:37 - INFO -   Delta: 685.37€
2026-02-06 20:10:37 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:37 - DEBUG -   Total registros: 138
2026-02-06 20:10:37 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 20:10:37 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 20:10:37 - INFO -   Ventas finales: 3862.17€
2026-02-06 20:10:37 - INFO - 
============================================================
2026-02-06 20:10:37 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:37 - INFO - ============================================================
2026-02-06 20:10:37 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:37 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:37 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:37 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:37 - INFO - ============================================================
2026-02-06 20:10:37 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:37 - INFO - ============================================================
2026-02-06 20:10:37 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:37 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:37 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:37 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:37 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:37 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:37 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:37 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:37 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:37 - INFO -   Stock: 30 registros
2026-02-06 20:10:37 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:37 - INFO - Fusión completada: 138 registros
2026-02-06 20:10:37 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:37 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:37 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:37 - INFO - 
============================================================
2026-02-06 20:10:37 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:37 - INFO - ============================================================
2026-02-06 20:10:37 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:37 - INFO - Corrección completada:
2026-02-06 20:10:37 - INFO -   - Artículos corregidos: 121/138
2026-02-06 20:10:37 - INFO -   - Artículos aumentados: 121
2026-02-06 20:10:37 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:37 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:37 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:37 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:37 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 20:10:37 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:37 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:37 - DEBUG -   Con valor 0: 17
2026-02-06 20:10:37 - DEBUG -   Con valor > 0: 121
2026-02-06 20:10:37 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 20:10:37 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 121 registros
2026-02-06 20:10:37 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:10:37 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:10:37 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:10:37 - INFO -   Articulos: 121
2026-02-06 20:10:37 - INFO -   Importe: 3862.17€
2026-02-06 20:10:37 - INFO - 
==================================================
2026-02-06 20:10:37 - INFO - SECCION: FITOS
2026-02-06 20:10:37 - INFO - ==================================================
2026-02-06 20:10:37 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 20:10:37 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:37 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 20:10:37 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:10:37 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:10:37 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:37 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 20:10:37 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:10:37 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:37 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:37 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:10:41 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:41 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:10:41 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:10:41 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:10:41 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:10:41 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:10:41 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 20:10:41 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:10:41 - DEBUG -   maf: 10970 registros
2026-02-06 20:10:41 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:10:41 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:10:41 - DEBUG -   interior: 3624 registros
2026-02-06 20:10:41 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:10:41 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:10:41 - DEBUG -   vivero: 2460 registros
2026-02-06 20:10:41 - DEBUG -   fitos: 1987 registros
2026-02-06 20:10:41 - DEBUG -   semillas: 1180 registros
2026-02-06 20:10:41 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:10:41 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:10:41 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 20:10:41 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 20:10:41 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:10:41 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:43 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:43 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:43 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:43 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:43 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:43 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 20:10:43 - INFO -   ABC: 247 registros
2026-02-06 20:10:43 - INFO -   Ventas: 1987 registros
2026-02-06 20:10:43 - INFO -   Costes: 22145 registros
2026-02-06 20:10:43 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:10:43 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 20:10:43 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:43 - INFO - Datos de ventas: 157 registros
2026-02-06 20:10:43 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 20:10:44 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 20:10:44 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:44 - INFO -   Factor total: 1.3125
2026-02-06 20:10:44 - INFO -   Factor escalado: 1.4055
2026-02-06 20:10:44 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 20:10:44 - INFO -   Objetivo final: 2360.20€
2026-02-06 20:10:44 - INFO -   Delta: 424.74€
2026-02-06 20:10:44 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:44 - DEBUG -   Total registros: 84
2026-02-06 20:10:44 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 20:10:44 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 20:10:44 - INFO -   Ventas finales: 2365.92€
2026-02-06 20:10:44 - INFO - 
============================================================
2026-02-06 20:10:44 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:44 - INFO - ============================================================
2026-02-06 20:10:44 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:44 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:44 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:44 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:44 - INFO - ============================================================
2026-02-06 20:10:44 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:44 - INFO - ============================================================
2026-02-06 20:10:44 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:44 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:44 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:44 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:44 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:44 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:44 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:44 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:44 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:44 - INFO -   Stock: 30 registros
2026-02-06 20:10:44 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:44 - INFO - Fusión completada: 84 registros
2026-02-06 20:10:44 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:44 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:44 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:44 - INFO - 
============================================================
2026-02-06 20:10:44 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:44 - INFO - ============================================================
2026-02-06 20:10:44 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:44 - INFO - Corrección completada:
2026-02-06 20:10:44 - INFO -   - Artículos corregidos: 82/84
2026-02-06 20:10:44 - INFO -   - Artículos aumentados: 82
2026-02-06 20:10:44 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:44 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:44 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:44 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:44 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:10:44 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:44 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:44 - DEBUG -   Con valor 0: 2
2026-02-06 20:10:44 - DEBUG -   Con valor > 0: 82
2026-02-06 20:10:44 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 20:10:44 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 82 registros
2026-02-06 20:10:44 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:10:44 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:10:44 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:10:44 - INFO -   Articulos: 82
2026-02-06 20:10:44 - INFO -   Importe: 2365.92€
2026-02-06 20:10:44 - INFO - 
==================================================
2026-02-06 20:10:44 - INFO - SECCION: VIVERO
2026-02-06 20:10:44 - INFO - ==================================================
2026-02-06 20:10:44 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 20:10:44 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:44 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 20:10:44 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:10:44 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:10:44 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:44 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 20:10:44 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 20:10:44 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:44 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:44 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:10:48 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:48 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:10:48 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:10:48 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:10:48 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:10:48 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:10:48 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 20:10:48 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:10:48 - DEBUG -   maf: 10970 registros
2026-02-06 20:10:48 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:10:48 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:10:48 - DEBUG -   interior: 3624 registros
2026-02-06 20:10:48 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:10:48 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:10:48 - DEBUG -   vivero: 2460 registros
2026-02-06 20:10:48 - DEBUG -   fitos: 1987 registros
2026-02-06 20:10:48 - DEBUG -   semillas: 1180 registros
2026-02-06 20:10:48 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:10:48 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:10:48 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 20:10:48 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 20:10:48 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:10:48 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:50 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:50 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:50 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:50 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:50 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:50 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 20:10:50 - INFO -   ABC: 565 registros
2026-02-06 20:10:50 - INFO -   Ventas: 2460 registros
2026-02-06 20:10:50 - INFO -   Costes: 22145 registros
2026-02-06 20:10:50 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 20:10:50 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 20:10:50 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:50 - INFO - Datos de ventas: 189 registros
2026-02-06 20:10:50 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 20:10:50 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 20:10:50 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:50 - INFO -   Factor total: 1.3125
2026-02-06 20:10:50 - INFO -   Factor escalado: 1.6886
2026-02-06 20:10:50 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 20:10:50 - INFO -   Objetivo final: 6952.54€
2026-02-06 20:10:50 - INFO -   Delta: 1809.40€
2026-02-06 20:10:50 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:50 - DEBUG -   Total registros: 107
2026-02-06 20:10:50 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 20:10:50 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 20:10:50 - INFO -   Ventas finales: 6990.51€
2026-02-06 20:10:50 - INFO - 
============================================================
2026-02-06 20:10:50 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:50 - INFO - ============================================================
2026-02-06 20:10:50 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:50 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:50 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:50 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:50 - INFO - ============================================================
2026-02-06 20:10:50 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:50 - INFO - ============================================================
2026-02-06 20:10:50 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:50 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:50 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:50 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:50 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:50 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:50 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:50 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:50 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:50 - INFO -   Stock: 30 registros
2026-02-06 20:10:50 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:50 - INFO - Fusión completada: 107 registros
2026-02-06 20:10:50 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:50 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:50 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:50 - INFO - 
============================================================
2026-02-06 20:10:50 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:50 - INFO - ============================================================
2026-02-06 20:10:50 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:50 - INFO - Corrección completada:
2026-02-06 20:10:50 - INFO -   - Artículos corregidos: 96/107
2026-02-06 20:10:50 - INFO -   - Artículos aumentados: 96
2026-02-06 20:10:50 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:50 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:50 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:50 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:50 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 20:10:50 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:50 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:50 - DEBUG -   Con valor 0: 11
2026-02-06 20:10:50 - DEBUG -   Con valor > 0: 96
2026-02-06 20:10:50 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 20:10:50 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 96 registros
2026-02-06 20:10:50 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:10:51 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:10:51 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:10:51 - INFO -   Articulos: 96
2026-02-06 20:10:51 - INFO -   Importe: 6990.51€
2026-02-06 20:10:51 - INFO - 
==================================================
2026-02-06 20:10:51 - INFO - SECCION: UTILES_JARDIN
2026-02-06 20:10:51 - INFO - ==================================================
2026-02-06 20:10:51 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 20:10:51 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:51 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 20:10:51 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:10:51 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:10:51 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:51 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 20:10:51 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 20:10:51 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:51 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:51 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:10:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:55 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:10:55 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:10:55 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:10:55 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:10:55 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:10:55 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 20:10:55 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:10:55 - DEBUG -   maf: 10970 registros
2026-02-06 20:10:55 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:10:55 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:10:55 - DEBUG -   interior: 3624 registros
2026-02-06 20:10:55 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:10:55 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:10:55 - DEBUG -   vivero: 2460 registros
2026-02-06 20:10:55 - DEBUG -   fitos: 1987 registros
2026-02-06 20:10:55 - DEBUG -   semillas: 1180 registros
2026-02-06 20:10:55 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:10:55 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:10:55 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 20:10:55 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 20:10:55 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:10:55 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:10:57 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:57 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:10:57 - INFO - Costes cargados: 22145 registros
2026-02-06 20:10:57 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:10:57 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:10:57 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 20:10:57 - INFO -   ABC: 433 registros
2026-02-06 20:10:57 - INFO -   Ventas: 1009 registros
2026-02-06 20:10:57 - INFO -   Costes: 22145 registros
2026-02-06 20:10:57 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 20:10:57 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 20:10:57 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:10:57 - INFO - Datos de ventas: 89 registros
2026-02-06 20:10:57 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 20:10:57 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 20:10:57 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:10:57 - INFO -   Factor total: 1.3125
2026-02-06 20:10:57 - INFO -   Factor escalado: 1.6747
2026-02-06 20:10:57 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 20:10:57 - INFO -   Objetivo final: 1371.26€
2026-02-06 20:10:57 - INFO -   Delta: 558.30€
2026-02-06 20:10:57 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:10:57 - DEBUG -   Total registros: 78
2026-02-06 20:10:57 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 20:10:57 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 20:10:57 - INFO -   Ventas finales: 1390.00€
2026-02-06 20:10:57 - INFO - 
============================================================
2026-02-06 20:10:57 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:10:57 - INFO - ============================================================
2026-02-06 20:10:57 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:10:57 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:10:57 - INFO - DataLoader inicializado correctamente
2026-02-06 20:10:57 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:10:57 - INFO - ============================================================
2026-02-06 20:10:57 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:10:57 - INFO - ============================================================
2026-02-06 20:10:57 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:10:57 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:10:57 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:57 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:57 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:10:57 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:10:57 - DEBUG - Usando hoja: Stock
2026-02-06 20:10:57 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:10:57 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:10:57 - INFO -   Stock: 30 registros
2026-02-06 20:10:57 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:10:57 - INFO - Fusión completada: 78 registros
2026-02-06 20:10:57 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:10:57 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:10:57 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:10:57 - INFO - 
============================================================
2026-02-06 20:10:57 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:10:57 - INFO - ============================================================
2026-02-06 20:10:57 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:10:57 - INFO - Corrección completada:
2026-02-06 20:10:57 - INFO -   - Artículos corregidos: 78/78
2026-02-06 20:10:57 - INFO -   - Artículos aumentados: 78
2026-02-06 20:10:57 - INFO -   - Artículos reducidos: 0
2026-02-06 20:10:57 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:10:57 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:10:57 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:10:57 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 20:10:57 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:10:57 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:10:57 - DEBUG -   Con valor 0: 0
2026-02-06 20:10:57 - DEBUG -   Con valor > 0: 78
2026-02-06 20:10:57 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 20:10:57 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 78 registros
2026-02-06 20:10:57 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:10:57 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:10:57 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:10:57 - INFO -   Articulos: 78
2026-02-06 20:10:57 - INFO -   Importe: 1390.00€
2026-02-06 20:10:57 - INFO - 
==================================================
2026-02-06 20:10:57 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 20:10:57 - INFO - ==================================================
2026-02-06 20:10:57 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 20:10:57 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:10:57 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 20:10:57 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:10:57 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:10:57 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:10:57 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 20:10:57 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:10:57 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:10:57 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:10:57 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:11:01 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:11:01 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:11:01 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:11:01 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:11:01 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:11:01 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:11:01 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 20:11:01 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:11:01 - DEBUG -   maf: 10970 registros
2026-02-06 20:11:01 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:11:01 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:11:01 - DEBUG -   interior: 3624 registros
2026-02-06 20:11:01 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:11:01 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:11:01 - DEBUG -   vivero: 2460 registros
2026-02-06 20:11:01 - DEBUG -   fitos: 1987 registros
2026-02-06 20:11:01 - DEBUG -   semillas: 1180 registros
2026-02-06 20:11:01 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:11:01 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:11:01 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 20:11:01 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 20:11:01 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:11:01 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:11:03 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:11:03 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:11:03 - INFO - Costes cargados: 22145 registros
2026-02-06 20:11:03 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:11:03 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:11:03 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 20:11:03 - INFO -   ABC: 247 registros
2026-02-06 20:11:03 - INFO -   Ventas: 3264 registros
2026-02-06 20:11:03 - INFO -   Costes: 22145 registros
2026-02-06 20:11:03 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:11:03 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 20:11:03 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:11:03 - INFO - Datos de ventas: 302 registros
2026-02-06 20:11:03 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 20:11:04 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 20:11:04 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:11:04 - INFO -   Factor total: 1.3125
2026-02-06 20:11:04 - INFO -   Factor escalado: 1.3380
2026-02-06 20:11:04 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 20:11:04 - INFO -   Objetivo final: 5377.63€
2026-02-06 20:11:04 - INFO -   Delta: 432.03€
2026-02-06 20:11:04 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:11:04 - DEBUG -   Total registros: 72
2026-02-06 20:11:04 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 20:11:04 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 20:11:04 - INFO -   Ventas finales: 5387.14€
2026-02-06 20:11:04 - INFO - 
============================================================
2026-02-06 20:11:04 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:11:04 - INFO - ============================================================
2026-02-06 20:11:04 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:11:04 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:11:04 - INFO - DataLoader inicializado correctamente
2026-02-06 20:11:04 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:11:04 - INFO - ============================================================
2026-02-06 20:11:04 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:11:04 - INFO - ============================================================
2026-02-06 20:11:04 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:11:04 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:11:04 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:11:04 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:11:04 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:11:04 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:11:04 - DEBUG - Usando hoja: Stock
2026-02-06 20:11:04 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:11:04 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:11:04 - INFO -   Stock: 30 registros
2026-02-06 20:11:04 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:11:04 - INFO - Fusión completada: 72 registros
2026-02-06 20:11:04 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:11:04 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:11:04 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:11:04 - INFO - 
============================================================
2026-02-06 20:11:04 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:11:04 - INFO - ============================================================
2026-02-06 20:11:04 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:11:04 - INFO - Corrección completada:
2026-02-06 20:11:04 - INFO -   - Artículos corregidos: 71/72
2026-02-06 20:11:04 - INFO -   - Artículos aumentados: 71
2026-02-06 20:11:04 - INFO -   - Artículos reducidos: 0
2026-02-06 20:11:04 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:11:04 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:11:04 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:11:04 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 20:11:04 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:11:04 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:11:04 - DEBUG -   Con valor 0: 1
2026-02-06 20:11:04 - DEBUG -   Con valor > 0: 71
2026-02-06 20:11:04 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 20:11:04 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 71 registros
2026-02-06 20:11:04 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:11:04 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:11:04 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:11:04 - INFO -   Articulos: 71
2026-02-06 20:11:04 - INFO -   Importe: 5387.14€
2026-02-06 20:11:04 - INFO - 
==================================================
2026-02-06 20:11:04 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 20:11:04 - INFO - ==================================================
2026-02-06 20:11:04 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 20:11:04 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:11:04 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 20:11:04 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:11:04 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:11:04 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:11:04 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 20:11:04 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 20:11:04 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:11:04 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:11:04 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:11:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:11:08 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:11:08 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:11:08 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:11:08 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:11:08 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:11:08 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 20:11:08 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:11:08 - DEBUG -   maf: 10970 registros
2026-02-06 20:11:08 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:11:08 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:11:08 - DEBUG -   interior: 3624 registros
2026-02-06 20:11:08 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:11:08 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:11:08 - DEBUG -   vivero: 2460 registros
2026-02-06 20:11:08 - DEBUG -   fitos: 1987 registros
2026-02-06 20:11:08 - DEBUG -   semillas: 1180 registros
2026-02-06 20:11:08 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:11:08 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:11:08 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 20:11:08 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 20:11:08 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:11:08 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:11:10 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:11:10 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:11:10 - INFO - Costes cargados: 22145 registros
2026-02-06 20:11:10 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:11:10 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:11:10 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 20:11:10 - INFO -   ABC: 995 registros
2026-02-06 20:11:10 - INFO -   Ventas: 4018 registros
2026-02-06 20:11:10 - INFO -   Costes: 22145 registros
2026-02-06 20:11:10 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 20:11:10 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 20:11:10 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:11:10 - INFO - Datos de ventas: 316 registros
2026-02-06 20:11:10 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 20:11:11 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 20:11:11 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:11:11 - INFO -   Factor total: 1.3125
2026-02-06 20:11:11 - INFO -   Factor escalado: 1.1960
2026-02-06 20:11:11 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 20:11:11 - INFO -   Objetivo final: 4909.20€
2026-02-06 20:11:11 - INFO -   Delta: 1185.39€
2026-02-06 20:11:11 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:11:11 - DEBUG -   Total registros: 224
2026-02-06 20:11:11 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 20:11:11 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 20:11:11 - INFO -   Ventas finales: 4923.89€
2026-02-06 20:11:11 - INFO - 
============================================================
2026-02-06 20:11:11 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:11:11 - INFO - ============================================================
2026-02-06 20:11:11 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:11:11 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:11:11 - INFO - DataLoader inicializado correctamente
2026-02-06 20:11:11 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:11:11 - INFO - ============================================================
2026-02-06 20:11:11 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:11:11 - INFO - ============================================================
2026-02-06 20:11:11 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:11:11 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:11:11 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:11:11 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:11:11 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:11:11 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:11:11 - DEBUG - Usando hoja: Stock
2026-02-06 20:11:11 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:11:11 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:11:11 - INFO -   Stock: 30 registros
2026-02-06 20:11:11 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:11:11 - INFO - Fusión completada: 224 registros
2026-02-06 20:11:11 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:11:11 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:11:11 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:11:11 - INFO - 
============================================================
2026-02-06 20:11:11 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:11:11 - INFO - ============================================================
2026-02-06 20:11:11 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:11:11 - INFO - Corrección completada:
2026-02-06 20:11:11 - INFO -   - Artículos corregidos: 205/224
2026-02-06 20:11:11 - INFO -   - Artículos aumentados: 205
2026-02-06 20:11:11 - INFO -   - Artículos reducidos: 0
2026-02-06 20:11:11 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:11:11 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:11:11 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:11:11 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 20:11:11 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Unidades_Pedido', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:11:11 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:11:11 - DEBUG -   Con valor 0: 19
2026-02-06 20:11:11 - DEBUG -   Con valor > 0: 205
2026-02-06 20:11:11 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 20:11:11 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 205 registros
2026-02-06 20:11:11 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:11:11 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:11:11 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:11:11 - INFO -   Articulos: 205
2026-02-06 20:11:11 - INFO -   Importe: 4923.89€
2026-02-06 20:11:11 - INFO - Estado guardado correctamente
2026-02-06 20:11:11 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:11:11 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:11:11 - INFO - Estado guardado correctamente
2026-02-06 20:11:11 - INFO - 
============================================================
2026-02-06 20:11:11 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 20:11:11 - INFO - ============================================================
2026-02-06 20:11:11 - DEBUG - [DEBUG] Archivos agrupados por sección: {'maf': ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx'], 'interior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx'], 'semillas': ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx'], 'vivo': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx'], 'manufacturado': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx'], 'fitos': ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx'], 'vivero': ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx'], 'jardin': ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx'], 'aridos': ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx'], 'exterior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']}
2026-02-06 20:11:11 - INFO - 
============================================================
2026-02-06 20:11:11 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 20:11:11 - INFO - ============================================================
2026-02-06 20:11:11 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 20:11:11 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 20:11:11 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 20:11:11 - INFO - EmailService inicializado correctamente
2026-02-06 20:11:11 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 20:11:11 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 20:11:11 - INFO - 
Enviando email para sección: maf
2026-02-06 20:11:11 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx']
2026-02-06 20:11:11 - DEBUG - Destinatarios para maf: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:11:11 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:11:11 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:11:11 - INFO - Email enviado para sección maf (semana 14)
2026-02-06 20:11:11 - ERROR - ✗ Error al enviar email a maf: None
2026-02-06 20:11:11 - INFO - 
Enviando email para sección: interior
2026-02-06 20:11:11 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx']
2026-02-06 20:11:11 - DEBUG - Destinatarios para interior: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Iris'}]
2026-02-06 20:11:11 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:11:11 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:11:12 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:11:12 - INFO - Email enviado para sección interior (semana 14)
2026-02-06 20:11:12 - ERROR - ✗ Error al enviar email a interior: None
2026-02-06 20:11:12 - INFO - 
Enviando email para sección: semillas
2026-02-06 20:11:12 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx']
2026-02-06 20:11:12 - DEBUG - Destinatarios para semillas: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:11:12 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:11:12 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:11:12 - INFO - Email enviado para sección semillas (semana 14)
2026-02-06 20:11:12 - ERROR - ✗ Error al enviar email a semillas: None
2026-02-06 20:11:12 - INFO - 
Enviando email para sección: vivo
2026-02-06 20:11:12 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx']
2026-02-06 20:11:12 - WARNING - No hay destinatarios configurados para la sección: vivo
2026-02-06 20:11:12 - WARNING - No se puede enviar email para vivo: No hay destinatarios configurados
2026-02-06 20:11:12 - ERROR - ✗ Error al enviar email a vivo: No hay destinatarios configurados
2026-02-06 20:11:12 - INFO - 
Enviando email para sección: manufacturado
2026-02-06 20:11:12 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx']
2026-02-06 20:11:12 - WARNING - No hay destinatarios configurados para la sección: manufacturado
2026-02-06 20:11:12 - WARNING - No se puede enviar email para manufacturado: No hay destinatarios configurados
2026-02-06 20:11:12 - ERROR - ✗ Error al enviar email a manufacturado: No hay destinatarios configurados
2026-02-06 20:11:12 - INFO - 
Enviando email para sección: fitos
2026-02-06 20:11:12 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx']
2026-02-06 20:11:12 - DEBUG - Destinatarios para fitos: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:11:12 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:11:13 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:11:13 - INFO - Email enviado para sección fitos (semana 14)
2026-02-06 20:11:13 - ERROR - ✗ Error al enviar email a fitos: None
2026-02-06 20:11:13 - INFO - 
Enviando email para sección: vivero
2026-02-06 20:11:13 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx']
2026-02-06 20:11:13 - DEBUG - Destinatarios para vivero: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:11:13 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:11:13 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:11:13 - INFO - Email enviado para sección vivero (semana 14)
2026-02-06 20:11:13 - ERROR - ✗ Error al enviar email a vivero: None
2026-02-06 20:11:13 - INFO - 
Enviando email para sección: jardin
2026-02-06 20:11:13 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx']
2026-02-06 20:11:13 - WARNING - No hay destinatarios configurados para la sección: jardin
2026-02-06 20:11:13 - WARNING - No se puede enviar email para jardin: No hay destinatarios configurados
2026-02-06 20:11:13 - ERROR - ✗ Error al enviar email a jardin: No hay destinatarios configurados
2026-02-06 20:11:13 - INFO - 
Enviando email para sección: aridos
2026-02-06 20:11:13 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx']
2026-02-06 20:11:13 - WARNING - No hay destinatarios configurados para la sección: aridos
2026-02-06 20:11:13 - WARNING - No se puede enviar email para aridos: No hay destinatarios configurados
2026-02-06 20:11:13 - ERROR - ✗ Error al enviar email a aridos: No hay destinatarios configurados
2026-02-06 20:11:13 - INFO - 
Enviando email para sección: exterior
2026-02-06 20:11:13 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']
2026-02-06 20:11:13 - WARNING - No hay destinatarios configurados para la sección: exterior
2026-02-06 20:11:13 - WARNING - No se puede enviar email para exterior: No hay destinatarios configurados
2026-02-06 20:11:13 - ERROR - ✗ Error al enviar email a exterior: No hay destinatarios configurados
2026-02-06 20:11:13 - INFO - 
============================================================
2026-02-06 20:11:13 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 20:11:13 - INFO - ============================================================
2026-02-06 20:11:13 - INFO - Emails enviados exitosamente: 0
2026-02-06 20:11:13 - INFO - Emails fallidos: 10
2026-02-06 20:11:13 - INFO - Secciones procesadas: 10
2026-02-06 20:11:13 - INFO - 
============================================================
2026-02-06 20:11:13 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:11:13 - INFO - ============================================================
2026-02-06 20:11:13 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:11:13 - INFO - 
============================================================
2026-02-06 20:11:13 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:11:13 - INFO - ============================================================
2026-02-06 20:11:13 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:11:13 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 20:11:13 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 20:11:13 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:11:13 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:11:13 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 20:11:13 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:11:14 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 20:11:14 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 20:11:14 - INFO - 
============================================================
2026-02-06 20:11:14 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 20:11:14 - INFO - ============================================================
2026-02-06 20:11:14 - INFO - Emails enviados: 3
2026-02-06 20:11:14 - INFO - Emails fallidos: 0
2026-02-06 20:11:14 - INFO - 
======================================================================
2026-02-06 20:11:14 - INFO - RESUMEN DE EJECUCION
2026-02-06 20:11:14 - INFO - ======================================================================
2026-02-06 20:11:14 - INFO - Semana procesada: 14
2026-02-06 20:11:14 - INFO - Archivos generados: 12
2026-02-06 20:11:14 - INFO - Total articulos: 1510
2026-02-06 20:11:14 - INFO - Total importe: 48115.81€
2026-02-06 20:11:14 - WARNING - 
✗ EMAILS FALLIDOS: 10
2026-02-06 20:11:14 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 20:11:14 - INFO - ======================================================================
2026-02-06 20:11:14 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 20:11:14 - INFO - Archivo principal: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:11:14 - INFO - Artículos: 1510
2026-02-06 20:11:14 - INFO - Importe: 48115.81€
2026-02-06 20:11:14 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 20:20:47 - INFO - ======================================================================
2026-02-06 20:20:47 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 20:20:47 - INFO - Fecha de ejecución: 2026-02-06 20:20:47
2026-02-06 20:20:47 - INFO - ======================================================================
2026-02-06 20:20:47 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 20:20:47 - INFO - Envío de emails: Sí
2026-02-06 20:20:47 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 20:20:47 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 20:20:47 - INFO - Estado cargado correctamente
2026-02-06 20:20:47 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:20:47 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:20:47 - INFO - Semana forzada por argumento: 14
2026-02-06 20:20:47 - INFO - ======================================================================
2026-02-06 20:20:47 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 20:20:47 - INFO - ======================================================================
2026-02-06 20:20:47 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 20:20:47 - INFO - DataLoader inicializado correctamente
2026-02-06 20:20:47 - INFO - ForecastEngine inicializado correctamente
2026-02-06 20:20:47 - INFO - OrderGenerator inicializado correctamente
2026-02-06 20:20:47 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:20:47 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:20:47 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 20:20:47 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 20:20:47 - INFO - 
==================================================
2026-02-06 20:20:47 - INFO - SECCION: MAF
2026-02-06 20:20:47 - INFO - ==================================================
2026-02-06 20:20:47 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 20:20:47 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:20:47 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 20:20:47 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:20:47 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:20:48 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:20:48 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 20:20:48 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 20:20:48 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:20:48 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:20:48 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:20:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:20:51 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:20:52 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:20:52 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:20:52 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:20:52 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:20:52 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 20:20:52 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:20:52 - DEBUG -   maf: 10970 registros
2026-02-06 20:20:52 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:20:52 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:20:52 - DEBUG -   interior: 3624 registros
2026-02-06 20:20:52 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:20:52 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:20:52 - DEBUG -   vivero: 2460 registros
2026-02-06 20:20:52 - DEBUG -   fitos: 1987 registros
2026-02-06 20:20:52 - DEBUG -   semillas: 1180 registros
2026-02-06 20:20:52 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:20:52 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:20:52 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 20:20:52 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 20:20:52 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:20:52 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:20:54 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:20:54 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:20:54 - INFO - Costes cargados: 22145 registros
2026-02-06 20:20:54 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:20:54 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:20:54 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 20:20:54 - INFO -   ABC: 499 registros
2026-02-06 20:20:54 - INFO -   Ventas: 10970 registros
2026-02-06 20:20:54 - INFO -   Costes: 22145 registros
2026-02-06 20:20:54 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 20:20:54 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 20:20:54 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:20:54 - INFO - Datos de ventas: 1011 registros
2026-02-06 20:20:54 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 20:20:54 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 20:20:54 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:20:54 - INFO -   Factor total: 1.3125
2026-02-06 20:20:54 - INFO -   Factor escalado: 1.5844
2026-02-06 20:20:54 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 20:20:54 - INFO -   Objetivo final: 9253.98€
2026-02-06 20:20:54 - INFO -   Delta: 679.77€
2026-02-06 20:20:54 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:20:54 - DEBUG -   Total registros: 222
2026-02-06 20:20:54 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 20:20:54 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 20:20:54 - INFO -   Ventas finales: 9254.53€
2026-02-06 20:20:54 - INFO - 
============================================================
2026-02-06 20:20:54 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:20:54 - INFO - ============================================================
2026-02-06 20:20:54 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:20:54 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:20:54 - INFO - DataLoader inicializado correctamente
2026-02-06 20:20:54 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:20:54 - INFO - ============================================================
2026-02-06 20:20:54 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:20:54 - INFO - ============================================================
2026-02-06 20:20:54 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:20:54 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:20:54 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:20:54 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:20:54 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:20:54 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:20:54 - DEBUG - Usando hoja: Stock
2026-02-06 20:20:54 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:20:54 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:20:54 - INFO -   Stock: 30 registros
2026-02-06 20:20:54 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:20:54 - INFO - Fusión completada: 222 registros
2026-02-06 20:20:54 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:20:54 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:20:54 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:20:54 - INFO - 
============================================================
2026-02-06 20:20:54 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:20:54 - INFO - ============================================================
2026-02-06 20:20:54 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:20:54 - INFO - Corrección completada:
2026-02-06 20:20:54 - INFO -   - Artículos corregidos: 191/222
2026-02-06 20:20:54 - INFO -   - Artículos aumentados: 191
2026-02-06 20:20:54 - INFO -   - Artículos reducidos: 0
2026-02-06 20:20:54 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:20:54 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:20:54 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:20:54 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 20:20:54 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:20:54 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:20:54 - DEBUG -   Con valor 0: 31
2026-02-06 20:20:54 - DEBUG -   Con valor > 0: 191
2026-02-06 20:20:54 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 20:20:54 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 191 registros
2026-02-06 20:20:54 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:20:54 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:20:54 - WARNING - No se generó archivo para 'maf'
2026-02-06 20:20:54 - INFO - 
==================================================
2026-02-06 20:20:54 - INFO - SECCION: DECO_INTERIOR
2026-02-06 20:20:54 - INFO - ==================================================
2026-02-06 20:20:54 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 20:20:54 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:20:54 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 20:20:54 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:20:54 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:20:55 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:20:55 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 20:20:55 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 20:20:55 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:20:55 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:20:55 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:20:59 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:20:59 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:20:59 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:20:59 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:20:59 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:20:59 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:20:59 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 20:20:59 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:20:59 - DEBUG -   maf: 10970 registros
2026-02-06 20:20:59 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:20:59 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:20:59 - DEBUG -   interior: 3624 registros
2026-02-06 20:20:59 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:20:59 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:20:59 - DEBUG -   vivero: 2460 registros
2026-02-06 20:20:59 - DEBUG -   fitos: 1987 registros
2026-02-06 20:20:59 - DEBUG -   semillas: 1180 registros
2026-02-06 20:20:59 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:20:59 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:20:59 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 20:20:59 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 20:20:59 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:20:59 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:01 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:01 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:01 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:01 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:01 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:01 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 20:21:01 - INFO -   ABC: 1827 registros
2026-02-06 20:21:01 - INFO -   Ventas: 2468 registros
2026-02-06 20:21:01 - INFO -   Costes: 22145 registros
2026-02-06 20:21:01 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 20:21:01 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 20:21:01 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:01 - INFO - Datos de ventas: 180 registros
2026-02-06 20:21:01 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 20:21:01 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 20:21:01 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:01 - INFO -   Factor total: 1.3125
2026-02-06 20:21:01 - INFO -   Factor escalado: 1.5747
2026-02-06 20:21:01 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 20:21:01 - INFO -   Objetivo final: 2576.42€
2026-02-06 20:21:01 - INFO -   Delta: 373.59€
2026-02-06 20:21:02 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:02 - DEBUG -   Total registros: 139
2026-02-06 20:21:02 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 20:21:02 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 20:21:02 - INFO -   Ventas finales: 2580.73€
2026-02-06 20:21:02 - INFO - 
============================================================
2026-02-06 20:21:02 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:02 - INFO - ============================================================
2026-02-06 20:21:02 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:02 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:02 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:02 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:02 - INFO - ============================================================
2026-02-06 20:21:02 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:02 - INFO - ============================================================
2026-02-06 20:21:02 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:02 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:02 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:02 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:02 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:02 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:02 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:02 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:02 - INFO -   Stock: 30 registros
2026-02-06 20:21:02 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:02 - INFO - Fusión completada: 139 registros
2026-02-06 20:21:02 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:02 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:02 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:02 - INFO - 
============================================================
2026-02-06 20:21:02 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:02 - INFO - ============================================================
2026-02-06 20:21:02 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:02 - INFO - Corrección completada:
2026-02-06 20:21:02 - INFO -   - Artículos corregidos: 135/139
2026-02-06 20:21:02 - INFO -   - Artículos aumentados: 135
2026-02-06 20:21:02 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:02 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:02 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:02 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:02 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 20:21:02 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:02 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:02 - DEBUG -   Con valor 0: 4
2026-02-06 20:21:02 - DEBUG -   Con valor > 0: 135
2026-02-06 20:21:02 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 20:21:02 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 135 registros
2026-02-06 20:21:02 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:21:02 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:02 - WARNING - No se generó archivo para 'deco_interior'
2026-02-06 20:21:02 - INFO - 
==================================================
2026-02-06 20:21:02 - INFO - SECCION: SEMILLAS
2026-02-06 20:21:02 - INFO - ==================================================
2026-02-06 20:21:02 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 20:21:02 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:02 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 20:21:02 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:21:02 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:21:02 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:02 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 20:21:02 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 20:21:02 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:02 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:02 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:21:06 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:06 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:21:06 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:21:06 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:21:06 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:21:06 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:21:06 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 20:21:06 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:21:06 - DEBUG -   maf: 10970 registros
2026-02-06 20:21:06 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:21:06 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:21:06 - DEBUG -   interior: 3624 registros
2026-02-06 20:21:06 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:21:06 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:21:06 - DEBUG -   vivero: 2460 registros
2026-02-06 20:21:06 - DEBUG -   fitos: 1987 registros
2026-02-06 20:21:06 - DEBUG -   semillas: 1180 registros
2026-02-06 20:21:06 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:21:06 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:21:06 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 20:21:06 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 20:21:06 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:21:06 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:08 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:08 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:08 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:08 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:08 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 20:21:08 - INFO -   ABC: 218 registros
2026-02-06 20:21:08 - INFO -   Ventas: 1180 registros
2026-02-06 20:21:08 - INFO -   Costes: 22145 registros
2026-02-06 20:21:08 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 20:21:08 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 20:21:08 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:08 - INFO - Datos de ventas: 136 registros
2026-02-06 20:21:08 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 20:21:08 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 20:21:08 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:08 - INFO -   Factor total: 1.3125
2026-02-06 20:21:08 - INFO -   Factor escalado: 2.0023
2026-02-06 20:21:08 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 20:21:08 - INFO -   Objetivo final: 911.32€
2026-02-06 20:21:08 - INFO -   Delta: 217.83€
2026-02-06 20:21:08 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:08 - DEBUG -   Total registros: 84
2026-02-06 20:21:08 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 20:21:08 - DEBUG -   Ventas finales: 911.60€
2026-02-06 20:21:08 - INFO -   Ventas finales: 911.60€
2026-02-06 20:21:08 - INFO - 
============================================================
2026-02-06 20:21:08 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:08 - INFO - ============================================================
2026-02-06 20:21:08 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:08 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:08 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:08 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:08 - INFO - ============================================================
2026-02-06 20:21:08 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:08 - INFO - ============================================================
2026-02-06 20:21:08 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:08 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:08 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:08 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:08 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:08 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:08 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:08 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:08 - INFO -   Stock: 30 registros
2026-02-06 20:21:08 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:08 - INFO - Fusión completada: 84 registros
2026-02-06 20:21:08 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:08 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:08 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:08 - INFO - 
============================================================
2026-02-06 20:21:08 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:08 - INFO - ============================================================
2026-02-06 20:21:08 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:08 - INFO - Corrección completada:
2026-02-06 20:21:08 - INFO -   - Artículos corregidos: 84/84
2026-02-06 20:21:08 - INFO -   - Artículos aumentados: 84
2026-02-06 20:21:08 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:08 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:08 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:08 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:08 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:21:08 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:08 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:08 - DEBUG -   Con valor 0: 0
2026-02-06 20:21:08 - DEBUG -   Con valor > 0: 84
2026-02-06 20:21:08 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 20:21:08 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 84 registros
2026-02-06 20:21:08 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:21:08 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:08 - WARNING - No se generó archivo para 'semillas'
2026-02-06 20:21:08 - INFO - 
==================================================
2026-02-06 20:21:08 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 20:21:08 - INFO - ==================================================
2026-02-06 20:21:08 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 20:21:08 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:08 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 20:21:08 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:21:08 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:21:08 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:08 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 20:21:08 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 20:21:08 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:08 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:08 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:21:12 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:12 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:21:12 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:21:12 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:21:12 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:21:12 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:21:12 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 20:21:12 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:21:12 - DEBUG -   maf: 10970 registros
2026-02-06 20:21:12 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:21:12 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:21:12 - DEBUG -   interior: 3624 registros
2026-02-06 20:21:12 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:21:12 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:21:12 - DEBUG -   vivero: 2460 registros
2026-02-06 20:21:12 - DEBUG -   fitos: 1987 registros
2026-02-06 20:21:12 - DEBUG -   semillas: 1180 registros
2026-02-06 20:21:12 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:21:12 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:21:12 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 20:21:12 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 20:21:12 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:21:12 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:15 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:15 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:15 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:15 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:15 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:15 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 20:21:15 - INFO -   ABC: 205 registros
2026-02-06 20:21:15 - INFO -   Ventas: 1124 registros
2026-02-06 20:21:15 - INFO -   Costes: 22145 registros
2026-02-06 20:21:15 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 20:21:15 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 20:21:15 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:15 - INFO - Datos de ventas: 88 registros
2026-02-06 20:21:15 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 20:21:15 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 20:21:15 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:15 - INFO -   Factor total: 1.3125
2026-02-06 20:21:15 - INFO -   Factor escalado: 1.6854
2026-02-06 20:21:15 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 20:21:15 - INFO -   Objetivo final: 1426.88€
2026-02-06 20:21:15 - INFO -   Delta: 346.78€
2026-02-06 20:21:15 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:15 - DEBUG -   Total registros: 43
2026-02-06 20:21:15 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 20:21:15 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 20:21:15 - INFO -   Ventas finales: 1455.34€
2026-02-06 20:21:15 - INFO - 
============================================================
2026-02-06 20:21:15 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:15 - INFO - ============================================================
2026-02-06 20:21:15 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:15 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:15 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:15 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:15 - INFO - ============================================================
2026-02-06 20:21:15 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:15 - INFO - ============================================================
2026-02-06 20:21:15 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:15 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:15 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:15 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:15 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:15 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:15 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:15 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:15 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:15 - INFO -   Stock: 30 registros
2026-02-06 20:21:15 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:15 - INFO - Fusión completada: 43 registros
2026-02-06 20:21:15 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:15 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:15 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:15 - INFO - 
============================================================
2026-02-06 20:21:15 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:15 - INFO - ============================================================
2026-02-06 20:21:15 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:15 - INFO - Corrección completada:
2026-02-06 20:21:15 - INFO -   - Artículos corregidos: 36/43
2026-02-06 20:21:15 - INFO -   - Artículos aumentados: 36
2026-02-06 20:21:15 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:15 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:15 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:15 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:15 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 20:21:15 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:15 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:15 - DEBUG -   Con valor 0: 7
2026-02-06 20:21:15 - DEBUG -   Con valor > 0: 36
2026-02-06 20:21:15 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 20:21:15 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 36 registros
2026-02-06 20:21:15 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:21:15 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:15 - WARNING - No se generó archivo para 'mascotas_vivo'
2026-02-06 20:21:15 - INFO - 
==================================================
2026-02-06 20:21:15 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 20:21:15 - INFO - ==================================================
2026-02-06 20:21:15 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 20:21:15 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:15 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 20:21:15 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:21:15 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:21:15 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:15 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 20:21:15 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 20:21:15 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:15 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:15 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:21:19 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:19 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:21:19 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:21:19 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:21:19 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:21:19 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:21:19 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 20:21:20 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:21:20 - DEBUG -   maf: 10970 registros
2026-02-06 20:21:20 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:21:20 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:21:20 - DEBUG -   interior: 3624 registros
2026-02-06 20:21:20 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:21:20 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:21:20 - DEBUG -   vivero: 2460 registros
2026-02-06 20:21:20 - DEBUG -   fitos: 1987 registros
2026-02-06 20:21:20 - DEBUG -   semillas: 1180 registros
2026-02-06 20:21:20 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:21:20 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:21:20 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 20:21:20 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 20:21:20 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:21:20 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:22 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:22 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:22 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:22 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:22 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:22 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 20:21:22 - INFO -   ABC: 2749 registros
2026-02-06 20:21:22 - INFO -   Ventas: 9784 registros
2026-02-06 20:21:22 - INFO -   Costes: 22145 registros
2026-02-06 20:21:22 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 20:21:22 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 20:21:22 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:22 - INFO - Datos de ventas: 822 registros
2026-02-06 20:21:22 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 20:21:24 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 20:21:24 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:24 - INFO -   Factor total: 1.3125
2026-02-06 20:21:24 - INFO -   Factor escalado: 1.0268
2026-02-06 20:21:24 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 20:21:24 - INFO -   Objetivo final: 8977.26€
2026-02-06 20:21:24 - INFO -   Delta: 3401.99€
2026-02-06 20:21:24 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:24 - DEBUG -   Total registros: 538
2026-02-06 20:21:24 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 20:21:24 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 20:21:24 - INFO -   Ventas finales: 8993.98€
2026-02-06 20:21:24 - INFO - 
============================================================
2026-02-06 20:21:24 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:24 - INFO - ============================================================
2026-02-06 20:21:24 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:24 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:24 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:24 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:24 - INFO - ============================================================
2026-02-06 20:21:24 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:24 - INFO - ============================================================
2026-02-06 20:21:24 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:24 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:24 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:24 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:24 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:24 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:24 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:24 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:24 - INFO -   Stock: 30 registros
2026-02-06 20:21:24 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:24 - INFO - Fusión completada: 538 registros
2026-02-06 20:21:24 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:24 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:24 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:24 - INFO - 
============================================================
2026-02-06 20:21:24 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:24 - INFO - ============================================================
2026-02-06 20:21:24 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:24 - INFO - Corrección completada:
2026-02-06 20:21:24 - INFO -   - Artículos corregidos: 411/538
2026-02-06 20:21:24 - INFO -   - Artículos aumentados: 411
2026-02-06 20:21:24 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:24 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:24 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:24 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:24 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 20:21:24 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:24 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:24 - DEBUG -   Con valor 0: 127
2026-02-06 20:21:24 - DEBUG -   Con valor > 0: 411
2026-02-06 20:21:24 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 20:21:24 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 411 registros
2026-02-06 20:21:24 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:21:24 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:24 - WARNING - No se generó archivo para 'mascotas_manufacturado'
2026-02-06 20:21:24 - INFO - 
==================================================
2026-02-06 20:21:24 - INFO - SECCION: INTERIOR
2026-02-06 20:21:24 - INFO - ==================================================
2026-02-06 20:21:24 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 20:21:24 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:24 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 20:21:24 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:21:24 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:21:24 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:24 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 20:21:24 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 20:21:24 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:24 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:24 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:21:28 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:28 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:21:28 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:21:28 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:21:28 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:21:28 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:21:28 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 20:21:28 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:21:28 - DEBUG -   maf: 10970 registros
2026-02-06 20:21:28 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:21:28 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:21:28 - DEBUG -   interior: 3624 registros
2026-02-06 20:21:28 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:21:28 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:21:28 - DEBUG -   vivero: 2460 registros
2026-02-06 20:21:28 - DEBUG -   fitos: 1987 registros
2026-02-06 20:21:28 - DEBUG -   semillas: 1180 registros
2026-02-06 20:21:28 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:21:28 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:21:29 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 20:21:29 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 20:21:29 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:21:29 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:31 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:31 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:31 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:31 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:31 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 20:21:31 - INFO -   ABC: 555 registros
2026-02-06 20:21:31 - INFO -   Ventas: 3624 registros
2026-02-06 20:21:31 - INFO -   Costes: 22145 registros
2026-02-06 20:21:31 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 20:21:31 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 20:21:31 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:31 - INFO - Datos de ventas: 286 registros
2026-02-06 20:21:31 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 20:21:31 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 20:21:31 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:31 - INFO -   Factor total: 1.3125
2026-02-06 20:21:31 - INFO -   Factor escalado: 1.5971
2026-02-06 20:21:31 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 20:21:31 - INFO -   Objetivo final: 3846.45€
2026-02-06 20:21:31 - INFO -   Delta: 685.37€
2026-02-06 20:21:31 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:31 - DEBUG -   Total registros: 138
2026-02-06 20:21:31 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 20:21:31 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 20:21:31 - INFO -   Ventas finales: 3862.17€
2026-02-06 20:21:31 - INFO - 
============================================================
2026-02-06 20:21:31 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:31 - INFO - ============================================================
2026-02-06 20:21:31 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:31 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:31 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:31 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:31 - INFO - ============================================================
2026-02-06 20:21:31 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:31 - INFO - ============================================================
2026-02-06 20:21:31 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:31 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:31 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:31 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:31 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:31 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:31 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:31 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:31 - INFO -   Stock: 30 registros
2026-02-06 20:21:31 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:31 - INFO - Fusión completada: 138 registros
2026-02-06 20:21:31 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:31 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:31 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:31 - INFO - 
============================================================
2026-02-06 20:21:31 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:31 - INFO - ============================================================
2026-02-06 20:21:31 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:31 - INFO - Corrección completada:
2026-02-06 20:21:31 - INFO -   - Artículos corregidos: 121/138
2026-02-06 20:21:31 - INFO -   - Artículos aumentados: 121
2026-02-06 20:21:31 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:31 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:31 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:31 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:31 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 20:21:31 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:31 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:31 - DEBUG -   Con valor 0: 17
2026-02-06 20:21:31 - DEBUG -   Con valor > 0: 121
2026-02-06 20:21:31 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 20:21:31 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 121 registros
2026-02-06 20:21:31 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:21:31 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:31 - WARNING - No se generó archivo para 'interior'
2026-02-06 20:21:31 - INFO - 
==================================================
2026-02-06 20:21:31 - INFO - SECCION: FITOS
2026-02-06 20:21:31 - INFO - ==================================================
2026-02-06 20:21:31 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 20:21:31 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:31 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 20:21:31 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:21:31 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:21:31 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:31 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 20:21:31 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:21:31 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:31 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:31 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:21:35 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:35 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:21:35 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:21:35 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:21:35 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:21:35 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:21:35 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 20:21:35 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:21:35 - DEBUG -   maf: 10970 registros
2026-02-06 20:21:35 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:21:35 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:21:35 - DEBUG -   interior: 3624 registros
2026-02-06 20:21:35 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:21:35 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:21:35 - DEBUG -   vivero: 2460 registros
2026-02-06 20:21:35 - DEBUG -   fitos: 1987 registros
2026-02-06 20:21:35 - DEBUG -   semillas: 1180 registros
2026-02-06 20:21:35 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:21:35 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:21:35 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 20:21:35 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 20:21:35 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:21:35 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:37 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:37 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:37 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:37 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:37 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:37 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 20:21:37 - INFO -   ABC: 247 registros
2026-02-06 20:21:37 - INFO -   Ventas: 1987 registros
2026-02-06 20:21:37 - INFO -   Costes: 22145 registros
2026-02-06 20:21:37 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:21:37 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 20:21:37 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:37 - INFO - Datos de ventas: 157 registros
2026-02-06 20:21:37 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 20:21:38 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 20:21:38 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:38 - INFO -   Factor total: 1.3125
2026-02-06 20:21:38 - INFO -   Factor escalado: 1.4055
2026-02-06 20:21:38 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 20:21:38 - INFO -   Objetivo final: 2360.20€
2026-02-06 20:21:38 - INFO -   Delta: 424.74€
2026-02-06 20:21:38 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:38 - DEBUG -   Total registros: 84
2026-02-06 20:21:38 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 20:21:38 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 20:21:38 - INFO -   Ventas finales: 2365.92€
2026-02-06 20:21:38 - INFO - 
============================================================
2026-02-06 20:21:38 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:38 - INFO - ============================================================
2026-02-06 20:21:38 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:38 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:38 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:38 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:38 - INFO - ============================================================
2026-02-06 20:21:38 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:38 - INFO - ============================================================
2026-02-06 20:21:38 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:38 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:38 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:38 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:38 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:38 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:38 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:38 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:38 - INFO -   Stock: 30 registros
2026-02-06 20:21:38 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:38 - INFO - Fusión completada: 84 registros
2026-02-06 20:21:38 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:38 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:38 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:38 - INFO - 
============================================================
2026-02-06 20:21:38 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:38 - INFO - ============================================================
2026-02-06 20:21:38 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:38 - INFO - Corrección completada:
2026-02-06 20:21:38 - INFO -   - Artículos corregidos: 82/84
2026-02-06 20:21:38 - INFO -   - Artículos aumentados: 82
2026-02-06 20:21:38 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:38 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:38 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:38 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:38 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:21:38 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:38 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:38 - DEBUG -   Con valor 0: 2
2026-02-06 20:21:38 - DEBUG -   Con valor > 0: 82
2026-02-06 20:21:38 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 20:21:38 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 82 registros
2026-02-06 20:21:38 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:21:38 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:38 - WARNING - No se generó archivo para 'fitos'
2026-02-06 20:21:38 - INFO - 
==================================================
2026-02-06 20:21:38 - INFO - SECCION: VIVERO
2026-02-06 20:21:38 - INFO - ==================================================
2026-02-06 20:21:38 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 20:21:38 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:38 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 20:21:38 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:21:38 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:21:38 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:38 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 20:21:38 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 20:21:38 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:38 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:38 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:21:42 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:42 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:21:42 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:21:42 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:21:42 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:21:42 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:21:42 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 20:21:42 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:21:42 - DEBUG -   maf: 10970 registros
2026-02-06 20:21:42 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:21:42 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:21:42 - DEBUG -   interior: 3624 registros
2026-02-06 20:21:42 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:21:42 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:21:42 - DEBUG -   vivero: 2460 registros
2026-02-06 20:21:42 - DEBUG -   fitos: 1987 registros
2026-02-06 20:21:42 - DEBUG -   semillas: 1180 registros
2026-02-06 20:21:42 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:21:42 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:21:42 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 20:21:42 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 20:21:42 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:21:42 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:44 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:44 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:44 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:44 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:44 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:44 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 20:21:44 - INFO -   ABC: 565 registros
2026-02-06 20:21:44 - INFO -   Ventas: 2460 registros
2026-02-06 20:21:44 - INFO -   Costes: 22145 registros
2026-02-06 20:21:44 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 20:21:44 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 20:21:44 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:44 - INFO - Datos de ventas: 189 registros
2026-02-06 20:21:44 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 20:21:44 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 20:21:44 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:44 - INFO -   Factor total: 1.3125
2026-02-06 20:21:44 - INFO -   Factor escalado: 1.6886
2026-02-06 20:21:44 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 20:21:44 - INFO -   Objetivo final: 6952.54€
2026-02-06 20:21:44 - INFO -   Delta: 1809.40€
2026-02-06 20:21:44 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:44 - DEBUG -   Total registros: 107
2026-02-06 20:21:44 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 20:21:44 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 20:21:44 - INFO -   Ventas finales: 6990.51€
2026-02-06 20:21:45 - INFO - 
============================================================
2026-02-06 20:21:45 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:45 - INFO - ============================================================
2026-02-06 20:21:45 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:45 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:45 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:45 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:45 - INFO - ============================================================
2026-02-06 20:21:45 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:45 - INFO - ============================================================
2026-02-06 20:21:45 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:45 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:45 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:45 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:45 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:45 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:45 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:45 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:45 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:45 - INFO -   Stock: 30 registros
2026-02-06 20:21:45 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:45 - INFO - Fusión completada: 107 registros
2026-02-06 20:21:45 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:45 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:45 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:45 - INFO - 
============================================================
2026-02-06 20:21:45 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:45 - INFO - ============================================================
2026-02-06 20:21:45 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:45 - INFO - Corrección completada:
2026-02-06 20:21:45 - INFO -   - Artículos corregidos: 96/107
2026-02-06 20:21:45 - INFO -   - Artículos aumentados: 96
2026-02-06 20:21:45 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:45 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:45 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:45 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:45 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 20:21:45 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:45 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:45 - DEBUG -   Con valor 0: 11
2026-02-06 20:21:45 - DEBUG -   Con valor > 0: 96
2026-02-06 20:21:45 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 20:21:45 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 96 registros
2026-02-06 20:21:45 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:21:45 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:45 - WARNING - No se generó archivo para 'vivero'
2026-02-06 20:21:45 - INFO - 
==================================================
2026-02-06 20:21:45 - INFO - SECCION: UTILES_JARDIN
2026-02-06 20:21:45 - INFO - ==================================================
2026-02-06 20:21:45 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 20:21:45 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:45 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 20:21:45 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:21:45 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:21:45 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:45 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 20:21:45 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 20:21:45 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:45 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:45 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:21:49 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:49 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:21:49 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:21:49 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:21:49 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:21:49 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:21:49 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 20:21:49 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:21:49 - DEBUG -   maf: 10970 registros
2026-02-06 20:21:49 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:21:49 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:21:49 - DEBUG -   interior: 3624 registros
2026-02-06 20:21:49 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:21:49 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:21:49 - DEBUG -   vivero: 2460 registros
2026-02-06 20:21:49 - DEBUG -   fitos: 1987 registros
2026-02-06 20:21:49 - DEBUG -   semillas: 1180 registros
2026-02-06 20:21:49 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:21:49 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:21:49 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 20:21:49 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 20:21:49 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:21:49 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:51 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:51 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:51 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:51 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:51 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 20:21:51 - INFO -   ABC: 433 registros
2026-02-06 20:21:51 - INFO -   Ventas: 1009 registros
2026-02-06 20:21:51 - INFO -   Costes: 22145 registros
2026-02-06 20:21:51 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 20:21:51 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 20:21:51 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:51 - INFO - Datos de ventas: 89 registros
2026-02-06 20:21:51 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 20:21:51 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 20:21:51 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:51 - INFO -   Factor total: 1.3125
2026-02-06 20:21:51 - INFO -   Factor escalado: 1.6747
2026-02-06 20:21:51 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 20:21:51 - INFO -   Objetivo final: 1371.26€
2026-02-06 20:21:51 - INFO -   Delta: 558.30€
2026-02-06 20:21:51 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:51 - DEBUG -   Total registros: 78
2026-02-06 20:21:51 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 20:21:51 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 20:21:51 - INFO -   Ventas finales: 1390.00€
2026-02-06 20:21:51 - INFO - 
============================================================
2026-02-06 20:21:51 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:51 - INFO - ============================================================
2026-02-06 20:21:51 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:51 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:51 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:51 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:51 - INFO - ============================================================
2026-02-06 20:21:51 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:51 - INFO - ============================================================
2026-02-06 20:21:51 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:51 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:51 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:51 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:51 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:51 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:51 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:51 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:51 - INFO -   Stock: 30 registros
2026-02-06 20:21:51 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:51 - INFO - Fusión completada: 78 registros
2026-02-06 20:21:51 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:51 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:51 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:51 - INFO - 
============================================================
2026-02-06 20:21:51 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:51 - INFO - ============================================================
2026-02-06 20:21:51 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:51 - INFO - Corrección completada:
2026-02-06 20:21:51 - INFO -   - Artículos corregidos: 78/78
2026-02-06 20:21:51 - INFO -   - Artículos aumentados: 78
2026-02-06 20:21:51 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:51 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:51 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:51 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:51 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 20:21:51 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:51 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:51 - DEBUG -   Con valor 0: 0
2026-02-06 20:21:51 - DEBUG -   Con valor > 0: 78
2026-02-06 20:21:51 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 20:21:51 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 78 registros
2026-02-06 20:21:51 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:21:51 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:51 - WARNING - No se generó archivo para 'utiles_jardin'
2026-02-06 20:21:51 - INFO - 
==================================================
2026-02-06 20:21:51 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 20:21:51 - INFO - ==================================================
2026-02-06 20:21:51 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 20:21:51 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:51 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 20:21:51 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:21:51 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:21:51 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:51 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 20:21:51 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:21:51 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:51 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:51 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:21:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:55 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:21:55 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:21:55 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:21:55 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:21:55 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:21:55 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 20:21:55 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:21:55 - DEBUG -   maf: 10970 registros
2026-02-06 20:21:55 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:21:55 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:21:55 - DEBUG -   interior: 3624 registros
2026-02-06 20:21:55 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:21:55 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:21:55 - DEBUG -   vivero: 2460 registros
2026-02-06 20:21:55 - DEBUG -   fitos: 1987 registros
2026-02-06 20:21:55 - DEBUG -   semillas: 1180 registros
2026-02-06 20:21:55 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:21:55 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:21:55 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 20:21:55 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 20:21:55 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:21:55 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:21:57 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:57 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:21:57 - INFO - Costes cargados: 22145 registros
2026-02-06 20:21:57 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:21:57 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:21:57 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 20:21:57 - INFO -   ABC: 247 registros
2026-02-06 20:21:57 - INFO -   Ventas: 3264 registros
2026-02-06 20:21:57 - INFO -   Costes: 22145 registros
2026-02-06 20:21:57 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:21:57 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 20:21:57 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:21:57 - INFO - Datos de ventas: 302 registros
2026-02-06 20:21:57 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 20:21:58 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 20:21:58 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:21:58 - INFO -   Factor total: 1.3125
2026-02-06 20:21:58 - INFO -   Factor escalado: 1.3380
2026-02-06 20:21:58 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 20:21:58 - INFO -   Objetivo final: 5377.63€
2026-02-06 20:21:58 - INFO -   Delta: 432.03€
2026-02-06 20:21:58 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:21:58 - DEBUG -   Total registros: 72
2026-02-06 20:21:58 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 20:21:58 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 20:21:58 - INFO -   Ventas finales: 5387.14€
2026-02-06 20:21:58 - INFO - 
============================================================
2026-02-06 20:21:58 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:21:58 - INFO - ============================================================
2026-02-06 20:21:58 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:21:58 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:21:58 - INFO - DataLoader inicializado correctamente
2026-02-06 20:21:58 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:21:58 - INFO - ============================================================
2026-02-06 20:21:58 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:21:58 - INFO - ============================================================
2026-02-06 20:21:58 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:21:58 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:21:58 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:58 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:58 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:21:58 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:21:58 - DEBUG - Usando hoja: Stock
2026-02-06 20:21:58 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:21:58 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:21:58 - INFO -   Stock: 30 registros
2026-02-06 20:21:58 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:21:58 - INFO - Fusión completada: 72 registros
2026-02-06 20:21:58 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:21:58 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:21:58 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:21:58 - INFO - 
============================================================
2026-02-06 20:21:58 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:21:58 - INFO - ============================================================
2026-02-06 20:21:58 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:21:58 - INFO - Corrección completada:
2026-02-06 20:21:58 - INFO -   - Artículos corregidos: 71/72
2026-02-06 20:21:58 - INFO -   - Artículos aumentados: 71
2026-02-06 20:21:58 - INFO -   - Artículos reducidos: 0
2026-02-06 20:21:58 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:21:58 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:21:58 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:21:58 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 20:21:58 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:21:58 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:21:58 - DEBUG -   Con valor 0: 1
2026-02-06 20:21:58 - DEBUG -   Con valor > 0: 71
2026-02-06 20:21:58 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 20:21:58 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 71 registros
2026-02-06 20:21:58 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:21:58 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:21:58 - WARNING - No se generó archivo para 'tierras_aridos'
2026-02-06 20:21:58 - INFO - 
==================================================
2026-02-06 20:21:58 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 20:21:58 - INFO - ==================================================
2026-02-06 20:21:58 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 20:21:58 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:21:58 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 20:21:58 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:21:58 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:21:58 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:21:58 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 20:21:58 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 20:21:58 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:21:58 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:21:58 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:22:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:22:02 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:22:02 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:22:02 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:22:02 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:22:02 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:22:02 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 20:22:02 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:22:02 - DEBUG -   maf: 10970 registros
2026-02-06 20:22:02 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:22:02 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:22:02 - DEBUG -   interior: 3624 registros
2026-02-06 20:22:02 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:22:02 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:22:02 - DEBUG -   vivero: 2460 registros
2026-02-06 20:22:02 - DEBUG -   fitos: 1987 registros
2026-02-06 20:22:02 - DEBUG -   semillas: 1180 registros
2026-02-06 20:22:02 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:22:02 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:22:02 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 20:22:02 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 20:22:02 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:22:02 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:22:04 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:22:04 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:22:04 - INFO - Costes cargados: 22145 registros
2026-02-06 20:22:04 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:22:04 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:22:04 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 20:22:04 - INFO -   ABC: 995 registros
2026-02-06 20:22:04 - INFO -   Ventas: 4018 registros
2026-02-06 20:22:04 - INFO -   Costes: 22145 registros
2026-02-06 20:22:04 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 20:22:04 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 20:22:04 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:22:04 - INFO - Datos de ventas: 316 registros
2026-02-06 20:22:04 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 20:22:05 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 20:22:05 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:22:05 - INFO -   Factor total: 1.3125
2026-02-06 20:22:05 - INFO -   Factor escalado: 1.1960
2026-02-06 20:22:05 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 20:22:05 - INFO -   Objetivo final: 4909.20€
2026-02-06 20:22:05 - INFO -   Delta: 1185.39€
2026-02-06 20:22:05 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:22:05 - DEBUG -   Total registros: 224
2026-02-06 20:22:05 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 20:22:05 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 20:22:05 - INFO -   Ventas finales: 4923.89€
2026-02-06 20:22:05 - INFO - 
============================================================
2026-02-06 20:22:05 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:22:05 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:22:05 - INFO - DataLoader inicializado correctamente
2026-02-06 20:22:05 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:22:05 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:22:05 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:22:05 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:22:05 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:22:05 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:22:05 - DEBUG - Usando hoja: Stock
2026-02-06 20:22:05 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:22:05 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:22:05 - INFO -   Stock: 30 registros
2026-02-06 20:22:05 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:22:05 - INFO - Fusión completada: 224 registros
2026-02-06 20:22:05 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:22:05 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:22:05 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:22:05 - INFO - 
============================================================
2026-02-06 20:22:05 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:22:05 - INFO - Corrección completada:
2026-02-06 20:22:05 - INFO -   - Artículos corregidos: 205/224
2026-02-06 20:22:05 - INFO -   - Artículos aumentados: 205
2026-02-06 20:22:05 - INFO -   - Artículos reducidos: 0
2026-02-06 20:22:05 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:22:05 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:22:05 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:22:05 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 20:22:05 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:22:05 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:22:05 - DEBUG -   Con valor 0: 19
2026-02-06 20:22:05 - DEBUG -   Con valor > 0: 205
2026-02-06 20:22:05 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 20:22:05 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 205 registros
2026-02-06 20:22:05 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:22:05 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:22:05 - WARNING - No se generó archivo para 'deco_exterior'
2026-02-06 20:22:05 - INFO - Estado guardado correctamente
2026-02-06 20:22:05 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:22:05 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:22:05 - INFO - Estado guardado correctamente
2026-02-06 20:22:05 - INFO - 
============================================================
2026-02-06 20:22:05 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - DEBUG - [DEBUG] Archivos agrupados por sección: {}
2026-02-06 20:22:05 - INFO - 
============================================================
2026-02-06 20:22:05 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 20:22:05 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 20:22:05 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 20:22:05 - INFO - EmailService inicializado correctamente
2026-02-06 20:22:05 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 20:22:05 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 20:22:05 - INFO - 
============================================================
2026-02-06 20:22:05 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - INFO - Emails enviados exitosamente: 0
2026-02-06 20:22:05 - INFO - Emails fallidos: 0
2026-02-06 20:22:05 - INFO - Secciones procesadas: 0
2026-02-06 20:22:05 - INFO - 
============================================================
2026-02-06 20:22:05 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:22:05 - INFO - 
============================================================
2026-02-06 20:22:05 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:22:05 - INFO - ============================================================
2026-02-06 20:22:05 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:22:05 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 20:22:05 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 20:22:05 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:22:06 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:22:06 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 20:22:06 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:22:06 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 20:22:06 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 20:22:06 - INFO - 
============================================================
2026-02-06 20:22:06 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 20:22:06 - INFO - ============================================================
2026-02-06 20:22:06 - INFO - Emails enviados: 3
2026-02-06 20:22:06 - INFO - Emails fallidos: 0
2026-02-06 20:22:06 - INFO - 
======================================================================
2026-02-06 20:22:06 - INFO - RESUMEN DE EJECUCION
2026-02-06 20:22:06 - INFO - ======================================================================
2026-02-06 20:22:06 - INFO - Semana procesada: 14
2026-02-06 20:22:06 - INFO - Archivos generados: 1
2026-02-06 20:22:06 - INFO - Total articulos: 0
2026-02-06 20:22:06 - INFO - Total importe: 0.00€
2026-02-06 20:22:06 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 20:22:06 - INFO - ======================================================================
2026-02-06 20:22:06 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 20:22:06 - INFO - Archivo principal: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:22:06 - INFO - Artículos: 0
2026-02-06 20:22:06 - INFO - Importe: 0.00€
2026-02-06 20:22:06 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 20:23:38 - INFO - ======================================================================
2026-02-06 20:23:38 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 20:23:38 - INFO - Fecha de ejecución: 2026-02-06 20:23:38
2026-02-06 20:23:38 - INFO - ======================================================================
2026-02-06 20:23:38 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 20:23:38 - INFO - Envío de emails: Sí
2026-02-06 20:23:38 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 20:23:38 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 20:23:38 - INFO - Estado cargado correctamente
2026-02-06 20:23:38 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:23:38 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:23:38 - INFO - Semana forzada por argumento: 14
2026-02-06 20:23:38 - INFO - ======================================================================
2026-02-06 20:23:38 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 20:23:38 - INFO - ======================================================================
2026-02-06 20:23:38 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 20:23:38 - INFO - DataLoader inicializado correctamente
2026-02-06 20:23:38 - INFO - ForecastEngine inicializado correctamente
2026-02-06 20:23:38 - INFO - OrderGenerator inicializado correctamente
2026-02-06 20:23:38 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:23:38 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:23:38 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 20:23:38 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 20:23:38 - INFO - 
==================================================
2026-02-06 20:23:38 - INFO - SECCION: MAF
2026-02-06 20:23:38 - INFO - ==================================================
2026-02-06 20:23:38 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 20:23:38 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:23:38 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 20:23:38 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:23:38 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:23:38 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:23:38 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 20:23:38 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 20:23:38 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:23:38 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:23:38 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:23:42 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:42 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:23:42 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:23:42 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:23:42 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:23:42 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:23:42 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 20:23:42 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:23:42 - DEBUG -   maf: 10970 registros
2026-02-06 20:23:42 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:23:42 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:23:42 - DEBUG -   interior: 3624 registros
2026-02-06 20:23:42 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:23:42 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:23:42 - DEBUG -   vivero: 2460 registros
2026-02-06 20:23:42 - DEBUG -   fitos: 1987 registros
2026-02-06 20:23:42 - DEBUG -   semillas: 1180 registros
2026-02-06 20:23:42 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:23:42 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:23:42 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 20:23:42 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 20:23:42 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:23:42 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:23:44 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:44 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:23:44 - INFO - Costes cargados: 22145 registros
2026-02-06 20:23:44 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:23:44 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:23:44 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 20:23:44 - INFO -   ABC: 499 registros
2026-02-06 20:23:44 - INFO -   Ventas: 10970 registros
2026-02-06 20:23:44 - INFO -   Costes: 22145 registros
2026-02-06 20:23:44 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 20:23:44 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 20:23:44 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:23:44 - INFO - Datos de ventas: 1011 registros
2026-02-06 20:23:44 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 20:23:45 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 20:23:45 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:23:45 - INFO -   Factor total: 1.3125
2026-02-06 20:23:45 - INFO -   Factor escalado: 1.5844
2026-02-06 20:23:45 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 20:23:45 - INFO -   Objetivo final: 9253.98€
2026-02-06 20:23:45 - INFO -   Delta: 679.77€
2026-02-06 20:23:45 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:23:45 - DEBUG -   Total registros: 222
2026-02-06 20:23:45 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 20:23:45 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 20:23:45 - INFO -   Ventas finales: 9254.53€
2026-02-06 20:23:45 - INFO - 
============================================================
2026-02-06 20:23:45 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:23:45 - INFO - ============================================================
2026-02-06 20:23:45 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:23:45 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:23:45 - INFO - DataLoader inicializado correctamente
2026-02-06 20:23:45 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:23:45 - INFO - ============================================================
2026-02-06 20:23:45 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:23:45 - INFO - ============================================================
2026-02-06 20:23:45 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:23:45 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:23:45 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:45 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:45 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:45 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:45 - DEBUG - Usando hoja: Stock
2026-02-06 20:23:45 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:23:45 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:23:45 - INFO -   Stock: 30 registros
2026-02-06 20:23:45 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:23:45 - INFO - Fusión completada: 222 registros
2026-02-06 20:23:45 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:23:45 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:23:45 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:23:45 - INFO - 
============================================================
2026-02-06 20:23:45 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:23:45 - INFO - ============================================================
2026-02-06 20:23:45 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:23:45 - INFO - Corrección completada:
2026-02-06 20:23:45 - INFO -   - Artículos corregidos: 191/222
2026-02-06 20:23:45 - INFO -   - Artículos aumentados: 191
2026-02-06 20:23:45 - INFO -   - Artículos reducidos: 0
2026-02-06 20:23:45 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:23:45 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:23:45 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:23:45 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 20:23:45 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:23:45 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:23:45 - DEBUG -   Con valor 0: 31
2026-02-06 20:23:45 - DEBUG -   Con valor > 0: 191
2026-02-06 20:23:45 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 20:23:45 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 191 registros
2026-02-06 20:23:45 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:23:45 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:23:45 - WARNING - No se generó archivo para 'maf'
2026-02-06 20:23:45 - INFO - 
==================================================
2026-02-06 20:23:45 - INFO - SECCION: DECO_INTERIOR
2026-02-06 20:23:45 - INFO - ==================================================
2026-02-06 20:23:45 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 20:23:45 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:23:45 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 20:23:45 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:23:45 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:23:45 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:23:45 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 20:23:45 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 20:23:45 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:23:45 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:23:45 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:23:49 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:49 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:23:49 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:23:49 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:23:49 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:23:49 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:23:49 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 20:23:49 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:23:49 - DEBUG -   maf: 10970 registros
2026-02-06 20:23:49 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:23:49 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:23:49 - DEBUG -   interior: 3624 registros
2026-02-06 20:23:49 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:23:49 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:23:49 - DEBUG -   vivero: 2460 registros
2026-02-06 20:23:49 - DEBUG -   fitos: 1987 registros
2026-02-06 20:23:49 - DEBUG -   semillas: 1180 registros
2026-02-06 20:23:49 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:23:49 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:23:49 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 20:23:49 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 20:23:49 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:23:49 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:23:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:51 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:23:51 - INFO - Costes cargados: 22145 registros
2026-02-06 20:23:51 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:23:51 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:23:51 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 20:23:51 - INFO -   ABC: 1827 registros
2026-02-06 20:23:51 - INFO -   Ventas: 2468 registros
2026-02-06 20:23:51 - INFO -   Costes: 22145 registros
2026-02-06 20:23:51 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 20:23:51 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 20:23:51 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:23:52 - INFO - Datos de ventas: 180 registros
2026-02-06 20:23:52 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 20:23:52 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 20:23:52 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:23:52 - INFO -   Factor total: 1.3125
2026-02-06 20:23:52 - INFO -   Factor escalado: 1.5747
2026-02-06 20:23:52 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 20:23:52 - INFO -   Objetivo final: 2576.42€
2026-02-06 20:23:52 - INFO -   Delta: 373.59€
2026-02-06 20:23:52 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:23:52 - DEBUG -   Total registros: 139
2026-02-06 20:23:52 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 20:23:52 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 20:23:52 - INFO -   Ventas finales: 2580.73€
2026-02-06 20:23:52 - INFO - 
============================================================
2026-02-06 20:23:52 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:23:52 - INFO - ============================================================
2026-02-06 20:23:52 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:23:52 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:23:52 - INFO - DataLoader inicializado correctamente
2026-02-06 20:23:52 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:23:52 - INFO - ============================================================
2026-02-06 20:23:52 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:23:52 - INFO - ============================================================
2026-02-06 20:23:52 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:23:52 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:23:52 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:52 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:52 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:52 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:52 - DEBUG - Usando hoja: Stock
2026-02-06 20:23:52 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:23:52 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:23:52 - INFO -   Stock: 30 registros
2026-02-06 20:23:52 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:23:52 - INFO - Fusión completada: 139 registros
2026-02-06 20:23:52 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:23:52 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:23:52 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:23:52 - INFO - 
============================================================
2026-02-06 20:23:52 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:23:52 - INFO - ============================================================
2026-02-06 20:23:52 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:23:52 - INFO - Corrección completada:
2026-02-06 20:23:52 - INFO -   - Artículos corregidos: 135/139
2026-02-06 20:23:52 - INFO -   - Artículos aumentados: 135
2026-02-06 20:23:52 - INFO -   - Artículos reducidos: 0
2026-02-06 20:23:52 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:23:52 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:23:52 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:23:52 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 20:23:52 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:23:52 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:23:52 - DEBUG -   Con valor 0: 4
2026-02-06 20:23:52 - DEBUG -   Con valor > 0: 135
2026-02-06 20:23:52 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 20:23:52 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 135 registros
2026-02-06 20:23:52 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:23:52 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:23:52 - WARNING - No se generó archivo para 'deco_interior'
2026-02-06 20:23:52 - INFO - 
==================================================
2026-02-06 20:23:52 - INFO - SECCION: SEMILLAS
2026-02-06 20:23:52 - INFO - ==================================================
2026-02-06 20:23:52 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 20:23:52 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:23:52 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 20:23:52 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:23:52 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:23:52 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:23:52 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 20:23:52 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 20:23:52 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:23:52 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:23:52 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:23:56 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:56 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:23:56 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:23:56 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:23:56 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:23:56 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:23:56 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 20:23:56 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:23:56 - DEBUG -   maf: 10970 registros
2026-02-06 20:23:56 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:23:56 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:23:56 - DEBUG -   interior: 3624 registros
2026-02-06 20:23:56 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:23:56 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:23:56 - DEBUG -   vivero: 2460 registros
2026-02-06 20:23:56 - DEBUG -   fitos: 1987 registros
2026-02-06 20:23:56 - DEBUG -   semillas: 1180 registros
2026-02-06 20:23:56 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:23:56 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:23:56 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 20:23:56 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 20:23:56 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:23:56 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:23:58 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:58 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:23:58 - INFO - Costes cargados: 22145 registros
2026-02-06 20:23:58 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:23:58 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:23:58 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 20:23:58 - INFO -   ABC: 218 registros
2026-02-06 20:23:58 - INFO -   Ventas: 1180 registros
2026-02-06 20:23:58 - INFO -   Costes: 22145 registros
2026-02-06 20:23:58 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 20:23:58 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 20:23:58 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:23:58 - INFO - Datos de ventas: 136 registros
2026-02-06 20:23:58 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 20:23:59 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 20:23:59 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:23:59 - INFO -   Factor total: 1.3125
2026-02-06 20:23:59 - INFO -   Factor escalado: 2.0023
2026-02-06 20:23:59 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 20:23:59 - INFO -   Objetivo final: 911.32€
2026-02-06 20:23:59 - INFO -   Delta: 217.83€
2026-02-06 20:23:59 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:23:59 - DEBUG -   Total registros: 84
2026-02-06 20:23:59 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 20:23:59 - DEBUG -   Ventas finales: 911.60€
2026-02-06 20:23:59 - INFO -   Ventas finales: 911.60€
2026-02-06 20:23:59 - INFO - 
============================================================
2026-02-06 20:23:59 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:23:59 - INFO - ============================================================
2026-02-06 20:23:59 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:23:59 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:23:59 - INFO - DataLoader inicializado correctamente
2026-02-06 20:23:59 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:23:59 - INFO - ============================================================
2026-02-06 20:23:59 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:23:59 - INFO - ============================================================
2026-02-06 20:23:59 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:23:59 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:23:59 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:59 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:59 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:23:59 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:23:59 - DEBUG - Usando hoja: Stock
2026-02-06 20:23:59 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:23:59 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:23:59 - INFO -   Stock: 30 registros
2026-02-06 20:23:59 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:23:59 - INFO - Fusión completada: 84 registros
2026-02-06 20:23:59 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:23:59 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:23:59 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:23:59 - INFO - 
============================================================
2026-02-06 20:23:59 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:23:59 - INFO - ============================================================
2026-02-06 20:23:59 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:23:59 - INFO - Corrección completada:
2026-02-06 20:23:59 - INFO -   - Artículos corregidos: 84/84
2026-02-06 20:23:59 - INFO -   - Artículos aumentados: 84
2026-02-06 20:23:59 - INFO -   - Artículos reducidos: 0
2026-02-06 20:23:59 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:23:59 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:23:59 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:23:59 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:23:59 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:23:59 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:23:59 - DEBUG -   Con valor 0: 0
2026-02-06 20:23:59 - DEBUG -   Con valor > 0: 84
2026-02-06 20:23:59 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 20:23:59 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 84 registros
2026-02-06 20:23:59 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:23:59 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:23:59 - WARNING - No se generó archivo para 'semillas'
2026-02-06 20:23:59 - INFO - 
==================================================
2026-02-06 20:23:59 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 20:23:59 - INFO - ==================================================
2026-02-06 20:23:59 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 20:23:59 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:23:59 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 20:23:59 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:23:59 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:23:59 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:23:59 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 20:23:59 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 20:23:59 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:23:59 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:23:59 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:24:03 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:03 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:24:03 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:24:03 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:24:03 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:24:03 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:24:03 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 20:24:03 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:24:03 - DEBUG -   maf: 10970 registros
2026-02-06 20:24:03 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:24:03 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:24:03 - DEBUG -   interior: 3624 registros
2026-02-06 20:24:03 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:24:03 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:24:03 - DEBUG -   vivero: 2460 registros
2026-02-06 20:24:03 - DEBUG -   fitos: 1987 registros
2026-02-06 20:24:03 - DEBUG -   semillas: 1180 registros
2026-02-06 20:24:03 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:24:03 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:24:03 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 20:24:03 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 20:24:03 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:24:03 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:24:05 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:05 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:24:05 - INFO - Costes cargados: 22145 registros
2026-02-06 20:24:05 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:24:05 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:24:05 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 20:24:05 - INFO -   ABC: 205 registros
2026-02-06 20:24:05 - INFO -   Ventas: 1124 registros
2026-02-06 20:24:05 - INFO -   Costes: 22145 registros
2026-02-06 20:24:05 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 20:24:05 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 20:24:05 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:24:05 - INFO - Datos de ventas: 88 registros
2026-02-06 20:24:05 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 20:24:05 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 20:24:05 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:24:05 - INFO -   Factor total: 1.3125
2026-02-06 20:24:05 - INFO -   Factor escalado: 1.6854
2026-02-06 20:24:05 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 20:24:05 - INFO -   Objetivo final: 1426.88€
2026-02-06 20:24:05 - INFO -   Delta: 346.78€
2026-02-06 20:24:05 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:24:05 - DEBUG -   Total registros: 43
2026-02-06 20:24:05 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 20:24:05 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 20:24:05 - INFO -   Ventas finales: 1455.34€
2026-02-06 20:24:05 - INFO - 
============================================================
2026-02-06 20:24:05 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:24:05 - INFO - ============================================================
2026-02-06 20:24:05 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:24:05 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:24:05 - INFO - DataLoader inicializado correctamente
2026-02-06 20:24:05 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:24:05 - INFO - ============================================================
2026-02-06 20:24:05 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:24:05 - INFO - ============================================================
2026-02-06 20:24:05 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:24:05 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:24:05 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:05 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:05 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:05 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:05 - DEBUG - Usando hoja: Stock
2026-02-06 20:24:05 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:24:05 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:24:05 - INFO -   Stock: 30 registros
2026-02-06 20:24:05 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:24:05 - INFO - Fusión completada: 43 registros
2026-02-06 20:24:05 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:24:05 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:24:05 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:24:05 - INFO - 
============================================================
2026-02-06 20:24:05 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:24:05 - INFO - ============================================================
2026-02-06 20:24:05 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:24:05 - INFO - Corrección completada:
2026-02-06 20:24:05 - INFO -   - Artículos corregidos: 36/43
2026-02-06 20:24:05 - INFO -   - Artículos aumentados: 36
2026-02-06 20:24:05 - INFO -   - Artículos reducidos: 0
2026-02-06 20:24:05 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:24:05 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:24:05 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:24:05 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 20:24:05 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:24:05 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:24:05 - DEBUG -   Con valor 0: 7
2026-02-06 20:24:05 - DEBUG -   Con valor > 0: 36
2026-02-06 20:24:05 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 20:24:05 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 36 registros
2026-02-06 20:24:05 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:24:05 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:24:05 - WARNING - No se generó archivo para 'mascotas_vivo'
2026-02-06 20:24:05 - INFO - 
==================================================
2026-02-06 20:24:05 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 20:24:05 - INFO - ==================================================
2026-02-06 20:24:05 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 20:24:05 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:24:05 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 20:24:05 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:24:05 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:24:06 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:24:06 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 20:24:06 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 20:24:06 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:24:06 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:24:06 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:24:10 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:10 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:24:10 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:24:10 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:24:10 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:24:10 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:24:10 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 20:24:10 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:24:10 - DEBUG -   maf: 10970 registros
2026-02-06 20:24:10 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:24:10 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:24:10 - DEBUG -   interior: 3624 registros
2026-02-06 20:24:10 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:24:10 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:24:10 - DEBUG -   vivero: 2460 registros
2026-02-06 20:24:10 - DEBUG -   fitos: 1987 registros
2026-02-06 20:24:10 - DEBUG -   semillas: 1180 registros
2026-02-06 20:24:10 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:24:10 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:24:10 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 20:24:10 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 20:24:10 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:24:10 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:24:12 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:12 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:24:12 - INFO - Costes cargados: 22145 registros
2026-02-06 20:24:12 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:24:12 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:24:12 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 20:24:12 - INFO -   ABC: 2749 registros
2026-02-06 20:24:12 - INFO -   Ventas: 9784 registros
2026-02-06 20:24:12 - INFO -   Costes: 22145 registros
2026-02-06 20:24:12 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 20:24:12 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 20:24:12 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:24:12 - INFO - Datos de ventas: 822 registros
2026-02-06 20:24:12 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 20:24:14 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 20:24:14 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:24:14 - INFO -   Factor total: 1.3125
2026-02-06 20:24:14 - INFO -   Factor escalado: 1.0268
2026-02-06 20:24:14 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 20:24:14 - INFO -   Objetivo final: 8977.26€
2026-02-06 20:24:14 - INFO -   Delta: 3401.99€
2026-02-06 20:24:14 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:24:14 - DEBUG -   Total registros: 538
2026-02-06 20:24:14 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 20:24:14 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 20:24:14 - INFO -   Ventas finales: 8993.98€
2026-02-06 20:24:14 - INFO - 
============================================================
2026-02-06 20:24:14 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:24:14 - INFO - ============================================================
2026-02-06 20:24:14 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:24:14 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:24:14 - INFO - DataLoader inicializado correctamente
2026-02-06 20:24:14 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:24:14 - INFO - ============================================================
2026-02-06 20:24:14 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:24:14 - INFO - ============================================================
2026-02-06 20:24:14 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:24:14 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:24:14 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:14 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:14 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:14 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:14 - DEBUG - Usando hoja: Stock
2026-02-06 20:24:14 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:24:14 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:24:14 - INFO -   Stock: 30 registros
2026-02-06 20:24:14 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:24:14 - INFO - Fusión completada: 538 registros
2026-02-06 20:24:14 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:24:14 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:24:14 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:24:14 - INFO - 
============================================================
2026-02-06 20:24:14 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:24:14 - INFO - ============================================================
2026-02-06 20:24:14 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:24:14 - INFO - Corrección completada:
2026-02-06 20:24:14 - INFO -   - Artículos corregidos: 411/538
2026-02-06 20:24:14 - INFO -   - Artículos aumentados: 411
2026-02-06 20:24:14 - INFO -   - Artículos reducidos: 0
2026-02-06 20:24:14 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:24:14 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:24:14 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:24:14 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 20:24:14 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:24:14 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:24:14 - DEBUG -   Con valor 0: 127
2026-02-06 20:24:14 - DEBUG -   Con valor > 0: 411
2026-02-06 20:24:14 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 20:24:14 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 411 registros
2026-02-06 20:24:14 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:24:14 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:24:14 - WARNING - No se generó archivo para 'mascotas_manufacturado'
2026-02-06 20:24:14 - INFO - 
==================================================
2026-02-06 20:24:14 - INFO - SECCION: INTERIOR
2026-02-06 20:24:14 - INFO - ==================================================
2026-02-06 20:24:14 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 20:24:14 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:24:14 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 20:24:14 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:24:14 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:24:14 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:24:14 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 20:24:14 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 20:24:14 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:24:14 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:24:14 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:24:18 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:18 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:24:18 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:24:18 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:24:18 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:24:18 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:24:18 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 20:24:18 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:24:18 - DEBUG -   maf: 10970 registros
2026-02-06 20:24:18 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:24:18 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:24:18 - DEBUG -   interior: 3624 registros
2026-02-06 20:24:18 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:24:18 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:24:18 - DEBUG -   vivero: 2460 registros
2026-02-06 20:24:18 - DEBUG -   fitos: 1987 registros
2026-02-06 20:24:18 - DEBUG -   semillas: 1180 registros
2026-02-06 20:24:18 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:24:18 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:24:18 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 20:24:18 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 20:24:18 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:24:18 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:24:20 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:20 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:24:20 - INFO - Costes cargados: 22145 registros
2026-02-06 20:24:20 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:24:20 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:24:20 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 20:24:20 - INFO -   ABC: 555 registros
2026-02-06 20:24:20 - INFO -   Ventas: 3624 registros
2026-02-06 20:24:20 - INFO -   Costes: 22145 registros
2026-02-06 20:24:20 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 20:24:20 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 20:24:20 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:24:21 - INFO - Datos de ventas: 286 registros
2026-02-06 20:24:21 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 20:24:21 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 20:24:21 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:24:21 - INFO -   Factor total: 1.3125
2026-02-06 20:24:21 - INFO -   Factor escalado: 1.5971
2026-02-06 20:24:21 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 20:24:21 - INFO -   Objetivo final: 3846.45€
2026-02-06 20:24:21 - INFO -   Delta: 685.37€
2026-02-06 20:24:21 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:24:21 - DEBUG -   Total registros: 138
2026-02-06 20:24:21 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 20:24:21 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 20:24:21 - INFO -   Ventas finales: 3862.17€
2026-02-06 20:24:21 - INFO - 
============================================================
2026-02-06 20:24:21 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:24:21 - INFO - ============================================================
2026-02-06 20:24:21 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:24:21 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:24:21 - INFO - DataLoader inicializado correctamente
2026-02-06 20:24:21 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:24:21 - INFO - ============================================================
2026-02-06 20:24:21 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:24:21 - INFO - ============================================================
2026-02-06 20:24:21 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:24:21 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:24:21 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:21 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:21 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:21 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:21 - DEBUG - Usando hoja: Stock
2026-02-06 20:24:21 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:24:21 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:24:21 - INFO -   Stock: 30 registros
2026-02-06 20:24:21 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:24:21 - INFO - Fusión completada: 138 registros
2026-02-06 20:24:21 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:24:21 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:24:21 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:24:21 - INFO - 
============================================================
2026-02-06 20:24:21 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:24:21 - INFO - ============================================================
2026-02-06 20:24:21 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:24:21 - INFO - Corrección completada:
2026-02-06 20:24:21 - INFO -   - Artículos corregidos: 121/138
2026-02-06 20:24:21 - INFO -   - Artículos aumentados: 121
2026-02-06 20:24:21 - INFO -   - Artículos reducidos: 0
2026-02-06 20:24:21 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:24:21 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:24:21 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:24:21 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 20:24:21 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:24:21 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:24:21 - DEBUG -   Con valor 0: 17
2026-02-06 20:24:21 - DEBUG -   Con valor > 0: 121
2026-02-06 20:24:21 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 20:24:21 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 121 registros
2026-02-06 20:24:21 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:24:21 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:24:21 - WARNING - No se generó archivo para 'interior'
2026-02-06 20:24:21 - INFO - 
==================================================
2026-02-06 20:24:21 - INFO - SECCION: FITOS
2026-02-06 20:24:21 - INFO - ==================================================
2026-02-06 20:24:21 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 20:24:21 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:24:21 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 20:24:21 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:24:21 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:24:21 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:24:21 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 20:24:21 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:24:21 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:24:21 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:24:21 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:24:25 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:25 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:24:25 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:24:25 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:24:25 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:24:25 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:24:25 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 20:24:25 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:24:25 - DEBUG -   maf: 10970 registros
2026-02-06 20:24:25 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:24:25 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:24:25 - DEBUG -   interior: 3624 registros
2026-02-06 20:24:25 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:24:25 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:24:25 - DEBUG -   vivero: 2460 registros
2026-02-06 20:24:25 - DEBUG -   fitos: 1987 registros
2026-02-06 20:24:25 - DEBUG -   semillas: 1180 registros
2026-02-06 20:24:25 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:24:25 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:24:25 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 20:24:25 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 20:24:25 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:24:25 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:24:27 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:27 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:24:27 - INFO - Costes cargados: 22145 registros
2026-02-06 20:24:27 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:24:27 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:24:27 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 20:24:27 - INFO -   ABC: 247 registros
2026-02-06 20:24:27 - INFO -   Ventas: 1987 registros
2026-02-06 20:24:27 - INFO -   Costes: 22145 registros
2026-02-06 20:24:27 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:24:27 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 20:24:27 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:24:27 - INFO - Datos de ventas: 157 registros
2026-02-06 20:24:27 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 20:24:28 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 20:24:28 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:24:28 - INFO -   Factor total: 1.3125
2026-02-06 20:24:28 - INFO -   Factor escalado: 1.4055
2026-02-06 20:24:28 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 20:24:28 - INFO -   Objetivo final: 2360.20€
2026-02-06 20:24:28 - INFO -   Delta: 424.74€
2026-02-06 20:24:28 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:24:28 - DEBUG -   Total registros: 84
2026-02-06 20:24:28 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 20:24:28 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 20:24:28 - INFO -   Ventas finales: 2365.92€
2026-02-06 20:24:28 - INFO - 
============================================================
2026-02-06 20:24:28 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:24:28 - INFO - ============================================================
2026-02-06 20:24:28 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:24:28 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:24:28 - INFO - DataLoader inicializado correctamente
2026-02-06 20:24:28 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:24:28 - INFO - ============================================================
2026-02-06 20:24:28 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:24:28 - INFO - ============================================================
2026-02-06 20:24:28 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:24:28 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:24:28 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:28 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:28 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:28 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:28 - DEBUG - Usando hoja: Stock
2026-02-06 20:24:28 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:24:28 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:24:28 - INFO -   Stock: 30 registros
2026-02-06 20:24:28 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:24:28 - INFO - Fusión completada: 84 registros
2026-02-06 20:24:28 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:24:28 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:24:28 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:24:28 - INFO - 
============================================================
2026-02-06 20:24:28 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:24:28 - INFO - ============================================================
2026-02-06 20:24:28 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:24:28 - INFO - Corrección completada:
2026-02-06 20:24:28 - INFO -   - Artículos corregidos: 82/84
2026-02-06 20:24:28 - INFO -   - Artículos aumentados: 82
2026-02-06 20:24:28 - INFO -   - Artículos reducidos: 0
2026-02-06 20:24:28 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:24:28 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:24:28 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:24:28 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:24:28 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:24:28 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:24:28 - DEBUG -   Con valor 0: 2
2026-02-06 20:24:28 - DEBUG -   Con valor > 0: 82
2026-02-06 20:24:28 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 20:24:28 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 82 registros
2026-02-06 20:24:28 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:24:28 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:24:28 - WARNING - No se generó archivo para 'fitos'
2026-02-06 20:24:28 - INFO - 
==================================================
2026-02-06 20:24:28 - INFO - SECCION: VIVERO
2026-02-06 20:24:28 - INFO - ==================================================
2026-02-06 20:24:28 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 20:24:28 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:24:28 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 20:24:28 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:24:28 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:24:28 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:24:28 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 20:24:28 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 20:24:28 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:24:28 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:24:28 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:24:32 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:32 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:24:32 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:24:32 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:24:32 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:24:32 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:24:32 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 20:24:32 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:24:32 - DEBUG -   maf: 10970 registros
2026-02-06 20:24:32 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:24:32 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:24:32 - DEBUG -   interior: 3624 registros
2026-02-06 20:24:32 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:24:32 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:24:32 - DEBUG -   vivero: 2460 registros
2026-02-06 20:24:32 - DEBUG -   fitos: 1987 registros
2026-02-06 20:24:32 - DEBUG -   semillas: 1180 registros
2026-02-06 20:24:32 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:24:32 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:24:32 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 20:24:32 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 20:24:32 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:24:32 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:24:34 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:34 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:24:34 - INFO - Costes cargados: 22145 registros
2026-02-06 20:24:34 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:24:34 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:24:34 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 20:24:34 - INFO -   ABC: 565 registros
2026-02-06 20:24:34 - INFO -   Ventas: 2460 registros
2026-02-06 20:24:34 - INFO -   Costes: 22145 registros
2026-02-06 20:24:34 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 20:24:34 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 20:24:34 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:24:34 - INFO - Datos de ventas: 189 registros
2026-02-06 20:24:34 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 20:24:34 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 20:24:34 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:24:34 - INFO -   Factor total: 1.3125
2026-02-06 20:24:34 - INFO -   Factor escalado: 1.6886
2026-02-06 20:24:34 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 20:24:34 - INFO -   Objetivo final: 6952.54€
2026-02-06 20:24:34 - INFO -   Delta: 1809.40€
2026-02-06 20:24:34 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:24:34 - DEBUG -   Total registros: 107
2026-02-06 20:24:34 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 20:24:34 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 20:24:34 - INFO -   Ventas finales: 6990.51€
2026-02-06 20:24:34 - INFO - 
============================================================
2026-02-06 20:24:34 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:24:34 - INFO - ============================================================
2026-02-06 20:24:34 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:24:34 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:24:34 - INFO - DataLoader inicializado correctamente
2026-02-06 20:24:34 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:24:34 - INFO - ============================================================
2026-02-06 20:24:34 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:24:34 - INFO - ============================================================
2026-02-06 20:24:34 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:24:34 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:24:34 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:34 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:34 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:34 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:34 - DEBUG - Usando hoja: Stock
2026-02-06 20:24:34 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:24:34 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:24:34 - INFO -   Stock: 30 registros
2026-02-06 20:24:34 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:24:34 - INFO - Fusión completada: 107 registros
2026-02-06 20:24:34 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:24:34 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:24:34 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:24:34 - INFO - 
============================================================
2026-02-06 20:24:34 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:24:34 - INFO - ============================================================
2026-02-06 20:24:34 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:24:34 - INFO - Corrección completada:
2026-02-06 20:24:34 - INFO -   - Artículos corregidos: 96/107
2026-02-06 20:24:34 - INFO -   - Artículos aumentados: 96
2026-02-06 20:24:34 - INFO -   - Artículos reducidos: 0
2026-02-06 20:24:34 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:24:34 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:24:34 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:24:34 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 20:24:34 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:24:34 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:24:34 - DEBUG -   Con valor 0: 11
2026-02-06 20:24:34 - DEBUG -   Con valor > 0: 96
2026-02-06 20:24:34 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 20:24:34 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 96 registros
2026-02-06 20:24:34 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:24:34 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:24:34 - WARNING - No se generó archivo para 'vivero'
2026-02-06 20:24:34 - INFO - 
==================================================
2026-02-06 20:24:34 - INFO - SECCION: UTILES_JARDIN
2026-02-06 20:24:34 - INFO - ==================================================
2026-02-06 20:24:34 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 20:24:34 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:24:34 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 20:24:34 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:24:34 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:24:34 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:24:34 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 20:24:34 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 20:24:34 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:24:34 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:24:34 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:24:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:38 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:24:38 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:24:38 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:24:38 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:24:38 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:24:38 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 20:24:38 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:24:38 - DEBUG -   maf: 10970 registros
2026-02-06 20:24:38 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:24:38 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:24:38 - DEBUG -   interior: 3624 registros
2026-02-06 20:24:38 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:24:38 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:24:38 - DEBUG -   vivero: 2460 registros
2026-02-06 20:24:38 - DEBUG -   fitos: 1987 registros
2026-02-06 20:24:38 - DEBUG -   semillas: 1180 registros
2026-02-06 20:24:38 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:24:38 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:24:38 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 20:24:38 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 20:24:38 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:24:38 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:24:40 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:40 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:24:40 - INFO - Costes cargados: 22145 registros
2026-02-06 20:24:40 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:24:40 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:24:40 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 20:24:40 - INFO -   ABC: 433 registros
2026-02-06 20:24:40 - INFO -   Ventas: 1009 registros
2026-02-06 20:24:40 - INFO -   Costes: 22145 registros
2026-02-06 20:24:40 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 20:24:40 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 20:24:40 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:24:41 - INFO - Datos de ventas: 89 registros
2026-02-06 20:24:41 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 20:24:41 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 20:24:41 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:24:41 - INFO -   Factor total: 1.3125
2026-02-06 20:24:41 - INFO -   Factor escalado: 1.6747
2026-02-06 20:24:41 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 20:24:41 - INFO -   Objetivo final: 1371.26€
2026-02-06 20:24:41 - INFO -   Delta: 558.30€
2026-02-06 20:24:41 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:24:41 - DEBUG -   Total registros: 78
2026-02-06 20:24:41 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 20:24:41 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 20:24:41 - INFO -   Ventas finales: 1390.00€
2026-02-06 20:24:41 - INFO - 
============================================================
2026-02-06 20:24:41 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:24:41 - INFO - ============================================================
2026-02-06 20:24:41 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:24:41 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:24:41 - INFO - DataLoader inicializado correctamente
2026-02-06 20:24:41 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:24:41 - INFO - ============================================================
2026-02-06 20:24:41 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:24:41 - INFO - ============================================================
2026-02-06 20:24:41 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:24:41 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:24:41 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:41 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:41 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:41 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:41 - DEBUG - Usando hoja: Stock
2026-02-06 20:24:41 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:24:41 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:24:41 - INFO -   Stock: 30 registros
2026-02-06 20:24:41 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:24:41 - INFO - Fusión completada: 78 registros
2026-02-06 20:24:41 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:24:41 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:24:41 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:24:41 - INFO - 
============================================================
2026-02-06 20:24:41 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:24:41 - INFO - ============================================================
2026-02-06 20:24:41 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:24:41 - INFO - Corrección completada:
2026-02-06 20:24:41 - INFO -   - Artículos corregidos: 78/78
2026-02-06 20:24:41 - INFO -   - Artículos aumentados: 78
2026-02-06 20:24:41 - INFO -   - Artículos reducidos: 0
2026-02-06 20:24:41 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:24:41 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:24:41 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:24:41 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 20:24:41 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:24:41 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:24:41 - DEBUG -   Con valor 0: 0
2026-02-06 20:24:41 - DEBUG -   Con valor > 0: 78
2026-02-06 20:24:41 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 20:24:41 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 78 registros
2026-02-06 20:24:41 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:24:41 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:24:41 - WARNING - No se generó archivo para 'utiles_jardin'
2026-02-06 20:24:41 - INFO - 
==================================================
2026-02-06 20:24:41 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 20:24:41 - INFO - ==================================================
2026-02-06 20:24:41 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 20:24:41 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:24:41 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 20:24:41 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:24:41 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:24:41 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:24:41 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 20:24:41 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:24:41 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:24:41 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:24:41 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:24:45 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:45 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:24:45 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:24:45 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:24:45 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:24:45 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:24:45 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 20:24:45 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:24:45 - DEBUG -   maf: 10970 registros
2026-02-06 20:24:45 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:24:45 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:24:45 - DEBUG -   interior: 3624 registros
2026-02-06 20:24:45 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:24:45 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:24:45 - DEBUG -   vivero: 2460 registros
2026-02-06 20:24:45 - DEBUG -   fitos: 1987 registros
2026-02-06 20:24:45 - DEBUG -   semillas: 1180 registros
2026-02-06 20:24:45 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:24:45 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:24:45 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 20:24:45 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 20:24:45 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:24:45 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:24:47 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:47 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:24:47 - INFO - Costes cargados: 22145 registros
2026-02-06 20:24:47 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:24:47 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:24:47 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 20:24:47 - INFO -   ABC: 247 registros
2026-02-06 20:24:47 - INFO -   Ventas: 3264 registros
2026-02-06 20:24:47 - INFO -   Costes: 22145 registros
2026-02-06 20:24:47 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:24:47 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 20:24:47 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:24:47 - INFO - Datos de ventas: 302 registros
2026-02-06 20:24:47 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 20:24:47 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 20:24:47 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:24:47 - INFO -   Factor total: 1.3125
2026-02-06 20:24:47 - INFO -   Factor escalado: 1.3380
2026-02-06 20:24:47 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 20:24:47 - INFO -   Objetivo final: 5377.63€
2026-02-06 20:24:47 - INFO -   Delta: 432.03€
2026-02-06 20:24:47 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:24:47 - DEBUG -   Total registros: 72
2026-02-06 20:24:47 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 20:24:47 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 20:24:47 - INFO -   Ventas finales: 5387.14€
2026-02-06 20:24:47 - INFO - 
============================================================
2026-02-06 20:24:47 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:24:47 - INFO - ============================================================
2026-02-06 20:24:47 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:24:47 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:24:47 - INFO - DataLoader inicializado correctamente
2026-02-06 20:24:47 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:24:47 - INFO - ============================================================
2026-02-06 20:24:47 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:24:47 - INFO - ============================================================
2026-02-06 20:24:47 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:24:47 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:24:47 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:47 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:47 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:47 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:47 - DEBUG - Usando hoja: Stock
2026-02-06 20:24:47 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:24:47 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:24:47 - INFO -   Stock: 30 registros
2026-02-06 20:24:47 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:24:47 - INFO - Fusión completada: 72 registros
2026-02-06 20:24:47 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:24:47 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:24:47 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:24:47 - INFO - 
============================================================
2026-02-06 20:24:47 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:24:47 - INFO - ============================================================
2026-02-06 20:24:47 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:24:47 - INFO - Corrección completada:
2026-02-06 20:24:47 - INFO -   - Artículos corregidos: 71/72
2026-02-06 20:24:47 - INFO -   - Artículos aumentados: 71
2026-02-06 20:24:47 - INFO -   - Artículos reducidos: 0
2026-02-06 20:24:47 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:24:47 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:24:47 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:24:47 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 20:24:47 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:24:47 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:24:47 - DEBUG -   Con valor 0: 1
2026-02-06 20:24:47 - DEBUG -   Con valor > 0: 71
2026-02-06 20:24:47 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 20:24:47 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 71 registros
2026-02-06 20:24:47 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:24:47 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:24:47 - WARNING - No se generó archivo para 'tierras_aridos'
2026-02-06 20:24:47 - INFO - 
==================================================
2026-02-06 20:24:47 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 20:24:47 - INFO - ==================================================
2026-02-06 20:24:47 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 20:24:47 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:24:47 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 20:24:47 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:24:47 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:24:48 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:24:48 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 20:24:48 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 20:24:48 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:24:48 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:24:48 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:24:52 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:52 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:24:52 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:24:52 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:24:52 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:24:52 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:24:52 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 20:24:52 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:24:52 - DEBUG -   maf: 10970 registros
2026-02-06 20:24:52 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:24:52 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:24:52 - DEBUG -   interior: 3624 registros
2026-02-06 20:24:52 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:24:52 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:24:52 - DEBUG -   vivero: 2460 registros
2026-02-06 20:24:52 - DEBUG -   fitos: 1987 registros
2026-02-06 20:24:52 - DEBUG -   semillas: 1180 registros
2026-02-06 20:24:52 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:24:52 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:24:52 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 20:24:52 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 20:24:52 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:24:52 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:24:54 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:54 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:24:54 - INFO - Costes cargados: 22145 registros
2026-02-06 20:24:54 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:24:54 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:24:54 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 20:24:54 - INFO -   ABC: 995 registros
2026-02-06 20:24:54 - INFO -   Ventas: 4018 registros
2026-02-06 20:24:54 - INFO -   Costes: 22145 registros
2026-02-06 20:24:54 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 20:24:54 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 20:24:54 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:24:54 - INFO - Datos de ventas: 316 registros
2026-02-06 20:24:54 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 20:24:54 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 20:24:54 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:24:54 - INFO -   Factor total: 1.3125
2026-02-06 20:24:54 - INFO -   Factor escalado: 1.1960
2026-02-06 20:24:54 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 20:24:54 - INFO -   Objetivo final: 4909.20€
2026-02-06 20:24:54 - INFO -   Delta: 1185.39€
2026-02-06 20:24:54 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:24:54 - DEBUG -   Total registros: 224
2026-02-06 20:24:54 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 20:24:54 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 20:24:54 - INFO -   Ventas finales: 4923.89€
2026-02-06 20:24:55 - INFO - 
============================================================
2026-02-06 20:24:55 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:24:55 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:24:55 - INFO - DataLoader inicializado correctamente
2026-02-06 20:24:55 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:24:55 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:24:55 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:55 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:55 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:24:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:24:55 - DEBUG - Usando hoja: Stock
2026-02-06 20:24:55 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:24:55 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:24:55 - INFO -   Stock: 30 registros
2026-02-06 20:24:55 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:24:55 - INFO - Fusión completada: 224 registros
2026-02-06 20:24:55 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:24:55 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:24:55 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:24:55 - INFO - 
============================================================
2026-02-06 20:24:55 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:24:55 - INFO - Corrección completada:
2026-02-06 20:24:55 - INFO -   - Artículos corregidos: 205/224
2026-02-06 20:24:55 - INFO -   - Artículos aumentados: 205
2026-02-06 20:24:55 - INFO -   - Artículos reducidos: 0
2026-02-06 20:24:55 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:24:55 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:24:55 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:24:55 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 20:24:55 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:24:55 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:24:55 - DEBUG -   Con valor 0: 19
2026-02-06 20:24:55 - DEBUG -   Con valor > 0: 205
2026-02-06 20:24:55 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 20:24:55 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 205 registros
2026-02-06 20:24:55 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:24:55 - ERROR - Error al generar archivo: 'Unidades_Pedido'
2026-02-06 20:24:55 - WARNING - No se generó archivo para 'deco_exterior'
2026-02-06 20:24:55 - INFO - Estado guardado correctamente
2026-02-06 20:24:55 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:24:55 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:24:55 - INFO - Estado guardado correctamente
2026-02-06 20:24:55 - INFO - 
============================================================
2026-02-06 20:24:55 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - DEBUG - [DEBUG] Archivos agrupados por sección: {}
2026-02-06 20:24:55 - INFO - 
============================================================
2026-02-06 20:24:55 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 20:24:55 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 20:24:55 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 20:24:55 - INFO - EmailService inicializado correctamente
2026-02-06 20:24:55 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 20:24:55 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 20:24:55 - INFO - 
============================================================
2026-02-06 20:24:55 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - INFO - Emails enviados exitosamente: 0
2026-02-06 20:24:55 - INFO - Emails fallidos: 0
2026-02-06 20:24:55 - INFO - Secciones procesadas: 0
2026-02-06 20:24:55 - INFO - 
============================================================
2026-02-06 20:24:55 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:24:55 - INFO - 
============================================================
2026-02-06 20:24:55 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:24:55 - INFO - ============================================================
2026-02-06 20:24:55 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:24:55 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 20:24:55 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 20:24:55 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:24:55 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:24:55 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 20:24:55 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:24:56 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 20:24:56 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 20:24:56 - INFO - 
============================================================
2026-02-06 20:24:56 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 20:24:56 - INFO - ============================================================
2026-02-06 20:24:56 - INFO - Emails enviados: 3
2026-02-06 20:24:56 - INFO - Emails fallidos: 0
2026-02-06 20:24:56 - INFO - 
======================================================================
2026-02-06 20:24:56 - INFO - RESUMEN DE EJECUCION
2026-02-06 20:24:56 - INFO - ======================================================================
2026-02-06 20:24:56 - INFO - Semana procesada: 14
2026-02-06 20:24:56 - INFO - Archivos generados: 1
2026-02-06 20:24:56 - INFO - Total articulos: 0
2026-02-06 20:24:56 - INFO - Total importe: 0.00€
2026-02-06 20:24:56 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 20:24:56 - INFO - ======================================================================
2026-02-06 20:24:56 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 20:24:56 - INFO - Archivo principal: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:24:56 - INFO - Artículos: 0
2026-02-06 20:24:56 - INFO - Importe: 0.00€
2026-02-06 20:24:56 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 20:39:42 - INFO - ======================================================================
2026-02-06 20:39:42 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 20:39:42 - INFO - Fecha de ejecución: 2026-02-06 20:39:42
2026-02-06 20:39:42 - INFO - ======================================================================
2026-02-06 20:39:42 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 20:39:42 - INFO - Envío de emails: Sí
2026-02-06 20:39:42 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 20:39:42 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 20:39:42 - INFO - Estado cargado correctamente
2026-02-06 20:39:42 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:39:42 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:39:42 - INFO - Semana forzada por argumento: 14
2026-02-06 20:39:42 - INFO - ======================================================================
2026-02-06 20:39:42 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 20:39:42 - INFO - ======================================================================
2026-02-06 20:39:42 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 20:39:42 - INFO - DataLoader inicializado correctamente
2026-02-06 20:39:42 - INFO - ForecastEngine inicializado correctamente
2026-02-06 20:39:42 - INFO - OrderGenerator inicializado correctamente
2026-02-06 20:39:42 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:39:42 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:39:42 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 20:39:42 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 20:39:42 - INFO - 
==================================================
2026-02-06 20:39:42 - INFO - SECCION: MAF
2026-02-06 20:39:42 - INFO - ==================================================
2026-02-06 20:39:42 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 20:39:42 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:39:42 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 20:39:42 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:39:42 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:39:42 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:39:42 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 20:39:42 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 20:39:42 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:39:42 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:39:42 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:39:46 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:39:46 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:39:46 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:39:46 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:39:46 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:39:46 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:39:46 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 20:39:46 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:39:46 - DEBUG -   maf: 10970 registros
2026-02-06 20:39:46 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:39:46 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:39:46 - DEBUG -   interior: 3624 registros
2026-02-06 20:39:46 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:39:46 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:39:46 - DEBUG -   vivero: 2460 registros
2026-02-06 20:39:46 - DEBUG -   fitos: 1987 registros
2026-02-06 20:39:46 - DEBUG -   semillas: 1180 registros
2026-02-06 20:39:46 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:39:46 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:39:46 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 20:39:46 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 20:39:46 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:39:46 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:39:48 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:39:48 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:39:48 - INFO - Costes cargados: 22145 registros
2026-02-06 20:39:48 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:39:48 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:39:48 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 20:39:48 - INFO -   ABC: 499 registros
2026-02-06 20:39:48 - INFO -   Ventas: 10970 registros
2026-02-06 20:39:48 - INFO -   Costes: 22145 registros
2026-02-06 20:39:48 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 20:39:48 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 20:39:48 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:39:48 - INFO - Datos de ventas: 1011 registros
2026-02-06 20:39:48 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 20:39:48 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 20:39:48 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:39:48 - INFO -   Factor total: 1.3125
2026-02-06 20:39:48 - INFO -   Factor escalado: 1.5844
2026-02-06 20:39:48 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 20:39:48 - INFO -   Objetivo final: 9253.98€
2026-02-06 20:39:48 - INFO -   Delta: 679.77€
2026-02-06 20:39:48 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:39:48 - DEBUG -   Total registros: 222
2026-02-06 20:39:48 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 20:39:48 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 20:39:48 - INFO -   Ventas finales: 9254.53€
2026-02-06 20:39:49 - INFO - 
============================================================
2026-02-06 20:39:49 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:39:49 - INFO - ============================================================
2026-02-06 20:39:49 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:39:49 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:39:49 - INFO - DataLoader inicializado correctamente
2026-02-06 20:39:49 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:39:49 - INFO - ============================================================
2026-02-06 20:39:49 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:39:49 - INFO - ============================================================
2026-02-06 20:39:49 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:39:49 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:39:49 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:39:49 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:39:49 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:39:49 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:39:49 - DEBUG - Usando hoja: Stock
2026-02-06 20:39:49 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:39:49 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:39:49 - INFO -   Stock: 30 registros
2026-02-06 20:39:49 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:39:49 - INFO - Fusión completada: 222 registros
2026-02-06 20:39:49 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:39:49 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:39:49 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:39:49 - INFO - 
============================================================
2026-02-06 20:39:49 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:39:49 - INFO - ============================================================
2026-02-06 20:39:49 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:39:49 - INFO - Corrección completada:
2026-02-06 20:39:49 - INFO -   - Artículos corregidos: 191/222
2026-02-06 20:39:49 - INFO -   - Artículos aumentados: 191
2026-02-06 20:39:49 - INFO -   - Artículos reducidos: 0
2026-02-06 20:39:49 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:39:49 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:39:49 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:39:49 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 20:39:49 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:39:49 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:39:49 - DEBUG -   Con valor 0: 31
2026-02-06 20:39:49 - DEBUG -   Con valor > 0: 191
2026-02-06 20:39:49 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 20:39:49 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 191 registros
2026-02-06 20:39:49 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:39:49 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:39:49 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:39:49 - INFO -   Articulos: 191
2026-02-06 20:39:49 - INFO -   Importe: 9254.53€
2026-02-06 20:39:49 - INFO - 
==================================================
2026-02-06 20:39:49 - INFO - SECCION: DECO_INTERIOR
2026-02-06 20:39:49 - INFO - ==================================================
2026-02-06 20:39:49 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 20:39:49 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:39:49 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 20:39:49 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:39:49 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:39:49 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:39:49 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 20:39:49 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 20:39:49 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:39:49 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:39:49 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:39:53 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:39:53 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:39:53 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:39:53 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:39:53 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:39:53 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:39:53 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 20:39:53 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:39:53 - DEBUG -   maf: 10970 registros
2026-02-06 20:39:53 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:39:53 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:39:53 - DEBUG -   interior: 3624 registros
2026-02-06 20:39:53 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:39:53 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:39:53 - DEBUG -   vivero: 2460 registros
2026-02-06 20:39:53 - DEBUG -   fitos: 1987 registros
2026-02-06 20:39:53 - DEBUG -   semillas: 1180 registros
2026-02-06 20:39:53 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:39:53 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:39:53 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 20:39:53 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 20:39:53 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:39:53 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:39:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:39:55 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:39:55 - INFO - Costes cargados: 22145 registros
2026-02-06 20:39:55 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:39:55 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:39:55 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 20:39:55 - INFO -   ABC: 1827 registros
2026-02-06 20:39:55 - INFO -   Ventas: 2468 registros
2026-02-06 20:39:55 - INFO -   Costes: 22145 registros
2026-02-06 20:39:55 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 20:39:55 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 20:39:55 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:39:55 - INFO - Datos de ventas: 180 registros
2026-02-06 20:39:55 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 20:39:56 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 20:39:56 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:39:56 - INFO -   Factor total: 1.3125
2026-02-06 20:39:56 - INFO -   Factor escalado: 1.5747
2026-02-06 20:39:56 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 20:39:56 - INFO -   Objetivo final: 2576.42€
2026-02-06 20:39:56 - INFO -   Delta: 373.59€
2026-02-06 20:39:56 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:39:56 - DEBUG -   Total registros: 139
2026-02-06 20:39:56 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 20:39:56 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 20:39:56 - INFO -   Ventas finales: 2580.73€
2026-02-06 20:39:56 - INFO - 
============================================================
2026-02-06 20:39:56 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:39:56 - INFO - ============================================================
2026-02-06 20:39:56 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:39:56 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:39:56 - INFO - DataLoader inicializado correctamente
2026-02-06 20:39:56 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:39:56 - INFO - ============================================================
2026-02-06 20:39:56 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:39:56 - INFO - ============================================================
2026-02-06 20:39:56 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:39:56 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:39:56 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:39:56 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:39:56 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:39:56 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:39:56 - DEBUG - Usando hoja: Stock
2026-02-06 20:39:56 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:39:56 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:39:56 - INFO -   Stock: 30 registros
2026-02-06 20:39:56 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:39:56 - INFO - Fusión completada: 139 registros
2026-02-06 20:39:56 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:39:56 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:39:56 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:39:56 - INFO - 
============================================================
2026-02-06 20:39:56 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:39:56 - INFO - ============================================================
2026-02-06 20:39:56 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:39:56 - INFO - Corrección completada:
2026-02-06 20:39:56 - INFO -   - Artículos corregidos: 135/139
2026-02-06 20:39:56 - INFO -   - Artículos aumentados: 135
2026-02-06 20:39:56 - INFO -   - Artículos reducidos: 0
2026-02-06 20:39:56 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:39:56 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:39:56 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:39:56 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 20:39:56 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:39:56 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:39:56 - DEBUG -   Con valor 0: 4
2026-02-06 20:39:56 - DEBUG -   Con valor > 0: 135
2026-02-06 20:39:56 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 20:39:56 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 135 registros
2026-02-06 20:39:56 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:39:56 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:39:56 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:39:56 - INFO -   Articulos: 135
2026-02-06 20:39:56 - INFO -   Importe: 2580.73€
2026-02-06 20:39:56 - INFO - 
==================================================
2026-02-06 20:39:56 - INFO - SECCION: SEMILLAS
2026-02-06 20:39:56 - INFO - ==================================================
2026-02-06 20:39:56 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 20:39:56 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:39:56 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 20:39:56 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:39:56 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:39:56 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:39:56 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 20:39:56 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 20:39:56 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:39:56 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:39:56 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:00 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:00 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:00 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:00 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:00 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:00 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:00 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 20:40:00 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:00 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:00 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:00 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:00 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:00 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:00 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:00 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:00 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:00 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:00 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:00 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:00 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 20:40:00 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 20:40:00 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:00 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:02 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:02 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:02 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:02 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:02 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 20:40:02 - INFO -   ABC: 218 registros
2026-02-06 20:40:02 - INFO -   Ventas: 1180 registros
2026-02-06 20:40:02 - INFO -   Costes: 22145 registros
2026-02-06 20:40:02 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 20:40:02 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 20:40:02 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:02 - INFO - Datos de ventas: 136 registros
2026-02-06 20:40:02 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 20:40:02 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 20:40:02 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:02 - INFO -   Factor total: 1.3125
2026-02-06 20:40:02 - INFO -   Factor escalado: 2.0023
2026-02-06 20:40:02 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 20:40:02 - INFO -   Objetivo final: 911.32€
2026-02-06 20:40:02 - INFO -   Delta: 217.83€
2026-02-06 20:40:02 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:02 - DEBUG -   Total registros: 84
2026-02-06 20:40:02 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 20:40:02 - DEBUG -   Ventas finales: 911.60€
2026-02-06 20:40:02 - INFO -   Ventas finales: 911.60€
2026-02-06 20:40:02 - INFO - 
============================================================
2026-02-06 20:40:02 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:02 - INFO - ============================================================
2026-02-06 20:40:02 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:02 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:02 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:02 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:02 - INFO - ============================================================
2026-02-06 20:40:02 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:02 - INFO - ============================================================
2026-02-06 20:40:02 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:02 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:02 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:02 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:02 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:02 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:02 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:02 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:02 - INFO -   Stock: 30 registros
2026-02-06 20:40:02 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:02 - INFO - Fusión completada: 84 registros
2026-02-06 20:40:02 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:02 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:02 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:02 - INFO - 
============================================================
2026-02-06 20:40:02 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:02 - INFO - ============================================================
2026-02-06 20:40:02 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:02 - INFO - Corrección completada:
2026-02-06 20:40:02 - INFO -   - Artículos corregidos: 84/84
2026-02-06 20:40:02 - INFO -   - Artículos aumentados: 84
2026-02-06 20:40:02 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:02 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:02 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:02 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:02 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:40:02 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:02 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:02 - DEBUG -   Con valor 0: 0
2026-02-06 20:40:02 - DEBUG -   Con valor > 0: 84
2026-02-06 20:40:02 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 20:40:02 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 84 registros
2026-02-06 20:40:02 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:40:02 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:40:02 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:40:02 - INFO -   Articulos: 84
2026-02-06 20:40:02 - INFO -   Importe: 911.60€
2026-02-06 20:40:02 - INFO - 
==================================================
2026-02-06 20:40:02 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 20:40:02 - INFO - ==================================================
2026-02-06 20:40:02 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 20:40:02 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:40:02 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 20:40:02 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:40:02 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:40:02 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:40:02 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 20:40:02 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 20:40:02 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:40:02 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:40:02 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:06 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:06 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:06 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:06 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:06 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:06 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:06 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 20:40:06 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:06 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:06 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:06 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:06 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:06 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:06 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:06 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:06 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:06 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:06 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:06 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:06 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 20:40:06 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 20:40:06 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:06 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:08 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:09 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:09 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:09 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:09 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 20:40:09 - INFO -   ABC: 205 registros
2026-02-06 20:40:09 - INFO -   Ventas: 1124 registros
2026-02-06 20:40:09 - INFO -   Costes: 22145 registros
2026-02-06 20:40:09 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 20:40:09 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 20:40:09 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:09 - INFO - Datos de ventas: 88 registros
2026-02-06 20:40:09 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 20:40:09 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 20:40:09 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:09 - INFO -   Factor total: 1.3125
2026-02-06 20:40:09 - INFO -   Factor escalado: 1.6854
2026-02-06 20:40:09 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 20:40:09 - INFO -   Objetivo final: 1426.88€
2026-02-06 20:40:09 - INFO -   Delta: 346.78€
2026-02-06 20:40:09 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:09 - DEBUG -   Total registros: 43
2026-02-06 20:40:09 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 20:40:09 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 20:40:09 - INFO -   Ventas finales: 1455.34€
2026-02-06 20:40:09 - INFO - 
============================================================
2026-02-06 20:40:09 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:09 - INFO - ============================================================
2026-02-06 20:40:09 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:09 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:09 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:09 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:09 - INFO - ============================================================
2026-02-06 20:40:09 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:09 - INFO - ============================================================
2026-02-06 20:40:09 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:09 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:09 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:09 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:09 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:09 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:09 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:09 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:09 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:09 - INFO -   Stock: 30 registros
2026-02-06 20:40:09 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:09 - INFO - Fusión completada: 43 registros
2026-02-06 20:40:09 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:09 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:09 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:09 - INFO - 
============================================================
2026-02-06 20:40:09 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:09 - INFO - ============================================================
2026-02-06 20:40:09 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:09 - INFO - Corrección completada:
2026-02-06 20:40:09 - INFO -   - Artículos corregidos: 36/43
2026-02-06 20:40:09 - INFO -   - Artículos aumentados: 36
2026-02-06 20:40:09 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:09 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:09 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:09 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:09 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 20:40:09 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:09 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:09 - DEBUG -   Con valor 0: 7
2026-02-06 20:40:09 - DEBUG -   Con valor > 0: 36
2026-02-06 20:40:09 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 20:40:09 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 36 registros
2026-02-06 20:40:09 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:40:09 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:40:09 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:40:09 - INFO -   Articulos: 36
2026-02-06 20:40:09 - INFO -   Importe: 1455.34€
2026-02-06 20:40:09 - INFO - 
==================================================
2026-02-06 20:40:09 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 20:40:09 - INFO - ==================================================
2026-02-06 20:40:09 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 20:40:09 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:40:09 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 20:40:09 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:40:09 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:40:09 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:40:09 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 20:40:09 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 20:40:09 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:40:09 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:40:09 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:13 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:13 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:13 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:13 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:13 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:13 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:13 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 20:40:13 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:13 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:13 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:13 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:13 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:13 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:13 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:13 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:13 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:13 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:13 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:13 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:13 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 20:40:13 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 20:40:13 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:13 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:15 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:15 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:15 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:15 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:15 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:15 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 20:40:15 - INFO -   ABC: 2749 registros
2026-02-06 20:40:15 - INFO -   Ventas: 9784 registros
2026-02-06 20:40:15 - INFO -   Costes: 22145 registros
2026-02-06 20:40:15 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 20:40:15 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 20:40:15 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:15 - INFO - Datos de ventas: 822 registros
2026-02-06 20:40:15 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 20:40:17 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 20:40:17 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:17 - INFO -   Factor total: 1.3125
2026-02-06 20:40:17 - INFO -   Factor escalado: 1.0268
2026-02-06 20:40:17 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 20:40:17 - INFO -   Objetivo final: 8977.26€
2026-02-06 20:40:17 - INFO -   Delta: 3401.99€
2026-02-06 20:40:18 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:18 - DEBUG -   Total registros: 538
2026-02-06 20:40:18 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 20:40:18 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 20:40:18 - INFO -   Ventas finales: 8993.98€
2026-02-06 20:40:18 - INFO - 
============================================================
2026-02-06 20:40:18 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:18 - INFO - ============================================================
2026-02-06 20:40:18 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:18 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:18 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:18 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:18 - INFO - ============================================================
2026-02-06 20:40:18 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:18 - INFO - ============================================================
2026-02-06 20:40:18 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:18 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:18 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:18 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:18 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:18 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:18 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:18 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:18 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:18 - INFO -   Stock: 30 registros
2026-02-06 20:40:18 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:18 - INFO - Fusión completada: 538 registros
2026-02-06 20:40:18 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:18 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:18 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:18 - INFO - 
============================================================
2026-02-06 20:40:18 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:18 - INFO - ============================================================
2026-02-06 20:40:18 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:18 - INFO - Corrección completada:
2026-02-06 20:40:18 - INFO -   - Artículos corregidos: 411/538
2026-02-06 20:40:18 - INFO -   - Artículos aumentados: 411
2026-02-06 20:40:18 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:18 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:18 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:18 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:18 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 20:40:18 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:18 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:18 - DEBUG -   Con valor 0: 127
2026-02-06 20:40:18 - DEBUG -   Con valor > 0: 411
2026-02-06 20:40:18 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 20:40:18 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 411 registros
2026-02-06 20:40:18 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:40:18 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:40:18 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:40:18 - INFO -   Articulos: 411
2026-02-06 20:40:18 - INFO -   Importe: 8993.98€
2026-02-06 20:40:18 - INFO - 
==================================================
2026-02-06 20:40:18 - INFO - SECCION: INTERIOR
2026-02-06 20:40:18 - INFO - ==================================================
2026-02-06 20:40:18 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 20:40:18 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:40:18 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 20:40:18 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:40:18 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:40:18 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:40:18 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 20:40:18 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 20:40:18 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:40:18 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:40:18 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:22 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:22 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:22 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:22 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:22 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:22 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:22 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 20:40:22 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:22 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:22 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:22 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:22 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:22 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:22 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:22 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:22 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:22 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:22 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:22 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:22 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 20:40:22 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 20:40:22 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:22 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:24 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:24 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:24 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:24 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:24 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 20:40:24 - INFO -   ABC: 555 registros
2026-02-06 20:40:24 - INFO -   Ventas: 3624 registros
2026-02-06 20:40:24 - INFO -   Costes: 22145 registros
2026-02-06 20:40:24 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 20:40:24 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 20:40:24 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:24 - INFO - Datos de ventas: 286 registros
2026-02-06 20:40:24 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 20:40:25 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 20:40:25 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:25 - INFO -   Factor total: 1.3125
2026-02-06 20:40:25 - INFO -   Factor escalado: 1.5971
2026-02-06 20:40:25 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 20:40:25 - INFO -   Objetivo final: 3846.45€
2026-02-06 20:40:25 - INFO -   Delta: 685.37€
2026-02-06 20:40:25 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:25 - DEBUG -   Total registros: 138
2026-02-06 20:40:25 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 20:40:25 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 20:40:25 - INFO -   Ventas finales: 3862.17€
2026-02-06 20:40:25 - INFO - 
============================================================
2026-02-06 20:40:25 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:25 - INFO - ============================================================
2026-02-06 20:40:25 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:25 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:25 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:25 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:25 - INFO - ============================================================
2026-02-06 20:40:25 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:25 - INFO - ============================================================
2026-02-06 20:40:25 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:25 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:25 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:25 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:25 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:25 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:25 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:25 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:25 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:25 - INFO -   Stock: 30 registros
2026-02-06 20:40:25 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:25 - INFO - Fusión completada: 138 registros
2026-02-06 20:40:25 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:25 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:25 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:25 - INFO - 
============================================================
2026-02-06 20:40:25 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:25 - INFO - ============================================================
2026-02-06 20:40:25 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:25 - INFO - Corrección completada:
2026-02-06 20:40:25 - INFO -   - Artículos corregidos: 121/138
2026-02-06 20:40:25 - INFO -   - Artículos aumentados: 121
2026-02-06 20:40:25 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:25 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:25 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:25 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:25 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 20:40:25 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:25 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:25 - DEBUG -   Con valor 0: 17
2026-02-06 20:40:25 - DEBUG -   Con valor > 0: 121
2026-02-06 20:40:25 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 20:40:25 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 121 registros
2026-02-06 20:40:25 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:40:25 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:40:25 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:40:25 - INFO -   Articulos: 121
2026-02-06 20:40:25 - INFO -   Importe: 3862.17€
2026-02-06 20:40:25 - INFO - 
==================================================
2026-02-06 20:40:25 - INFO - SECCION: FITOS
2026-02-06 20:40:25 - INFO - ==================================================
2026-02-06 20:40:25 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 20:40:25 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:40:25 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 20:40:25 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:40:25 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:40:25 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:40:25 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 20:40:25 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:40:25 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:40:25 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:40:25 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:29 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:29 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:29 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:29 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:29 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:29 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:29 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 20:40:29 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:29 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:29 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:29 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:29 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:29 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:29 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:29 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:29 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:29 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:29 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:29 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:29 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 20:40:29 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 20:40:29 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:29 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:31 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:31 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:31 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:31 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:31 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 20:40:31 - INFO -   ABC: 247 registros
2026-02-06 20:40:31 - INFO -   Ventas: 1987 registros
2026-02-06 20:40:31 - INFO -   Costes: 22145 registros
2026-02-06 20:40:31 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:40:31 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 20:40:31 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:31 - INFO - Datos de ventas: 157 registros
2026-02-06 20:40:31 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 20:40:31 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 20:40:31 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:31 - INFO -   Factor total: 1.3125
2026-02-06 20:40:31 - INFO -   Factor escalado: 1.4055
2026-02-06 20:40:31 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 20:40:31 - INFO -   Objetivo final: 2360.20€
2026-02-06 20:40:31 - INFO -   Delta: 424.74€
2026-02-06 20:40:31 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:31 - DEBUG -   Total registros: 84
2026-02-06 20:40:31 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 20:40:31 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 20:40:31 - INFO -   Ventas finales: 2365.92€
2026-02-06 20:40:31 - INFO - 
============================================================
2026-02-06 20:40:31 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:31 - INFO - ============================================================
2026-02-06 20:40:31 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:31 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:31 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:31 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:31 - INFO - ============================================================
2026-02-06 20:40:31 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:31 - INFO - ============================================================
2026-02-06 20:40:31 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:31 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:31 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:31 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:31 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:31 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:31 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:31 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:31 - INFO -   Stock: 30 registros
2026-02-06 20:40:31 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:31 - INFO - Fusión completada: 84 registros
2026-02-06 20:40:31 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:31 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:31 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:31 - INFO - 
============================================================
2026-02-06 20:40:31 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:31 - INFO - ============================================================
2026-02-06 20:40:31 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:31 - INFO - Corrección completada:
2026-02-06 20:40:31 - INFO -   - Artículos corregidos: 82/84
2026-02-06 20:40:31 - INFO -   - Artículos aumentados: 82
2026-02-06 20:40:31 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:31 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:31 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:31 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:31 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:40:31 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:31 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:31 - DEBUG -   Con valor 0: 2
2026-02-06 20:40:31 - DEBUG -   Con valor > 0: 82
2026-02-06 20:40:31 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 20:40:31 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 82 registros
2026-02-06 20:40:31 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:40:31 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:40:31 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:40:31 - INFO -   Articulos: 82
2026-02-06 20:40:31 - INFO -   Importe: 2365.92€
2026-02-06 20:40:31 - INFO - 
==================================================
2026-02-06 20:40:31 - INFO - SECCION: VIVERO
2026-02-06 20:40:31 - INFO - ==================================================
2026-02-06 20:40:31 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 20:40:31 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:40:31 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 20:40:31 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:40:31 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:40:31 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:40:31 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 20:40:31 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 20:40:31 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:40:31 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:40:31 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:35 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:35 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:35 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:35 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:35 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:35 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:35 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 20:40:35 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:35 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:35 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:35 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:35 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:35 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:35 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:35 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:35 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:35 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:35 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:35 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:35 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 20:40:35 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 20:40:35 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:35 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:37 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:37 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:37 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:37 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:37 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:37 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 20:40:37 - INFO -   ABC: 565 registros
2026-02-06 20:40:37 - INFO -   Ventas: 2460 registros
2026-02-06 20:40:37 - INFO -   Costes: 22145 registros
2026-02-06 20:40:37 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 20:40:37 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 20:40:37 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:37 - INFO - Datos de ventas: 189 registros
2026-02-06 20:40:37 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 20:40:38 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 20:40:38 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:38 - INFO -   Factor total: 1.3125
2026-02-06 20:40:38 - INFO -   Factor escalado: 1.6886
2026-02-06 20:40:38 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 20:40:38 - INFO -   Objetivo final: 6952.54€
2026-02-06 20:40:38 - INFO -   Delta: 1809.40€
2026-02-06 20:40:38 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:38 - DEBUG -   Total registros: 107
2026-02-06 20:40:38 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 20:40:38 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 20:40:38 - INFO -   Ventas finales: 6990.51€
2026-02-06 20:40:38 - INFO - 
============================================================
2026-02-06 20:40:38 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:38 - INFO - ============================================================
2026-02-06 20:40:38 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:38 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:38 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:38 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:38 - INFO - ============================================================
2026-02-06 20:40:38 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:38 - INFO - ============================================================
2026-02-06 20:40:38 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:38 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:38 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:38 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:38 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:38 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:38 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:38 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:38 - INFO -   Stock: 30 registros
2026-02-06 20:40:38 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:38 - INFO - Fusión completada: 107 registros
2026-02-06 20:40:38 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:38 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:38 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:38 - INFO - 
============================================================
2026-02-06 20:40:38 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:38 - INFO - ============================================================
2026-02-06 20:40:38 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:38 - INFO - Corrección completada:
2026-02-06 20:40:38 - INFO -   - Artículos corregidos: 96/107
2026-02-06 20:40:38 - INFO -   - Artículos aumentados: 96
2026-02-06 20:40:38 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:38 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:38 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:38 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:38 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 20:40:38 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:38 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:38 - DEBUG -   Con valor 0: 11
2026-02-06 20:40:38 - DEBUG -   Con valor > 0: 96
2026-02-06 20:40:38 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 20:40:38 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 96 registros
2026-02-06 20:40:38 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:40:38 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:40:38 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:40:38 - INFO -   Articulos: 96
2026-02-06 20:40:38 - INFO -   Importe: 6990.51€
2026-02-06 20:40:38 - INFO - 
==================================================
2026-02-06 20:40:38 - INFO - SECCION: UTILES_JARDIN
2026-02-06 20:40:38 - INFO - ==================================================
2026-02-06 20:40:38 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 20:40:38 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:40:38 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 20:40:38 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:40:38 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:40:38 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:40:38 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 20:40:38 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 20:40:38 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:40:38 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:40:38 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:42 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:42 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:42 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:42 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:42 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:42 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:42 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 20:40:42 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:42 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:42 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:42 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:42 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:42 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:42 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:42 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:42 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:42 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:42 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:42 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:42 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 20:40:42 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 20:40:42 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:42 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:44 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:44 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:44 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:44 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:44 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:44 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 20:40:44 - INFO -   ABC: 433 registros
2026-02-06 20:40:44 - INFO -   Ventas: 1009 registros
2026-02-06 20:40:44 - INFO -   Costes: 22145 registros
2026-02-06 20:40:44 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 20:40:44 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 20:40:44 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:44 - INFO - Datos de ventas: 89 registros
2026-02-06 20:40:44 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 20:40:44 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 20:40:44 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:44 - INFO -   Factor total: 1.3125
2026-02-06 20:40:44 - INFO -   Factor escalado: 1.6747
2026-02-06 20:40:44 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 20:40:44 - INFO -   Objetivo final: 1371.26€
2026-02-06 20:40:44 - INFO -   Delta: 558.30€
2026-02-06 20:40:44 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:44 - DEBUG -   Total registros: 78
2026-02-06 20:40:44 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 20:40:44 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 20:40:44 - INFO -   Ventas finales: 1390.00€
2026-02-06 20:40:44 - INFO - 
============================================================
2026-02-06 20:40:44 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:44 - INFO - ============================================================
2026-02-06 20:40:44 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:44 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:44 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:44 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:44 - INFO - ============================================================
2026-02-06 20:40:44 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:44 - INFO - ============================================================
2026-02-06 20:40:44 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:44 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:44 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:44 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:44 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:44 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:44 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:44 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:44 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:44 - INFO -   Stock: 30 registros
2026-02-06 20:40:44 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:44 - INFO - Fusión completada: 78 registros
2026-02-06 20:40:44 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:44 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:44 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:44 - INFO - 
============================================================
2026-02-06 20:40:44 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:44 - INFO - ============================================================
2026-02-06 20:40:44 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:44 - INFO - Corrección completada:
2026-02-06 20:40:44 - INFO -   - Artículos corregidos: 78/78
2026-02-06 20:40:44 - INFO -   - Artículos aumentados: 78
2026-02-06 20:40:44 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:44 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:44 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:44 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:44 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 20:40:44 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:44 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:44 - DEBUG -   Con valor 0: 0
2026-02-06 20:40:44 - DEBUG -   Con valor > 0: 78
2026-02-06 20:40:44 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 20:40:44 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 78 registros
2026-02-06 20:40:44 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:40:44 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:40:44 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:40:44 - INFO -   Articulos: 78
2026-02-06 20:40:44 - INFO -   Importe: 1390.00€
2026-02-06 20:40:44 - INFO - 
==================================================
2026-02-06 20:40:44 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 20:40:44 - INFO - ==================================================
2026-02-06 20:40:44 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 20:40:44 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:40:44 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 20:40:44 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:40:44 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:40:45 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:40:45 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 20:40:45 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:40:45 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:40:45 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:40:45 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:48 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:48 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:48 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:48 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:48 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:48 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:48 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 20:40:48 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:48 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:48 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:48 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:48 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:48 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:48 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:48 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:48 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:48 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:48 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:48 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:49 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 20:40:49 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 20:40:49 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:49 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:51 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:51 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:51 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:51 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:51 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 20:40:51 - INFO -   ABC: 247 registros
2026-02-06 20:40:51 - INFO -   Ventas: 3264 registros
2026-02-06 20:40:51 - INFO -   Costes: 22145 registros
2026-02-06 20:40:51 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:40:51 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 20:40:51 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:51 - INFO - Datos de ventas: 302 registros
2026-02-06 20:40:51 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 20:40:51 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 20:40:51 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:51 - INFO -   Factor total: 1.3125
2026-02-06 20:40:51 - INFO -   Factor escalado: 1.3380
2026-02-06 20:40:51 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 20:40:51 - INFO -   Objetivo final: 5377.63€
2026-02-06 20:40:51 - INFO -   Delta: 432.03€
2026-02-06 20:40:51 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:51 - DEBUG -   Total registros: 72
2026-02-06 20:40:51 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 20:40:51 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 20:40:51 - INFO -   Ventas finales: 5387.14€
2026-02-06 20:40:51 - INFO - 
============================================================
2026-02-06 20:40:51 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:51 - INFO - ============================================================
2026-02-06 20:40:51 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:51 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:51 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:51 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:51 - INFO - ============================================================
2026-02-06 20:40:51 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:51 - INFO - ============================================================
2026-02-06 20:40:51 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:51 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:51 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:51 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:51 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:51 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:51 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:51 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:51 - INFO -   Stock: 30 registros
2026-02-06 20:40:51 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:51 - INFO - Fusión completada: 72 registros
2026-02-06 20:40:51 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:51 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:51 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:51 - INFO - 
============================================================
2026-02-06 20:40:51 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:51 - INFO - ============================================================
2026-02-06 20:40:51 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:51 - INFO - Corrección completada:
2026-02-06 20:40:51 - INFO -   - Artículos corregidos: 71/72
2026-02-06 20:40:51 - INFO -   - Artículos aumentados: 71
2026-02-06 20:40:51 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:51 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:51 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:51 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:51 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 20:40:51 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:51 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:51 - DEBUG -   Con valor 0: 1
2026-02-06 20:40:51 - DEBUG -   Con valor > 0: 71
2026-02-06 20:40:51 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 20:40:51 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 71 registros
2026-02-06 20:40:51 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:40:51 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:40:51 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:40:51 - INFO -   Articulos: 71
2026-02-06 20:40:51 - INFO -   Importe: 5387.14€
2026-02-06 20:40:51 - INFO - 
==================================================
2026-02-06 20:40:51 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 20:40:51 - INFO - ==================================================
2026-02-06 20:40:51 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 20:40:51 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:40:51 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 20:40:51 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:40:51 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:40:51 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:40:51 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 20:40:51 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 20:40:51 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:40:51 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:40:51 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:40:55 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:55 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:40:55 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:40:55 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:40:55 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:40:55 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:40:55 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 20:40:55 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:40:55 - DEBUG -   maf: 10970 registros
2026-02-06 20:40:55 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:40:55 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:40:55 - DEBUG -   interior: 3624 registros
2026-02-06 20:40:55 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:40:55 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:40:55 - DEBUG -   vivero: 2460 registros
2026-02-06 20:40:55 - DEBUG -   fitos: 1987 registros
2026-02-06 20:40:55 - DEBUG -   semillas: 1180 registros
2026-02-06 20:40:55 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:40:55 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:40:55 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 20:40:55 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 20:40:55 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:40:55 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:40:58 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:58 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:40:58 - INFO - Costes cargados: 22145 registros
2026-02-06 20:40:58 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:40:58 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:40:58 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 20:40:58 - INFO -   ABC: 995 registros
2026-02-06 20:40:58 - INFO -   Ventas: 4018 registros
2026-02-06 20:40:58 - INFO -   Costes: 22145 registros
2026-02-06 20:40:58 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 20:40:58 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 20:40:58 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:40:58 - INFO - Datos de ventas: 316 registros
2026-02-06 20:40:58 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 20:40:59 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 20:40:59 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:40:59 - INFO -   Factor total: 1.3125
2026-02-06 20:40:59 - INFO -   Factor escalado: 1.1960
2026-02-06 20:40:59 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 20:40:59 - INFO -   Objetivo final: 4909.20€
2026-02-06 20:40:59 - INFO -   Delta: 1185.39€
2026-02-06 20:40:59 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:40:59 - DEBUG -   Total registros: 224
2026-02-06 20:40:59 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 20:40:59 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 20:40:59 - INFO -   Ventas finales: 4923.89€
2026-02-06 20:40:59 - INFO - 
============================================================
2026-02-06 20:40:59 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:40:59 - INFO - ============================================================
2026-02-06 20:40:59 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:40:59 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:40:59 - INFO - DataLoader inicializado correctamente
2026-02-06 20:40:59 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:40:59 - INFO - ============================================================
2026-02-06 20:40:59 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:40:59 - INFO - ============================================================
2026-02-06 20:40:59 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:40:59 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:40:59 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:59 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:59 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:40:59 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:40:59 - DEBUG - Usando hoja: Stock
2026-02-06 20:40:59 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:40:59 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:40:59 - INFO -   Stock: 30 registros
2026-02-06 20:40:59 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:40:59 - INFO - Fusión completada: 224 registros
2026-02-06 20:40:59 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:40:59 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:40:59 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:40:59 - INFO - 
============================================================
2026-02-06 20:40:59 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:40:59 - INFO - ============================================================
2026-02-06 20:40:59 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:40:59 - INFO - Corrección completada:
2026-02-06 20:40:59 - INFO -   - Artículos corregidos: 205/224
2026-02-06 20:40:59 - INFO -   - Artículos aumentados: 205
2026-02-06 20:40:59 - INFO -   - Artículos reducidos: 0
2026-02-06 20:40:59 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:40:59 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:40:59 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:40:59 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 20:40:59 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:40:59 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:40:59 - DEBUG -   Con valor 0: 19
2026-02-06 20:40:59 - DEBUG -   Con valor > 0: 205
2026-02-06 20:40:59 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 20:40:59 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 205 registros
2026-02-06 20:40:59 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:40:59 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:40:59 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:40:59 - INFO -   Articulos: 205
2026-02-06 20:40:59 - INFO -   Importe: 4923.89€
2026-02-06 20:40:59 - INFO - Estado guardado correctamente
2026-02-06 20:40:59 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:40:59 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:40:59 - INFO - Estado guardado correctamente
2026-02-06 20:40:59 - INFO - 
============================================================
2026-02-06 20:40:59 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 20:40:59 - INFO - ============================================================
2026-02-06 20:40:59 - DEBUG - [DEBUG] Archivos agrupados por sección: {'maf': ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx'], 'interior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx'], 'semillas': ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx'], 'vivo': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx'], 'manufacturado': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx'], 'fitos': ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx'], 'vivero': ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx'], 'jardin': ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx'], 'aridos': ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx'], 'exterior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']}
2026-02-06 20:40:59 - INFO - 
============================================================
2026-02-06 20:40:59 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 20:40:59 - INFO - ============================================================
2026-02-06 20:40:59 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 20:40:59 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 20:40:59 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 20:40:59 - INFO - EmailService inicializado correctamente
2026-02-06 20:40:59 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 20:40:59 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 20:40:59 - INFO - 
Enviando email para sección: maf
2026-02-06 20:40:59 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx']
2026-02-06 20:40:59 - DEBUG - Destinatarios para maf: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:40:59 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:40:59 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:40:59 - INFO - Email enviado para sección maf (semana 14)
2026-02-06 20:40:59 - ERROR - ✗ Error al enviar email a maf: None
2026-02-06 20:40:59 - INFO - 
Enviando email para sección: interior
2026-02-06 20:40:59 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx']
2026-02-06 20:40:59 - DEBUG - Destinatarios para interior: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Iris'}]
2026-02-06 20:40:59 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:40:59 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:41:00 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:41:00 - INFO - Email enviado para sección interior (semana 14)
2026-02-06 20:41:00 - ERROR - ✗ Error al enviar email a interior: None
2026-02-06 20:41:00 - INFO - 
Enviando email para sección: semillas
2026-02-06 20:41:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx']
2026-02-06 20:41:00 - DEBUG - Destinatarios para semillas: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:41:00 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:41:00 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:41:00 - INFO - Email enviado para sección semillas (semana 14)
2026-02-06 20:41:00 - ERROR - ✗ Error al enviar email a semillas: None
2026-02-06 20:41:00 - INFO - 
Enviando email para sección: vivo
2026-02-06 20:41:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx']
2026-02-06 20:41:00 - WARNING - No hay destinatarios configurados para la sección: vivo
2026-02-06 20:41:00 - WARNING - No se puede enviar email para vivo: No hay destinatarios configurados
2026-02-06 20:41:00 - ERROR - ✗ Error al enviar email a vivo: No hay destinatarios configurados
2026-02-06 20:41:00 - INFO - 
Enviando email para sección: manufacturado
2026-02-06 20:41:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx']
2026-02-06 20:41:00 - WARNING - No hay destinatarios configurados para la sección: manufacturado
2026-02-06 20:41:00 - WARNING - No se puede enviar email para manufacturado: No hay destinatarios configurados
2026-02-06 20:41:00 - ERROR - ✗ Error al enviar email a manufacturado: No hay destinatarios configurados
2026-02-06 20:41:00 - INFO - 
Enviando email para sección: fitos
2026-02-06 20:41:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx']
2026-02-06 20:41:00 - DEBUG - Destinatarios para fitos: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:41:00 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:41:00 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:41:00 - INFO - Email enviado para sección fitos (semana 14)
2026-02-06 20:41:00 - ERROR - ✗ Error al enviar email a fitos: None
2026-02-06 20:41:00 - INFO - 
Enviando email para sección: vivero
2026-02-06 20:41:00 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx']
2026-02-06 20:41:00 - DEBUG - Destinatarios para vivero: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:41:00 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:41:01 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:41:01 - INFO - Email enviado para sección vivero (semana 14)
2026-02-06 20:41:01 - ERROR - ✗ Error al enviar email a vivero: None
2026-02-06 20:41:01 - INFO - 
Enviando email para sección: jardin
2026-02-06 20:41:01 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx']
2026-02-06 20:41:01 - WARNING - No hay destinatarios configurados para la sección: jardin
2026-02-06 20:41:01 - WARNING - No se puede enviar email para jardin: No hay destinatarios configurados
2026-02-06 20:41:01 - ERROR - ✗ Error al enviar email a jardin: No hay destinatarios configurados
2026-02-06 20:41:01 - INFO - 
Enviando email para sección: aridos
2026-02-06 20:41:01 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx']
2026-02-06 20:41:01 - WARNING - No hay destinatarios configurados para la sección: aridos
2026-02-06 20:41:01 - WARNING - No se puede enviar email para aridos: No hay destinatarios configurados
2026-02-06 20:41:01 - ERROR - ✗ Error al enviar email a aridos: No hay destinatarios configurados
2026-02-06 20:41:01 - INFO - 
Enviando email para sección: exterior
2026-02-06 20:41:01 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']
2026-02-06 20:41:01 - WARNING - No hay destinatarios configurados para la sección: exterior
2026-02-06 20:41:01 - WARNING - No se puede enviar email para exterior: No hay destinatarios configurados
2026-02-06 20:41:01 - ERROR - ✗ Error al enviar email a exterior: No hay destinatarios configurados
2026-02-06 20:41:01 - INFO - 
============================================================
2026-02-06 20:41:01 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 20:41:01 - INFO - ============================================================
2026-02-06 20:41:01 - INFO - Emails enviados exitosamente: 0
2026-02-06 20:41:01 - INFO - Emails fallidos: 10
2026-02-06 20:41:01 - INFO - Secciones procesadas: 10
2026-02-06 20:41:01 - INFO - 
============================================================
2026-02-06 20:41:01 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:41:01 - INFO - ============================================================
2026-02-06 20:41:01 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:41:01 - INFO - 
============================================================
2026-02-06 20:41:01 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:41:01 - INFO - ============================================================
2026-02-06 20:41:01 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:41:01 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 20:41:01 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 20:41:01 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:41:01 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:41:01 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 20:41:01 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:41:02 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 20:41:02 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 20:41:02 - INFO - 
============================================================
2026-02-06 20:41:02 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 20:41:02 - INFO - ============================================================
2026-02-06 20:41:02 - INFO - Emails enviados: 3
2026-02-06 20:41:02 - INFO - Emails fallidos: 0
2026-02-06 20:41:02 - INFO - 
======================================================================
2026-02-06 20:41:02 - INFO - RESUMEN DE EJECUCION
2026-02-06 20:41:02 - INFO - ======================================================================
2026-02-06 20:41:02 - INFO - Semana procesada: 14
2026-02-06 20:41:02 - INFO - Archivos generados: 12
2026-02-06 20:41:02 - INFO - Total articulos: 1510
2026-02-06 20:41:02 - INFO - Total importe: 48115.81€
2026-02-06 20:41:02 - WARNING - 
✗ EMAILS FALLIDOS: 10
2026-02-06 20:41:02 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 20:41:02 - INFO - ======================================================================
2026-02-06 20:41:02 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 20:41:02 - INFO - Archivo principal: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:41:02 - INFO - Artículos: 1510
2026-02-06 20:41:02 - INFO - Importe: 48115.81€
2026-02-06 20:41:02 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 20:50:20 - INFO - ======================================================================
2026-02-06 20:50:20 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 20:50:20 - INFO - Fecha de ejecución: 2026-02-06 20:50:20
2026-02-06 20:50:20 - INFO - ======================================================================
2026-02-06 20:50:20 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 20:50:20 - INFO - Envío de emails: Sí
2026-02-06 20:50:20 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 20:50:20 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 20:50:20 - INFO - Estado cargado correctamente
2026-02-06 20:50:20 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:50:20 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:50:20 - INFO - Semana forzada por argumento: 14
2026-02-06 20:50:20 - INFO - ======================================================================
2026-02-06 20:50:20 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 20:50:20 - INFO - ======================================================================
2026-02-06 20:50:20 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 20:50:20 - INFO - DataLoader inicializado correctamente
2026-02-06 20:50:20 - INFO - ForecastEngine inicializado correctamente
2026-02-06 20:50:20 - INFO - OrderGenerator inicializado correctamente
2026-02-06 20:50:20 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:50:20 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:50:20 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 20:50:20 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 20:50:20 - INFO - 
==================================================
2026-02-06 20:50:20 - INFO - SECCION: MAF
2026-02-06 20:50:20 - INFO - ==================================================
2026-02-06 20:50:20 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 20:50:20 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:50:20 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 20:50:20 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:50:20 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:50:20 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:50:20 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 20:50:20 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 20:50:20 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:50:20 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:50:20 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:50:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:24 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:50:24 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:50:24 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:50:24 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:50:24 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:50:24 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 20:50:24 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:50:24 - DEBUG -   maf: 10970 registros
2026-02-06 20:50:24 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:50:24 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:50:24 - DEBUG -   interior: 3624 registros
2026-02-06 20:50:24 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:50:24 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:50:24 - DEBUG -   vivero: 2460 registros
2026-02-06 20:50:24 - DEBUG -   fitos: 1987 registros
2026-02-06 20:50:24 - DEBUG -   semillas: 1180 registros
2026-02-06 20:50:24 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:50:24 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:50:24 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 20:50:24 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 20:50:24 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:50:24 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:50:27 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:27 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:50:27 - INFO - Costes cargados: 22145 registros
2026-02-06 20:50:27 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:50:27 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:50:27 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 20:50:27 - INFO -   ABC: 499 registros
2026-02-06 20:50:27 - INFO -   Ventas: 10970 registros
2026-02-06 20:50:27 - INFO -   Costes: 22145 registros
2026-02-06 20:50:27 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 20:50:27 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 20:50:27 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:50:27 - INFO - Datos de ventas: 1011 registros
2026-02-06 20:50:27 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 20:50:27 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 20:50:27 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:50:27 - INFO -   Factor total: 1.3125
2026-02-06 20:50:27 - INFO -   Factor escalado: 1.5844
2026-02-06 20:50:27 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 20:50:27 - INFO -   Objetivo final: 9253.98€
2026-02-06 20:50:27 - INFO -   Delta: 679.77€
2026-02-06 20:50:27 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:50:27 - DEBUG -   Total registros: 222
2026-02-06 20:50:27 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 20:50:27 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 20:50:27 - INFO -   Ventas finales: 9254.53€
2026-02-06 20:50:27 - INFO - 
============================================================
2026-02-06 20:50:27 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:50:27 - INFO - ============================================================
2026-02-06 20:50:27 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:50:27 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:50:27 - INFO - DataLoader inicializado correctamente
2026-02-06 20:50:27 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:50:27 - INFO - ============================================================
2026-02-06 20:50:27 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:50:27 - INFO - ============================================================
2026-02-06 20:50:27 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:50:27 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:50:27 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:27 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:27 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:27 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:27 - DEBUG - Usando hoja: Stock
2026-02-06 20:50:27 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:50:27 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:50:27 - INFO -   Stock: 30 registros
2026-02-06 20:50:27 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:50:27 - INFO - Fusión completada: 222 registros
2026-02-06 20:50:27 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:50:27 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:50:27 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:50:27 - INFO - 
============================================================
2026-02-06 20:50:27 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:50:27 - INFO - ============================================================
2026-02-06 20:50:27 - INFO - Corrección de tendencia completada:
2026-02-06 20:50:27 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:50:27 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:50:27 - INFO - ============================================================
2026-02-06 20:50:27 - INFO - Corrección completada:
2026-02-06 20:50:27 - INFO -   - Artículos corregidos: 191/222
2026-02-06 20:50:27 - INFO -   - Artículos aumentados: 191
2026-02-06 20:50:27 - INFO -   - Artículos reducidos: 0
2026-02-06 20:50:27 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:50:27 - WARNING -   [ALTO] 222 artículos con stock en 0 o negativo
2026-02-06 20:50:27 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:50:27 - INFO -   Artículos corregidos: 191/222
2026-02-06 20:50:27 - INFO -   Porcentaje corregido: 86.0%
2026-02-06 20:50:27 - INFO -   Diferencia unidades: +774
2026-02-06 20:50:27 - INFO -   Porcentaje cambio: +25.3%
2026-02-06 20:50:27 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_maf_CORREGIDO.xlsx
2026-02-06 20:50:27 - INFO - Archivo corregido: Pedido_Semana_14_06042026_maf_CORREGIDO.xlsx
2026-02-06 20:50:27 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 20:50:27 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:50:27 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:50:27 - DEBUG -   Con valor 0: 31
2026-02-06 20:50:27 - DEBUG -   Con valor > 0: 191
2026-02-06 20:50:27 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 20:50:27 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 191 registros
2026-02-06 20:50:27 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:50:28 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:50:28 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:50:28 - INFO -   Articulos: 191
2026-02-06 20:50:28 - INFO -   Importe: 9254.53€
2026-02-06 20:50:28 - INFO - 
==================================================
2026-02-06 20:50:28 - INFO - SECCION: DECO_INTERIOR
2026-02-06 20:50:28 - INFO - ==================================================
2026-02-06 20:50:28 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 20:50:28 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:50:28 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 20:50:28 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:50:28 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:50:28 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:50:28 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 20:50:28 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 20:50:28 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:50:28 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:50:28 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:50:32 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:32 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:50:32 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:50:32 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:50:32 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:50:32 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:50:32 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 20:50:32 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:50:32 - DEBUG -   maf: 10970 registros
2026-02-06 20:50:32 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:50:32 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:50:32 - DEBUG -   interior: 3624 registros
2026-02-06 20:50:32 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:50:32 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:50:32 - DEBUG -   vivero: 2460 registros
2026-02-06 20:50:32 - DEBUG -   fitos: 1987 registros
2026-02-06 20:50:32 - DEBUG -   semillas: 1180 registros
2026-02-06 20:50:32 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:50:32 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:50:32 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 20:50:32 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 20:50:32 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:50:32 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:50:34 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:34 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:50:34 - INFO - Costes cargados: 22145 registros
2026-02-06 20:50:34 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:50:34 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:50:34 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 20:50:34 - INFO -   ABC: 1827 registros
2026-02-06 20:50:34 - INFO -   Ventas: 2468 registros
2026-02-06 20:50:34 - INFO -   Costes: 22145 registros
2026-02-06 20:50:34 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 20:50:34 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 20:50:34 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:50:34 - INFO - Datos de ventas: 180 registros
2026-02-06 20:50:34 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 20:50:34 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 20:50:34 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:50:34 - INFO -   Factor total: 1.3125
2026-02-06 20:50:34 - INFO -   Factor escalado: 1.5747
2026-02-06 20:50:34 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 20:50:34 - INFO -   Objetivo final: 2576.42€
2026-02-06 20:50:34 - INFO -   Delta: 373.59€
2026-02-06 20:50:34 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:50:34 - DEBUG -   Total registros: 139
2026-02-06 20:50:34 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 20:50:34 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 20:50:34 - INFO -   Ventas finales: 2580.73€
2026-02-06 20:50:35 - INFO - 
============================================================
2026-02-06 20:50:35 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:50:35 - INFO - ============================================================
2026-02-06 20:50:35 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:50:35 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:50:35 - INFO - DataLoader inicializado correctamente
2026-02-06 20:50:35 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:50:35 - INFO - ============================================================
2026-02-06 20:50:35 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:50:35 - INFO - ============================================================
2026-02-06 20:50:35 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:50:35 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:50:35 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:35 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:35 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:35 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:35 - DEBUG - Usando hoja: Stock
2026-02-06 20:50:35 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:50:35 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:50:35 - INFO -   Stock: 30 registros
2026-02-06 20:50:35 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:50:35 - INFO - Fusión completada: 139 registros
2026-02-06 20:50:35 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:50:35 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:50:35 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:50:35 - INFO - 
============================================================
2026-02-06 20:50:35 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:50:35 - INFO - ============================================================
2026-02-06 20:50:35 - INFO - Corrección de tendencia completada:
2026-02-06 20:50:35 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:50:35 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:50:35 - INFO - ============================================================
2026-02-06 20:50:35 - INFO - Corrección completada:
2026-02-06 20:50:35 - INFO -   - Artículos corregidos: 135/139
2026-02-06 20:50:35 - INFO -   - Artículos aumentados: 135
2026-02-06 20:50:35 - INFO -   - Artículos reducidos: 0
2026-02-06 20:50:35 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:50:35 - WARNING -   [ALTO] 139 artículos con stock en 0 o negativo
2026-02-06 20:50:35 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:50:35 - INFO -   Artículos corregidos: 135/139
2026-02-06 20:50:35 - INFO -   Porcentaje corregido: 97.1%
2026-02-06 20:50:35 - INFO -   Diferencia unidades: +169
2026-02-06 20:50:35 - INFO -   Porcentaje cambio: +33.6%
2026-02-06 20:50:35 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_deco_interior_CORREGIDO.xlsx
2026-02-06 20:50:35 - INFO - Archivo corregido: Pedido_Semana_14_06042026_deco_interior_CORREGIDO.xlsx
2026-02-06 20:50:35 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 20:50:35 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:50:35 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:50:35 - DEBUG -   Con valor 0: 4
2026-02-06 20:50:35 - DEBUG -   Con valor > 0: 135
2026-02-06 20:50:35 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 20:50:35 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 135 registros
2026-02-06 20:50:35 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:50:35 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:50:35 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:50:35 - INFO -   Articulos: 135
2026-02-06 20:50:35 - INFO -   Importe: 2580.73€
2026-02-06 20:50:35 - INFO - 
==================================================
2026-02-06 20:50:35 - INFO - SECCION: SEMILLAS
2026-02-06 20:50:35 - INFO - ==================================================
2026-02-06 20:50:35 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 20:50:35 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:50:35 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 20:50:35 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:50:35 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:50:35 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:50:35 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 20:50:35 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 20:50:35 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:50:35 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:50:35 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:50:39 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:39 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:50:39 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:50:39 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:50:39 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:50:39 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:50:39 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 20:50:39 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:50:39 - DEBUG -   maf: 10970 registros
2026-02-06 20:50:39 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:50:39 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:50:39 - DEBUG -   interior: 3624 registros
2026-02-06 20:50:39 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:50:39 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:50:39 - DEBUG -   vivero: 2460 registros
2026-02-06 20:50:39 - DEBUG -   fitos: 1987 registros
2026-02-06 20:50:39 - DEBUG -   semillas: 1180 registros
2026-02-06 20:50:39 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:50:39 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:50:39 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 20:50:39 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 20:50:39 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:50:39 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:50:41 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:41 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:50:41 - INFO - Costes cargados: 22145 registros
2026-02-06 20:50:41 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:50:41 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:50:41 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 20:50:41 - INFO -   ABC: 218 registros
2026-02-06 20:50:41 - INFO -   Ventas: 1180 registros
2026-02-06 20:50:41 - INFO -   Costes: 22145 registros
2026-02-06 20:50:41 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 20:50:41 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 20:50:41 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:50:41 - INFO - Datos de ventas: 136 registros
2026-02-06 20:50:41 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 20:50:41 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 20:50:41 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:50:41 - INFO -   Factor total: 1.3125
2026-02-06 20:50:41 - INFO -   Factor escalado: 2.0023
2026-02-06 20:50:41 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 20:50:41 - INFO -   Objetivo final: 911.32€
2026-02-06 20:50:41 - INFO -   Delta: 217.83€
2026-02-06 20:50:41 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:50:41 - DEBUG -   Total registros: 84
2026-02-06 20:50:41 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 20:50:41 - DEBUG -   Ventas finales: 911.60€
2026-02-06 20:50:41 - INFO -   Ventas finales: 911.60€
2026-02-06 20:50:41 - INFO - 
============================================================
2026-02-06 20:50:41 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:50:41 - INFO - ============================================================
2026-02-06 20:50:41 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:50:41 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:50:41 - INFO - DataLoader inicializado correctamente
2026-02-06 20:50:41 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:50:41 - INFO - ============================================================
2026-02-06 20:50:41 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:50:41 - INFO - ============================================================
2026-02-06 20:50:41 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:50:41 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:50:41 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:41 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:41 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:41 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:41 - DEBUG - Usando hoja: Stock
2026-02-06 20:50:41 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:50:41 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:50:41 - INFO -   Stock: 30 registros
2026-02-06 20:50:41 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:50:41 - INFO - Fusión completada: 84 registros
2026-02-06 20:50:41 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:50:41 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:50:41 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:50:41 - INFO - 
============================================================
2026-02-06 20:50:41 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:50:41 - INFO - ============================================================
2026-02-06 20:50:41 - INFO - Corrección de tendencia completada:
2026-02-06 20:50:41 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:50:41 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:50:41 - INFO - ============================================================
2026-02-06 20:50:41 - INFO - Corrección completada:
2026-02-06 20:50:41 - INFO -   - Artículos corregidos: 84/84
2026-02-06 20:50:41 - INFO -   - Artículos aumentados: 84
2026-02-06 20:50:41 - INFO -   - Artículos reducidos: 0
2026-02-06 20:50:41 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:50:41 - WARNING -   [ALTO] 84 artículos con stock en 0 o negativo
2026-02-06 20:50:41 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:50:41 - INFO -   Artículos corregidos: 84/84
2026-02-06 20:50:41 - INFO -   Porcentaje corregido: 100.0%
2026-02-06 20:50:41 - INFO -   Diferencia unidades: +108
2026-02-06 20:50:41 - INFO -   Porcentaje cambio: +33.5%
2026-02-06 20:50:41 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_semillas_CORREGIDO.xlsx
2026-02-06 20:50:41 - INFO - Archivo corregido: Pedido_Semana_14_06042026_semillas_CORREGIDO.xlsx
2026-02-06 20:50:41 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:50:41 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:50:41 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:50:41 - DEBUG -   Con valor 0: 0
2026-02-06 20:50:41 - DEBUG -   Con valor > 0: 84
2026-02-06 20:50:41 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 20:50:41 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 84 registros
2026-02-06 20:50:41 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:50:41 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:50:41 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:50:41 - INFO -   Articulos: 84
2026-02-06 20:50:41 - INFO -   Importe: 911.60€
2026-02-06 20:50:41 - INFO - 
==================================================
2026-02-06 20:50:41 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 20:50:41 - INFO - ==================================================
2026-02-06 20:50:41 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 20:50:41 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:50:41 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 20:50:41 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:50:41 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:50:41 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:50:41 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 20:50:41 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 20:50:41 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:50:41 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:50:41 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:50:45 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:45 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:50:45 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:50:45 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:50:45 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:50:45 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:50:45 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 20:50:45 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:50:45 - DEBUG -   maf: 10970 registros
2026-02-06 20:50:45 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:50:45 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:50:45 - DEBUG -   interior: 3624 registros
2026-02-06 20:50:45 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:50:45 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:50:45 - DEBUG -   vivero: 2460 registros
2026-02-06 20:50:45 - DEBUG -   fitos: 1987 registros
2026-02-06 20:50:45 - DEBUG -   semillas: 1180 registros
2026-02-06 20:50:45 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:50:45 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:50:45 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 20:50:45 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 20:50:45 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:50:45 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:50:47 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:47 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:50:47 - INFO - Costes cargados: 22145 registros
2026-02-06 20:50:47 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:50:47 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:50:47 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 20:50:47 - INFO -   ABC: 205 registros
2026-02-06 20:50:47 - INFO -   Ventas: 1124 registros
2026-02-06 20:50:47 - INFO -   Costes: 22145 registros
2026-02-06 20:50:48 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 20:50:48 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 20:50:48 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:50:48 - INFO - Datos de ventas: 88 registros
2026-02-06 20:50:48 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 20:50:48 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 20:50:48 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:50:48 - INFO -   Factor total: 1.3125
2026-02-06 20:50:48 - INFO -   Factor escalado: 1.6854
2026-02-06 20:50:48 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 20:50:48 - INFO -   Objetivo final: 1426.88€
2026-02-06 20:50:48 - INFO -   Delta: 346.78€
2026-02-06 20:50:48 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:50:48 - DEBUG -   Total registros: 43
2026-02-06 20:50:48 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 20:50:48 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 20:50:48 - INFO -   Ventas finales: 1455.34€
2026-02-06 20:50:48 - INFO - 
============================================================
2026-02-06 20:50:48 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:50:48 - INFO - ============================================================
2026-02-06 20:50:48 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:50:48 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:50:48 - INFO - DataLoader inicializado correctamente
2026-02-06 20:50:48 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:50:48 - INFO - ============================================================
2026-02-06 20:50:48 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:50:48 - INFO - ============================================================
2026-02-06 20:50:48 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:50:48 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:50:48 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:48 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:48 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:48 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:48 - DEBUG - Usando hoja: Stock
2026-02-06 20:50:48 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:50:48 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:50:48 - INFO -   Stock: 30 registros
2026-02-06 20:50:48 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:50:48 - INFO - Fusión completada: 43 registros
2026-02-06 20:50:48 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:50:48 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:50:48 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:50:48 - INFO - 
============================================================
2026-02-06 20:50:48 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:50:48 - INFO - ============================================================
2026-02-06 20:50:48 - INFO - Corrección de tendencia completada:
2026-02-06 20:50:48 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:50:48 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:50:48 - INFO - ============================================================
2026-02-06 20:50:48 - INFO - Corrección completada:
2026-02-06 20:50:48 - INFO -   - Artículos corregidos: 36/43
2026-02-06 20:50:48 - INFO -   - Artículos aumentados: 36
2026-02-06 20:50:48 - INFO -   - Artículos reducidos: 0
2026-02-06 20:50:48 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:50:48 - WARNING -   [ALTO] 43 artículos con stock en 0 o negativo
2026-02-06 20:50:48 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:50:48 - INFO -   Artículos corregidos: 36/43
2026-02-06 20:50:48 - INFO -   Porcentaje corregido: 83.7%
2026-02-06 20:50:48 - INFO -   Diferencia unidades: +64
2026-02-06 20:50:48 - INFO -   Porcentaje cambio: +28.8%
2026-02-06 20:50:48 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_mascotas_vivo_CORREGIDO.xlsx
2026-02-06 20:50:48 - INFO - Archivo corregido: Pedido_Semana_14_06042026_mascotas_vivo_CORREGIDO.xlsx
2026-02-06 20:50:48 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 20:50:48 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:50:48 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:50:48 - DEBUG -   Con valor 0: 7
2026-02-06 20:50:48 - DEBUG -   Con valor > 0: 36
2026-02-06 20:50:48 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 20:50:48 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 36 registros
2026-02-06 20:50:48 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:50:48 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:50:48 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:50:48 - INFO -   Articulos: 36
2026-02-06 20:50:48 - INFO -   Importe: 1455.34€
2026-02-06 20:50:48 - INFO - 
==================================================
2026-02-06 20:50:48 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 20:50:48 - INFO - ==================================================
2026-02-06 20:50:48 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 20:50:48 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:50:48 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 20:50:48 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:50:48 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:50:48 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:50:48 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 20:50:48 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 20:50:48 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:50:48 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:50:48 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:50:52 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:52 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:50:52 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:50:52 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:50:52 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:50:52 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:50:52 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 20:50:52 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:50:52 - DEBUG -   maf: 10970 registros
2026-02-06 20:50:52 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:50:52 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:50:52 - DEBUG -   interior: 3624 registros
2026-02-06 20:50:52 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:50:52 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:50:52 - DEBUG -   vivero: 2460 registros
2026-02-06 20:50:52 - DEBUG -   fitos: 1987 registros
2026-02-06 20:50:52 - DEBUG -   semillas: 1180 registros
2026-02-06 20:50:52 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:50:52 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:50:52 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 20:50:52 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 20:50:52 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:50:52 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:50:54 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:54 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:50:54 - INFO - Costes cargados: 22145 registros
2026-02-06 20:50:54 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:50:54 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:50:54 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 20:50:54 - INFO -   ABC: 2749 registros
2026-02-06 20:50:54 - INFO -   Ventas: 9784 registros
2026-02-06 20:50:54 - INFO -   Costes: 22145 registros
2026-02-06 20:50:54 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 20:50:54 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 20:50:54 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:50:54 - INFO - Datos de ventas: 822 registros
2026-02-06 20:50:54 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 20:50:56 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 20:50:56 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:50:56 - INFO -   Factor total: 1.3125
2026-02-06 20:50:56 - INFO -   Factor escalado: 1.0268
2026-02-06 20:50:57 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 20:50:57 - INFO -   Objetivo final: 8977.26€
2026-02-06 20:50:57 - INFO -   Delta: 3401.99€
2026-02-06 20:50:57 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:50:57 - DEBUG -   Total registros: 538
2026-02-06 20:50:57 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 20:50:57 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 20:50:57 - INFO -   Ventas finales: 8993.98€
2026-02-06 20:50:57 - INFO - 
============================================================
2026-02-06 20:50:57 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:50:57 - INFO - ============================================================
2026-02-06 20:50:57 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:50:57 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:50:57 - INFO - DataLoader inicializado correctamente
2026-02-06 20:50:57 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:50:57 - INFO - ============================================================
2026-02-06 20:50:57 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:50:57 - INFO - ============================================================
2026-02-06 20:50:57 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:50:57 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:50:57 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:57 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:57 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:50:57 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:50:57 - DEBUG - Usando hoja: Stock
2026-02-06 20:50:57 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:50:57 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:50:57 - INFO -   Stock: 30 registros
2026-02-06 20:50:57 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:50:57 - INFO - Fusión completada: 538 registros
2026-02-06 20:50:57 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:50:57 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:50:57 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:50:57 - INFO - 
============================================================
2026-02-06 20:50:57 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:50:57 - INFO - ============================================================
2026-02-06 20:50:57 - INFO - Corrección de tendencia completada:
2026-02-06 20:50:57 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:50:57 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:50:57 - INFO - ============================================================
2026-02-06 20:50:57 - INFO - Corrección completada:
2026-02-06 20:50:57 - INFO -   - Artículos corregidos: 411/538
2026-02-06 20:50:57 - INFO -   - Artículos aumentados: 411
2026-02-06 20:50:57 - INFO -   - Artículos reducidos: 0
2026-02-06 20:50:57 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:50:57 - WARNING -   [ALTO] 538 artículos con stock en 0 o negativo
2026-02-06 20:50:57 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:50:57 - INFO -   Artículos corregidos: 411/538
2026-02-06 20:50:57 - INFO -   Porcentaje corregido: 76.4%
2026-02-06 20:50:57 - INFO -   Diferencia unidades: +545
2026-02-06 20:50:57 - INFO -   Porcentaje cambio: +34.2%
2026-02-06 20:50:57 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_mascotas_manufacturado_CORREGIDO.xlsx
2026-02-06 20:50:57 - INFO - Archivo corregido: Pedido_Semana_14_06042026_mascotas_manufacturado_CORREGIDO.xlsx
2026-02-06 20:50:57 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 20:50:57 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:50:57 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:50:57 - DEBUG -   Con valor 0: 127
2026-02-06 20:50:57 - DEBUG -   Con valor > 0: 411
2026-02-06 20:50:57 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 20:50:57 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 411 registros
2026-02-06 20:50:57 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:50:57 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:50:57 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:50:57 - INFO -   Articulos: 411
2026-02-06 20:50:57 - INFO -   Importe: 8993.98€
2026-02-06 20:50:57 - INFO - 
==================================================
2026-02-06 20:50:57 - INFO - SECCION: INTERIOR
2026-02-06 20:50:57 - INFO - ==================================================
2026-02-06 20:50:57 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 20:50:57 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:50:57 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 20:50:57 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:50:57 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:50:57 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:50:57 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 20:50:57 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 20:50:57 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:50:57 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:50:57 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:51:01 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:01 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:51:01 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:51:01 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:51:01 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:51:01 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:51:01 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 20:51:01 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:51:01 - DEBUG -   maf: 10970 registros
2026-02-06 20:51:01 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:51:01 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:51:01 - DEBUG -   interior: 3624 registros
2026-02-06 20:51:01 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:51:01 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:51:01 - DEBUG -   vivero: 2460 registros
2026-02-06 20:51:01 - DEBUG -   fitos: 1987 registros
2026-02-06 20:51:01 - DEBUG -   semillas: 1180 registros
2026-02-06 20:51:01 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:51:01 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:51:01 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 20:51:01 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 20:51:01 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:51:01 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:51:03 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:03 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:51:03 - INFO - Costes cargados: 22145 registros
2026-02-06 20:51:03 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:51:03 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:51:03 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 20:51:03 - INFO -   ABC: 555 registros
2026-02-06 20:51:03 - INFO -   Ventas: 3624 registros
2026-02-06 20:51:03 - INFO -   Costes: 22145 registros
2026-02-06 20:51:03 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 20:51:03 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 20:51:03 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:51:03 - INFO - Datos de ventas: 286 registros
2026-02-06 20:51:03 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 20:51:04 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 20:51:04 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:51:04 - INFO -   Factor total: 1.3125
2026-02-06 20:51:04 - INFO -   Factor escalado: 1.5971
2026-02-06 20:51:04 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 20:51:04 - INFO -   Objetivo final: 3846.45€
2026-02-06 20:51:04 - INFO -   Delta: 685.37€
2026-02-06 20:51:04 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:51:04 - DEBUG -   Total registros: 138
2026-02-06 20:51:04 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 20:51:04 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 20:51:04 - INFO -   Ventas finales: 3862.17€
2026-02-06 20:51:04 - INFO - 
============================================================
2026-02-06 20:51:04 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:51:04 - INFO - ============================================================
2026-02-06 20:51:04 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:51:04 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:51:04 - INFO - DataLoader inicializado correctamente
2026-02-06 20:51:04 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:51:04 - INFO - ============================================================
2026-02-06 20:51:04 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:51:04 - INFO - ============================================================
2026-02-06 20:51:04 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:51:04 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:51:04 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:04 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:04 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:04 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:04 - DEBUG - Usando hoja: Stock
2026-02-06 20:51:04 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:51:04 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:51:04 - INFO -   Stock: 30 registros
2026-02-06 20:51:04 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:51:04 - INFO - Fusión completada: 138 registros
2026-02-06 20:51:04 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:51:04 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:51:04 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:51:04 - INFO - 
============================================================
2026-02-06 20:51:04 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:51:04 - INFO - ============================================================
2026-02-06 20:51:04 - INFO - Corrección de tendencia completada:
2026-02-06 20:51:04 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:51:04 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:51:04 - INFO - ============================================================
2026-02-06 20:51:04 - INFO - Corrección completada:
2026-02-06 20:51:04 - INFO -   - Artículos corregidos: 121/138
2026-02-06 20:51:04 - INFO -   - Artículos aumentados: 121
2026-02-06 20:51:04 - INFO -   - Artículos reducidos: 0
2026-02-06 20:51:04 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:51:04 - WARNING -   [ALTO] 138 artículos con stock en 0 o negativo
2026-02-06 20:51:04 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:51:04 - INFO -   Artículos corregidos: 121/138
2026-02-06 20:51:04 - INFO -   Porcentaje corregido: 87.7%
2026-02-06 20:51:04 - INFO -   Diferencia unidades: +199
2026-02-06 20:51:04 - INFO -   Porcentaje cambio: +30.5%
2026-02-06 20:51:04 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_interior_CORREGIDO.xlsx
2026-02-06 20:51:04 - INFO - Archivo corregido: Pedido_Semana_14_06042026_interior_CORREGIDO.xlsx
2026-02-06 20:51:04 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 20:51:04 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:51:04 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:51:04 - DEBUG -   Con valor 0: 17
2026-02-06 20:51:04 - DEBUG -   Con valor > 0: 121
2026-02-06 20:51:04 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 20:51:04 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 121 registros
2026-02-06 20:51:04 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:51:04 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:51:04 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:51:04 - INFO -   Articulos: 121
2026-02-06 20:51:04 - INFO -   Importe: 3862.17€
2026-02-06 20:51:04 - INFO - 
==================================================
2026-02-06 20:51:04 - INFO - SECCION: FITOS
2026-02-06 20:51:04 - INFO - ==================================================
2026-02-06 20:51:04 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 20:51:04 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:51:04 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 20:51:04 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:51:04 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:51:04 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:51:04 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 20:51:04 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:51:04 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:51:04 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:51:04 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:51:08 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:08 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:51:08 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:51:08 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:51:08 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:51:08 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:51:08 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 20:51:08 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:51:08 - DEBUG -   maf: 10970 registros
2026-02-06 20:51:08 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:51:08 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:51:08 - DEBUG -   interior: 3624 registros
2026-02-06 20:51:08 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:51:08 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:51:08 - DEBUG -   vivero: 2460 registros
2026-02-06 20:51:08 - DEBUG -   fitos: 1987 registros
2026-02-06 20:51:08 - DEBUG -   semillas: 1180 registros
2026-02-06 20:51:08 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:51:08 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:51:08 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 20:51:08 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 20:51:08 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:51:08 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:51:10 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:10 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:51:10 - INFO - Costes cargados: 22145 registros
2026-02-06 20:51:10 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:51:10 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:51:10 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 20:51:10 - INFO -   ABC: 247 registros
2026-02-06 20:51:10 - INFO -   Ventas: 1987 registros
2026-02-06 20:51:10 - INFO -   Costes: 22145 registros
2026-02-06 20:51:10 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:51:10 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 20:51:10 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:51:10 - INFO - Datos de ventas: 157 registros
2026-02-06 20:51:10 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 20:51:11 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 20:51:11 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:51:11 - INFO -   Factor total: 1.3125
2026-02-06 20:51:11 - INFO -   Factor escalado: 1.4055
2026-02-06 20:51:11 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 20:51:11 - INFO -   Objetivo final: 2360.20€
2026-02-06 20:51:11 - INFO -   Delta: 424.74€
2026-02-06 20:51:11 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:51:11 - DEBUG -   Total registros: 84
2026-02-06 20:51:11 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 20:51:11 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 20:51:11 - INFO -   Ventas finales: 2365.92€
2026-02-06 20:51:11 - INFO - 
============================================================
2026-02-06 20:51:11 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:51:11 - INFO - ============================================================
2026-02-06 20:51:11 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:51:11 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:51:11 - INFO - DataLoader inicializado correctamente
2026-02-06 20:51:11 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:51:11 - INFO - ============================================================
2026-02-06 20:51:11 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:51:11 - INFO - ============================================================
2026-02-06 20:51:11 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:51:11 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:51:11 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:11 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:11 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:11 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:11 - DEBUG - Usando hoja: Stock
2026-02-06 20:51:11 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:51:11 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:51:11 - INFO -   Stock: 30 registros
2026-02-06 20:51:11 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:51:11 - INFO - Fusión completada: 84 registros
2026-02-06 20:51:11 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:51:11 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:51:11 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:51:11 - INFO - 
============================================================
2026-02-06 20:51:11 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:51:11 - INFO - ============================================================
2026-02-06 20:51:11 - INFO - Corrección de tendencia completada:
2026-02-06 20:51:11 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:51:11 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:51:11 - INFO - ============================================================
2026-02-06 20:51:11 - INFO - Corrección completada:
2026-02-06 20:51:11 - INFO -   - Artículos corregidos: 82/84
2026-02-06 20:51:11 - INFO -   - Artículos aumentados: 82
2026-02-06 20:51:11 - INFO -   - Artículos reducidos: 0
2026-02-06 20:51:11 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:51:11 - WARNING -   [ALTO] 84 artículos con stock en 0 o negativo
2026-02-06 20:51:11 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:51:11 - INFO -   Artículos corregidos: 82/84
2026-02-06 20:51:11 - INFO -   Porcentaje corregido: 97.6%
2026-02-06 20:51:11 - INFO -   Diferencia unidades: +115
2026-02-06 20:51:11 - INFO -   Porcentaje cambio: +32.0%
2026-02-06 20:51:11 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_fitos_CORREGIDO.xlsx
2026-02-06 20:51:11 - INFO - Archivo corregido: Pedido_Semana_14_06042026_fitos_CORREGIDO.xlsx
2026-02-06 20:51:11 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:51:11 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:51:11 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:51:11 - DEBUG -   Con valor 0: 2
2026-02-06 20:51:11 - DEBUG -   Con valor > 0: 82
2026-02-06 20:51:11 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 20:51:11 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 82 registros
2026-02-06 20:51:11 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:51:11 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:51:11 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:51:11 - INFO -   Articulos: 82
2026-02-06 20:51:11 - INFO -   Importe: 2365.92€
2026-02-06 20:51:11 - INFO - 
==================================================
2026-02-06 20:51:11 - INFO - SECCION: VIVERO
2026-02-06 20:51:11 - INFO - ==================================================
2026-02-06 20:51:11 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 20:51:11 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:51:11 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 20:51:11 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:51:11 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:51:11 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:51:11 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 20:51:11 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 20:51:11 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:51:11 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:51:11 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:51:15 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:15 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:51:15 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:51:15 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:51:15 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:51:15 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:51:15 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 20:51:15 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:51:15 - DEBUG -   maf: 10970 registros
2026-02-06 20:51:15 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:51:15 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:51:15 - DEBUG -   interior: 3624 registros
2026-02-06 20:51:15 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:51:15 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:51:15 - DEBUG -   vivero: 2460 registros
2026-02-06 20:51:15 - DEBUG -   fitos: 1987 registros
2026-02-06 20:51:15 - DEBUG -   semillas: 1180 registros
2026-02-06 20:51:15 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:51:15 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:51:15 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 20:51:15 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 20:51:15 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:51:15 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:51:17 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:17 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:51:17 - INFO - Costes cargados: 22145 registros
2026-02-06 20:51:17 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:51:17 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:51:17 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 20:51:17 - INFO -   ABC: 565 registros
2026-02-06 20:51:17 - INFO -   Ventas: 2460 registros
2026-02-06 20:51:17 - INFO -   Costes: 22145 registros
2026-02-06 20:51:17 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 20:51:17 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 20:51:17 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:51:17 - INFO - Datos de ventas: 189 registros
2026-02-06 20:51:17 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 20:51:17 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 20:51:17 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:51:17 - INFO -   Factor total: 1.3125
2026-02-06 20:51:17 - INFO -   Factor escalado: 1.6886
2026-02-06 20:51:17 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 20:51:17 - INFO -   Objetivo final: 6952.54€
2026-02-06 20:51:17 - INFO -   Delta: 1809.40€
2026-02-06 20:51:17 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:51:17 - DEBUG -   Total registros: 107
2026-02-06 20:51:17 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 20:51:17 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 20:51:17 - INFO -   Ventas finales: 6990.51€
2026-02-06 20:51:17 - INFO - 
============================================================
2026-02-06 20:51:17 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:51:17 - INFO - ============================================================
2026-02-06 20:51:17 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:51:17 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:51:17 - INFO - DataLoader inicializado correctamente
2026-02-06 20:51:17 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:51:17 - INFO - ============================================================
2026-02-06 20:51:17 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:51:17 - INFO - ============================================================
2026-02-06 20:51:17 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:51:17 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:51:17 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:17 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:17 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:17 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:17 - DEBUG - Usando hoja: Stock
2026-02-06 20:51:17 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:51:17 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:51:17 - INFO -   Stock: 30 registros
2026-02-06 20:51:17 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:51:17 - INFO - Fusión completada: 107 registros
2026-02-06 20:51:17 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:51:17 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:51:17 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:51:17 - INFO - 
============================================================
2026-02-06 20:51:17 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:51:17 - INFO - ============================================================
2026-02-06 20:51:17 - INFO - Corrección de tendencia completada:
2026-02-06 20:51:17 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:51:17 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:51:17 - INFO - ============================================================
2026-02-06 20:51:17 - INFO - Corrección completada:
2026-02-06 20:51:17 - INFO -   - Artículos corregidos: 96/107
2026-02-06 20:51:17 - INFO -   - Artículos aumentados: 96
2026-02-06 20:51:17 - INFO -   - Artículos reducidos: 0
2026-02-06 20:51:17 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:51:17 - WARNING -   [ALTO] 107 artículos con stock en 0 o negativo
2026-02-06 20:51:17 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:51:17 - INFO -   Artículos corregidos: 96/107
2026-02-06 20:51:17 - INFO -   Porcentaje corregido: 89.7%
2026-02-06 20:51:17 - INFO -   Diferencia unidades: +159
2026-02-06 20:51:17 - INFO -   Porcentaje cambio: +29.8%
2026-02-06 20:51:17 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_vivero_CORREGIDO.xlsx
2026-02-06 20:51:17 - INFO - Archivo corregido: Pedido_Semana_14_06042026_vivero_CORREGIDO.xlsx
2026-02-06 20:51:17 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 20:51:17 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:51:17 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:51:17 - DEBUG -   Con valor 0: 11
2026-02-06 20:51:17 - DEBUG -   Con valor > 0: 96
2026-02-06 20:51:17 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 20:51:17 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 96 registros
2026-02-06 20:51:17 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:51:18 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:51:18 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:51:18 - INFO -   Articulos: 96
2026-02-06 20:51:18 - INFO -   Importe: 6990.51€
2026-02-06 20:51:18 - INFO - 
==================================================
2026-02-06 20:51:18 - INFO - SECCION: UTILES_JARDIN
2026-02-06 20:51:18 - INFO - ==================================================
2026-02-06 20:51:18 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 20:51:18 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:51:18 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 20:51:18 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:51:18 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:51:18 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:51:18 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 20:51:18 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 20:51:18 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:51:18 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:51:18 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:51:22 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:22 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:51:22 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:51:22 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:51:22 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:51:22 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:51:22 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 20:51:22 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:51:22 - DEBUG -   maf: 10970 registros
2026-02-06 20:51:22 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:51:22 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:51:22 - DEBUG -   interior: 3624 registros
2026-02-06 20:51:22 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:51:22 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:51:22 - DEBUG -   vivero: 2460 registros
2026-02-06 20:51:22 - DEBUG -   fitos: 1987 registros
2026-02-06 20:51:22 - DEBUG -   semillas: 1180 registros
2026-02-06 20:51:22 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:51:22 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:51:22 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 20:51:22 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 20:51:22 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:51:22 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:51:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:24 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:51:24 - INFO - Costes cargados: 22145 registros
2026-02-06 20:51:24 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:51:24 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:51:24 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 20:51:24 - INFO -   ABC: 433 registros
2026-02-06 20:51:24 - INFO -   Ventas: 1009 registros
2026-02-06 20:51:24 - INFO -   Costes: 22145 registros
2026-02-06 20:51:24 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 20:51:24 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 20:51:24 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:51:24 - INFO - Datos de ventas: 89 registros
2026-02-06 20:51:24 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 20:51:24 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 20:51:24 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:51:24 - INFO -   Factor total: 1.3125
2026-02-06 20:51:24 - INFO -   Factor escalado: 1.6747
2026-02-06 20:51:24 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 20:51:24 - INFO -   Objetivo final: 1371.26€
2026-02-06 20:51:24 - INFO -   Delta: 558.30€
2026-02-06 20:51:24 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:51:24 - DEBUG -   Total registros: 78
2026-02-06 20:51:24 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 20:51:24 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 20:51:24 - INFO -   Ventas finales: 1390.00€
2026-02-06 20:51:24 - INFO - 
============================================================
2026-02-06 20:51:24 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:51:24 - INFO - ============================================================
2026-02-06 20:51:24 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:51:24 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:51:24 - INFO - DataLoader inicializado correctamente
2026-02-06 20:51:24 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:51:24 - INFO - ============================================================
2026-02-06 20:51:24 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:51:24 - INFO - ============================================================
2026-02-06 20:51:24 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:51:24 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:51:24 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:24 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:24 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:24 - DEBUG - Usando hoja: Stock
2026-02-06 20:51:24 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:51:24 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:51:24 - INFO -   Stock: 30 registros
2026-02-06 20:51:24 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:51:24 - INFO - Fusión completada: 78 registros
2026-02-06 20:51:24 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:51:24 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:51:24 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:51:24 - INFO - 
============================================================
2026-02-06 20:51:24 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:51:24 - INFO - ============================================================
2026-02-06 20:51:24 - INFO - Corrección de tendencia completada:
2026-02-06 20:51:24 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:51:24 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:51:24 - INFO - ============================================================
2026-02-06 20:51:24 - INFO - Corrección completada:
2026-02-06 20:51:24 - INFO -   - Artículos corregidos: 78/78
2026-02-06 20:51:24 - INFO -   - Artículos aumentados: 78
2026-02-06 20:51:24 - INFO -   - Artículos reducidos: 0
2026-02-06 20:51:24 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:51:24 - WARNING -   [ALTO] 78 artículos con stock en 0 o negativo
2026-02-06 20:51:24 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:51:24 - INFO -   Artículos corregidos: 78/78
2026-02-06 20:51:24 - INFO -   Porcentaje corregido: 100.0%
2026-02-06 20:51:24 - INFO -   Diferencia unidades: +108
2026-02-06 20:51:24 - INFO -   Porcentaje cambio: +31.3%
2026-02-06 20:51:24 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_utiles_jardin_CORREGIDO.xlsx
2026-02-06 20:51:24 - INFO - Archivo corregido: Pedido_Semana_14_06042026_utiles_jardin_CORREGIDO.xlsx
2026-02-06 20:51:24 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 20:51:24 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:51:24 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:51:24 - DEBUG -   Con valor 0: 0
2026-02-06 20:51:24 - DEBUG -   Con valor > 0: 78
2026-02-06 20:51:24 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 20:51:24 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 78 registros
2026-02-06 20:51:24 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:51:24 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:51:24 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:51:24 - INFO -   Articulos: 78
2026-02-06 20:51:24 - INFO -   Importe: 1390.00€
2026-02-06 20:51:24 - INFO - 
==================================================
2026-02-06 20:51:24 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 20:51:24 - INFO - ==================================================
2026-02-06 20:51:24 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 20:51:24 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:51:24 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 20:51:24 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:51:24 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:51:24 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:51:24 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 20:51:24 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:51:24 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:51:24 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:51:24 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:51:29 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:29 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:51:29 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:51:29 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:51:29 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:51:29 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:51:29 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 20:51:29 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:51:29 - DEBUG -   maf: 10970 registros
2026-02-06 20:51:29 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:51:29 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:51:29 - DEBUG -   interior: 3624 registros
2026-02-06 20:51:29 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:51:29 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:51:29 - DEBUG -   vivero: 2460 registros
2026-02-06 20:51:29 - DEBUG -   fitos: 1987 registros
2026-02-06 20:51:29 - DEBUG -   semillas: 1180 registros
2026-02-06 20:51:29 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:51:29 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:51:29 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 20:51:29 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 20:51:29 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:51:29 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:51:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:31 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:51:31 - INFO - Costes cargados: 22145 registros
2026-02-06 20:51:31 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:51:31 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:51:31 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 20:51:31 - INFO -   ABC: 247 registros
2026-02-06 20:51:31 - INFO -   Ventas: 3264 registros
2026-02-06 20:51:31 - INFO -   Costes: 22145 registros
2026-02-06 20:51:31 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:51:31 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 20:51:31 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:51:31 - INFO - Datos de ventas: 302 registros
2026-02-06 20:51:31 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 20:51:31 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 20:51:31 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:51:31 - INFO -   Factor total: 1.3125
2026-02-06 20:51:31 - INFO -   Factor escalado: 1.3380
2026-02-06 20:51:31 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 20:51:31 - INFO -   Objetivo final: 5377.63€
2026-02-06 20:51:31 - INFO -   Delta: 432.03€
2026-02-06 20:51:31 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:51:31 - DEBUG -   Total registros: 72
2026-02-06 20:51:31 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 20:51:31 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 20:51:31 - INFO -   Ventas finales: 5387.14€
2026-02-06 20:51:31 - INFO - 
============================================================
2026-02-06 20:51:31 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:51:31 - INFO - ============================================================
2026-02-06 20:51:31 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:51:31 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:51:31 - INFO - DataLoader inicializado correctamente
2026-02-06 20:51:31 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:51:31 - INFO - ============================================================
2026-02-06 20:51:31 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:51:31 - INFO - ============================================================
2026-02-06 20:51:31 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:51:31 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:51:31 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:31 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:31 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:31 - DEBUG - Usando hoja: Stock
2026-02-06 20:51:31 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:51:31 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:51:31 - INFO -   Stock: 30 registros
2026-02-06 20:51:31 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:51:31 - INFO - Fusión completada: 72 registros
2026-02-06 20:51:31 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:51:31 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:51:31 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:51:31 - INFO - 
============================================================
2026-02-06 20:51:31 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:51:31 - INFO - ============================================================
2026-02-06 20:51:31 - INFO - Corrección de tendencia completada:
2026-02-06 20:51:31 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:51:31 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:51:31 - INFO - ============================================================
2026-02-06 20:51:31 - INFO - Corrección completada:
2026-02-06 20:51:31 - INFO -   - Artículos corregidos: 71/72
2026-02-06 20:51:31 - INFO -   - Artículos aumentados: 71
2026-02-06 20:51:31 - INFO -   - Artículos reducidos: 0
2026-02-06 20:51:31 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:51:31 - WARNING -   [ALTO] 72 artículos con stock en 0 o negativo
2026-02-06 20:51:31 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:51:31 - INFO -   Artículos corregidos: 71/72
2026-02-06 20:51:31 - INFO -   Porcentaje corregido: 98.6%
2026-02-06 20:51:31 - INFO -   Diferencia unidades: +212
2026-02-06 20:51:31 - INFO -   Porcentaje cambio: +26.5%
2026-02-06 20:51:31 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_tierras_aridos_CORREGIDO.xlsx
2026-02-06 20:51:31 - INFO - Archivo corregido: Pedido_Semana_14_06042026_tierras_aridos_CORREGIDO.xlsx
2026-02-06 20:51:31 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 20:51:31 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:51:31 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:51:31 - DEBUG -   Con valor 0: 1
2026-02-06 20:51:31 - DEBUG -   Con valor > 0: 71
2026-02-06 20:51:31 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 20:51:31 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 71 registros
2026-02-06 20:51:31 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:51:31 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:51:31 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:51:31 - INFO -   Articulos: 71
2026-02-06 20:51:31 - INFO -   Importe: 5387.14€
2026-02-06 20:51:31 - INFO - 
==================================================
2026-02-06 20:51:31 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 20:51:31 - INFO - ==================================================
2026-02-06 20:51:31 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 20:51:31 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:51:31 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 20:51:31 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:51:31 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:51:32 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:51:32 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 20:51:32 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 20:51:32 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:51:32 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:51:32 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:51:35 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:35 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:51:35 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:51:36 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:51:36 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:51:36 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:51:36 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 20:51:36 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:51:36 - DEBUG -   maf: 10970 registros
2026-02-06 20:51:36 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:51:36 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:51:36 - DEBUG -   interior: 3624 registros
2026-02-06 20:51:36 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:51:36 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:51:36 - DEBUG -   vivero: 2460 registros
2026-02-06 20:51:36 - DEBUG -   fitos: 1987 registros
2026-02-06 20:51:36 - DEBUG -   semillas: 1180 registros
2026-02-06 20:51:36 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:51:36 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:51:36 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 20:51:36 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 20:51:36 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:51:36 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:51:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:38 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:51:38 - INFO - Costes cargados: 22145 registros
2026-02-06 20:51:38 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:51:38 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:51:38 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 20:51:38 - INFO -   ABC: 995 registros
2026-02-06 20:51:38 - INFO -   Ventas: 4018 registros
2026-02-06 20:51:38 - INFO -   Costes: 22145 registros
2026-02-06 20:51:38 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 20:51:38 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 20:51:38 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:51:38 - INFO - Datos de ventas: 316 registros
2026-02-06 20:51:38 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 20:51:38 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 20:51:38 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:51:38 - INFO -   Factor total: 1.3125
2026-02-06 20:51:38 - INFO -   Factor escalado: 1.1960
2026-02-06 20:51:38 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 20:51:38 - INFO -   Objetivo final: 4909.20€
2026-02-06 20:51:38 - INFO -   Delta: 1185.39€
2026-02-06 20:51:38 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:51:38 - DEBUG -   Total registros: 224
2026-02-06 20:51:38 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 20:51:38 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 20:51:38 - INFO -   Ventas finales: 4923.89€
2026-02-06 20:51:38 - INFO - 
============================================================
2026-02-06 20:51:38 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:51:38 - INFO - ============================================================
2026-02-06 20:51:38 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:51:38 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:51:38 - INFO - DataLoader inicializado correctamente
2026-02-06 20:51:38 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:51:38 - INFO - ============================================================
2026-02-06 20:51:38 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:51:38 - INFO - ============================================================
2026-02-06 20:51:38 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:51:38 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:51:38 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:38 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:38 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:51:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:51:38 - DEBUG - Usando hoja: Stock
2026-02-06 20:51:38 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:51:38 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:51:38 - INFO -   Stock: 30 registros
2026-02-06 20:51:38 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:51:38 - INFO - Fusión completada: 224 registros
2026-02-06 20:51:38 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:51:38 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:51:38 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:51:38 - INFO - 
============================================================
2026-02-06 20:51:38 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:51:38 - INFO - ============================================================
2026-02-06 20:51:38 - INFO - Corrección de tendencia completada:
2026-02-06 20:51:38 - INFO -   - Artículos con tendencia detectada: 0
2026-02-06 20:51:38 - INFO -   - Total incremento aplicado: 0 unidades
2026-02-06 20:51:38 - INFO - ============================================================
2026-02-06 20:51:38 - INFO - Corrección completada:
2026-02-06 20:51:38 - INFO -   - Artículos corregidos: 205/224
2026-02-06 20:51:38 - INFO -   - Artículos aumentados: 205
2026-02-06 20:51:38 - INFO -   - Artículos reducidos: 0
2026-02-06 20:51:38 - WARNING - ALERTAS GENERADAS:
2026-02-06 20:51:38 - WARNING -   [ALTO] 224 artículos con stock en 0 o negativo
2026-02-06 20:51:38 - INFO - 
RESUMEN DE CORRECCIÓN:
2026-02-06 20:51:38 - INFO -   Artículos corregidos: 205/224
2026-02-06 20:51:38 - INFO -   Porcentaje corregido: 91.5%
2026-02-06 20:51:38 - INFO -   Diferencia unidades: +299
2026-02-06 20:51:38 - INFO -   Porcentaje cambio: +32.9%
2026-02-06 20:51:39 - INFO - Archivo de pedido corregido generado: Pedido_Semana_14_06042026_deco_exterior_CORREGIDO.xlsx
2026-02-06 20:51:39 - INFO - Archivo corregido: Pedido_Semana_14_06042026_deco_exterior_CORREGIDO.xlsx
2026-02-06 20:51:39 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 20:51:39 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final', 'Stock_Fisico', 'Pedido_Corregido', 'Escenario', 'Razon_Correccion', 'Porcentaje_Consumido_Stock', 'Incremento_Tendencia', 'Tendencia_Aplicada', 'pct_cambio']
2026-02-06 20:51:39 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:51:39 - DEBUG -   Con valor 0: 19
2026-02-06 20:51:39 - DEBUG -   Con valor > 0: 205
2026-02-06 20:51:39 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 20:51:39 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 205 registros
2026-02-06 20:51:39 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:51:39 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:51:39 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:51:39 - INFO -   Articulos: 205
2026-02-06 20:51:39 - INFO -   Importe: 4923.89€
2026-02-06 20:51:39 - INFO - Estado guardado correctamente
2026-02-06 20:51:39 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:51:39 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:51:39 - INFO - Estado guardado correctamente
2026-02-06 20:51:39 - INFO - 
============================================================
2026-02-06 20:51:39 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 20:51:39 - INFO - ============================================================
2026-02-06 20:51:39 - DEBUG - [DEBUG] Archivos agrupados por sección: {'CORREGIDO': ['./data/output\\Pedido_Semana_14_06042026_maf_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_deco_interior_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_semillas_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_mascotas_vivo_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_mascotas_manufacturado_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_interior_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_fitos_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_vivero_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_utiles_jardin_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_tierras_aridos_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_deco_exterior_CORREGIDO.xlsx'], 'maf': ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx'], 'interior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx'], 'semillas': ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx'], 'vivo': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx'], 'manufacturado': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx'], 'fitos': ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx'], 'vivero': ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx'], 'jardin': ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx'], 'aridos': ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx'], 'exterior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']}
2026-02-06 20:51:39 - INFO - 
============================================================
2026-02-06 20:51:39 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 20:51:39 - INFO - ============================================================
2026-02-06 20:51:39 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 20:51:39 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 20:51:39 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 20:51:39 - INFO - EmailService inicializado correctamente
2026-02-06 20:51:39 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 20:51:39 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 20:51:39 - INFO - 
Enviando email para sección: CORREGIDO
2026-02-06 20:51:39 - INFO - Archivos: ['./data/output\\Pedido_Semana_14_06042026_maf_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_deco_interior_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_semillas_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_mascotas_vivo_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_mascotas_manufacturado_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_interior_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_fitos_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_vivero_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_utiles_jardin_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_tierras_aridos_CORREGIDO.xlsx', './data/output\\Pedido_Semana_14_06042026_deco_exterior_CORREGIDO.xlsx']
2026-02-06 20:51:39 - WARNING - No hay destinatarios configurados para la sección: CORREGIDO
2026-02-06 20:51:39 - WARNING - No se puede enviar email para CORREGIDO: No hay destinatarios configurados
2026-02-06 20:51:39 - ERROR - ✗ Error al enviar email a CORREGIDO: No hay destinatarios configurados
2026-02-06 20:51:39 - INFO - 
Enviando email para sección: maf
2026-02-06 20:51:39 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx']
2026-02-06 20:51:39 - DEBUG - Destinatarios para maf: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:51:39 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:51:39 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:51:39 - INFO - Email enviado para sección maf (semana 14)
2026-02-06 20:51:39 - ERROR - ✗ Error al enviar email a maf: None
2026-02-06 20:51:39 - INFO - 
Enviando email para sección: interior
2026-02-06 20:51:39 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx']
2026-02-06 20:51:39 - DEBUG - Destinatarios para interior: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Iris'}]
2026-02-06 20:51:39 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:51:39 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:51:40 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:51:40 - INFO - Email enviado para sección interior (semana 14)
2026-02-06 20:51:40 - ERROR - ✗ Error al enviar email a interior: None
2026-02-06 20:51:40 - INFO - 
Enviando email para sección: semillas
2026-02-06 20:51:40 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx']
2026-02-06 20:51:40 - DEBUG - Destinatarios para semillas: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:51:40 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:51:40 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:51:40 - INFO - Email enviado para sección semillas (semana 14)
2026-02-06 20:51:40 - ERROR - ✗ Error al enviar email a semillas: None
2026-02-06 20:51:40 - INFO - 
Enviando email para sección: vivo
2026-02-06 20:51:40 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx']
2026-02-06 20:51:40 - WARNING - No hay destinatarios configurados para la sección: vivo
2026-02-06 20:51:40 - WARNING - No se puede enviar email para vivo: No hay destinatarios configurados
2026-02-06 20:51:40 - ERROR - ✗ Error al enviar email a vivo: No hay destinatarios configurados
2026-02-06 20:51:40 - INFO - 
Enviando email para sección: manufacturado
2026-02-06 20:51:40 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx']
2026-02-06 20:51:40 - WARNING - No hay destinatarios configurados para la sección: manufacturado
2026-02-06 20:51:40 - WARNING - No se puede enviar email para manufacturado: No hay destinatarios configurados
2026-02-06 20:51:40 - ERROR - ✗ Error al enviar email a manufacturado: No hay destinatarios configurados
2026-02-06 20:51:40 - INFO - 
Enviando email para sección: fitos
2026-02-06 20:51:40 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx']
2026-02-06 20:51:40 - DEBUG - Destinatarios para fitos: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:51:40 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:51:40 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:51:40 - INFO - Email enviado para sección fitos (semana 14)
2026-02-06 20:51:40 - ERROR - ✗ Error al enviar email a fitos: None
2026-02-06 20:51:40 - INFO - 
Enviando email para sección: vivero
2026-02-06 20:51:40 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx']
2026-02-06 20:51:40 - DEBUG - Destinatarios para vivero: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:51:40 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:51:41 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:51:41 - INFO - Email enviado para sección vivero (semana 14)
2026-02-06 20:51:41 - ERROR - ✗ Error al enviar email a vivero: None
2026-02-06 20:51:41 - INFO - 
Enviando email para sección: jardin
2026-02-06 20:51:41 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx']
2026-02-06 20:51:41 - WARNING - No hay destinatarios configurados para la sección: jardin
2026-02-06 20:51:41 - WARNING - No se puede enviar email para jardin: No hay destinatarios configurados
2026-02-06 20:51:41 - ERROR - ✗ Error al enviar email a jardin: No hay destinatarios configurados
2026-02-06 20:51:41 - INFO - 
Enviando email para sección: aridos
2026-02-06 20:51:41 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx']
2026-02-06 20:51:41 - WARNING - No hay destinatarios configurados para la sección: aridos
2026-02-06 20:51:41 - WARNING - No se puede enviar email para aridos: No hay destinatarios configurados
2026-02-06 20:51:41 - ERROR - ✗ Error al enviar email a aridos: No hay destinatarios configurados
2026-02-06 20:51:41 - INFO - 
Enviando email para sección: exterior
2026-02-06 20:51:41 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']
2026-02-06 20:51:41 - WARNING - No hay destinatarios configurados para la sección: exterior
2026-02-06 20:51:41 - WARNING - No se puede enviar email para exterior: No hay destinatarios configurados
2026-02-06 20:51:41 - ERROR - ✗ Error al enviar email a exterior: No hay destinatarios configurados
2026-02-06 20:51:41 - INFO - 
============================================================
2026-02-06 20:51:41 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 20:51:41 - INFO - ============================================================
2026-02-06 20:51:41 - INFO - Emails enviados exitosamente: 0
2026-02-06 20:51:41 - INFO - Emails fallidos: 11
2026-02-06 20:51:41 - INFO - Secciones procesadas: 11
2026-02-06 20:51:41 - INFO - 
============================================================
2026-02-06 20:51:41 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:51:41 - INFO - ============================================================
2026-02-06 20:51:41 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:51:41 - INFO - 
============================================================
2026-02-06 20:51:41 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:51:41 - INFO - ============================================================
2026-02-06 20:51:41 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:51:41 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 20:51:41 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 20:51:41 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:51:41 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:51:41 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 20:51:41 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:51:41 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 20:51:41 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 20:51:41 - INFO - 
============================================================
2026-02-06 20:51:41 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 20:51:41 - INFO - ============================================================
2026-02-06 20:51:41 - INFO - Emails enviados: 3
2026-02-06 20:51:41 - INFO - Emails fallidos: 0
2026-02-06 20:51:41 - INFO - 
======================================================================
2026-02-06 20:51:41 - INFO - RESUMEN DE EJECUCION
2026-02-06 20:51:41 - INFO - ======================================================================
2026-02-06 20:51:41 - INFO - Semana procesada: 14
2026-02-06 20:51:41 - INFO - Archivos generados: 23
2026-02-06 20:51:41 - INFO - Total articulos: 1510
2026-02-06 20:51:41 - INFO - Total importe: 48115.81€
2026-02-06 20:51:41 - INFO - 
MÉTRICAS DE CORRECCIÓN (FASE 2):
2026-02-06 20:51:41 - INFO - ----------------------------------------
2026-02-06 20:51:41 - INFO -   maf: 191 artículos corregidos
2026-02-06 20:51:41 - INFO -   deco_interior: 135 artículos corregidos
2026-02-06 20:51:41 - INFO -   semillas: 84 artículos corregidos
2026-02-06 20:51:41 - INFO -   mascotas_vivo: 36 artículos corregidos
2026-02-06 20:51:41 - INFO -   mascotas_manufacturado: 411 artículos corregidos
2026-02-06 20:51:41 - INFO -   interior: 121 artículos corregidos
2026-02-06 20:51:41 - INFO -   fitos: 82 artículos corregidos
2026-02-06 20:51:41 - INFO -   vivero: 96 artículos corregidos
2026-02-06 20:51:41 - INFO -   utiles_jardin: 78 artículos corregidos
2026-02-06 20:51:41 - INFO -   tierras_aridos: 71 artículos corregidos
2026-02-06 20:51:41 - INFO -   deco_exterior: 205 artículos corregidos
2026-02-06 20:51:41 - INFO -   TOTAL: 1510 artículos corregidos
2026-02-06 20:51:41 - INFO -   Diferencia neta: +2752 unidades
2026-02-06 20:51:41 - WARNING - 
✗ EMAILS FALLIDOS: 11
2026-02-06 20:51:41 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 20:51:41 - INFO - ======================================================================
2026-02-06 20:51:41 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 20:51:41 - INFO - Archivo principal: ./data/output\Pedido_Semana_14_06042026_maf_CORREGIDO.xlsx
2026-02-06 20:51:41 - INFO - Artículos: 1510
2026-02-06 20:51:41 - INFO - Importe: 48115.81€
2026-02-06 20:51:41 - INFO - 
FASE 2 completada: 11 secciones corregidas
2026-02-06 20:51:41 - INFO - Resumen enviado a responsables de gestión: 3/3
2026-02-06 20:53:20 - INFO - ======================================================================
2026-02-06 20:53:20 - INFO - SISTEMA DE PEDIDOS DE COMPRA - VIVERO ARANJUEZ V2
2026-02-06 20:53:20 - INFO - Fecha de ejecución: 2026-02-06 20:53:20
2026-02-06 20:53:20 - INFO - ======================================================================
2026-02-06 20:53:20 - INFO - Modo de ejecución: FASE 1 + FASE 2
2026-02-06 20:53:20 - INFO - Envío de emails: Sí
2026-02-06 20:53:20 - INFO - StateManager inicializado. Archivo de estado: .\./data\state.json
2026-02-06 20:53:20 - INFO - Cargando estado desde: .\./data\state.json
2026-02-06 20:53:20 - INFO - Estado cargado correctamente
2026-02-06 20:53:20 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:53:20 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:53:20 - INFO - Semana forzada por argumento: 14
2026-02-06 20:53:20 - INFO - ======================================================================
2026-02-06 20:53:20 - INFO - PROCESANDO PEDIDO PARA SEMANA 14
2026-02-06 20:53:20 - INFO - ======================================================================
2026-02-06 20:53:20 - INFO - MODO: FASE 1 (Forecast) + FASE 2 (Corrección)
2026-02-06 20:53:20 - INFO - DataLoader inicializado correctamente
2026-02-06 20:53:20 - INFO - ForecastEngine inicializado correctamente
2026-02-06 20:53:20 - INFO - OrderGenerator inicializado correctamente
2026-02-06 20:53:20 - INFO - SchedulerService inicializado correctamente
2026-02-06 20:53:20 - INFO - Horario configurado: sunday a las 15:00
2026-02-06 20:53:20 - INFO - Período de la semana: 2026-03-30 al 2026-04-05
2026-02-06 20:53:20 - INFO - Stock acumulado cargado: 1727 artículos
2026-02-06 20:53:20 - INFO - 
==================================================
2026-02-06 20:53:20 - INFO - SECCION: MAF
2026-02-06 20:53:20 - INFO - ==================================================
2026-02-06 20:53:20 - INFO - === LEYENDO DATOS PARA SECCIÓN: MAF ===
2026-02-06 20:53:20 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:53:20 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: maf
2026-02-06 20:53:20 - INFO - Archivo ABC encontrado (nuevo formato) para 'maf': .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:53:20 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MAF_P2_2025.xlsx
2026-02-06 20:53:20 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:53:20 - INFO - Clasificación ABC cargada para 'maf': 499 registros
2026-02-06 20:53:20 - DEBUG - [DEBUG] ABC leído: 499 registros
2026-02-06 20:53:20 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:53:20 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:53:20 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:53:24 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:24 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:53:24 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:53:24 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:53:24 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:53:24 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:53:24 - DEBUG - [DEBUG] Filtrando ventas por sección: maf
2026-02-06 20:53:24 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:53:24 - DEBUG -   maf: 10970 registros
2026-02-06 20:53:24 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:53:24 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:53:24 - DEBUG -   interior: 3624 registros
2026-02-06 20:53:24 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:53:24 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:53:24 - DEBUG -   vivero: 2460 registros
2026-02-06 20:53:24 - DEBUG -   fitos: 1987 registros
2026-02-06 20:53:24 - DEBUG -   semillas: 1180 registros
2026-02-06 20:53:24 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:53:24 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:53:24 - DEBUG - [DEBUG] Tras filtrar por 'maf': 10970 registros
2026-02-06 20:53:24 - INFO - Filtrados 10970 registros de sección 'maf' de 44082 total
2026-02-06 20:53:24 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:53:24 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:53:26 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:26 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:53:26 - INFO - Costes cargados: 22145 registros
2026-02-06 20:53:26 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:53:26 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:53:26 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MAF ===
2026-02-06 20:53:26 - INFO -   ABC: 499 registros
2026-02-06 20:53:26 - INFO -   Ventas: 10970 registros
2026-02-06 20:53:26 - INFO -   Costes: 22145 registros
2026-02-06 20:53:26 - DEBUG - [DEBUG] abc_df: 499 registros
2026-02-06 20:53:26 - DEBUG - [DEBUG] ventas_df: 10970 registros
2026-02-06 20:53:26 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:53:26 - INFO - Datos de ventas: 1011 registros
2026-02-06 20:53:26 - INFO - Calculando pedido para semana 14 (1011 registros)
2026-02-06 20:53:26 - INFO -   Objetivo: 7050.65€, Actual (ABC): 5840.61€
2026-02-06 20:53:26 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:53:26 - INFO -   Factor total: 1.3125
2026-02-06 20:53:26 - INFO -   Factor escalado: 1.5844
2026-02-06 20:53:26 - INFO -   Ventas preliminares (con ceil): 9933.75€
2026-02-06 20:53:26 - INFO -   Objetivo final: 9253.98€
2026-02-06 20:53:26 - INFO -   Delta: 679.77€
2026-02-06 20:53:26 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:53:26 - DEBUG -   Total registros: 222
2026-02-06 20:53:26 - DEBUG -   Registros con Unidades_Finales > 0: 191
2026-02-06 20:53:26 - DEBUG -   Ventas finales: 9254.53€
2026-02-06 20:53:26 - INFO -   Ventas finales: 9254.53€
2026-02-06 20:53:27 - INFO - 
============================================================
2026-02-06 20:53:27 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:53:27 - INFO - ============================================================
2026-02-06 20:53:27 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:53:27 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:53:27 - INFO - DataLoader inicializado correctamente
2026-02-06 20:53:27 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:53:27 - INFO - ============================================================
2026-02-06 20:53:27 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:53:27 - INFO - ============================================================
2026-02-06 20:53:27 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:53:27 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:53:27 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:27 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:27 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:27 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:27 - DEBUG - Usando hoja: Stock
2026-02-06 20:53:27 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:53:27 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:53:27 - INFO -   Stock: 30 registros
2026-02-06 20:53:27 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:53:27 - INFO - Fusión completada: 222 registros
2026-02-06 20:53:27 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:53:27 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:53:27 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:53:27 - INFO - 
============================================================
2026-02-06 20:53:27 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:53:27 - INFO - ============================================================
2026-02-06 20:53:27 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:53:27 - INFO - Corrección completada:
2026-02-06 20:53:27 - INFO -   - Artículos corregidos: 191/222
2026-02-06 20:53:27 - INFO -   - Artículos aumentados: 191
2026-02-06 20:53:27 - INFO -   - Artículos reducidos: 0
2026-02-06 20:53:27 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:53:27 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:53:27 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:53:27 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 222 registros
2026-02-06 20:53:27 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:53:27 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:53:27 - DEBUG -   Con valor 0: 31
2026-02-06 20:53:27 - DEBUG -   Con valor > 0: 191
2026-02-06 20:53:27 - DEBUG -   Suma Ventas_Objetivo: 9254.53€
2026-02-06 20:53:27 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 191 registros
2026-02-06 20:53:27 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:53:27 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:53:27 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:53:27 - INFO -   Articulos: 191
2026-02-06 20:53:27 - INFO -   Importe: 9254.53€
2026-02-06 20:53:27 - INFO - 
==================================================
2026-02-06 20:53:27 - INFO - SECCION: DECO_INTERIOR
2026-02-06 20:53:27 - INFO - ==================================================
2026-02-06 20:53:27 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_INTERIOR ===
2026-02-06 20:53:27 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:53:27 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_interior
2026-02-06 20:53:27 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_interior': .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:53:27 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_INTERIOR_P2_2025.xlsx
2026-02-06 20:53:27 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:53:27 - INFO - Clasificación ABC cargada para 'deco_interior': 1827 registros
2026-02-06 20:53:27 - DEBUG - [DEBUG] ABC leído: 1827 registros
2026-02-06 20:53:27 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:53:27 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:53:27 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:53:31 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:31 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:53:31 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:53:31 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:53:31 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:53:31 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:53:31 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_interior
2026-02-06 20:53:31 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:53:31 - DEBUG -   maf: 10970 registros
2026-02-06 20:53:31 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:53:31 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:53:31 - DEBUG -   interior: 3624 registros
2026-02-06 20:53:31 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:53:31 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:53:31 - DEBUG -   vivero: 2460 registros
2026-02-06 20:53:31 - DEBUG -   fitos: 1987 registros
2026-02-06 20:53:31 - DEBUG -   semillas: 1180 registros
2026-02-06 20:53:31 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:53:31 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:53:31 - DEBUG - [DEBUG] Tras filtrar por 'deco_interior': 2468 registros
2026-02-06 20:53:31 - INFO - Filtrados 2468 registros de sección 'deco_interior' de 44082 total
2026-02-06 20:53:31 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:53:31 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:53:33 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:33 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:53:33 - INFO - Costes cargados: 22145 registros
2026-02-06 20:53:33 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:53:33 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:53:33 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_INTERIOR ===
2026-02-06 20:53:33 - INFO -   ABC: 1827 registros
2026-02-06 20:53:33 - INFO -   Ventas: 2468 registros
2026-02-06 20:53:33 - INFO -   Costes: 22145 registros
2026-02-06 20:53:33 - DEBUG - [DEBUG] abc_df: 1827 registros
2026-02-06 20:53:33 - DEBUG - [DEBUG] ventas_df: 2468 registros
2026-02-06 20:53:33 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:53:33 - INFO - Datos de ventas: 180 registros
2026-02-06 20:53:33 - INFO - Calculando pedido para semana 14 (180 registros)
2026-02-06 20:53:34 - INFO -   Objetivo: 1962.99€, Actual (ABC): 1636.15€
2026-02-06 20:53:34 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:53:34 - INFO -   Factor total: 1.3125
2026-02-06 20:53:34 - INFO -   Factor escalado: 1.5747
2026-02-06 20:53:34 - INFO -   Ventas preliminares (con ceil): 2950.01€
2026-02-06 20:53:34 - INFO -   Objetivo final: 2576.42€
2026-02-06 20:53:34 - INFO -   Delta: 373.59€
2026-02-06 20:53:34 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:53:34 - DEBUG -   Total registros: 139
2026-02-06 20:53:34 - DEBUG -   Registros con Unidades_Finales > 0: 135
2026-02-06 20:53:34 - DEBUG -   Ventas finales: 2580.73€
2026-02-06 20:53:34 - INFO -   Ventas finales: 2580.73€
2026-02-06 20:53:34 - INFO - 
============================================================
2026-02-06 20:53:34 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:53:34 - INFO - ============================================================
2026-02-06 20:53:34 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:53:34 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:53:34 - INFO - DataLoader inicializado correctamente
2026-02-06 20:53:34 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:53:34 - INFO - ============================================================
2026-02-06 20:53:34 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:53:34 - INFO - ============================================================
2026-02-06 20:53:34 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:53:34 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:53:34 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:34 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:34 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:34 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:34 - DEBUG - Usando hoja: Stock
2026-02-06 20:53:34 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:53:34 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:53:34 - INFO -   Stock: 30 registros
2026-02-06 20:53:34 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:53:34 - INFO - Fusión completada: 139 registros
2026-02-06 20:53:34 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:53:34 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:53:34 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:53:34 - INFO - 
============================================================
2026-02-06 20:53:34 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:53:34 - INFO - ============================================================
2026-02-06 20:53:34 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:53:34 - INFO - Corrección completada:
2026-02-06 20:53:34 - INFO -   - Artículos corregidos: 135/139
2026-02-06 20:53:34 - INFO -   - Artículos aumentados: 135
2026-02-06 20:53:34 - INFO -   - Artículos reducidos: 0
2026-02-06 20:53:34 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:53:34 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:53:34 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:53:34 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 139 registros
2026-02-06 20:53:34 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:53:34 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:53:34 - DEBUG -   Con valor 0: 4
2026-02-06 20:53:34 - DEBUG -   Con valor > 0: 135
2026-02-06 20:53:34 - DEBUG -   Suma Ventas_Objetivo: 2580.73€
2026-02-06 20:53:34 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 135 registros
2026-02-06 20:53:34 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:53:34 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:53:34 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:53:34 - INFO -   Articulos: 135
2026-02-06 20:53:34 - INFO -   Importe: 2580.73€
2026-02-06 20:53:34 - INFO - 
==================================================
2026-02-06 20:53:34 - INFO - SECCION: SEMILLAS
2026-02-06 20:53:34 - INFO - ==================================================
2026-02-06 20:53:34 - INFO - === LEYENDO DATOS PARA SECCIÓN: SEMILLAS ===
2026-02-06 20:53:34 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:53:34 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: semillas
2026-02-06 20:53:34 - INFO - Archivo ABC encontrado (nuevo formato) para 'semillas': .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:53:34 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_SEMILLAS_P2_2025.xlsx
2026-02-06 20:53:34 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:53:34 - INFO - Clasificación ABC cargada para 'semillas': 218 registros
2026-02-06 20:53:34 - DEBUG - [DEBUG] ABC leído: 218 registros
2026-02-06 20:53:34 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:53:34 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:53:34 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:53:38 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:38 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:53:38 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:53:38 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:53:38 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:53:38 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:53:38 - DEBUG - [DEBUG] Filtrando ventas por sección: semillas
2026-02-06 20:53:38 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:53:38 - DEBUG -   maf: 10970 registros
2026-02-06 20:53:38 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:53:38 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:53:38 - DEBUG -   interior: 3624 registros
2026-02-06 20:53:38 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:53:38 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:53:38 - DEBUG -   vivero: 2460 registros
2026-02-06 20:53:38 - DEBUG -   fitos: 1987 registros
2026-02-06 20:53:38 - DEBUG -   semillas: 1180 registros
2026-02-06 20:53:38 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:53:38 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:53:38 - DEBUG - [DEBUG] Tras filtrar por 'semillas': 1180 registros
2026-02-06 20:53:38 - INFO - Filtrados 1180 registros de sección 'semillas' de 44082 total
2026-02-06 20:53:38 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:53:38 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:53:40 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:40 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:53:40 - INFO - Costes cargados: 22145 registros
2026-02-06 20:53:40 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:53:40 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:53:40 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA SEMILLAS ===
2026-02-06 20:53:40 - INFO -   ABC: 218 registros
2026-02-06 20:53:40 - INFO -   Ventas: 1180 registros
2026-02-06 20:53:40 - INFO -   Costes: 22145 registros
2026-02-06 20:53:40 - DEBUG - [DEBUG] abc_df: 218 registros
2026-02-06 20:53:40 - DEBUG - [DEBUG] ventas_df: 1180 registros
2026-02-06 20:53:40 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:53:40 - INFO - Datos de ventas: 136 registros
2026-02-06 20:53:40 - INFO - Calculando pedido para semana 14 (136 registros)
2026-02-06 20:53:40 - INFO -   Objetivo: 694.34€, Actual (ABC): 455.14€
2026-02-06 20:53:40 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:53:40 - INFO -   Factor total: 1.3125
2026-02-06 20:53:40 - INFO -   Factor escalado: 2.0023
2026-02-06 20:53:40 - INFO -   Ventas preliminares (con ceil): 1129.15€
2026-02-06 20:53:40 - INFO -   Objetivo final: 911.32€
2026-02-06 20:53:40 - INFO -   Delta: 217.83€
2026-02-06 20:53:40 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:53:40 - DEBUG -   Total registros: 84
2026-02-06 20:53:40 - DEBUG -   Registros con Unidades_Finales > 0: 84
2026-02-06 20:53:40 - DEBUG -   Ventas finales: 911.60€
2026-02-06 20:53:40 - INFO -   Ventas finales: 911.60€
2026-02-06 20:53:40 - INFO - 
============================================================
2026-02-06 20:53:40 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:53:40 - INFO - ============================================================
2026-02-06 20:53:40 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:53:40 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:53:40 - INFO - DataLoader inicializado correctamente
2026-02-06 20:53:40 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:53:40 - INFO - ============================================================
2026-02-06 20:53:40 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:53:40 - INFO - ============================================================
2026-02-06 20:53:40 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:53:40 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:53:40 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:40 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:40 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:40 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:40 - DEBUG - Usando hoja: Stock
2026-02-06 20:53:40 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:53:40 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:53:40 - INFO -   Stock: 30 registros
2026-02-06 20:53:40 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:53:40 - INFO - Fusión completada: 84 registros
2026-02-06 20:53:40 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:53:40 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:53:40 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:53:40 - INFO - 
============================================================
2026-02-06 20:53:40 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:53:40 - INFO - ============================================================
2026-02-06 20:53:40 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:53:40 - INFO - Corrección completada:
2026-02-06 20:53:40 - INFO -   - Artículos corregidos: 84/84
2026-02-06 20:53:40 - INFO -   - Artículos aumentados: 84
2026-02-06 20:53:40 - INFO -   - Artículos reducidos: 0
2026-02-06 20:53:40 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:53:40 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:53:40 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:53:40 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:53:40 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:53:40 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:53:40 - DEBUG -   Con valor 0: 0
2026-02-06 20:53:40 - DEBUG -   Con valor > 0: 84
2026-02-06 20:53:40 - DEBUG -   Suma Ventas_Objetivo: 911.60€
2026-02-06 20:53:40 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 84 registros
2026-02-06 20:53:40 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:53:40 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:53:40 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:53:40 - INFO -   Articulos: 84
2026-02-06 20:53:40 - INFO -   Importe: 911.60€
2026-02-06 20:53:40 - INFO - 
==================================================
2026-02-06 20:53:40 - INFO - SECCION: MASCOTAS_VIVO
2026-02-06 20:53:40 - INFO - ==================================================
2026-02-06 20:53:40 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_VIVO ===
2026-02-06 20:53:40 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:53:40 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_vivo
2026-02-06 20:53:40 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_vivo': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:53:40 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_VIVO_P2_2025.xlsx
2026-02-06 20:53:40 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:53:40 - INFO - Clasificación ABC cargada para 'mascotas_vivo': 205 registros
2026-02-06 20:53:40 - DEBUG - [DEBUG] ABC leído: 205 registros
2026-02-06 20:53:40 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:53:40 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:53:40 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:53:44 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:44 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:53:44 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:53:44 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:53:44 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:53:44 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:53:44 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_vivo
2026-02-06 20:53:45 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:53:45 - DEBUG -   maf: 10970 registros
2026-02-06 20:53:45 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:53:45 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:53:45 - DEBUG -   interior: 3624 registros
2026-02-06 20:53:45 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:53:45 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:53:45 - DEBUG -   vivero: 2460 registros
2026-02-06 20:53:45 - DEBUG -   fitos: 1987 registros
2026-02-06 20:53:45 - DEBUG -   semillas: 1180 registros
2026-02-06 20:53:45 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:53:45 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:53:45 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_vivo': 1124 registros
2026-02-06 20:53:45 - INFO - Filtrados 1124 registros de sección 'mascotas_vivo' de 44082 total
2026-02-06 20:53:45 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:53:45 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:53:47 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:47 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:53:47 - INFO - Costes cargados: 22145 registros
2026-02-06 20:53:47 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:53:47 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:53:47 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_VIVO ===
2026-02-06 20:53:47 - INFO -   ABC: 205 registros
2026-02-06 20:53:47 - INFO -   Ventas: 1124 registros
2026-02-06 20:53:47 - INFO -   Costes: 22145 registros
2026-02-06 20:53:47 - DEBUG - [DEBUG] abc_df: 205 registros
2026-02-06 20:53:47 - DEBUG - [DEBUG] ventas_df: 1124 registros
2026-02-06 20:53:47 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:53:47 - INFO - Datos de ventas: 88 registros
2026-02-06 20:53:47 - INFO - Calculando pedido para semana 14 (88 registros)
2026-02-06 20:53:47 - INFO -   Objetivo: 1087.15€, Actual (ABC): 846.63€
2026-02-06 20:53:47 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:53:47 - INFO -   Factor total: 1.3125
2026-02-06 20:53:47 - INFO -   Factor escalado: 1.6854
2026-02-06 20:53:47 - INFO -   Ventas preliminares (con ceil): 1773.66€
2026-02-06 20:53:47 - INFO -   Objetivo final: 1426.88€
2026-02-06 20:53:47 - INFO -   Delta: 346.78€
2026-02-06 20:53:47 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:53:47 - DEBUG -   Total registros: 43
2026-02-06 20:53:47 - DEBUG -   Registros con Unidades_Finales > 0: 36
2026-02-06 20:53:47 - DEBUG -   Ventas finales: 1455.34€
2026-02-06 20:53:47 - INFO -   Ventas finales: 1455.34€
2026-02-06 20:53:47 - INFO - 
============================================================
2026-02-06 20:53:47 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:53:47 - INFO - ============================================================
2026-02-06 20:53:47 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:53:47 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:53:47 - INFO - DataLoader inicializado correctamente
2026-02-06 20:53:47 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:53:47 - INFO - ============================================================
2026-02-06 20:53:47 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:53:47 - INFO - ============================================================
2026-02-06 20:53:47 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:53:47 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:53:47 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:47 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:47 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:47 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:47 - DEBUG - Usando hoja: Stock
2026-02-06 20:53:47 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:53:47 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:53:47 - INFO -   Stock: 30 registros
2026-02-06 20:53:47 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:53:47 - INFO - Fusión completada: 43 registros
2026-02-06 20:53:47 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:53:47 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:53:47 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:53:47 - INFO - 
============================================================
2026-02-06 20:53:47 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:53:47 - INFO - ============================================================
2026-02-06 20:53:47 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:53:47 - INFO - Corrección completada:
2026-02-06 20:53:47 - INFO -   - Artículos corregidos: 36/43
2026-02-06 20:53:47 - INFO -   - Artículos aumentados: 36
2026-02-06 20:53:47 - INFO -   - Artículos reducidos: 0
2026-02-06 20:53:47 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:53:47 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:53:47 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:53:47 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 43 registros
2026-02-06 20:53:47 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:53:47 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:53:47 - DEBUG -   Con valor 0: 7
2026-02-06 20:53:47 - DEBUG -   Con valor > 0: 36
2026-02-06 20:53:47 - DEBUG -   Suma Ventas_Objetivo: 1455.34€
2026-02-06 20:53:47 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 36 registros
2026-02-06 20:53:47 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:53:47 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:53:47 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_vivo.xlsx
2026-02-06 20:53:47 - INFO -   Articulos: 36
2026-02-06 20:53:47 - INFO -   Importe: 1455.34€
2026-02-06 20:53:47 - INFO - 
==================================================
2026-02-06 20:53:47 - INFO - SECCION: MASCOTAS_MANUFACTURADO
2026-02-06 20:53:47 - INFO - ==================================================
2026-02-06 20:53:47 - INFO - === LEYENDO DATOS PARA SECCIÓN: MASCOTAS_MANUFACTURADO ===
2026-02-06 20:53:47 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:53:47 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: mascotas_manufacturado
2026-02-06 20:53:47 - INFO - Archivo ABC encontrado (nuevo formato) para 'mascotas_manufacturado': .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:53:47 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_MASCOTAS_MANUFACTURADO_P2_2025.xlsx
2026-02-06 20:53:47 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:53:47 - INFO - Clasificación ABC cargada para 'mascotas_manufacturado': 2749 registros
2026-02-06 20:53:47 - DEBUG - [DEBUG] ABC leído: 2749 registros
2026-02-06 20:53:47 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:53:47 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:53:47 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:53:51 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:51 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:53:51 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:53:51 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:53:51 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:53:51 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:53:51 - DEBUG - [DEBUG] Filtrando ventas por sección: mascotas_manufacturado
2026-02-06 20:53:51 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:53:51 - DEBUG -   maf: 10970 registros
2026-02-06 20:53:51 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:53:51 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:53:51 - DEBUG -   interior: 3624 registros
2026-02-06 20:53:51 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:53:51 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:53:51 - DEBUG -   vivero: 2460 registros
2026-02-06 20:53:51 - DEBUG -   fitos: 1987 registros
2026-02-06 20:53:51 - DEBUG -   semillas: 1180 registros
2026-02-06 20:53:51 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:53:51 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:53:51 - DEBUG - [DEBUG] Tras filtrar por 'mascotas_manufacturado': 9784 registros
2026-02-06 20:53:51 - INFO - Filtrados 9784 registros de sección 'mascotas_manufacturado' de 44082 total
2026-02-06 20:53:51 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:53:51 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:53:53 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:53 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:53:53 - INFO - Costes cargados: 22145 registros
2026-02-06 20:53:53 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:53:53 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:53:53 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA MASCOTAS_MANUFACTURADO ===
2026-02-06 20:53:53 - INFO -   ABC: 2749 registros
2026-02-06 20:53:53 - INFO -   Ventas: 9784 registros
2026-02-06 20:53:53 - INFO -   Costes: 22145 registros
2026-02-06 20:53:53 - DEBUG - [DEBUG] abc_df: 2749 registros
2026-02-06 20:53:53 - DEBUG - [DEBUG] ventas_df: 9784 registros
2026-02-06 20:53:53 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:53:54 - INFO - Datos de ventas: 822 registros
2026-02-06 20:53:54 - INFO - Calculando pedido para semana 14 (822 registros)
2026-02-06 20:53:55 - INFO -   Objetivo: 6839.82€, Actual (ABC): 8742.92€
2026-02-06 20:53:55 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:53:55 - INFO -   Factor total: 1.3125
2026-02-06 20:53:55 - INFO -   Factor escalado: 1.0268
2026-02-06 20:53:55 - INFO -   Ventas preliminares (con ceil): 12379.25€
2026-02-06 20:53:55 - INFO -   Objetivo final: 8977.26€
2026-02-06 20:53:55 - INFO -   Delta: 3401.99€
2026-02-06 20:53:56 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:53:56 - DEBUG -   Total registros: 538
2026-02-06 20:53:56 - DEBUG -   Registros con Unidades_Finales > 0: 411
2026-02-06 20:53:56 - DEBUG -   Ventas finales: 8993.98€
2026-02-06 20:53:56 - INFO -   Ventas finales: 8993.98€
2026-02-06 20:53:56 - INFO - 
============================================================
2026-02-06 20:53:56 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:53:56 - INFO - ============================================================
2026-02-06 20:53:56 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:53:56 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:53:56 - INFO - DataLoader inicializado correctamente
2026-02-06 20:53:56 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:53:56 - INFO - ============================================================
2026-02-06 20:53:56 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:53:56 - INFO - ============================================================
2026-02-06 20:53:56 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:53:56 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:53:56 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:56 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:56 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:53:56 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:53:56 - DEBUG - Usando hoja: Stock
2026-02-06 20:53:56 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:53:56 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:53:56 - INFO -   Stock: 30 registros
2026-02-06 20:53:56 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:53:56 - INFO - Fusión completada: 538 registros
2026-02-06 20:53:56 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:53:56 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:53:56 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:53:56 - INFO - 
============================================================
2026-02-06 20:53:56 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:53:56 - INFO - ============================================================
2026-02-06 20:53:56 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:53:56 - INFO - Corrección completada:
2026-02-06 20:53:56 - INFO -   - Artículos corregidos: 411/538
2026-02-06 20:53:56 - INFO -   - Artículos aumentados: 411
2026-02-06 20:53:56 - INFO -   - Artículos reducidos: 0
2026-02-06 20:53:56 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:53:56 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:53:56 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:53:56 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 538 registros
2026-02-06 20:53:56 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:53:56 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:53:56 - DEBUG -   Con valor 0: 127
2026-02-06 20:53:56 - DEBUG -   Con valor > 0: 411
2026-02-06 20:53:56 - DEBUG -   Suma Ventas_Objetivo: 8993.98€
2026-02-06 20:53:56 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 411 registros
2026-02-06 20:53:56 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:53:56 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:53:56 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx
2026-02-06 20:53:56 - INFO -   Articulos: 411
2026-02-06 20:53:56 - INFO -   Importe: 8993.98€
2026-02-06 20:53:56 - INFO - 
==================================================
2026-02-06 20:53:56 - INFO - SECCION: INTERIOR
2026-02-06 20:53:56 - INFO - ==================================================
2026-02-06 20:53:56 - INFO - === LEYENDO DATOS PARA SECCIÓN: INTERIOR ===
2026-02-06 20:53:56 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:53:56 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: interior
2026-02-06 20:53:56 - INFO - Archivo ABC encontrado (nuevo formato) para 'interior': .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:53:56 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_INTERIOR_P2_2025.xlsx
2026-02-06 20:53:56 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:53:56 - INFO - Clasificación ABC cargada para 'interior': 555 registros
2026-02-06 20:53:56 - DEBUG - [DEBUG] ABC leído: 555 registros
2026-02-06 20:53:56 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:53:56 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:53:56 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:54:00 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:00 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:54:00 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:54:00 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:54:00 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:54:00 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:54:00 - DEBUG - [DEBUG] Filtrando ventas por sección: interior
2026-02-06 20:54:00 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:54:00 - DEBUG -   maf: 10970 registros
2026-02-06 20:54:00 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:54:00 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:54:00 - DEBUG -   interior: 3624 registros
2026-02-06 20:54:00 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:54:00 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:54:00 - DEBUG -   vivero: 2460 registros
2026-02-06 20:54:00 - DEBUG -   fitos: 1987 registros
2026-02-06 20:54:00 - DEBUG -   semillas: 1180 registros
2026-02-06 20:54:00 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:54:00 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:54:00 - DEBUG - [DEBUG] Tras filtrar por 'interior': 3624 registros
2026-02-06 20:54:00 - INFO - Filtrados 3624 registros de sección 'interior' de 44082 total
2026-02-06 20:54:00 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:54:00 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:54:02 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:02 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:54:02 - INFO - Costes cargados: 22145 registros
2026-02-06 20:54:02 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:54:02 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:54:02 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA INTERIOR ===
2026-02-06 20:54:02 - INFO -   ABC: 555 registros
2026-02-06 20:54:02 - INFO -   Ventas: 3624 registros
2026-02-06 20:54:02 - INFO -   Costes: 22145 registros
2026-02-06 20:54:02 - DEBUG - [DEBUG] abc_df: 555 registros
2026-02-06 20:54:02 - DEBUG - [DEBUG] ventas_df: 3624 registros
2026-02-06 20:54:02 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:54:02 - INFO - Datos de ventas: 286 registros
2026-02-06 20:54:02 - INFO - Calculando pedido para semana 14 (286 registros)
2026-02-06 20:54:03 - INFO -   Objetivo: 2930.63€, Actual (ABC): 2408.44€
2026-02-06 20:54:03 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:54:03 - INFO -   Factor total: 1.3125
2026-02-06 20:54:03 - INFO -   Factor escalado: 1.5971
2026-02-06 20:54:03 - INFO -   Ventas preliminares (con ceil): 4531.82€
2026-02-06 20:54:03 - INFO -   Objetivo final: 3846.45€
2026-02-06 20:54:03 - INFO -   Delta: 685.37€
2026-02-06 20:54:03 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:54:03 - DEBUG -   Total registros: 138
2026-02-06 20:54:03 - DEBUG -   Registros con Unidades_Finales > 0: 121
2026-02-06 20:54:03 - DEBUG -   Ventas finales: 3862.17€
2026-02-06 20:54:03 - INFO -   Ventas finales: 3862.17€
2026-02-06 20:54:03 - INFO - 
============================================================
2026-02-06 20:54:03 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:54:03 - INFO - ============================================================
2026-02-06 20:54:03 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:54:03 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:54:03 - INFO - DataLoader inicializado correctamente
2026-02-06 20:54:03 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:54:03 - INFO - ============================================================
2026-02-06 20:54:03 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:54:03 - INFO - ============================================================
2026-02-06 20:54:03 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:54:03 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:54:03 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:03 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:03 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:03 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:03 - DEBUG - Usando hoja: Stock
2026-02-06 20:54:03 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:54:03 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:54:03 - INFO -   Stock: 30 registros
2026-02-06 20:54:03 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:54:03 - INFO - Fusión completada: 138 registros
2026-02-06 20:54:03 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:54:03 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:54:03 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:54:03 - INFO - 
============================================================
2026-02-06 20:54:03 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:54:03 - INFO - ============================================================
2026-02-06 20:54:03 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:54:03 - INFO - Corrección completada:
2026-02-06 20:54:03 - INFO -   - Artículos corregidos: 121/138
2026-02-06 20:54:03 - INFO -   - Artículos aumentados: 121
2026-02-06 20:54:03 - INFO -   - Artículos reducidos: 0
2026-02-06 20:54:03 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:54:03 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:54:03 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:54:03 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 138 registros
2026-02-06 20:54:03 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:54:03 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:54:03 - DEBUG -   Con valor 0: 17
2026-02-06 20:54:03 - DEBUG -   Con valor > 0: 121
2026-02-06 20:54:03 - DEBUG -   Suma Ventas_Objetivo: 3862.17€
2026-02-06 20:54:03 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 121 registros
2026-02-06 20:54:03 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:54:03 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:54:03 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:54:03 - INFO -   Articulos: 121
2026-02-06 20:54:03 - INFO -   Importe: 3862.17€
2026-02-06 20:54:03 - INFO - 
==================================================
2026-02-06 20:54:03 - INFO - SECCION: FITOS
2026-02-06 20:54:03 - INFO - ==================================================
2026-02-06 20:54:03 - INFO - === LEYENDO DATOS PARA SECCIÓN: FITOS ===
2026-02-06 20:54:03 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:54:03 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: fitos
2026-02-06 20:54:03 - INFO - Archivo ABC encontrado (nuevo formato) para 'fitos': .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:54:03 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:54:03 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:54:03 - INFO - Clasificación ABC cargada para 'fitos': 247 registros
2026-02-06 20:54:03 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:54:03 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:54:03 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:54:03 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:54:07 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:07 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:54:07 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:54:07 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:54:07 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:54:07 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:54:07 - DEBUG - [DEBUG] Filtrando ventas por sección: fitos
2026-02-06 20:54:07 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:54:07 - DEBUG -   maf: 10970 registros
2026-02-06 20:54:07 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:54:07 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:54:07 - DEBUG -   interior: 3624 registros
2026-02-06 20:54:07 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:54:07 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:54:07 - DEBUG -   vivero: 2460 registros
2026-02-06 20:54:07 - DEBUG -   fitos: 1987 registros
2026-02-06 20:54:07 - DEBUG -   semillas: 1180 registros
2026-02-06 20:54:07 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:54:07 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:54:07 - DEBUG - [DEBUG] Tras filtrar por 'fitos': 1987 registros
2026-02-06 20:54:07 - INFO - Filtrados 1987 registros de sección 'fitos' de 44082 total
2026-02-06 20:54:07 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:54:07 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:54:09 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:09 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:54:09 - INFO - Costes cargados: 22145 registros
2026-02-06 20:54:09 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:54:09 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:54:09 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA FITOS ===
2026-02-06 20:54:09 - INFO -   ABC: 247 registros
2026-02-06 20:54:09 - INFO -   Ventas: 1987 registros
2026-02-06 20:54:09 - INFO -   Costes: 22145 registros
2026-02-06 20:54:09 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:54:09 - DEBUG - [DEBUG] ventas_df: 1987 registros
2026-02-06 20:54:09 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:54:09 - INFO - Datos de ventas: 157 registros
2026-02-06 20:54:09 - INFO - Calculando pedido para semana 14 (157 registros)
2026-02-06 20:54:09 - INFO -   Objetivo: 1798.25€, Actual (ABC): 1679.26€
2026-02-06 20:54:09 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:54:09 - INFO -   Factor total: 1.3125
2026-02-06 20:54:09 - INFO -   Factor escalado: 1.4055
2026-02-06 20:54:09 - INFO -   Ventas preliminares (con ceil): 2784.94€
2026-02-06 20:54:09 - INFO -   Objetivo final: 2360.20€
2026-02-06 20:54:09 - INFO -   Delta: 424.74€
2026-02-06 20:54:09 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:54:09 - DEBUG -   Total registros: 84
2026-02-06 20:54:09 - DEBUG -   Registros con Unidades_Finales > 0: 82
2026-02-06 20:54:09 - DEBUG -   Ventas finales: 2365.92€
2026-02-06 20:54:09 - INFO -   Ventas finales: 2365.92€
2026-02-06 20:54:09 - INFO - 
============================================================
2026-02-06 20:54:09 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:54:09 - INFO - ============================================================
2026-02-06 20:54:09 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:54:09 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:54:09 - INFO - DataLoader inicializado correctamente
2026-02-06 20:54:09 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:54:09 - INFO - ============================================================
2026-02-06 20:54:09 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:54:09 - INFO - ============================================================
2026-02-06 20:54:09 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:54:09 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:54:09 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:09 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:09 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:09 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:09 - DEBUG - Usando hoja: Stock
2026-02-06 20:54:09 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:54:09 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:54:09 - INFO -   Stock: 30 registros
2026-02-06 20:54:09 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:54:09 - INFO - Fusión completada: 84 registros
2026-02-06 20:54:09 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:54:09 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:54:09 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:54:09 - INFO - 
============================================================
2026-02-06 20:54:09 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:54:09 - INFO - ============================================================
2026-02-06 20:54:09 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:54:09 - INFO - Corrección completada:
2026-02-06 20:54:09 - INFO -   - Artículos corregidos: 82/84
2026-02-06 20:54:09 - INFO -   - Artículos aumentados: 82
2026-02-06 20:54:09 - INFO -   - Artículos reducidos: 0
2026-02-06 20:54:09 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:54:09 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:54:09 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:54:09 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 84 registros
2026-02-06 20:54:09 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:54:09 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:54:09 - DEBUG -   Con valor 0: 2
2026-02-06 20:54:09 - DEBUG -   Con valor > 0: 82
2026-02-06 20:54:09 - DEBUG -   Suma Ventas_Objetivo: 2365.92€
2026-02-06 20:54:09 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 82 registros
2026-02-06 20:54:09 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:54:09 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:54:09 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:54:09 - INFO -   Articulos: 82
2026-02-06 20:54:09 - INFO -   Importe: 2365.92€
2026-02-06 20:54:09 - INFO - 
==================================================
2026-02-06 20:54:09 - INFO - SECCION: VIVERO
2026-02-06 20:54:09 - INFO - ==================================================
2026-02-06 20:54:09 - INFO - === LEYENDO DATOS PARA SECCIÓN: VIVERO ===
2026-02-06 20:54:09 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:54:09 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: vivero
2026-02-06 20:54:09 - INFO - Archivo ABC encontrado (nuevo formato) para 'vivero': .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:54:09 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_VIVERO_P2_2025.xlsx
2026-02-06 20:54:10 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:54:10 - INFO - Clasificación ABC cargada para 'vivero': 565 registros
2026-02-06 20:54:10 - DEBUG - [DEBUG] ABC leído: 565 registros
2026-02-06 20:54:10 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:54:10 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:54:10 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:54:13 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:13 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:54:14 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:54:14 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:54:14 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:54:14 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:54:14 - DEBUG - [DEBUG] Filtrando ventas por sección: vivero
2026-02-06 20:54:14 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:54:14 - DEBUG -   maf: 10970 registros
2026-02-06 20:54:14 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:54:14 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:54:14 - DEBUG -   interior: 3624 registros
2026-02-06 20:54:14 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:54:14 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:54:14 - DEBUG -   vivero: 2460 registros
2026-02-06 20:54:14 - DEBUG -   fitos: 1987 registros
2026-02-06 20:54:14 - DEBUG -   semillas: 1180 registros
2026-02-06 20:54:14 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:54:14 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:54:14 - DEBUG - [DEBUG] Tras filtrar por 'vivero': 2460 registros
2026-02-06 20:54:14 - INFO - Filtrados 2460 registros de sección 'vivero' de 44082 total
2026-02-06 20:54:14 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:54:14 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:54:16 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:16 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:54:16 - INFO - Costes cargados: 22145 registros
2026-02-06 20:54:16 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:54:16 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:54:16 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA VIVERO ===
2026-02-06 20:54:16 - INFO -   ABC: 565 registros
2026-02-06 20:54:16 - INFO -   Ventas: 2460 registros
2026-02-06 20:54:16 - INFO -   Costes: 22145 registros
2026-02-06 20:54:16 - DEBUG - [DEBUG] abc_df: 565 registros
2026-02-06 20:54:16 - DEBUG - [DEBUG] ventas_df: 2460 registros
2026-02-06 20:54:16 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:54:16 - INFO - Datos de ventas: 189 registros
2026-02-06 20:54:16 - INFO - Calculando pedido para semana 14 (189 registros)
2026-02-06 20:54:16 - INFO -   Objetivo: 5297.17€, Actual (ABC): 4117.24€
2026-02-06 20:54:16 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:54:16 - INFO -   Factor total: 1.3125
2026-02-06 20:54:16 - INFO -   Factor escalado: 1.6886
2026-02-06 20:54:16 - INFO -   Ventas preliminares (con ceil): 8761.94€
2026-02-06 20:54:16 - INFO -   Objetivo final: 6952.54€
2026-02-06 20:54:16 - INFO -   Delta: 1809.40€
2026-02-06 20:54:16 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:54:16 - DEBUG -   Total registros: 107
2026-02-06 20:54:16 - DEBUG -   Registros con Unidades_Finales > 0: 96
2026-02-06 20:54:16 - DEBUG -   Ventas finales: 6990.51€
2026-02-06 20:54:16 - INFO -   Ventas finales: 6990.51€
2026-02-06 20:54:16 - INFO - 
============================================================
2026-02-06 20:54:16 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:54:16 - INFO - ============================================================
2026-02-06 20:54:16 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:54:16 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:54:16 - INFO - DataLoader inicializado correctamente
2026-02-06 20:54:16 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:54:16 - INFO - ============================================================
2026-02-06 20:54:16 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:54:16 - INFO - ============================================================
2026-02-06 20:54:16 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:54:16 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:54:16 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:16 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:16 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:16 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:16 - DEBUG - Usando hoja: Stock
2026-02-06 20:54:16 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:54:16 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:54:16 - INFO -   Stock: 30 registros
2026-02-06 20:54:16 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:54:16 - INFO - Fusión completada: 107 registros
2026-02-06 20:54:16 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:54:16 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:54:16 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:54:16 - INFO - 
============================================================
2026-02-06 20:54:16 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:54:16 - INFO - ============================================================
2026-02-06 20:54:16 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:54:16 - INFO - Corrección completada:
2026-02-06 20:54:16 - INFO -   - Artículos corregidos: 96/107
2026-02-06 20:54:16 - INFO -   - Artículos aumentados: 96
2026-02-06 20:54:16 - INFO -   - Artículos reducidos: 0
2026-02-06 20:54:16 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:54:16 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:54:16 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:54:16 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 107 registros
2026-02-06 20:54:16 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:54:16 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:54:16 - DEBUG -   Con valor 0: 11
2026-02-06 20:54:16 - DEBUG -   Con valor > 0: 96
2026-02-06 20:54:16 - DEBUG -   Suma Ventas_Objetivo: 6990.51€
2026-02-06 20:54:16 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 96 registros
2026-02-06 20:54:16 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:54:16 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:54:16 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:54:16 - INFO -   Articulos: 96
2026-02-06 20:54:16 - INFO -   Importe: 6990.51€
2026-02-06 20:54:16 - INFO - 
==================================================
2026-02-06 20:54:16 - INFO - SECCION: UTILES_JARDIN
2026-02-06 20:54:16 - INFO - ==================================================
2026-02-06 20:54:16 - INFO - === LEYENDO DATOS PARA SECCIÓN: UTILES_JARDIN ===
2026-02-06 20:54:16 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:54:16 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: utiles_jardin
2026-02-06 20:54:16 - INFO - Archivo ABC encontrado (nuevo formato) para 'utiles_jardin': .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:54:16 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_UTILES_JARDIN_P2_2025.xlsx
2026-02-06 20:54:16 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:54:16 - INFO - Clasificación ABC cargada para 'utiles_jardin': 433 registros
2026-02-06 20:54:16 - DEBUG - [DEBUG] ABC leído: 433 registros
2026-02-06 20:54:16 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:54:16 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:54:16 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:54:20 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:20 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:54:20 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:54:20 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:54:20 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:54:20 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:54:20 - DEBUG - [DEBUG] Filtrando ventas por sección: utiles_jardin
2026-02-06 20:54:20 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:54:20 - DEBUG -   maf: 10970 registros
2026-02-06 20:54:20 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:54:20 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:54:20 - DEBUG -   interior: 3624 registros
2026-02-06 20:54:20 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:54:20 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:54:20 - DEBUG -   vivero: 2460 registros
2026-02-06 20:54:20 - DEBUG -   fitos: 1987 registros
2026-02-06 20:54:20 - DEBUG -   semillas: 1180 registros
2026-02-06 20:54:20 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:54:20 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:54:20 - DEBUG - [DEBUG] Tras filtrar por 'utiles_jardin': 1009 registros
2026-02-06 20:54:20 - INFO - Filtrados 1009 registros de sección 'utiles_jardin' de 44082 total
2026-02-06 20:54:20 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:54:20 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:54:22 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:22 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:54:22 - INFO - Costes cargados: 22145 registros
2026-02-06 20:54:22 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:54:22 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:54:22 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA UTILES_JARDIN ===
2026-02-06 20:54:22 - INFO -   ABC: 433 registros
2026-02-06 20:54:22 - INFO -   Ventas: 1009 registros
2026-02-06 20:54:22 - INFO -   Costes: 22145 registros
2026-02-06 20:54:22 - DEBUG - [DEBUG] abc_df: 433 registros
2026-02-06 20:54:22 - DEBUG - [DEBUG] ventas_df: 1009 registros
2026-02-06 20:54:22 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:54:22 - INFO - Datos de ventas: 89 registros
2026-02-06 20:54:22 - INFO - Calculando pedido para semana 14 (89 registros)
2026-02-06 20:54:23 - INFO -   Objetivo: 1044.77€, Actual (ABC): 818.79€
2026-02-06 20:54:23 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:54:23 - INFO -   Factor total: 1.3125
2026-02-06 20:54:23 - INFO -   Factor escalado: 1.6747
2026-02-06 20:54:23 - INFO -   Ventas preliminares (con ceil): 1929.56€
2026-02-06 20:54:23 - INFO -   Objetivo final: 1371.26€
2026-02-06 20:54:23 - INFO -   Delta: 558.30€
2026-02-06 20:54:23 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:54:23 - DEBUG -   Total registros: 78
2026-02-06 20:54:23 - DEBUG -   Registros con Unidades_Finales > 0: 78
2026-02-06 20:54:23 - DEBUG -   Ventas finales: 1390.00€
2026-02-06 20:54:23 - INFO -   Ventas finales: 1390.00€
2026-02-06 20:54:23 - INFO - 
============================================================
2026-02-06 20:54:23 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:54:23 - INFO - ============================================================
2026-02-06 20:54:23 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:54:23 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:54:23 - INFO - DataLoader inicializado correctamente
2026-02-06 20:54:23 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:54:23 - INFO - ============================================================
2026-02-06 20:54:23 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:54:23 - INFO - ============================================================
2026-02-06 20:54:23 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:54:23 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:54:23 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:23 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:23 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:23 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:23 - DEBUG - Usando hoja: Stock
2026-02-06 20:54:23 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:54:23 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:54:23 - INFO -   Stock: 30 registros
2026-02-06 20:54:23 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:54:23 - INFO - Fusión completada: 78 registros
2026-02-06 20:54:23 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:54:23 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:54:23 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:54:23 - INFO - 
============================================================
2026-02-06 20:54:23 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:54:23 - INFO - ============================================================
2026-02-06 20:54:23 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:54:23 - INFO - Corrección completada:
2026-02-06 20:54:23 - INFO -   - Artículos corregidos: 78/78
2026-02-06 20:54:23 - INFO -   - Artículos aumentados: 78
2026-02-06 20:54:23 - INFO -   - Artículos reducidos: 0
2026-02-06 20:54:23 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:54:23 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:54:23 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:54:23 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 78 registros
2026-02-06 20:54:23 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:54:23 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:54:23 - DEBUG -   Con valor 0: 0
2026-02-06 20:54:23 - DEBUG -   Con valor > 0: 78
2026-02-06 20:54:23 - DEBUG -   Suma Ventas_Objetivo: 1390.00€
2026-02-06 20:54:23 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 78 registros
2026-02-06 20:54:23 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:54:23 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:54:23 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_utiles_jardin.xlsx
2026-02-06 20:54:23 - INFO -   Articulos: 78
2026-02-06 20:54:23 - INFO -   Importe: 1390.00€
2026-02-06 20:54:23 - INFO - 
==================================================
2026-02-06 20:54:23 - INFO - SECCION: TIERRAS_ARIDOS
2026-02-06 20:54:23 - INFO - ==================================================
2026-02-06 20:54:23 - INFO - === LEYENDO DATOS PARA SECCIÓN: TIERRAS_ARIDOS ===
2026-02-06 20:54:23 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:54:23 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: tierras_aridos
2026-02-06 20:54:23 - WARNING - No se encontró archivo específico para 'tierras_aridos', usando: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:54:23 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_FITOS_P2_2025.xlsx
2026-02-06 20:54:23 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:54:23 - INFO - Clasificación ABC cargada para 'tierras_aridos': 247 registros
2026-02-06 20:54:23 - DEBUG - [DEBUG] ABC leído: 247 registros
2026-02-06 20:54:23 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:54:23 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:54:23 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:54:27 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:27 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:54:27 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:54:27 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:54:27 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:54:27 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:54:27 - DEBUG - [DEBUG] Filtrando ventas por sección: tierras_aridos
2026-02-06 20:54:27 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:54:27 - DEBUG -   maf: 10970 registros
2026-02-06 20:54:27 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:54:27 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:54:27 - DEBUG -   interior: 3624 registros
2026-02-06 20:54:27 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:54:27 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:54:27 - DEBUG -   vivero: 2460 registros
2026-02-06 20:54:27 - DEBUG -   fitos: 1987 registros
2026-02-06 20:54:27 - DEBUG -   semillas: 1180 registros
2026-02-06 20:54:27 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:54:27 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:54:27 - DEBUG - [DEBUG] Tras filtrar por 'tierras_aridos': 3264 registros
2026-02-06 20:54:27 - INFO - Filtrados 3264 registros de sección 'tierras_aridos' de 44082 total
2026-02-06 20:54:27 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:54:27 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:54:29 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:29 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:54:29 - INFO - Costes cargados: 22145 registros
2026-02-06 20:54:29 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:54:29 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:54:29 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA TIERRAS_ARIDOS ===
2026-02-06 20:54:29 - INFO -   ABC: 247 registros
2026-02-06 20:54:29 - INFO -   Ventas: 3264 registros
2026-02-06 20:54:29 - INFO -   Costes: 22145 registros
2026-02-06 20:54:29 - DEBUG - [DEBUG] abc_df: 247 registros
2026-02-06 20:54:29 - DEBUG - [DEBUG] ventas_df: 3264 registros
2026-02-06 20:54:29 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:54:29 - INFO - Datos de ventas: 302 registros
2026-02-06 20:54:29 - INFO - Calculando pedido para semana 14 (302 registros)
2026-02-06 20:54:29 - INFO -   Objetivo: 4097.24€, Actual (ABC): 4019.19€
2026-02-06 20:54:29 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:54:29 - INFO -   Factor total: 1.3125
2026-02-06 20:54:29 - INFO -   Factor escalado: 1.3380
2026-02-06 20:54:29 - INFO -   Ventas preliminares (con ceil): 5809.66€
2026-02-06 20:54:29 - INFO -   Objetivo final: 5377.63€
2026-02-06 20:54:29 - INFO -   Delta: 432.03€
2026-02-06 20:54:29 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:54:29 - DEBUG -   Total registros: 72
2026-02-06 20:54:29 - DEBUG -   Registros con Unidades_Finales > 0: 71
2026-02-06 20:54:29 - DEBUG -   Ventas finales: 5387.14€
2026-02-06 20:54:29 - INFO -   Ventas finales: 5387.14€
2026-02-06 20:54:29 - INFO - 
============================================================
2026-02-06 20:54:29 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:54:29 - INFO - ============================================================
2026-02-06 20:54:29 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:54:29 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:54:29 - INFO - DataLoader inicializado correctamente
2026-02-06 20:54:29 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:54:29 - INFO - ============================================================
2026-02-06 20:54:29 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:54:29 - INFO - ============================================================
2026-02-06 20:54:29 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:54:29 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:54:29 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:29 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:29 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:29 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:29 - DEBUG - Usando hoja: Stock
2026-02-06 20:54:29 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:54:29 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:54:29 - INFO -   Stock: 30 registros
2026-02-06 20:54:29 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:54:29 - INFO - Fusión completada: 72 registros
2026-02-06 20:54:29 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:54:29 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:54:29 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:54:29 - INFO - 
============================================================
2026-02-06 20:54:29 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:54:29 - INFO - ============================================================
2026-02-06 20:54:29 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:54:29 - INFO - Corrección completada:
2026-02-06 20:54:29 - INFO -   - Artículos corregidos: 71/72
2026-02-06 20:54:29 - INFO -   - Artículos aumentados: 71
2026-02-06 20:54:29 - INFO -   - Artículos reducidos: 0
2026-02-06 20:54:29 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:54:29 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:54:29 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:54:29 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 72 registros
2026-02-06 20:54:29 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:54:29 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:54:29 - DEBUG -   Con valor 0: 1
2026-02-06 20:54:29 - DEBUG -   Con valor > 0: 71
2026-02-06 20:54:29 - DEBUG -   Suma Ventas_Objetivo: 5387.14€
2026-02-06 20:54:29 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 71 registros
2026-02-06 20:54:29 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:54:29 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:54:29 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_tierras_aridos.xlsx
2026-02-06 20:54:29 - INFO -   Articulos: 71
2026-02-06 20:54:29 - INFO -   Importe: 5387.14€
2026-02-06 20:54:29 - INFO - 
==================================================
2026-02-06 20:54:29 - INFO - SECCION: DECO_EXTERIOR
2026-02-06 20:54:29 - INFO - ==================================================
2026-02-06 20:54:29 - INFO - === LEYENDO DATOS PARA SECCIÓN: DECO_EXTERIOR ===
2026-02-06 20:54:29 - DEBUG - [DEBUG] Secciones activas configuradas: ['maf', 'deco_interior', 'semillas', 'mascotas_vivo', 'mascotas_manufacturado', 'interior', 'fitos', 'vivero', 'utiles_jardin', 'tierras_aridos', 'deco_exterior']
2026-02-06 20:54:29 - DEBUG - [DEBUG] Intentando leer clasificación ABC para sección: deco_exterior
2026-02-06 20:54:29 - INFO - Archivo ABC encontrado (nuevo formato) para 'deco_exterior': .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:54:29 - INFO - Leyendo archivo: .\./data/input\CLASIFICACION_ABC+D_DECO_EXTERIOR_P2_2025.xlsx
2026-02-06 20:54:30 - INFO - Archivo leído exitosamente: 4 hojas
2026-02-06 20:54:30 - INFO - Clasificación ABC cargada para 'deco_exterior': 995 registros
2026-02-06 20:54:30 - DEBUG - [DEBUG] ABC leído: 995 registros
2026-02-06 20:54:30 - DEBUG - [DEBUG] Columnas en ABC: ['Artículo', 'Nombre artículo', 'Talla', 'Color', 'Familia', 'Nombre Familia', 'Rotación Familia (días)', 'Ventas (unidades)', 'Importe ventas (€)', 'Beneficio (importe €)', 'Tasa de venta (%)', 'Rotación excedida (unidades)', 'Stock mínimo (unidades)', 'Stock máximo (unidades)', 'Stock Final (unidades)', 'Antigüedad Última Venta (días)', 'Antigüedad Stock (días)', '% Rotación Consumido', 'Descuento Sugerido (%)', 'Riesgo de Merma/ inmovilizado', 'Acción Sugerida', 'Origen Stock Final', 'Escenario', 'Categoria', 'Clave']
2026-02-06 20:54:30 - DEBUG - [DEBUG] Intentando leer archivo de ventas...
2026-02-06 20:54:30 - INFO - Leyendo archivo: .\./data/input\Ventas.xlsx
2026-02-06 20:54:33 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:33 - INFO - Usando hoja: Ventas por vendedor
2026-02-06 20:54:34 - INFO - Filtrados 44082 registros de tipo 'Detalle'
2026-02-06 20:54:34 - INFO - Ventas cargadas: 44082 registros
2026-02-06 20:54:34 - DEBUG - [DEBUG] Ventas leído: 44082 registros
2026-02-06 20:54:34 - DEBUG - [DEBUG] Columnas en Ventas: ['Vendedor', 'Serie', 'Documento', 'Fecha', 'Factura', 'Artículo', 'Nombre artículo', 'Talla', 'Color', 'Unidades', 'Precio', 'Importe', 'Comisión', 'Tipo registro', 'Codigo', 'Nombre']
2026-02-06 20:54:34 - DEBUG - [DEBUG] Filtrando ventas por sección: deco_exterior
2026-02-06 20:54:34 - DEBUG - [DEBUG] Distribución de secciones antes de filtrar:
2026-02-06 20:54:34 - DEBUG -   maf: 10970 registros
2026-02-06 20:54:34 - DEBUG -   mascotas_manufacturado: 9784 registros
2026-02-06 20:54:34 - DEBUG -   deco_exterior: 4018 registros
2026-02-06 20:54:34 - DEBUG -   interior: 3624 registros
2026-02-06 20:54:34 - DEBUG -   tierras_aridos: 3264 registros
2026-02-06 20:54:34 - DEBUG -   deco_interior: 2468 registros
2026-02-06 20:54:34 - DEBUG -   vivero: 2460 registros
2026-02-06 20:54:34 - DEBUG -   fitos: 1987 registros
2026-02-06 20:54:34 - DEBUG -   semillas: 1180 registros
2026-02-06 20:54:34 - DEBUG -   mascotas_vivo: 1124 registros
2026-02-06 20:54:34 - DEBUG -   utiles_jardin: 1009 registros
2026-02-06 20:54:34 - DEBUG - [DEBUG] Tras filtrar por 'deco_exterior': 4018 registros
2026-02-06 20:54:34 - INFO - Filtrados 4018 registros de sección 'deco_exterior' de 44082 total
2026-02-06 20:54:34 - DEBUG - [DEBUG] Intentando leer archivo de costes...
2026-02-06 20:54:34 - INFO - Leyendo archivo: .\./data/input\Coste.xlsx
2026-02-06 20:54:36 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:36 - DEBUG - Usando primera hoja del archivo de costes: INFORME
2026-02-06 20:54:36 - INFO - Costes cargados: 22145 registros
2026-02-06 20:54:36 - DEBUG - [DEBUG] Costes leído: 22145 registros
2026-02-06 20:54:36 - DEBUG - [DEBUG] Columnas en Costes: ['Codigo', 'Nombre', 'Tarifa10', 'Talla', 'Color', 'Proveedor', 'Nombre proveedor', 'Barras', 'Codigo antiguo', 'Ref proveedor', 'Coste', 'Fecha ultcom', 'Margen subf', 'Margen', 'Clave']
2026-02-06 20:54:36 - INFO - === DATOS LEÍDOS CORRECTAMENTE PARA DECO_EXTERIOR ===
2026-02-06 20:54:36 - INFO -   ABC: 995 registros
2026-02-06 20:54:36 - INFO -   Ventas: 4018 registros
2026-02-06 20:54:36 - INFO -   Costes: 22145 registros
2026-02-06 20:54:36 - DEBUG - [DEBUG] abc_df: 995 registros
2026-02-06 20:54:36 - DEBUG - [DEBUG] ventas_df: 4018 registros
2026-02-06 20:54:36 - DEBUG - [DEBUG] costes_df: 22145 registros
2026-02-06 20:54:36 - INFO - Datos de ventas: 316 registros
2026-02-06 20:54:36 - INFO - Calculando pedido para semana 14 (316 registros)
2026-02-06 20:54:36 - INFO -   Objetivo: 3740.34€, Actual (ABC): 4104.66€
2026-02-06 20:54:36 - INFO -   Factor crecimiento: 0.05, Factor festivo: 0.25
2026-02-06 20:54:36 - INFO -   Factor total: 1.3125
2026-02-06 20:54:36 - INFO -   Factor escalado: 1.1960
2026-02-06 20:54:36 - INFO -   Ventas preliminares (con ceil): 6094.59€
2026-02-06 20:54:36 - INFO -   Objetivo final: 4909.20€
2026-02-06 20:54:36 - INFO -   Delta: 1185.39€
2026-02-06 20:54:36 - DEBUG - [DEBUG] Resumen final del cálculo:
2026-02-06 20:54:36 - DEBUG -   Total registros: 224
2026-02-06 20:54:36 - DEBUG -   Registros con Unidades_Finales > 0: 205
2026-02-06 20:54:36 - DEBUG -   Ventas finales: 4923.89€
2026-02-06 20:54:36 - INFO -   Ventas finales: 4923.89€
2026-02-06 20:54:36 - INFO - 
============================================================
2026-02-06 20:54:36 - INFO - FASE 2: APLICANDO CORRECCIÓN AL PEDIDO
2026-02-06 20:54:36 - INFO - ============================================================
2026-02-06 20:54:36 - INFO - Archivo de stock encontrado: Stock_actual.xlsx
2026-02-06 20:54:36 - INFO - Archivos de corrección disponibles: {'stock': True, 'ventas': False, 'compras': False}
2026-02-06 20:54:36 - INFO - DataLoader inicializado correctamente
2026-02-06 20:54:36 - INFO - CorrectionDataLoader inicializado correctamente
2026-02-06 20:54:36 - INFO - ============================================================
2026-02-06 20:54:36 - INFO - CARGANDO DATOS DE CORRECCIÓN PARA SEMANA 14
2026-02-06 20:54:36 - INFO - ============================================================
2026-02-06 20:54:36 - WARNING - Archivo de corrección no encontrado: Stock_actual_Semana_14.xlsx
2026-02-06 20:54:36 - WARNING - Archivo de corrección no encontrado: Stock_semana_14.xlsx
2026-02-06 20:54:36 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:36 - INFO - Archivo de corrección encontrado: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:36 - INFO - Leyendo archivo de corrección: .\./data/input\Stock_actual.xlsx
2026-02-06 20:54:36 - INFO - Archivo leído exitosamente: 1 hojas
2026-02-06 20:54:36 - DEBUG - Usando hoja: Stock
2026-02-06 20:54:36 - DEBUG - Columnas renombradas en stock: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Stock_Fisico', 'Fecha_Ultimo_Movimiento']
2026-02-06 20:54:36 - INFO - Stock actual cargado: 30 registros
2026-02-06 20:54:36 - INFO -   Stock: 30 registros
2026-02-06 20:54:36 - INFO - Fusionando datos de corrección con pedido teórico...
2026-02-06 20:54:36 - INFO - Fusión completada: 224 registros
2026-02-06 20:54:36 - INFO - CorrectionEngine inicializado correctamente
2026-02-06 20:54:36 - DEBUG - Política de stock mínimo: {'A': 1.5, 'B': 1.0, 'C': 0.5, 'D': 0.0}
2026-02-06 20:54:36 - INFO - Aplicando corrección a DataFrame de pedidos...
2026-02-06 20:54:36 - INFO - 
============================================================
2026-02-06 20:54:36 - INFO - APLICANDO CORRECCIÓN POR TENDENCIA DE VENTAS (ÚLTIMA VARIABLE)
2026-02-06 20:54:36 - INFO - ============================================================
2026-02-06 20:54:36 - WARNING - No hay datos de ventas reales u objetivo. Omitiendo corrección de tendencia.
2026-02-06 20:54:36 - INFO - Corrección completada:
2026-02-06 20:54:36 - INFO -   - Artículos corregidos: 205/224
2026-02-06 20:54:36 - INFO -   - Artículos aumentados: 205
2026-02-06 20:54:36 - INFO -   - Artículos reducidos: 0
2026-02-06 20:54:36 - ERROR - Error al aplicar corrección: 'Unidades_Vendidas'
2026-02-06 20:54:36 - ERROR - Traceback (most recent call last):
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'Unidades_Vendidas'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\main.py", line 174, in aplicar_correccion_pedido
    alertas = engine.generar_alertas(pedido_corregido)
  File "D:\ALMACENAMIENTO\Ivan\viveverde\Trabajos\IA\PROGRAMA_COMPRAS_AUTOMATICAS\2_LISTADO_PEDIDO_COMPRAS\LISTADO_PEDIDO_COMPRAS\src\correction_engine.py", line 737, in generar_alertas
    sin_ventas_con_stock = df[(df['Unidades_Vendidas'] == 0) & (df['Stock_Fisico'] > 0)]
                               ~~^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\idalo\AppData\Local\Programs\Python\Python313\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'Unidades_Vendidas'

2026-02-06 20:54:36 - INFO - Usando pedido teórico (sin corrección)
2026-02-06 20:54:36 - DEBUG - [DEBUG generar_archivo_pedido] Recibido DataFrame con 224 registros
2026-02-06 20:54:36 - DEBUG - [DEBUG] Columnas disponibles: ['Codigo_Articulo', 'Nombre_Articulo', 'Talla', 'Color', 'Seccion', 'Unidades_Base', 'Unidades_ABC', 'PVP', 'Coste_Pedido', 'Proveedor', 'Categoria', 'Accion_Aplicada', 'Peso_Categoria', 'Ventas_Preliminares', 'Unidades_Escaladas', 'Unidades_Finales', 'Ventas_Objetivo', 'Beneficio_Objetivo', 'Stock_Minimo_Objetivo', 'Diferencia_Stock', 'Pedido_Corregido_Stock', 'Ventas_Reales', 'Tendencia_Consumo', 'Pedido_Final']
2026-02-06 20:54:36 - DEBUG - [DEBUG] Distribución de Pedido_Corregido_Stock:
2026-02-06 20:54:36 - DEBUG -   Con valor 0: 19
2026-02-06 20:54:36 - DEBUG -   Con valor > 0: 205
2026-02-06 20:54:36 - DEBUG -   Suma Ventas_Objetivo: 4923.89€
2026-02-06 20:54:36 - DEBUG - [DEBUG] Tras filtrar Pedido_Corregido_Stock > 0: 205 registros
2026-02-06 20:54:36 - INFO - Generando archivo: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:54:36 - INFO - Archivo guardado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:54:37 - INFO - Archivo generado: .\./data/output\Pedido_Semana_14_06022026_deco_exterior.xlsx
2026-02-06 20:54:37 - INFO -   Articulos: 205
2026-02-06 20:54:37 - INFO -   Importe: 4923.89€
2026-02-06 20:54:37 - INFO - Estado guardado correctamente
2026-02-06 20:54:37 - INFO - Generando resumen: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:54:37 - INFO - Resumen guardado: .\./data/output\Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:54:37 - INFO - Estado guardado correctamente
2026-02-06 20:54:37 - INFO - 
============================================================
2026-02-06 20:54:37 - INFO - PREPARANDO ENVÍO DE EMAILS
2026-02-06 20:54:37 - INFO - ============================================================
2026-02-06 20:54:37 - DEBUG - [DEBUG] Archivos agrupados por sección: {'maf': ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx'], 'interior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx'], 'semillas': ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx'], 'vivo': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx'], 'manufacturado': ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx'], 'fitos': ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx'], 'vivero': ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx'], 'jardin': ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx'], 'aridos': ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx'], 'exterior': ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']}
2026-02-06 20:54:37 - INFO - 
============================================================
2026-02-06 20:54:37 - INFO - ENVÍO DE EMAILS A RESPONSABLES
2026-02-06 20:54:37 - INFO - ============================================================
2026-02-06 20:54:37 - DEBUG - Configuración de email cargada desde config.json
2026-02-06 20:54:37 - INFO - Encargados cargados desde config\encargados.json: 11 secciones
2026-02-06 20:54:37 - DEBUG - Mapping de encargados: {'interior': 'Iris', 'mascotas_manufacturado': 'María', 'mascotas_vivo': 'María', 'deco_exterior': 'Pablo', 'tierras_aridos': 'Pablo', 'fitos': 'Ivan', 'semillas': 'Ivan', 'utiles_jardin': 'Ivan', 'deco_interior': 'Sandra', 'maf': 'Jose', 'vivero': 'Jose'}
2026-02-06 20:54:37 - INFO - EmailService inicializado correctamente
2026-02-06 20:54:37 - INFO - Remitente: ivan.delgado@viveverde.es
2026-02-06 20:54:37 - INFO - Secciones con destinatarios: ['maf', 'interior', 'mascotas_vivo', 'mascotas_manufacturado', 'deco_interior', 'deco_exterior', 'tierras_aridos', 'fitos', 'semillas', 'utiles_jardin', 'vivero']
2026-02-06 20:54:37 - INFO - 
Enviando email para sección: maf
2026-02-06 20:54:37 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_maf.xlsx']
2026-02-06 20:54:37 - DEBUG - Destinatarios para maf: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:54:37 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:54:37 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:54:37 - INFO - Email enviado para sección maf (semana 14)
2026-02-06 20:54:37 - ERROR - ✗ Error al enviar email a maf: None
2026-02-06 20:54:37 - INFO - 
Enviando email para sección: interior
2026-02-06 20:54:37 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_interior.xlsx', '.\\./data/output\\Pedido_Semana_14_06022026_interior.xlsx']
2026-02-06 20:54:37 - DEBUG - Destinatarios para interior: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Iris'}]
2026-02-06 20:54:37 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_deco_interior.xlsx
2026-02-06 20:54:37 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_interior.xlsx
2026-02-06 20:54:37 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:54:37 - INFO - Email enviado para sección interior (semana 14)
2026-02-06 20:54:37 - ERROR - ✗ Error al enviar email a interior: None
2026-02-06 20:54:37 - INFO - 
Enviando email para sección: semillas
2026-02-06 20:54:37 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_semillas.xlsx']
2026-02-06 20:54:37 - DEBUG - Destinatarios para semillas: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:54:37 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_semillas.xlsx
2026-02-06 20:54:38 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:54:38 - INFO - Email enviado para sección semillas (semana 14)
2026-02-06 20:54:38 - ERROR - ✗ Error al enviar email a semillas: None
2026-02-06 20:54:38 - INFO - 
Enviando email para sección: vivo
2026-02-06 20:54:38 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_vivo.xlsx']
2026-02-06 20:54:38 - WARNING - No hay destinatarios configurados para la sección: vivo
2026-02-06 20:54:38 - WARNING - No se puede enviar email para vivo: No hay destinatarios configurados
2026-02-06 20:54:38 - ERROR - ✗ Error al enviar email a vivo: No hay destinatarios configurados
2026-02-06 20:54:38 - INFO - 
Enviando email para sección: manufacturado
2026-02-06 20:54:38 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_mascotas_manufacturado.xlsx']
2026-02-06 20:54:38 - WARNING - No hay destinatarios configurados para la sección: manufacturado
2026-02-06 20:54:38 - WARNING - No se puede enviar email para manufacturado: No hay destinatarios configurados
2026-02-06 20:54:38 - ERROR - ✗ Error al enviar email a manufacturado: No hay destinatarios configurados
2026-02-06 20:54:38 - INFO - 
Enviando email para sección: fitos
2026-02-06 20:54:38 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_fitos.xlsx']
2026-02-06 20:54:38 - DEBUG - Destinatarios para fitos: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Ivan'}]
2026-02-06 20:54:38 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_fitos.xlsx
2026-02-06 20:54:38 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:54:38 - INFO - Email enviado para sección fitos (semana 14)
2026-02-06 20:54:38 - ERROR - ✗ Error al enviar email a fitos: None
2026-02-06 20:54:38 - INFO - 
Enviando email para sección: vivero
2026-02-06 20:54:38 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_vivero.xlsx']
2026-02-06 20:54:38 - DEBUG - Destinatarios para vivero: [{'email': 'ivan.delgado@viveverde.es', 'nombre': 'Jose'}]
2026-02-06 20:54:38 - DEBUG - Adjunto añadido: Pedido_Semana_14_06022026_vivero.xlsx
2026-02-06 20:54:38 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:54:38 - INFO - Email enviado para sección vivero (semana 14)
2026-02-06 20:54:38 - ERROR - ✗ Error al enviar email a vivero: None
2026-02-06 20:54:38 - INFO - 
Enviando email para sección: jardin
2026-02-06 20:54:38 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_utiles_jardin.xlsx']
2026-02-06 20:54:38 - WARNING - No hay destinatarios configurados para la sección: jardin
2026-02-06 20:54:38 - WARNING - No se puede enviar email para jardin: No hay destinatarios configurados
2026-02-06 20:54:38 - ERROR - ✗ Error al enviar email a jardin: No hay destinatarios configurados
2026-02-06 20:54:38 - INFO - 
Enviando email para sección: aridos
2026-02-06 20:54:38 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_tierras_aridos.xlsx']
2026-02-06 20:54:38 - WARNING - No hay destinatarios configurados para la sección: aridos
2026-02-06 20:54:38 - WARNING - No se puede enviar email para aridos: No hay destinatarios configurados
2026-02-06 20:54:38 - ERROR - ✗ Error al enviar email a aridos: No hay destinatarios configurados
2026-02-06 20:54:38 - INFO - 
Enviando email para sección: exterior
2026-02-06 20:54:38 - INFO - Archivos: ['.\\./data/output\\Pedido_Semana_14_06022026_deco_exterior.xlsx']
2026-02-06 20:54:38 - WARNING - No hay destinatarios configurados para la sección: exterior
2026-02-06 20:54:38 - WARNING - No se puede enviar email para exterior: No hay destinatarios configurados
2026-02-06 20:54:38 - ERROR - ✗ Error al enviar email a exterior: No hay destinatarios configurados
2026-02-06 20:54:38 - INFO - 
============================================================
2026-02-06 20:54:38 - INFO - RESUMEN DE ENVÍO DE EMAILS
2026-02-06 20:54:38 - INFO - ============================================================
2026-02-06 20:54:38 - INFO - Emails enviados exitosamente: 0
2026-02-06 20:54:38 - INFO - Emails fallidos: 10
2026-02-06 20:54:38 - INFO - Secciones procesadas: 10
2026-02-06 20:54:38 - INFO - 
============================================================
2026-02-06 20:54:38 - INFO - PREPARANDO ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:54:38 - INFO - ============================================================
2026-02-06 20:54:38 - INFO - Archivo de resumen encontrado: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:54:38 - INFO - 
============================================================
2026-02-06 20:54:38 - INFO - ENVÍO DE RESUMEN A RESPONSABLES DE GESTIÓN
2026-02-06 20:54:38 - INFO - ============================================================
2026-02-06 20:54:38 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:54:39 - INFO - Email enviado exitosamente a: sandra.delgado@viveverde.es
2026-02-06 20:54:39 - INFO - ✓ Resumen enviado a Sandra (sandra.delgado@viveverde.es)
2026-02-06 20:54:39 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:54:39 - INFO - Email enviado exitosamente a: ivan.delgado@viveverde.es
2026-02-06 20:54:39 - INFO - ✓ Resumen enviado a Ivan (ivan.delgado@viveverde.es)
2026-02-06 20:54:39 - DEBUG - Adjunto añadido: Resumen_Pedidos_CONSOLIDADO_06022026.xlsx
2026-02-06 20:54:39 - INFO - Email enviado exitosamente a: pedro.delgado@viveverde.es
2026-02-06 20:54:39 - INFO - ✓ Resumen enviado a Pedro (pedro.delgado@viveverde.es)
2026-02-06 20:54:39 - INFO - 
============================================================
2026-02-06 20:54:39 - INFO - RESUMEN DE ENVÍO A RESPONSABLES DE GESTIÓN
2026-02-06 20:54:39 - INFO - ============================================================
2026-02-06 20:54:39 - INFO - Emails enviados: 3
2026-02-06 20:54:39 - INFO - Emails fallidos: 0
2026-02-06 20:54:39 - INFO - 
======================================================================
2026-02-06 20:54:39 - INFO - RESUMEN DE EJECUCION
2026-02-06 20:54:39 - INFO - ======================================================================
2026-02-06 20:54:39 - INFO - Semana procesada: 14
2026-02-06 20:54:39 - INFO - Archivos generados: 12
2026-02-06 20:54:39 - INFO - Total articulos: 1510
2026-02-06 20:54:39 - INFO - Total importe: 48115.81€
2026-02-06 20:54:39 - WARNING - 
✗ EMAILS FALLIDOS: 10
2026-02-06 20:54:39 - INFO - 
✓ RESUMEN ENVIADO A RESPONSABLES DE GESTIÓN: 3/3
2026-02-06 20:54:39 - INFO - ======================================================================
2026-02-06 20:54:39 - INFO - 
¡PEDIDO GENERADO EXITOSAMENTE!
2026-02-06 20:54:39 - INFO - Archivo principal: .\./data/output\Pedido_Semana_14_06022026_maf.xlsx
2026-02-06 20:54:39 - INFO - Artículos: 1510
2026-02-06 20:54:39 - INFO - Importe: 48115.81€
2026-02-06 20:54:39 - INFO - Resumen enviado a responsables de gestión: 3/3
